---
number: 915
title: "Bug: Google Ads unit tests fail - missing GOOGLE_ADS_DEVELOPER_TOKEN in CI"
state: open
labels: ["bug", "p1"]
created_at: 2026-01-29T15:01:52Z
updated_at: 2026-01-29T15:01:52Z
---

# Bug: Google Ads unit tests fail - missing GOOGLE_ADS_DEVELOPER_TOKEN in CI

## Summary
Unit tests for the Google Ads allocator client are failing in CI because the `GOOGLE_ADS_DEVELOPER_TOKEN` environment variable is not configured in the test environment.

## Error Details
```
AssertionError: promise rejected "Error: Google Ads Developer Token not con…" instead of resolving
❯ src/lib/allocator/google-ads/client.test.ts:141:7

Caused by: Error: Google Ads Developer Token not configured. Set GOOGLE_ADS_DEVELOPER_TOKEN environment variable.
❯ GoogleAdsAllocatorClient.updateCampaignBudget src/lib/allocator/google-ads/client.ts:300:15
```

Multiple test failures at:
- `src/lib/allocator/google-ads/client.test.ts:141` - updateCampaignBudget test
- `src/lib/allocator/google-ads/client.test.ts:178` - rate limit error test
- `src/lib/allocator/google-ads/client.test.ts:205` - permission denied error test
- `src/lib/allocator/google-ads/client.test.ts:239` - additional test

## Affected Files
- `src/lib/allocator/google-ads/client.ts:300`
- `src/lib/allocator/google-ads/client.test.ts`

## CI Runs
- Failed run: https://github.com/zerdos/spike-land-nextjs/actions/runs/21482321725 (unit-tests-3 shard)
- Failed run: https://github.com/zerdos/spike-land-nextjs/actions/runs/21481900362 (unit-tests-3 shard)

## Root Cause Analysis
The tests are attempting to test error handling scenarios but the client validates the developer token before reaching the mocked error scenarios. The tests need to:
1. Mock the environment variable in the test setup, OR
2. Mock the token validation check to bypass it during tests

## Impact
- **P1: HIGH** - CI is failing on main branch (shard 3/4)
- Blocking merges that depend on all tests passing

## Proposed Fix
1. Update the test file to mock `process.env.GOOGLE_ADS_DEVELOPER_TOKEN` before each test
2. OR refactor the client to allow dependency injection of config for testing
3. Consider using `vi.stubEnv()` in Vitest to set the environment variable

## Example Fix
```typescript
beforeEach(() => {
  vi.stubEnv('GOOGLE_ADS_DEVELOPER_TOKEN', 'test-token');
});

afterEach(() => {
  vi.unstubAllEnvs();
});
```
