name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 30

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Cache node_modules
        uses: actions/cache@v5
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install --immutable-cache

      - name: download diff
        run: |
          curl -fsSL https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}.diff > ${{ github.event.pull_request.number }}.diff

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_TOKEN }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          E2E_BYPASS_SECRET: ${{ secrets.E2E_BYPASS_SECRET }}
          NEXTAUTH_URL: http://localhost:3000
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          GH_PAT_TOKEN: ${{ secrets.GH_PAT_TOKEN }}
          SPIKE_LAND_API_KEY: ${{ secrets.SPIKE_LAND_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_R2_ACCESS_KEY_ID: ${{ secrets.CLOUDFLARE_R2_ACCESS_KEY_ID }}
          CLOUDFLARE_R2_SECRET_ACCESS_KEY: ${{ secrets.CLOUDFLARE_R2_SECRET_ACCESS_KEY }}
          CLOUDFLARE_R2_BUCKET_NAME: ${{ secrets.CLOUDFLARE_R2_BUCKET_NAME }}
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            the full changeset of the branch till now is!
            @${{ github.event.pull_request.number }}.diff

            Please do a line by line code review on this pull request and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage

            Use the repository's CLAUDE.md for guidance on style and conventions.

            ## Your Capabilities

            **GitHub Access:**
            - Read existing comments: `gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments`
            - Read PR reviews: `gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews`
            - Read PR commits: `gh pr view ${{ github.event.pull_request.number }} --json commits`
            - Remove outdated Pull request reviews! so if something got fixed - remove from the original comment as well which mentioned the issue.
            - Use `gh pr comment` or `gh api` for comment management

            **File Editing:**
            - You can directly edit files if it makes easier for you to test something
            - But you shouldn't commit anything.

            **Comment Management:**
            - Before posting new review comments, check for existing Claude code code reviews! If you find any, please update / remove the existing review.

            Be constructive and helpful.
            If you find anything that's not clear - or needs to be changed, you can ask @Jules to do it, simply mentioning in the PR review - to do the following changes in this PR.  You must either accept the PR, or ask modifications. If you are happy with it, wait until the CI finishes. If it is passed, you can merge the PR. If the PR failed, please ask @Jules to fix the CI.

            ## Jules Integration (only if Jules created the PR)

            If not Jules created the PR, just ignore this section.
            When you need Jules to make changes:


            To communicate with Jules, use PR reviews instead of PR comments:
            # This works (PR review):
            echo $GH_PAT_TOKEN | gh auth login --with-token
            gh api repos/zerdos/spike-land-nextjs/pulls/XXX/reviews -X POST -f body="@Jules message" -f event="COMMENT"

            # This does NOT work (regular comment):
            gh pr comment XXX --body "@Jules message"

            **Jules Request Template:**
            ```
            @Jules Please make the following changes to this PR:
            - [ ] Fix: <specific issue with file path and line number>
            - [ ] Add: <specific addition needed>
            ```

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
          claude_args: |
            --mcp-config .mcp.json
            --allowed-tools "Bash(gh:*),Bash(yarn:*),Bash(git:*),Bash(npm:*),Edit,Write,Read,Glob,Grep,mcp__playwright__*,mcp__github__*"
            --model opus
            --dangerously-skip-permissions
