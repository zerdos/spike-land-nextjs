name: Smoke Test

on:
  # Manual trigger with environment selection
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
          - local
      stage:
        description: "Run specific stage (empty for all)"
        required: false
        type: string
      enable_real_tests:
        description: "Enable real integration tests (Stripe, AI, Social)"
        required: false
        type: boolean
        default: false

  # Scheduled daily smoke test on staging
  schedule:
    - cron: "0 6 * * *" # 6 AM UTC daily

permissions:
  contents: read
  issues: write

jobs:
  smoke-test:
    name: Smoke Test (${{ inputs.environment || 'staging' }})
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Generate Prisma client
        run: |
          yarn db:generate
          yarn install

      - name: Cache Playwright browsers
        uses: actions/cache@v5
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: yarn playwright install chromium --with-deps

      - name: Install Playwright dependencies
        run: yarn playwright install-deps chromium

      - name: Set BASE_URL based on environment
        id: set-url
        run: |
          case "${{ inputs.environment || 'staging' }}" in
            "production")
              echo "BASE_URL=https://spike.land" >> $GITHUB_OUTPUT
              ;;
            "staging")
              echo "BASE_URL=https://next.spike.land" >> $GITHUB_OUTPUT
              ;;
            "local")
              echo "BASE_URL=http://localhost:3000" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Start local server (if local environment)
        if: inputs.environment == 'local'
        run: |
          yarn build
          yarn start &
          sleep 10
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy?schema=public

      - name: Run Smoke Test Workflow
        run: |
          STAGE_ARG=""
          if [ -n "${{ inputs.stage }}" ]; then
            STAGE_ARG="--stage=${{ inputs.stage }}"
          fi
          # Use yarn tsx instead of npx tsx to ensure proper Yarn PnP resolution
          yarn tsx e2e/smoke-test-workflow.ts $STAGE_ARG
        env:
          BASE_URL: ${{ steps.set-url.outputs.BASE_URL }}
          E2E_BYPASS_SECRET: ${{ secrets.E2E_BYPASS_SECRET }}
          DATABASE_URL: ${{ secrets.DATABASE_URL_E2E }}
          ENABLE_REAL_AI_TESTS: ${{ inputs.enable_real_tests }}
          ENABLE_REAL_PAYMENT_TESTS: ${{ inputs.enable_real_tests }}
          ENABLE_SOCIAL_POSTING: ${{ inputs.enable_real_tests }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          GOOGLE_GEMINI_API_KEY: ${{ secrets.GOOGLE_GEMINI_API_KEY }}
          CI: true
          HEADLESS: true

      - name: Upload Screenshot Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-test-screenshots
          path: e2e/smoke-test-screenshots/
          retention-days: 7

      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-test-report
          path: e2e/reports/smoke-test-report.json
          retention-days: 30

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'e2e/reports/smoke-test-report.json';
            let reportContent = 'Report not available';
            let failureCount = 0;
            let isTransientFailure = false;
            let skippedOnlyFailure = false;

            try {
              if (fs.existsSync(reportPath)) {
                const report = JSON.parse(fs.readFileSync(reportPath, 'utf-8'));
                const failures = report.failures || [];
                failureCount = failures.length;

                // Check if this is a transient failure (e.g., timeout, network issues)
                const transientPatterns = [
                  /timeout/i, /ETIMEDOUT/i, /ECONNREFUSED/i, /ECONNRESET/i,
                  /net::ERR_/i, /Navigation failed/i, /Page crashed/i, /Target closed/i,
                ];
                isTransientFailure = failures.length > 0 && failures.every(f =>
                  transientPatterns.some(pattern => pattern.test(f.error || ''))
                );

                // Check if all failures are in optional/skipped features
                const optionalJobs = ['3.2', '3.4', '3.5', '4.1', '4.2', '4.3'];
                skippedOnlyFailure = failures.length > 0 && failures.every(f =>
                  optionalJobs.includes(f.job)
                );

                reportContent = failures.length > 0
                  ? failures.map(f => `- **[${f.job}] ${f.name}**: ${f.error}`).join('\n')
                  : 'No specific failures recorded';
              }
            } catch (e) {
              reportContent = `Error reading report: ${e.message}`;
            }

            // Determine priority based on failure type
            let priority = 'p0';
            let priorityNote = '';

            if (reportContent === 'Report not available') {
              priorityNote = '\n\n> **Note**: Report was not generated - infrastructure issue.';
            } else if (skippedOnlyFailure) {
              priority = 'p2';
              priorityNote = '\n\n> **Note**: Only optional features failed. Downgraded to P2.';
            } else if (isTransientFailure) {
              priority = 'p1';
              priorityNote = '\n\n> **Note**: Transient failures detected. May resolve on retry.';
            }

            // Check for existing open smoke test issues today to avoid duplicates
            const today = new Date().toISOString().split('T')[0];
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'agent-created',
              per_page: 10,
            });

            const duplicateIssue = existingIssues.data.find(issue =>
              issue.title.includes('Smoke Test Failure') && issue.title.includes(today)
            );

            if (duplicateIssue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: duplicateIssue.number,
                body: `## Additional Run Failed\n\n**Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n### Failures\n\n${reportContent}${priorityNote}`,
              });
              console.log(`Added comment to existing issue #${duplicateIssue.number}`);
              return;
            }

            const title = `Smoke Test Failure - ${today}`;
            const body = [
              '## Smoke Test Failed',
              '',
              `- **Environment:** $\{{ inputs.environment || 'staging' }}`,
              `- **Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              `- **Triggered by:** ${context.actor}`,
              `- **Failure Count:** ${failureCount}`,
              '',
              '### Failures',
              '',
              reportContent + priorityNote,
              '',
              '### Next Steps',
              '',
              `1. Review the [workflow run logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              '2. Download screenshots from artifacts',
              '3. Fix issues and re-run smoke test',
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['bug', priority, 'agent-created']
            });

      - name: Summary
        if: always()
        run: |
          echo "## Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment || 'staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Base URL:** ${{ steps.set-url.outputs.BASE_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "e2e/reports/smoke-test-report.json" ]; then
            echo "### Summary" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat e2e/reports/smoke-test-report.json | jq '.summary' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
