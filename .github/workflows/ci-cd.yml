name: CI/CD Pipeline

permissions:
  contents: read
  pull-requests: write # For PR comments

# Cancel in-progress runs for the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

on:
  push:
    branches:
      - "main"
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "CLAUDE.md"
  pull_request:
    branches:
      - "main"
    paths-ignore:
      - "**.md"
      - "docs/**"

# NOTE: Vercel deployments are now handled natively via Git integration.
# - Preview deployments: Automatically created for all PRs by Vercel
# - Production deployments: Automatically deployed when merging to main
# - PR comments: Vercel automatically posts deployment URLs on PRs
# This workflow focuses on testing and quality checks only.

jobs:
  # ============================================================================
  # TIER 1: All these jobs run in PARALLEL immediately (no dependencies)
  # ============================================================================
  quality-checks:
    name: Quality Checks (Lint + Security)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Cache node_modules
        uses: actions/cache@v5
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install --immutable

      - name: Run linter
        run: yarn lint

      - name: Tsc check
        run: yarn tsc --noEmit

      - name: Run security audit
        run: yarn npm audit --all --severity moderate

  unit-tests:
    name: unit-tests-${{ matrix.shard }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        shard: [1, 2, 3, 4]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          # Fetch full history so we can compare against main branch for --changed
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Cache node_modules
        uses: actions/cache@v5
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install --immutable

      - name: Generate Prisma Client
        run: yarn prisma generate --no-hints

      - name: Fetch main branch for comparison
        if: github.ref != 'refs/heads/main'
        run: git fetch origin main:main

      - name: Run tests (shard ${{ matrix.shard }}/4)
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            # On main branch: run all tests
            yarn test:run --shard=${{ matrix.shard }}/4 --reporter=github-actions
          else
            # On PR/feature branch: run only changed tests
            yarn test:run --changed $(yarn find-last-passing-ci unit-tests-${{ matrix.shard }})  --shard=${{ matrix.shard }}/4 --reporter=github-actions
          fi
        env:
          # Provide dummy DATABASE_URL for Prisma 7 client engine initialization
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy?schema=public

      - name: Upload coverage reports
        uses: codecov/codecov-action@v5
        if: always()
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-shard-${{ matrix.shard }}
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  # Build runs in PARALLEL with quality-checks and unit-tests (no needs)
  build:
    name: Build Application
    runs-on: ubuntu-latest
    # NO DEPENDENCIES - runs immediately in parallel with tests and lint!

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Cache node_modules
        uses: actions/cache@v5
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install --immutable

      - name: Cache Next.js build (Turbopack)
        uses: actions/cache@v5
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-${{ hashFiles('**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-
            ${{ runner.os }}-nextjs-

      - name: Build application
        run: yarn build
        env:
          # Provide dummy DATABASE_URL for Prisma 7 client engine initialization
          # Actual database connection only happens at runtime with real credentials
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy?schema=public

  # ============================================================================
  # TIER 2: E2E Tests - runs against localhost (in parallel with other jobs)
  # ============================================================================

  # E2E tests run against localhost with yarn dev, not against Vercel preview.
  # This speeds up CI by not waiting for Vercel deployment.
  # Tests are sharded across 8 runners for faster execution.
  e2e:
    name: E2E Tests [${{ matrix.shard }}/8]
    runs-on: ubuntu-latest
    # NO DEPENDENCIES - runs in parallel with other jobs
    timeout-minutes: 30
    strategy:
      matrix:
        shard: [1, 2, 3, 4, 5, 6, 7, 8]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Cache node_modules
        uses: actions/cache@v5
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install --immutable

      - name: Cache Playwright browsers
        uses: actions/cache@v5
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers (if cache miss)
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: yarn playwright install chromium --with-deps

      - name: Install Playwright dependencies (always needed for system libs)
        run: yarn playwright install-deps chromium

      - name: Generate Prisma Client
        run: yarn prisma generate --no-hints

      - name: Run E2E tests (shard ${{ matrix.shard }}/8)
        env:
          BASE_URL: http://localhost:3000
          E2E_BYPASS_SECRET: ${{ secrets.E2E_BYPASS_SECRET }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          NEXTAUTH_URL: http://localhost:3000
          SKIP_ENV_VALIDATION: "true"
          SHARD_INDEX: ${{ matrix.shard }}
          SHARD_TOTAL: 8
        run: yarn start:server:and:test:ci
      - name: Upload E2E test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-reports-shard-${{ matrix.shard }}
          path: e2e/reports
          retention-days: 7

  # ============================================================================
  # TIER 2: E2E Database Tests - runs @requires-db scenarios against test database
  # ============================================================================

  # E2E database tests run against a Neon test database.
  # These tests require real database interaction and run sequentially.
  e2e-db:
    name: E2E Database Tests
    runs-on: ubuntu-latest
    # NO DEPENDENCIES - runs in parallel with other jobs
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Cache node_modules
        uses: actions/cache@v5
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install --immutable

      - name: Cache Playwright browsers
        uses: actions/cache@v5
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers (if cache miss)
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: yarn playwright install chromium --with-deps

      - name: Install Playwright dependencies (always needed for system libs)
        run: yarn playwright install-deps chromium

      - name: Generate Prisma Client
        run: yarn prisma generate --no-hints

      - name: Seed E2E test database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_E2E }}
        run: yarn db:seed-e2e

      - name: Run E2E database tests
        env:
          BASE_URL: http://localhost:3000
          E2E_BYPASS_SECRET: ${{ secrets.E2E_BYPASS_SECRET }}
          DATABASE_URL: ${{ secrets.DATABASE_URL_E2E }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          NEXTAUTH_URL: http://localhost:3000
          SKIP_ENV_VALIDATION: "true"
        run: |
          # Start dev server in background and wait for it
          yarn dev:e2e &
          npx wait-on http://localhost:3000 --timeout 60000
          # Run database-dependent E2E tests
          yarn test:e2e:db

      - name: Cleanup E2E test database
        if: always()
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_E2E }}
        run: yarn db:cleanup-e2e

      - name: Upload E2E database test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-db-reports
          path: e2e/reports
          retention-days: 7
