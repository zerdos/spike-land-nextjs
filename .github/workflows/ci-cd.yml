name: CI/CD Pipeline

permissions:
  contents: read
  pull-requests: write # For PR comments

# Cancel in-progress runs for the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

on:
  push:
    branches:
      - "main"
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "CLAUDE.md"
  pull_request:
    branches:
      - "main"
    paths-ignore:
      - "**.md"
      - "docs/**"

# NOTE: Vercel deployments are now handled natively via Git integration.
# - Preview deployments: Automatically created for all PRs by Vercel
# - Production deployments: Automatically deployed when merging to main
# - PR comments: Vercel automatically posts deployment URLs on PRs
# This workflow focuses on testing and quality checks only.

jobs:
  # ============================================================================
  # TIER 1: All these jobs run in PARALLEL immediately (no dependencies)
  # ============================================================================
  quality-checks:
    name: Quality Checks (Lint + Security)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Cache node_modules
        uses: actions/cache@v5
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install --immutable

      - name: Run linter
        run: yarn lint

      - name: Run security audit
        run: yarn npm audit --all --severity moderate

  unit-tests:
    name: Unit Tests [${{ matrix.shard }}/8]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        shard: [1, 2, 3, 4, 5, 6, 7, 8]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Cache node_modules
        uses: actions/cache@v5
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install --immutable

      - name: Generate Prisma Client
        run: yarn prisma generate --no-hints

      - name: Run tests (shard ${{ matrix.shard }}/4)
        run: |
          git  checkout -b temp-shard-branch
          # Run tests for this shard (1-4)
          git checkout main
          git merge --squash --no-commit temp-shard-branch
          yarn test:run --changed main --shard=${{ matrix.shard }}/4 --reporter=github-actions
        env:
          # Provide dummy DATABASE_URL for Prisma 7 client engine initialization
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy?schema=public

      - name: Upload coverage reports
        uses: codecov/codecov-action@v5
        if: always()
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-shard-${{ matrix.shard }}
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  # Build runs in PARALLEL with quality-checks and unit-tests (no needs)
  build:
    name: Build Application
    runs-on: ubuntu-latest
    # NO DEPENDENCIES - runs immediately in parallel with tests and lint!

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Cache node_modules
        uses: actions/cache@v5
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install --immutable

      - name: Build application
        run: yarn build
        env:
          # Provide dummy DATABASE_URL for Prisma 7 client engine initialization
          # Actual database connection only happens at runtime with real credentials
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy?schema=public

  # ============================================================================
  # TIER 2: E2E Tests - runs against localhost (in parallel with other jobs)
  # ============================================================================

  # E2E tests run against localhost with yarn dev, not against Vercel preview.
  # This speeds up CI by not waiting for Vercel deployment.
  # Tests are sharded across 8 runners for faster execution.
  e2e:
    name: E2E Tests [${{ matrix.shard }}/8]
    runs-on: ubuntu-latest
    # NO DEPENDENCIES - runs in parallel with other jobs
    timeout-minutes: 30
    strategy:
      matrix:
        shard: [1, 2, 3, 4, 5, 6, 7, 8]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Cache node_modules
        uses: actions/cache@v5
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install --immutable

      - name: Cache Playwright browsers
        uses: actions/cache@v5
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers (if cache miss)
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: yarn playwright install chromium --with-deps

      - name: Install Playwright dependencies (always needed for system libs)
        run: yarn playwright install-deps chromium

      - name: Generate Prisma Client
        run: yarn prisma generate --no-hints

      - name: Select feature files for shard
        id: shard-files
        run: |
          # Get all feature files sorted alphabetically for consistent sharding
          ALL_FILES=$(find e2e/features -name "*.feature" | sort)
          TOTAL_FILES=$(echo "$ALL_FILES" | wc -l)
          SHARD=${{ matrix.shard }}
          TOTAL_SHARDS=8

          # Calculate which files belong to this shard
          FILES_PER_SHARD=$(( (TOTAL_FILES + TOTAL_SHARDS - 1) / TOTAL_SHARDS ))
          START_IDX=$(( (SHARD - 1) * FILES_PER_SHARD + 1 ))
          END_IDX=$(( SHARD * FILES_PER_SHARD ))

          # Get files for this shard
          SHARD_FILES=$(echo "$ALL_FILES" | sed -n "${START_IDX},${END_IDX}p" | tr '\n' ' ')

          echo "Shard $SHARD/$TOTAL_SHARDS: Running $(echo "$SHARD_FILES" | wc -w) feature files"
          echo "Files: $SHARD_FILES"
          echo "files=$SHARD_FILES" >> $GITHUB_OUTPUT

      - name: Start dev server
        run: |
          yarn dev &
          DEV_PID=$!
          echo "DEV_PID=$DEV_PID" >> $GITHUB_ENV

          # Wait for server to be ready (up to 120 seconds)
          echo "Waiting for dev server to be ready..."
          for i in {1..120}; do
            if curl -s http://localhost:3000 > /dev/null 2>&1; then
              echo "✓ Dev server is ready! (took ${i}s)"
              exit 0
            fi
            if [ $((i % 10)) -eq 0 ]; then
              echo "Still waiting... (${i}s)"
            fi
            sleep 1
          done
          echo "✗ Dev server failed to start after 120 seconds"
          exit 1
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          E2E_BYPASS_SECRET: ${{ secrets.E2E_BYPASS_SECRET }}
          NEXTAUTH_URL: http://localhost:3000
          # Disable external services for E2E tests
          SKIP_ENV_VALIDATION: "true"

      - name: Run E2E tests (shard ${{ matrix.shard }}/8)
        env:
          BASE_URL: http://localhost:3000
          E2E_BYPASS_SECRET: ${{ secrets.E2E_BYPASS_SECRET }}
        run: |
          # Run cucumber with only the shard's feature files
          npx cucumber-js --profile ci ${{ steps.shard-files.outputs.files }}

      - name: Upload E2E test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-reports-shard-${{ matrix.shard }}
          path: e2e/reports
          retention-days: 7
