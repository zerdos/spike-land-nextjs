name: CI/CD Pipeline

permissions:
  contents: read
  pull-requests: write # For PR comments

# Cancel in-progress runs for the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

on:
  push:
    branches:
      - "main"
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "CLAUDE.md"
  pull_request:
    branches:
      - "main"
    paths-ignore:
      - "**.md"
      - "docs/**"

# NOTE: Vercel deployments are now handled natively via Git integration.
# - Preview deployments: Automatically created for all PRs by Vercel
# - Production deployments: Automatically deployed when merging to main
# - PR comments: Vercel automatically posts deployment URLs on PRs
# This workflow focuses on testing and quality checks only.

jobs:
  # ============================================================================
  # TIER 1: All these jobs run in PARALLEL immediately (no dependencies)
  # ============================================================================
  quality-checks:
    name: Quality Checks (Lint + Security)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Cache node_modules
        uses: actions/cache@v5
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install --immutable

      - name: Run silent install
        run: yarn silent:install

      - name: Cache TypeScript build info
        uses: actions/cache@v5
        with:
          path: tsconfig.tsbuildinfo
          key: ${{ runner.os }}-tsbuildinfo-${{ hashFiles('**/tsconfig.json', 'src/**/*.ts', 'src/**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-tsbuildinfo-

      - name: Run linter
        run: yarn lint

      - name: Tsc check
        run: yarn tsc --noEmit

      - name: Run security audit
        run: yarn npm audit --all --severity moderate

  unit-tests:
    name: unit-tests-${{ matrix.shard }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        shard: [1, 2, 3, 4]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          # Fetch full history so we can compare against main branch for --changed
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Cache node_modules
        uses: actions/cache@v5
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install --immutable

      - name: Generate Prisma Client
        run: yarn prisma generate --no-hints

      - name: Fetch main branch for comparison
        if: github.ref != 'refs/heads/main'
        run: git fetch origin main:main

      - name: Run tests (shard ${{ matrix.shard }}/4)
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            # On main branch: run all tests with coverage enforcement
            yarn test:coverage --shard=${{ matrix.shard }}/4 --reporter=github-actions
          else
            # On PR/feature branch: run only changed tests (no coverage threshold enforcement)
            yarn test:run --changed $(yarn find-last-passing-ci unit-tests-${{ matrix.shard }}) --shard=${{ matrix.shard }}/4 --reporter=github-actions
          fi
        env:
          # Provide dummy DATABASE_URL for Prisma 7 client engine initialization
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy?schema=public

      - name: Upload coverage reports
        uses: codecov/codecov-action@v5
        # Only upload if coverage was generated (skipped when --changed finds no tests)
        if: always() && hashFiles('./coverage/lcov.info') != ''
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-shard-${{ matrix.shard }}
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  # Package tests run the tests for workspace packages (code, backend, transpiler, renderer)
  package-tests:
    name: Package Tests
    runs-on: ubuntu-latest
    # NO DEPENDENCIES - runs in parallel with other Tier 1 jobs

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Cache node_modules
        uses: actions/cache@v5
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install --immutable

      - name: Generate Prisma Client
        run: yarn prisma generate --no-hints

      - name: Run package tests
        run: yarn test:packages
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy?schema=public

  # Build runs in PARALLEL with quality-checks and unit-tests (no needs)
  build:
    name: Build Application
    runs-on: ubuntu-latest
    # NO DEPENDENCIES - runs immediately in parallel with tests and lint!

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Cache node_modules
        uses: actions/cache@v5
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install --immutable

      - name: Cache Next.js build (Turbopack)
        uses: actions/cache@v5
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-${{ hashFiles('**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-
            ${{ runner.os }}-nextjs-

      - name: Install libvips for sharp
        run: sudo apt-get update && sudo apt-get install -y libvips-dev

      - name: Build application
        run: yarn build
        env:
          # Provide dummy DATABASE_URL for Prisma 7 client engine initialization
          # Actual database connection only happens at runtime with real credentials
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy?schema=public

  # ============================================================================
  # TIER 2: E2E Database Seed - prepares test database before sharded E2E tests
  # ============================================================================

  e2e-seed:
    name: Seed E2E Database
    runs-on: ubuntu-latest
    # NO DEPENDENCIES - runs in parallel with other Tier 1 jobs

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Cache node_modules
        uses: actions/cache@v5
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install --immutable

      - name: Generate Prisma Client
        run: yarn prisma generate --no-hints

      - name: Seed E2E test database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_E2E }}
          E2E_DATABASE_CONFIRMED: true
        run: yarn db:seed-e2e

  # ============================================================================
  # TIER 2: E2E Tests - runs against localhost (after database seed)
  # ============================================================================

  # E2E tests run against localhost with yarn dev, not against Vercel preview.
  # This speeds up CI by not waiting for Vercel deployment.
  # Tests are sharded across 8 runners for faster execution.
  # Includes @requires-db tests - all shards connect to test database.
  e2e:
    name: E2E Tests [${{ matrix.shard }}/8]
    runs-on: ubuntu-latest
    needs: [e2e-seed] # Wait for database seeding before running tests
    timeout-minutes: 30
    strategy:
      matrix:
        shard: [1, 2, 3, 4, 5, 6, 7, 8]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Cache node_modules
        uses: actions/cache@v5
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install --immutable

      - name: Cache Playwright browsers
        uses: actions/cache@v5
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers (if cache miss)
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: yarn playwright install chromium --with-deps

      - name: Install Playwright dependencies (always needed for system libs)
        run: yarn playwright install-deps chromium

      - name: Generate Prisma Client
        run: yarn prisma generate --no-hints

      - name: Run E2E tests (shard ${{ matrix.shard }}/8)
        env:
          BASE_URL: http://localhost:3000
          E2E_BYPASS_SECRET: ${{ secrets.E2E_BYPASS_SECRET }}
          DATABASE_URL: ${{ secrets.DATABASE_URL_E2E }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          NEXTAUTH_URL: http://localhost:3000
          SKIP_ENV_VALIDATION: "true"
          SHARD_INDEX: ${{ matrix.shard }}
          SHARD_TOTAL: 8
          # Upstash Redis for queue operations
          KV_REST_API_URL: ${{ secrets.KV_REST_API_URL }}
          KV_REST_API_TOKEN: ${{ secrets.KV_REST_API_TOKEN }}
        run: yarn start:server:and:test:ci
      - name: Upload E2E test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-reports-shard-${{ matrix.shard }}
          path: e2e/reports
          retention-days: 7

  # ============================================================================
  # TIER 3: E2E Database Cleanup - cleans up test database after all shards complete
  # ============================================================================

  e2e-cleanup:
    name: Cleanup E2E Database
    runs-on: ubuntu-latest
    needs: [e2e]
    if: always() # Run cleanup even if tests fail

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Cache node_modules
        uses: actions/cache@v5
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install --immutable

      - name: Generate Prisma Client
        run: yarn prisma generate --no-hints

      - name: Cleanup E2E test database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_E2E }}
          E2E_DATABASE_CONFIRMED: true
        run: yarn db:cleanup-e2e
