generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id                   String                @id @default(cuid())
  name                 String?
  email                String?               @unique
  emailVerified        DateTime?
  image                String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  stripeCustomerId     String?               @unique
  role                 UserRole              @default(USER)
  referralCode         String?               @unique
  referredById         String?
  referralCount        Int                   @default(0)
  passwordHash         String?
  accounts             Account[]
  albums               Album[]
  apps                 App[]
  auditLogs            AuditLog[]
  enhancedImages       EnhancedImage[]
  enhancementJobs      ImageEnhancementJob[]
  refereeReferrals     Referral[]            @relation("RefereeReferrals")
  referrerReferrals    Referral[]            @relation("ReferrerReferrals")
  sessions             Session[]
  stripePayments       StripePayment[]
  subscription         Subscription?
  tokenTransactions    TokenTransaction[]
  tokenBalance         UserTokenBalance?
  referredBy           User?                 @relation("Referrals", fields: [referredById], references: [id])
  referrals            User[]                @relation("Referrals")
  voucherRedemptions   VoucherRedemption[]
  feedback             Feedback[]
  createdGalleryItems  FeaturedGalleryItem[] @relation("GalleryItemCreator")
  emailLogs            EmailLog[]
  trackedUrls          TrackedUrl[]
  apiKeys              ApiKey[]
  mcpGenerationJobs    McpGenerationJob[]
  boxes                Box[]
  pipelines            EnhancementPipeline[]
  audioMixerProjects   AudioMixerProject[]
  marketingAccounts    MarketingAccount[]
  // Campaign Analytics relations
  visitorSessions      VisitorSession[]
  campaignAttributions CampaignAttribution[]
  // Merch relations
  merchCart            MerchCart?
  merchOrders          MerchOrder[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model MarketingAccount {
  id           String            @id @default(cuid())
  userId       String
  platform     MarketingPlatform
  accountId    String // Platform-specific account ID (FB Ad Account ID, Google Ads Customer ID)
  accountName  String?
  accessToken  String // Encrypted access token
  refreshToken String? // Encrypted refresh token (for Google Ads)
  expiresAt    DateTime?
  isActive     Boolean           @default(true)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform, accountId])
  @@index([userId])
  @@index([platform])
  @@map("marketing_accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model App {
  id                 String              @id @default(cuid())
  name               String
  description        String?
  userId             String
  forkedFrom         String?
  status             AppStatus           @default(DRAFT)
  domain             String?             @unique
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  parentApp          App?                @relation("AppForks", fields: [forkedFrom], references: [id])
  forks              App[]               @relation("AppForks")
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  monetizationModels MonetizationModel[]
  requirements       Requirement[]

  @@index([userId])
  @@index([forkedFrom])
  @@index([status])
  @@map("apps")
}

model Requirement {
  id          String              @id @default(cuid())
  appId       String
  description String
  priority    RequirementPriority @default(MEDIUM)
  status      RequirementStatus   @default(PENDING)
  version     Int                 @default(1)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  app         App                 @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([status])
  @@index([priority])
  @@map("requirements")
}

model MonetizationModel {
  id                   String                @id @default(cuid())
  appId                String
  type                 MonetizationType      @default(FREE)
  price                Decimal?              @db.Decimal(10, 2)
  subscriptionInterval SubscriptionInterval?
  features             String[]
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  app                  App                   @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([type])
  @@map("monetization_models")
}

model UserTokenBalance {
  id               String   @id @default(cuid())
  userId           String   @unique
  balance          Int      @default(0)
  lastRegeneration DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_token_balances")
}

model TokenTransaction {
  id           String               @id @default(cuid())
  userId       String
  amount       Int
  type         TokenTransactionType
  source       String?
  sourceId     String?
  balanceAfter Int
  metadata     Json?
  createdAt    DateTime             @default(now())
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([sourceId])
  @@map("token_transactions")
}

model TokensPackage {
  id             String          @id @default(cuid())
  name           String
  tokens         Int
  priceUSD       Decimal         @db.Decimal(10, 2)
  stripePriceId  String          @unique
  active         Boolean         @default(true)
  sortOrder      Int             @default(0)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  stripePayments StripePayment[]

  @@index([active, sortOrder])
  @@map("tokens_packages")
}

model StripePayment {
  id                    String              @id @default(cuid())
  userId                String
  packageId             String
  tokensGranted         Int
  amountUSD             Decimal             @db.Decimal(10, 2)
  stripePaymentIntentId String              @unique
  status                StripePaymentStatus
  metadata              Json?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  package               TokensPackage       @relation(fields: [packageId], references: [id])
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([stripePaymentIntentId])
  @@map("stripe_payments")
}

model EnhancedImage {
  id                   String                @id @default(cuid())
  userId               String
  name                 String
  description          String?
  originalUrl          String
  originalR2Key        String
  originalWidth        Int
  originalHeight       Int
  originalSizeBytes    Int
  originalFormat       String
  isPublic             Boolean               @default(false)
  viewCount            Int                   @default(0)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  shareToken           String?               @unique
  albumImages          AlbumImage[]
  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  enhancementJobs      ImageEnhancementJob[]
  blendTargetJobs      ImageEnhancementJob[] @relation("BlendSource")
  featuredGalleryItems FeaturedGalleryItem[]
  merchCartItems       MerchCartItem[]

  @@index([userId, createdAt])
  @@index([isPublic, createdAt])
  @@index([shareToken])
  @@map("enhanced_images")
}

model ImageEnhancementJob {
  id                    String          @id @default(cuid())
  imageId               String
  userId                String
  tier                  EnhancementTier
  tokensCost            Int
  status                JobStatus
  currentStage          PipelineStage? // Current pipeline stage for progress tracking
  enhancedUrl           String?
  enhancedR2Key         String?
  enhancedWidth         Int?
  enhancedHeight        Int?
  enhancedSizeBytes     Int?
  errorMessage          String?
  retryCount            Int             @default(0)
  maxRetries            Int             @default(3)
  geminiPrompt          String?
  geminiModel           String?
  geminiTemp            Float?
  processingStartedAt   DateTime?
  processingCompletedAt DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  workflowRunId         String?
  // Analysis fields for dynamic prompt pipeline
  analysisResult        Json? // Stores full AnalysisDetailedResult JSON
  analysisSource        String? // Model used for analysis (e.g., "gemini-3-pro-image-preview")
  // Cropping fields for auto-crop feature
  wasCropped            Boolean         @default(false)
  cropDimensions        Json? // Stores { left, top, width, height } pixel values used

  // Pipeline reference for audit trail
  pipelineId String?
  pipeline   EnhancementPipeline? @relation(fields: [pipelineId], references: [id])

  // Blend enhancement - optional source image for image-to-image blending
  sourceImageId String?
  sourceImage   EnhancedImage? @relation("BlendSource", fields: [sourceImageId], references: [id], onDelete: SetNull)
  isBlend       Boolean        @default(false) // True when job uses blend enhancement (file upload or stored image)

  image                EnhancedImage         @relation(fields: [imageId], references: [id], onDelete: Cascade)
  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  featuredGalleryItems FeaturedGalleryItem[]

  @@index([userId, status, createdAt])
  @@index([imageId])
  @@index([status, updatedAt])
  @@index([workflowRunId])
  @@index([pipelineId])
  @@index([status, currentStage]) // Optimize SSE stream queries filtering by status and stage
  @@map("image_enhancement_jobs")
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  stripeSubscriptionId String             @unique
  stripePriceId        String
  status               SubscriptionStatus
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  tokensPerMonth       Int
  rolloverTokens       Int                @default(0)
  maxRollover          Int                @default(0)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeSubscriptionId])
  @@index([status])
  @@map("subscriptions")
}

model SubscriptionPlan {
  id             String   @id @default(cuid())
  name           String
  tokensPerMonth Int
  priceGBP       Decimal  @db.Decimal(10, 2)
  stripePriceId  String   @unique
  maxRollover    Int      @default(0)
  priority       Boolean  @default(false)
  apiAccess      Boolean  @default(false)
  active         Boolean  @default(true)
  sortOrder      Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([active, sortOrder])
  @@map("subscription_plans")
}

model Album {
  id           String          @id @default(cuid())
  userId       String
  name         String
  description  String?
  coverImageId String?
  privacy      AlbumPrivacy    @default(PRIVATE)
  defaultTier  EnhancementTier @default(TIER_1K)
  shareToken   String?         @unique
  sortOrder    Int             @default(0)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Pipeline reference (optional - falls back to system default)
  pipelineId String?
  pipeline   EnhancementPipeline? @relation(fields: [pipelineId], references: [id])

  albumImages AlbumImage[]
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name, privacy]) // Prevent duplicate default albums per user
  @@index([userId, createdAt])
  @@index([privacy])
  @@index([shareToken])
  @@index([pipelineId])
  @@map("albums")
}

model AlbumImage {
  id        String        @id @default(cuid())
  albumId   String
  imageId   String
  sortOrder Int           @default(0)
  addedAt   DateTime      @default(now())
  album     Album         @relation(fields: [albumId], references: [id], onDelete: Cascade)
  image     EnhancedImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@unique([albumId, imageId])
  @@index([albumId, sortOrder])
  @@index([imageId])
  @@index([albumId, addedAt])
  @@map("album_images")
}

model Voucher {
  id          String              @id @default(cuid())
  code        String              @unique
  type        VoucherType
  value       Int
  maxUses     Int?
  currentUses Int                 @default(0)
  expiresAt   DateTime?
  status      VoucherStatus       @default(ACTIVE)
  metadata    Json?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  redemptions VoucherRedemption[]

  @@index([code])
  @@index([status, expiresAt])
  @@map("vouchers")
}

model VoucherRedemption {
  id            String   @id @default(cuid())
  voucherId     String
  userId        String
  tokensGranted Int
  redeemedAt    DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  voucher       Voucher  @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  @@unique([voucherId, userId])
  @@index([userId, redeemedAt])
  @@index([voucherId])
  @@map("voucher_redemptions")
}

model Referral {
  id            String         @id @default(cuid())
  referrerId    String
  refereeId     String
  status        ReferralStatus @default(PENDING)
  tokensGranted Int            @default(0)
  ipAddress     String?
  createdAt     DateTime       @default(now())
  completedAt   DateTime?
  referee       User           @relation("RefereeReferrals", fields: [refereeId], references: [id], onDelete: Cascade)
  referrer      User           @relation("ReferrerReferrals", fields: [referrerId], references: [id], onDelete: Cascade)

  @@unique([referrerId, refereeId])
  @@index([referrerId, status])
  @@index([refereeId])
  @@index([status, createdAt])
  @@map("referrals")
}

model AuditLog {
  id        String      @id @default(cuid())
  userId    String
  action    AuditAction
  targetId  String?
  metadata  Json?
  ipAddress String?
  createdAt DateTime    @default(now())
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([targetId])
  @@index([createdAt])
  @@map("audit_logs")
}

// Error logging for tryCatch blocks across frontend and backend
model ErrorLog {
  id           String           @id @default(cuid())
  timestamp    DateTime         @default(now())
  message      String
  stack        String?
  sourceFile   String?
  sourceLine   Int?
  sourceColumn Int?
  callerName   String?
  userId       String?
  route        String?
  environment  ErrorEnvironment
  errorType    String?
  errorCode    String?
  metadata     Json?

  @@index([timestamp])
  @@index([sourceFile])
  @@index([errorType])
  @@index([environment])
  @@map("error_logs")
}

model Feedback {
  id        String         @id @default(cuid())
  userId    String?
  email     String?
  type      FeedbackType
  message   String
  page      String
  userAgent String?
  status    FeedbackStatus @default(NEW)
  adminNote String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("feedback")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum MarketingPlatform {
  FACEBOOK
  GOOGLE_ADS
}

enum AppStatus {
  DRAFT
  ACTIVE
  ARCHIVED
  DELETED
}

enum RequirementPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RequirementStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
}

enum MonetizationType {
  FREE
  ONE_TIME
  SUBSCRIPTION
  FREEMIUM
  USAGE_BASED
}

enum SubscriptionInterval {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum VoucherType {
  FIXED_TOKENS
  PERCENTAGE_BONUS
  SUBSCRIPTION_TRIAL
}

enum VoucherStatus {
  ACTIVE
  INACTIVE
  EXPIRED
  DEPLETED
}

enum TokenTransactionType {
  EARN_REGENERATION
  EARN_PURCHASE
  EARN_BONUS
  SPEND_ENHANCEMENT
  SPEND_MCP_GENERATION
  SPEND_BOX_CREATION
  REFUND
}

enum McpJobType {
  GENERATE
  MODIFY
}

enum StripePaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum EnhancementTier {
  FREE
  TIER_1K
  TIER_2K
  TIER_4K
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PipelineStage {
  ANALYZING // Image analysis with vision model
  CROPPING // Auto-crop based on analysis
  PROMPTING // Build dynamic enhancement prompt
  GENERATING // Gemini API image generation
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
  TRIALING
}

enum AlbumPrivacy {
  PRIVATE
  UNLISTED
  PUBLIC
}

enum ReferralStatus {
  PENDING
  COMPLETED
  INVALID
}

enum AuditAction {
  ROLE_CHANGE
  TOKEN_ADJUSTMENT
  VOUCHER_CREATE
  VOUCHER_UPDATE
  VOUCHER_DELETE
  USER_DELETE
  ADMIN_LOGIN
}

enum FeedbackType {
  BUG
  IDEA
  OTHER
}

enum FeedbackStatus {
  NEW
  REVIEWED
  RESOLVED
  DISMISSED
}

enum ErrorEnvironment {
  FRONTEND
  BACKEND
}

enum GalleryCategory {
  PORTRAIT
  LANDSCAPE
  PRODUCT
  ARCHITECTURE
}

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
}

enum BoxStatus {
  CREATING
  STARTING
  RUNNING
  PAUSED
  STOPPING
  STOPPED
  TERMINATED
  ERROR
}

enum BoxActionType {
  CREATE
  START
  STOP
  RESTART
  DELETE
  CLONE
}

model FeaturedGalleryItem {
  id            String          @id @default(cuid())
  title         String
  description   String?
  category      GalleryCategory @default(PORTRAIT)
  originalUrl   String
  enhancedUrl   String
  width         Int             @default(16)
  height        Int             @default(9)
  sourceImageId String?
  sourceJobId   String?
  sortOrder     Int             @default(0)
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  createdBy     String

  sourceImage EnhancedImage?       @relation(fields: [sourceImageId], references: [id], onDelete: SetNull)
  sourceJob   ImageEnhancementJob? @relation(fields: [sourceJobId], references: [id], onDelete: SetNull)
  creator     User                 @relation("GalleryItemCreator", fields: [createdBy], references: [id])

  @@index([isActive, sortOrder])
  @@index([isActive, category, sortOrder])
  @@map("featured_gallery_items")
}

// Browser Agent Service Models

model BoxTier {
  id            String   @id @default(cuid())
  name          String // e.g. "Standard", "Pro", "Ultra"
  description   String?
  cpu           Int // vCPU count
  ram           Int // RAM in MB
  storage       Int // Storage in GB
  pricePerHour  Int // Token cost per hour
  pricePerMonth Int // Token cost per month (if subscription)
  isActive      Boolean  @default(true)
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  boxes         Box[]

  @@map("box_tiers")
}

model Box {
  id              String    @id @default(cuid())
  name            String
  description     String?
  userId          String
  tierId          String?
  status          BoxStatus @default(STOPPED)
  connectionUrl   String? // URL to access the VNC/NoVNC interface
  storageVolumeId String? // ID of the persistent storage volume (R2/S3)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  tier     BoxTier?     @relation(fields: [tierId], references: [id])
  actions  BoxAction[]
  tasks    AgentTask[]
  messages BoxMessage[]

  @@index([userId, createdAt])
  @@index([status])
  @@map("boxes")
}

model BoxAction {
  id        String        @id @default(cuid())
  boxId     String
  action    BoxActionType
  status    JobStatus     @default(PENDING)
  metadata  Json?
  error     String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  box Box @relation(fields: [boxId], references: [id], onDelete: Cascade)

  @@index([boxId, createdAt])
  @@map("box_actions")
}

model AgentTask {
  id        String    @id @default(cuid())
  boxId     String
  type      String // e.g. "NAVIGATE", "CLICK", "TYPE"
  payload   Json? // e.g. { url: "https://google.com" }
  status    JobStatus @default(PENDING)
  result    Json?
  error     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  box Box @relation(fields: [boxId], references: [id], onDelete: Cascade)

  @@index([boxId, status])
  @@map("agent_tasks")
}

model EmailLog {
  id        String      @id @default(cuid())
  userId    String
  to        String
  subject   String
  template  String
  status    EmailStatus @default(SENT)
  resendId  String?     @unique
  sentAt    DateTime    @default(now())
  openedAt  DateTime?
  clickedAt DateTime?
  bouncedAt DateTime?
  metadata  Json?
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([sentAt])
  @@index([template])
  @@map("email_logs")
}

model TrackedUrl {
  id          String   @id @default(cuid())
  path        String   @unique // Store path only (e.g., "/custom-page"), not full URL
  label       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@map("tracked_urls")
}

// MCP Asset Generator Models

model ApiKey {
  id                String             @id @default(cuid())
  userId            String
  name              String
  keyHash           String             @unique
  keyPrefix         String
  lastUsedAt        DateTime?
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  mcpGenerationJobs McpGenerationJob[]

  @@index([userId, isActive])
  @@index([keyHash])
  @@map("api_keys")
}

model McpGenerationJob {
  id                    String          @id @default(cuid())
  userId                String
  apiKeyId              String?
  type                  McpJobType
  tier                  EnhancementTier
  tokensCost            Int
  status                JobStatus
  prompt                String
  inputImageUrl         String?
  inputImageR2Key       String?
  outputImageUrl        String?
  outputImageR2Key      String?
  outputWidth           Int?
  outputHeight          Int?
  outputSizeBytes       Int?
  errorMessage          String?
  geminiModel           String?
  processingStartedAt   DateTime?
  processingCompletedAt DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  apiKey ApiKey? @relation(fields: [apiKeyId], references: [id], onDelete: SetNull)

  @@index([userId, status, createdAt])
  @@index([apiKeyId])
  @@index([status, updatedAt])
  @@map("mcp_generation_jobs")
}

model BoxMessage {
  id        String         @id @default(cuid())
  boxId     String
  role      BoxMessageRole
  content   String
  createdAt DateTime       @default(now())
  box       Box            @relation(fields: [boxId], references: [id], onDelete: Cascade)

  @@index([boxId, createdAt])
  @@map("box_messages")
}

enum BoxMessageRole {
  USER
  AGENT
  SYSTEM
}

enum PipelineVisibility {
  PRIVATE // Only owner can use
  PUBLIC // Anyone can use/fork
  LINK // Accessible via shareToken
}

// Pipeline Configuration System
// Stores reusable AI enhancement pipeline configurations

model EnhancementPipeline {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Ownership (null = system default)
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Sharing
  visibility PipelineVisibility @default(PRIVATE)
  shareToken String?            @unique // For link-based sharing

  // Pipeline Configuration (includes tier)
  tier EnhancementTier @default(TIER_1K)

  // Stage Configs (JSON)
  analysisConfig   Json? // Analysis stage settings
  autoCropConfig   Json? // Auto-crop behavior
  promptConfig     Json? // Dynamic prompt generation
  generationConfig Json? // Gemini generation settings

  // Usage tracking
  usageCount Int @default(0)

  // Relations
  albums Album[]
  jobs   ImageEnhancementJob[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([visibility])
  @@map("enhancement_pipelines")
}

// =============================================================================
// Campaign Analytics Models
// =============================================================================

// Visitor session tracking with UTM parameters for campaign attribution
model VisitorSession {
  id           String    @id @default(cuid())
  visitorId    String // Anonymous fingerprint/cookie ID
  userId       String? // Linked user ID after signup/login
  sessionStart DateTime  @default(now())
  sessionEnd   DateTime?

  // Device & Browser info
  deviceType String? // mobile, tablet, desktop
  browser    String?
  os         String?

  // Geo info (anonymized)
  ipCountry String? // ISO 2-letter country code
  ipCity    String?

  // Traffic source
  referrer      String? // Full referrer URL
  landingPage   String // First page of session
  exitPage      String? // Last page of session
  pageViewCount Int     @default(0)

  // UTM parameters for campaign attribution
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?

  // Platform click IDs for direct attribution
  gclid  String? // Google Click ID
  fbclid String? // Facebook Click ID

  // Relations
  user      User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  pageViews PageView[]
  events    AnalyticsEvent[]

  @@index([visitorId])
  @@index([userId])
  @@index([utmCampaign])
  @@index([utmSource])
  @@index([sessionStart])
  @@index([gclid])
  @@index([fbclid])
  @@map("visitor_sessions")
}

// Individual page view tracking
model PageView {
  id          String   @id @default(cuid())
  sessionId   String
  path        String
  title       String?
  timestamp   DateTime @default(now())
  timeOnPage  Int? // Seconds spent on page
  scrollDepth Int? // Percentage scrolled (0-100)

  session VisitorSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, timestamp])
  @@index([path])
  @@map("page_views")
}

// Custom event tracking for user behavior
model AnalyticsEvent {
  id        String   @id @default(cuid())
  sessionId String
  name      String // e.g., "signup_started", "enhancement_completed"
  category  String? // e.g., "conversion", "engagement"
  value     Float? // Numeric value (e.g., token amount, revenue)
  metadata  Json? // Additional event data
  timestamp DateTime @default(now())

  session VisitorSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, timestamp])
  @@index([name])
  @@index([category])
  @@map("analytics_events")
}

// Campaign attribution linking users to campaigns
model CampaignAttribution {
  id        String @id @default(cuid())
  userId    String
  sessionId String

  // Attribution model
  attributionType AttributionType

  // Campaign identifiers
  platform           String? // "FACEBOOK", "GOOGLE_ADS", "ORGANIC", "DIRECT", etc.
  externalCampaignId String? // Campaign ID from FB/Google for ROI matching
  utmCampaign        String?
  utmSource          String?
  utmMedium          String?

  // Conversion data
  conversionType  ConversionType
  conversionValue Float? // Token/revenue value
  convertedAt     DateTime       @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([utmCampaign])
  @@index([externalCampaignId])
  @@index([convertedAt])
  @@index([conversionType])
  @@index([attributionType])
  @@map("campaign_attributions")
}

// Cached campaign metrics for dashboard performance
model CampaignMetricsCache {
  id         String   @id @default(cuid())
  cacheKey   String   @unique // e.g., "overview:2024-01-01:2024-01-31:first_touch"
  metrics    Json // Cached metrics data
  computedAt DateTime @default(now())
  expiresAt  DateTime

  @@index([cacheKey])
  @@index([expiresAt])
  @@map("campaign_metrics_cache")
}

// Campaign link for connecting UTM campaigns to external platform campaign IDs
model CampaignLink {
  id                   String   @id @default(cuid())
  utmCampaign          String
  platform             String // "FACEBOOK" | "GOOGLE_ADS"
  externalCampaignId   String
  externalCampaignName String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@unique([utmCampaign, platform])
  @@index([platform])
  @@index([externalCampaignId])
  @@map("campaign_links")
}

// =============================================================================
// Audio Mixer Models
// =============================================================================

model AudioMixerProject {
  id          String       @id @default(cuid())
  userId      String
  name        String
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  tracks      AudioTrack[]

  @@index([userId, createdAt])
  @@map("audio_mixer_projects")
}

model AudioTrack {
  id            String            @id @default(cuid())
  projectId     String
  name          String
  fileUrl       String? // R2 public URL
  fileR2Key     String? // R2 key for server operations
  fileFormat    String // wav, mp3, webm, etc.
  duration      Float // seconds
  fileSizeBytes Int
  volume        Float             @default(1.0)
  muted         Boolean           @default(false)
  solo          Boolean           @default(false)
  sortOrder     Int               @default(0)
  storageType   AudioStorageType  @default(R2)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  project       AudioMixerProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, sortOrder])
  @@map("audio_tracks")
}

enum AudioStorageType {
  R2
  OPFS
}

// Enums for Campaign Analytics
enum AttributionType {
  FIRST_TOUCH
  LAST_TOUCH
}

enum ConversionType {
  SIGNUP
  ENHANCEMENT
  PURCHASE
}

// =============================================================================
// Merch / Print-on-Demand Models
// =============================================================================

enum PodProvider {
  PRODIGI
  PRINTFUL
}

enum MerchOrderStatus {
  PENDING // Created, awaiting payment
  PAYMENT_PENDING // Payment authorized, awaiting capture
  PAID // Payment captured
  SUBMITTED // Sent to POD provider
  IN_PRODUCTION // Being manufactured
  SHIPPED // In transit
  DELIVERED // Delivered
  CANCELLED // Cancelled
  REFUNDED // Fully refunded
}

enum ShipmentStatus {
  PENDING
  PROCESSING
  SHIPPED
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED
}

// Product Catalog
model MerchCategory {
  id          String         @id @default(cuid())
  name        String         @unique
  slug        String         @unique
  description String?
  icon        String?
  sortOrder   Int            @default(0)
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  products    MerchProduct[]

  @@index([isActive, sortOrder])
  @@map("merch_categories")
}

model MerchProduct {
  id              String      @id @default(cuid())
  name            String
  description     String?
  categoryId      String
  provider        PodProvider
  providerSku     String // External SKU from POD provider
  basePrice       Decimal     @db.Decimal(10, 2) // Cost from provider
  retailPrice     Decimal     @db.Decimal(10, 2) // Selling price
  currency        String      @default("GBP")
  isActive        Boolean     @default(true)
  minDpi          Int         @default(150)
  minWidth        Int         @default(1800)
  minHeight       Int         @default(1800)
  printAreaWidth  Int? // Print area in pixels
  printAreaHeight Int?
  mockupTemplate  String? // URL to mockup overlay image
  sortOrder       Int         @default(0)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  category   MerchCategory    @relation(fields: [categoryId], references: [id])
  variants   MerchVariant[]
  cartItems  MerchCartItem[]
  orderItems MerchOrderItem[]

  @@index([categoryId, isActive])
  @@index([provider, providerSku])
  @@index([isActive, sortOrder])
  @@map("merch_products")
}

model MerchVariant {
  id          String   @id @default(cuid())
  productId   String
  name        String // "30x40cm", "Large", "Black", etc.
  providerSku String // Provider-specific SKU for this variant
  priceDelta  Decimal  @default(0) @db.Decimal(10, 2) // Price adjustment from base
  isActive    Boolean  @default(true)
  attributes  Json? // { size: "30x40", color: "black" }
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  product    MerchProduct     @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems  MerchCartItem[]
  orderItems MerchOrderItem[]

  @@index([productId, isActive])
  @@map("merch_variants")
}

// Shopping Cart
model MerchCart {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  items MerchCartItem[]

  @@map("merch_carts")
}

model MerchCartItem {
  id                 String   @id @default(cuid())
  cartId             String
  productId          String
  variantId          String?
  // Image source: ONE of these must be set
  imageId            String? // EnhancedImage reference (if using existing)
  uploadedImageR2Key String? // R2 key (if direct upload)
  uploadedImageUrl   String? // Public URL for direct uploads
  quantity           Int      @default(1)
  customText         String? // Optional personalization text
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  cart    MerchCart      @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product MerchProduct   @relation(fields: [productId], references: [id])
  variant MerchVariant?  @relation(fields: [variantId], references: [id])
  image   EnhancedImage? @relation(fields: [imageId], references: [id])

  @@unique([cartId, productId, variantId, imageId, uploadedImageR2Key])
  @@index([cartId])
  @@index([productId])
  @@map("merch_cart_items")
}

// Orders
model MerchOrder {
  id                    String           @id @default(cuid())
  userId                String
  orderNumber           String           @unique // Human-readable order number
  status                MerchOrderStatus @default(PENDING)
  subtotal              Decimal          @db.Decimal(10, 2)
  shippingCost          Decimal          @db.Decimal(10, 2)
  taxAmount             Decimal          @default(0) @db.Decimal(10, 2)
  totalAmount           Decimal          @db.Decimal(10, 2)
  currency              String           @default("GBP")
  stripePaymentIntentId String?          @unique
  stripePaymentStatus   String? // authorized, captured, cancelled
  shippingAddress       Json // { name, line1, line2, city, postalCode, country }
  billingAddress        Json?
  customerEmail         String
  customerPhone         String?
  notes                 String?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  paidAt                DateTime?

  user      User              @relation(fields: [userId], references: [id])
  items     MerchOrderItem[]
  shipments MerchShipment[]
  events    MerchOrderEvent[]

  @@index([userId, createdAt])
  @@index([status])
  @@index([orderNumber])
  @@index([stripePaymentIntentId])
  @@map("merch_orders")
}

model MerchOrderItem {
  id          String   @id @default(cuid())
  orderId     String
  productId   String
  variantId   String?
  productName String // Snapshot at order time
  variantName String?
  imageUrl    String // Snapshot of image URL for display
  imageR2Key  String // R2 key for reprints and POD submission
  quantity    Int
  unitPrice   Decimal  @db.Decimal(10, 2)
  totalPrice  Decimal  @db.Decimal(10, 2)
  customText  String?
  podOrderId  String? // Provider order ID
  podStatus   String? // Provider-specific status
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  order      MerchOrder     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product    MerchProduct   @relation(fields: [productId], references: [id])
  variant    MerchVariant?  @relation(fields: [variantId], references: [id])
  shipment   MerchShipment? @relation(fields: [shipmentId], references: [id])
  shipmentId String?

  @@index([orderId])
  @@index([podOrderId])
  @@map("merch_order_items")
}

model MerchShipment {
  id             String         @id @default(cuid())
  orderId        String
  provider       PodProvider
  providerShipId String? // Shipment ID from provider
  carrier        String? // FedEx, UPS, Royal Mail, etc.
  trackingNumber String?
  trackingUrl    String?
  status         ShipmentStatus @default(PENDING)
  shippedAt      DateTime?
  deliveredAt    DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  order MerchOrder       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  items MerchOrderItem[]

  @@index([orderId])
  @@index([trackingNumber])
  @@map("merch_shipments")
}

model MerchOrderEvent {
  id        String   @id @default(cuid())
  orderId   String
  type      String // ORDER_CREATED, PAYMENT_AUTHORIZED, PAYMENT_CAPTURED, SUBMITTED_TO_POD, etc.
  data      Json? // Event-specific data
  createdAt DateTime @default(now())

  order MerchOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, createdAt])
  @@map("merch_order_events")
}

// Webhook event deduplication
model MerchWebhookEvent {
  id          String    @id @default(cuid())
  provider    String // STRIPE, PRODIGI, PRINTFUL
  eventId     String    @unique // External event ID for deduplication
  eventType   String
  processed   Boolean   @default(false)
  payload     Json
  processedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([provider, eventType])
  @@index([processed, createdAt])
  @@map("merch_webhook_events")
}
