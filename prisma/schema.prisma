generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String                @id @default(cuid())
  name               String?
  email              String?               @unique
  emailVerified      DateTime?
  image              String?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  stripeCustomerId   String?               @unique
  role               UserRole              @default(USER)
  referralCode       String?               @unique
  referredById       String?
  referralCount      Int                   @default(0)
  passwordHash       String?
  accounts           Account[]
  albums             Album[]
  apps               App[]
  auditLogs          AuditLog[]
  enhancedImages     EnhancedImage[]
  enhancementJobs    ImageEnhancementJob[]
  refereeReferrals   Referral[]            @relation("RefereeReferrals")
  referrerReferrals  Referral[]            @relation("ReferrerReferrals")
  sessions           Session[]
  stripePayments     StripePayment[]
  subscription       Subscription?
  tokenTransactions  TokenTransaction[]
  tokenBalance       UserTokenBalance?
  referredBy         User?                 @relation("Referrals", fields: [referredById], references: [id])
  referrals          User[]                @relation("Referrals")
  voucherRedemptions VoucherRedemption[]
  feedback           Feedback[]
  createdGalleryItems FeaturedGalleryItem[] @relation("GalleryItemCreator")
  emailLogs          EmailLog[]
  trackedUrls        TrackedUrl[]
  apiKeys            ApiKey[]
  mcpGenerationJobs  McpGenerationJob[]
  boxes              Box[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model App {
  id                 String              @id @default(cuid())
  name               String
  description        String?
  userId             String
  forkedFrom         String?
  status             AppStatus           @default(DRAFT)
  domain             String?             @unique
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  parentApp          App?                @relation("AppForks", fields: [forkedFrom], references: [id])
  forks              App[]               @relation("AppForks")
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  monetizationModels MonetizationModel[]
  requirements       Requirement[]

  @@index([userId])
  @@index([forkedFrom])
  @@index([status])
  @@map("apps")
}

model Requirement {
  id          String              @id @default(cuid())
  appId       String
  description String
  priority    RequirementPriority @default(MEDIUM)
  status      RequirementStatus   @default(PENDING)
  version     Int                 @default(1)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  app         App                 @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([status])
  @@index([priority])
  @@map("requirements")
}

model MonetizationModel {
  id                   String                @id @default(cuid())
  appId                String
  type                 MonetizationType      @default(FREE)
  price                Decimal?              @db.Decimal(10, 2)
  subscriptionInterval SubscriptionInterval?
  features             String[]
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  app                  App                   @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([type])
  @@map("monetization_models")
}

model UserTokenBalance {
  id               String   @id @default(cuid())
  userId           String   @unique
  balance          Int      @default(0)
  lastRegeneration DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_token_balances")
}

model TokenTransaction {
  id           String               @id @default(cuid())
  userId       String
  amount       Int
  type         TokenTransactionType
  source       String?
  sourceId     String?
  balanceAfter Int
  metadata     Json?
  createdAt    DateTime             @default(now())
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([sourceId])
  @@map("token_transactions")
}

model TokensPackage {
  id             String          @id @default(cuid())
  name           String
  tokens         Int
  priceUSD       Decimal         @db.Decimal(10, 2)
  stripePriceId  String          @unique
  active         Boolean         @default(true)
  sortOrder      Int             @default(0)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  stripePayments StripePayment[]

  @@index([active, sortOrder])
  @@map("tokens_packages")
}

model StripePayment {
  id                    String              @id @default(cuid())
  userId                String
  packageId             String
  tokensGranted         Int
  amountUSD             Decimal             @db.Decimal(10, 2)
  stripePaymentIntentId String              @unique
  status                StripePaymentStatus
  metadata              Json?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  package               TokensPackage       @relation(fields: [packageId], references: [id])
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([stripePaymentIntentId])
  @@map("stripe_payments")
}

model EnhancedImage {
  id                String                @id @default(cuid())
  userId            String
  name              String
  description       String?
  originalUrl       String
  originalR2Key     String
  originalWidth     Int
  originalHeight    Int
  originalSizeBytes Int
  originalFormat    String
  isPublic          Boolean               @default(false)
  viewCount         Int                   @default(0)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  shareToken        String?               @unique
  albumImages       AlbumImage[]
  user              User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  enhancementJobs   ImageEnhancementJob[]
  featuredGalleryItems FeaturedGalleryItem[]

  @@index([userId, createdAt])
  @@index([isPublic, createdAt])
  @@index([shareToken])
  @@map("enhanced_images")
}

model ImageEnhancementJob {
  id                    String          @id @default(cuid())
  imageId               String
  userId                String
  tier                  EnhancementTier
  tokensCost            Int
  status                JobStatus
  enhancedUrl           String?
  enhancedR2Key         String?
  enhancedWidth         Int?
  enhancedHeight        Int?
  enhancedSizeBytes     Int?
  errorMessage          String?
  retryCount            Int             @default(0)
  maxRetries            Int             @default(3)
  geminiPrompt          String?
  geminiModel           String?
  geminiTemp            Float?
  processingStartedAt   DateTime?
  processingCompletedAt DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  workflowRunId         String?
  image                 EnhancedImage   @relation(fields: [imageId], references: [id], onDelete: Cascade)
  user                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  featuredGalleryItems FeaturedGalleryItem[]

  @@index([userId, status, createdAt])
  @@index([imageId])
  @@index([status, updatedAt])
  @@index([workflowRunId])
  @@map("image_enhancement_jobs")
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  stripeSubscriptionId String             @unique
  stripePriceId        String
  status               SubscriptionStatus
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  tokensPerMonth       Int
  rolloverTokens       Int                @default(0)
  maxRollover          Int                @default(0)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeSubscriptionId])
  @@index([status])
  @@map("subscriptions")
}

model SubscriptionPlan {
  id             String   @id @default(cuid())
  name           String
  tokensPerMonth Int
  priceGBP       Decimal  @db.Decimal(10, 2)
  stripePriceId  String   @unique
  maxRollover    Int      @default(0)
  priority       Boolean  @default(false)
  apiAccess      Boolean  @default(false)
  active         Boolean  @default(true)
  sortOrder      Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([active, sortOrder])
  @@map("subscription_plans")
}

model Album {
  id           String       @id @default(cuid())
  userId       String
  name         String
  description  String?
  coverImageId String?
  privacy      AlbumPrivacy @default(PRIVATE)
  shareToken   String?      @unique
  sortOrder    Int          @default(0)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  albumImages  AlbumImage[]
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([privacy])
  @@index([shareToken])
  @@map("albums")
}

model AlbumImage {
  id        String        @id @default(cuid())
  albumId   String
  imageId   String
  sortOrder Int           @default(0)
  addedAt   DateTime      @default(now())
  album     Album         @relation(fields: [albumId], references: [id], onDelete: Cascade)
  image     EnhancedImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@unique([albumId, imageId])
  @@index([albumId, sortOrder])
  @@index([imageId])
  @@index([albumId, addedAt])
  @@map("album_images")
}

model Voucher {
  id          String              @id @default(cuid())
  code        String              @unique
  type        VoucherType
  value       Int
  maxUses     Int?
  currentUses Int                 @default(0)
  expiresAt   DateTime?
  status      VoucherStatus       @default(ACTIVE)
  metadata    Json?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  redemptions VoucherRedemption[]

  @@index([code])
  @@index([status, expiresAt])
  @@map("vouchers")
}

model VoucherRedemption {
  id            String   @id @default(cuid())
  voucherId     String
  userId        String
  tokensGranted Int
  redeemedAt    DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  voucher       Voucher  @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  @@unique([voucherId, userId])
  @@index([userId, redeemedAt])
  @@index([voucherId])
  @@map("voucher_redemptions")
}

model Referral {
  id            String         @id @default(cuid())
  referrerId    String
  refereeId     String
  status        ReferralStatus @default(PENDING)
  tokensGranted Int            @default(0)
  ipAddress     String?
  createdAt     DateTime       @default(now())
  completedAt   DateTime?
  referee       User           @relation("RefereeReferrals", fields: [refereeId], references: [id], onDelete: Cascade)
  referrer      User           @relation("ReferrerReferrals", fields: [referrerId], references: [id], onDelete: Cascade)

  @@unique([referrerId, refereeId])
  @@index([referrerId, status])
  @@index([refereeId])
  @@index([status, createdAt])
  @@map("referrals")
}

model AuditLog {
  id        String      @id @default(cuid())
  userId    String
  action    AuditAction
  targetId  String?
  metadata  Json?
  ipAddress String?
  createdAt DateTime    @default(now())
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([targetId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Feedback {
  id        String         @id @default(cuid())
  userId    String?
  email     String?
  type      FeedbackType
  message   String
  page      String
  userAgent String?
  status    FeedbackStatus @default(NEW)
  adminNote String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("feedback")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum AppStatus {
  DRAFT
  ACTIVE
  ARCHIVED
  DELETED
}

enum RequirementPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RequirementStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
}

enum MonetizationType {
  FREE
  ONE_TIME
  SUBSCRIPTION
  FREEMIUM
  USAGE_BASED
}

enum SubscriptionInterval {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum VoucherType {
  FIXED_TOKENS
  PERCENTAGE_BONUS
  SUBSCRIPTION_TRIAL
}

enum VoucherStatus {
  ACTIVE
  INACTIVE
  EXPIRED
  DEPLETED
}

enum TokenTransactionType {
  EARN_REGENERATION
  EARN_PURCHASE
  EARN_BONUS
  SPEND_ENHANCEMENT
  SPEND_MCP_GENERATION
  REFUND
}

enum McpJobType {
  GENERATE
  MODIFY
}

enum StripePaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum EnhancementTier {
  TIER_1K
  TIER_2K
  TIER_4K
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
  TRIALING
}

enum AlbumPrivacy {
  PRIVATE
  UNLISTED
  PUBLIC
}

enum ReferralStatus {
  PENDING
  COMPLETED
  INVALID
}

enum AuditAction {
  ROLE_CHANGE
  TOKEN_ADJUSTMENT
  VOUCHER_CREATE
  VOUCHER_UPDATE
  VOUCHER_DELETE
  USER_DELETE
  ADMIN_LOGIN
}

enum FeedbackType {
  BUG
  IDEA
  OTHER
}

enum FeedbackStatus {
  NEW
  REVIEWED
  RESOLVED
  DISMISSED
}

enum GalleryCategory {
  PORTRAIT
  LANDSCAPE
  PRODUCT
  ARCHITECTURE
}

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
}

enum BoxStatus {
  CREATING
  STARTING
  RUNNING
  STOPPING
  STOPPED
  TERMINATED
  ERROR
}

enum BoxActionType {
  CREATE
  START
  STOP
  RESTART
  DELETE
  CLONE
}

model FeaturedGalleryItem {
  id            String          @id @default(cuid())
  title         String
  description   String?
  category      GalleryCategory @default(PORTRAIT)
  originalUrl   String
  enhancedUrl   String
  width         Int             @default(16)
  height        Int             @default(9)
  sourceImageId String?
  sourceJobId   String?
  sortOrder     Int             @default(0)
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  createdBy     String

  sourceImage EnhancedImage?       @relation(fields: [sourceImageId], references: [id], onDelete: SetNull)
  sourceJob   ImageEnhancementJob? @relation(fields: [sourceJobId], references: [id], onDelete: SetNull)
  creator     User                 @relation("GalleryItemCreator", fields: [createdBy], references: [id])

  @@index([isActive, sortOrder])
  @@index([isActive, category, sortOrder])
  @@map("featured_gallery_items")
}

// Browser Agent Service Models

model BoxTier {
  id             String   @id @default(cuid())
  name           String   // e.g. "Standard", "Pro", "Ultra"
  description    String?
  cpu            Int      // vCPU count
  ram            Int      // RAM in MB
  storage        Int      // Storage in GB
  pricePerHour   Int      // Token cost per hour
  pricePerMonth  Int      // Token cost per month (if subscription)
  isActive       Boolean  @default(true)
  sortOrder      Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  boxes          Box[]

  @@map("box_tiers")
}

model Box {
  id              String      @id @default(cuid())
  name            String
  userId          String
  tierId          String
  status          BoxStatus   @default(STOPPED)
  connectionUrl   String?     // URL to access the VNC/NoVNC interface
  storageVolumeId String?     // ID of the persistent storage volume (R2/S3)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  tier            BoxTier     @relation(fields: [tierId], references: [id])
  actions         BoxAction[]
  tasks           AgentTask[]

  @@index([userId])
  @@index([status])
  @@map("boxes")
}

model BoxAction {
  id        String      @id @default(cuid())
  boxId     String
  action    BoxActionType
  status    JobStatus   @default(PENDING)
  metadata  Json?
  error     String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  box       Box         @relation(fields: [boxId], references: [id], onDelete: Cascade)

  @@index([boxId, createdAt])
  @@map("box_actions")
}

model AgentTask {
  id        String      @id @default(cuid())
  boxId     String
  type      String      // e.g. "NAVIGATE", "CLICK", "TYPE"
  payload   Json?       // e.g. { url: "https://google.com" }
  status    JobStatus   @default(PENDING)
  result    Json?
  error     String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  box       Box         @relation(fields: [boxId], references: [id], onDelete: Cascade)

  @@index([boxId, status])
  @@map("agent_tasks")
}

model EmailLog {
  id         String      @id @default(cuid())
  userId     String
  to         String
  subject    String
  template   String
  status     EmailStatus @default(SENT)
  resendId   String?     @unique
  sentAt     DateTime    @default(now())
  openedAt   DateTime?
  clickedAt  DateTime?
  bouncedAt  DateTime?
  metadata   Json?
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([sentAt])
  @@index([template])
  @@map("email_logs")
}

model TrackedUrl {
  id          String   @id @default(cuid())
  path        String   @unique  // Store path only (e.g., "/custom-page"), not full URL
  label       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@map("tracked_urls")
}

// MCP Asset Generator Models

model ApiKey {
  id                String             @id @default(cuid())
  userId            String
  name              String
  keyHash           String             @unique
  keyPrefix         String
  lastUsedAt        DateTime?
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  mcpGenerationJobs McpGenerationJob[]

  @@index([userId, isActive])
  @@index([keyHash])
  @@map("api_keys")
}

model McpGenerationJob {
  id                    String          @id @default(cuid())
  userId                String
  apiKeyId              String?
  type                  McpJobType
  tier                  EnhancementTier
  tokensCost            Int
  status                JobStatus
  prompt                String
  inputImageUrl         String?
  inputImageR2Key       String?
  outputImageUrl        String?
  outputImageR2Key      String?
  outputWidth           Int?
  outputHeight          Int?
  outputSizeBytes       Int?
  errorMessage          String?
  geminiModel           String?
  processingStartedAt   DateTime?
  processingCompletedAt DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  apiKey ApiKey? @relation(fields: [apiKeyId], references: [id], onDelete: SetNull)

  @@index([userId, status, createdAt])
  @@index([apiKeyId])
  @@index([status, updatedAt])
  @@map("mcp_generation_jobs")
}
