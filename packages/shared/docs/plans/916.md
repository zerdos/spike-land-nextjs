# Implementation Plan: Issue #916

**Issue**: Bug: Vercel production deployment failed (dpl_66JopoBuUetKw7n6kxAuiXuq9vss)
**Priority**: P0 - BLOCKING
**Created**: 2026-01-29

## Summary

Vercel production deployment is failing due to a TypeScript build error. The investigation revealed that the actual error is a Prisma model name casing issue in `src/app/api/apps/route.ts:409`, not the TransitionFlow.tsx import issue mentioned in the related issue #914.

## Root Cause Analysis

The build fails with the following error:

```
./src/app/api/apps/route.ts:409:20
Type error: Property 'workspaceApp' does not exist on type 'Omit<PrismaClient...>'. Did you mean 'workspace'?

  409 |           await tx.workspaceApp.create({
      |                    ^
```

**Actual Problem**: The code uses `tx.workspaceApp` but Prisma models use PascalCase (`WorkspaceApp`), not camelCase.

**Good News**: This has **already been fixed** in the local codebase (uncommitted change shows `tx.WorkspaceApp.create()`), but the fix hasn't been pushed to production yet.

## Investigation Results

### 1. TransitionFlow.tsx Import (Issue #914)

- **Status**: ✅ Actually working correctly
- **Import**: `import type { PlatformTransition } from "@spike-npm-land/shared/types"`
- **Verification**:
  - Type exists in `packages/shared/src/types/attribution.ts:52`
  - Properly exported from `packages/shared/src/types/index.ts:389`
  - Available at subpath export `@spike-npm-land/shared/types`
  - Built correctly in `packages/shared/dist/types/index.d.ts`

### 2. Actual Build Error (Issue #916)

- **Status**: ⚠️ Fixed locally but not deployed
- **File**: `src/app/api/apps/route.ts:409`
- **Error**: Using `workspaceApp` instead of `WorkspaceApp`
- **Prisma Model**: Defined as `model WorkspaceApp` in `prisma/schema.prisma:2508`
- **Local Fix**: Already changed to `tx.WorkspaceApp.create()` (in git diff)

## Implementation Steps

### Step 1: Verify Current State ✅

- [x] Confirmed the fix exists locally in git diff
- [x] Verified Prisma schema uses `model WorkspaceApp`
- [x] Confirmed shared package builds correctly
- [x] Verified PlatformTransition type is properly exported

### Step 2: Stage and Commit the Fix

**File to commit**: `src/app/api/apps/route.ts`

The change is already present but unstaged:

```diff
-          await tx.workspaceApp.create({
+          await tx.WorkspaceApp.create({
```

**Verification needed**: Check if there are any other references to `workspaceApp` (camelCase) that need fixing.

### Step 3: Build Verification

After committing, verify the build succeeds:

```bash
# Build shared package first
cd packages/shared && yarn build

# Build Next.js app
cd ../.. && yarn build
```

Expected: ✅ Build should succeed without TypeScript errors

### Step 4: Deployment

1. Push the committed fix to `main` branch
2. Vercel will automatically trigger a new deployment
3. Monitor deployment status: `vercel ls`
4. Verify deployment succeeds
5. Test production aliases:
   - https://spike-land-nextjs-zoltan-erdos-projects.vercel.app
   - https://spike-land-nextjs-git-main-zoltan-erdos-projects.vercel.app

### Step 5: Smoke Testing

Once deployed, manually verify:

- [ ] Home page loads
- [ ] My Apps page loads
- [ ] App creation flow works
- [ ] No console errors
- [ ] Workspace app creation works (if applicable)

## Files to Modify

### 1. `src/app/api/apps/route.ts` (Line 409)

**Change**: Already fixed locally, needs to be committed

```typescript
// Before (incorrect - causes build error)
await tx.workspaceApp.create({

// After (correct - matches Prisma model)
await tx.WorkspaceApp.create({
```

**Why**: Prisma generates PascalCase model names from schema definitions

## Testing Considerations

### Unit Tests

- No unit tests need updating (this is a build fix, not a behavior change)
- The fix aligns code with Prisma's generated types

### Integration Tests

- Verify app creation still works after deployment
- Test workspace app linking functionality

### Type Safety

- TypeScript build must pass (currently fails)
- Prisma client types must match usage

## Potential Risks & Blockers

### Low Risk ✅

- **Risk**: Build may fail for other reasons
- **Mitigation**: Full build test locally before pushing
- **Likelihood**: Low - local build test should catch this

### No Risk ✅

- The fix is a simple rename matching Prisma conventions
- No runtime behavior changes
- No database schema changes needed
- No migration required

## Related Issues

- **#914**: "Bug: TypeScript build fails - Cannot find module '@spike-npm-land/shared/types'"
  - **Status**: False alarm - the import is actually correct
  - **Resolution**: Close as "not a bug" or "works as intended"
  - **Note**: The subpath export `@spike-npm-land/shared/types` is properly configured

- **#916**: This issue - actual build blocker
  - **Status**: Fix ready, needs deployment
  - **Resolution**: Commit and push the local fix

## Success Criteria

- [x] Identified root cause (Prisma model casing)
- [x] Verified fix exists locally
- [ ] Committed the fix
- [ ] Build succeeds locally
- [ ] Build succeeds in CI/CD
- [ ] Vercel deployment completes successfully
- [ ] Production site is accessible and functional
- [ ] Issue #916 closed as resolved

## Estimated Complexity

**Simple** ⚡

- Single-line change (already implemented)
- No schema changes
- No migrations
- No breaking changes
- Just needs to be committed and pushed

## Notes

### About Issue #914

The TransitionFlow.tsx import is **NOT** the problem. The error reported in #914 appears to be a false positive or from a different build context. The actual production build error is the `workspaceApp` casing issue in `route.ts`.

**Evidence**:

1. `PlatformTransition` type exists and is exported correctly
2. Package.json exports configuration includes `"./types"` subpath
3. Shared package builds successfully with types
4. The actual build error points to line 409 of `route.ts`, not TransitionFlow.tsx

### Additional Findings

There are 40+ modified issue files in git status, suggesting recent issue sync. The main branch is 45 commits ahead of origin, indicating local changes that need to be pushed.

## Follow-up Actions

After resolving this issue:

1. **Close #914**: Mark as "not a bug" - the import path is correct
2. **Verify CI/CD**: Ensure all checks pass on the new deployment
3. **Monitor Production**: Check for any runtime errors post-deployment
4. **Push commits**: The local branch is 45 commits ahead - these should be pushed

## Appendix: Build Output

### Error from `yarn next build`:

```
Running TypeScript ...
Failed to compile.

./src/app/api/apps/route.ts:409:20
Type error: Property 'workspaceApp' does not exist on type 'Omit<PrismaClient<PrismaClientOptions, never, DefaultArgs>, "$connect" | "$disconnect" | "$on" | "$transaction" | "$extends">'. Did you mean 'workspace'?

 407 |           }
 408 |
>409 |           await tx.workspaceApp.create({
     |                    ^
 410 |             data: {
 411 |               workspaceId: data.workspaceId,
 412 |               appId: app.id,
```

### Prisma Model (schema.prisma:2508):

```prisma
model WorkspaceApp {
  id             String   @id @default(cuid())
  workspaceId    String
  appId          String   @unique
  purpose        String?
  linkedCampaign String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  app       App       @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([appId])
  @@index([purpose])
  @@map("workspace_apps")
}
```
