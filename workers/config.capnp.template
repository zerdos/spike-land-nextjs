using Workerd = import "/workerd/workerd.capnp";

const config :Workerd.Config = (
  services = [
    # --- API Gateway: main entry point, routes to all other services ---
    ( name = "api-gateway",
      worker = (
        compatibilityDate = "2024-12-01",
        compatibilityFlags = ["nodejs_compat_v2"],
        modules = [
          (name = "worker", esModule = embed "services/api-gateway/index.js"),
        ],
        bindings = [
          (name = "COLLAB", service = "collab"),
          (name = "TRANSPILER", service = "transpiler"),
          (name = "STORAGE_PROXY", service = "storage-proxy"),
          (name = "AI_PROXY", service = "ai-proxy"),
          (name = "AUTH_WORKER", service = "auth-worker"),
        ],
        globalOutbound = "internet",
      )
    ),

    # --- Collab: real-time collaboration, WebSocket, session state ---
    ( name = "collab",
      worker = (
        compatibilityDate = "2024-12-01",
        compatibilityFlags = ["nodejs_compat_v2"],
        modules = [
          (name = "worker", esModule = embed "services/collab/index.js"),
        ],
        bindings = [
          (name = "REDIS_URL", text = "${REDIS_URL}"),
          (name = "REDIS_TOKEN", text = "${REDIS_TOKEN}"),
        ],
        globalOutbound = "internet",
      )
    ),

    # --- Transpiler: code transpilation service (esbuild-wasm) ---
    ( name = "transpiler",
      worker = (
        compatibilityDate = "2024-12-01",
        compatibilityFlags = ["nodejs_compat_v2"],
        modules = [
          (name = "worker", esModule = embed "services/transpiler/index.js"),
          (name = "esbuild-wasm-module", wasmModule = embed "services/transpiler/esbuild.wasm"),
        ],
        globalOutbound = "internet",
      )
    ),

    # --- Storage Proxy: KV/R2-style API backed by DynamoDB/S3 ---
    ( name = "storage-proxy",
      worker = (
        compatibilityDate = "2024-12-01",
        compatibilityFlags = ["nodejs_compat_v2"],
        modules = [
          (name = "worker", esModule = embed "services/storage-proxy/index.js"),
        ],
        bindings = [
          (name = "AWS_ACCESS_KEY_ID", text = "${AWS_ACCESS_KEY_ID}"),
          (name = "AWS_SECRET_ACCESS_KEY", text = "${AWS_SECRET_ACCESS_KEY}"),
          (name = "AWS_REGION", text = "${AWS_REGION}"),
          (name = "DYNAMODB_TABLE", text = "${DYNAMODB_TABLE}"),
          (name = "S3_BUCKET", text = "${S3_BUCKET}"),
          (name = "AWS_ENDPOINT_URL", text = "${AWS_ENDPOINT_URL}"),
        ],
        globalOutbound = "internet",
      )
    ),

    # --- AI Proxy: forwards requests to OpenAI, Anthropic, Replicate ---
    ( name = "ai-proxy",
      worker = (
        compatibilityDate = "2024-12-01",
        compatibilityFlags = ["nodejs_compat_v2"],
        modules = [
          (name = "worker", esModule = embed "services/ai-proxy/index.js"),
        ],
        bindings = [
          (name = "OPENAI_API_KEY", text = "${OPENAI_API_KEY}"),
          (name = "ANTHROPIC_API_KEY", text = "${ANTHROPIC_API_KEY}"),
          (name = "REPLICATE_API_TOKEN", text = "${REPLICATE_API_TOKEN}"),
        ],
        globalOutbound = "internet",
      )
    ),

    # --- Auth Worker: JWT validation and session management ---
    ( name = "auth-worker",
      worker = (
        compatibilityDate = "2024-12-01",
        compatibilityFlags = ["nodejs_compat_v2"],
        modules = [
          (name = "worker", esModule = embed "services/auth-worker/index.js"),
        ],
        bindings = [
          (name = "JWT_SECRET", text = "${JWT_SECRET}"),
          (name = "AUTH_ISSUER", text = "${AUTH_ISSUER}"),
        ],
        globalOutbound = "internet",
      )
    ),

    # --- Internet: outbound network access ---
    ( name = "internet",
      network = (
        allow = ["public"],
        tlsOptions = (trustBrowserCas = true),
      )
    ),
  ],

  sockets = [
    ( name = "http",
      address = "*:8080",
      http = (),
      service = "api-gateway",
    ),
  ],
);
