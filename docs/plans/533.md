# Implementation Plan: ORB-055 Multi-Workspace Management

**Issue**: #533 - [Story] ORB-055: Implement multi-workspace management
**Epic**: #519 (Agency Features)
**Status**: Planning Complete
**Complexity**: Medium

---

## Summary

Build multi-workspace management capabilities allowing agencies to switch between client workspaces, view aggregate dashboards, generate cross-workspace reports, and perform bulk operations across multiple workspaces.

★ **Insight**: The workspace infrastructure is already well-established with WorkspaceContext, WorkspaceSwitcher, and AggregateDashboard. This ticket focuses on enhancing and completing the multi-workspace experience with role-based access control, cross-workspace reporting, and bulk operations.

---

## Current State Analysis

### ✅ Already Implemented

1. **Workspace Switcher** (`src/components/orbit/WorkspaceSwitcher.tsx`)
   - Quick access to recent and favorited workspaces ✓
   - Favorites toggle functionality ✓
   - Recent workspace tracking ✓
   - Visual indicators for personal workspaces ✓

2. **Workspace Context** (`src/components/orbit/WorkspaceContext.tsx`)
   - React Context provider with lazy loading ✓
   - Workspace metadata caching (localStorage) ✓
   - Fast switching without API calls (uses cached data) ✓
   - Cross-tab synchronization via storage events ✓

3. **Aggregate Dashboard** (`src/components/orbit/AggregateDashboard.tsx`)
   - KPIs across all managed workspaces ✓
   - Per-workspace summaries ✓
   - Social account, post, and engagement metrics ✓

4. **Database Infrastructure**
   - `WorkspaceMember` model with roles (OWNER, ADMIN, MEMBER, VIEWER) ✓
   - `WorkspaceFavorite` for favorite tracking ✓
   - `WorkspaceRecentAccess` for recent workspace tracking ✓
   - Aggregate query service (`src/lib/workspace/aggregate-queries.ts`) ✓

### ⚠️ Gaps to Address

1. **Cross-Workspace Reporting**
   - No UI for customizable metrics selection
   - No date range filtering UI
   - No export functionality (CSV, PDF)

2. **Bulk Operations**
   - No bulk scheduling across workspaces
   - No bulk publishing functionality
   - No bulk content management (drafts, assets)

3. **Role-Based Access Control**
   - RBAC types exist but need enforcement in UI
   - No inheritance options UI
   - No permission checks in bulk operations

---

## Acceptance Criteria Mapping

| Criterion                                                               | Status      | Implementation                                  |
| ----------------------------------------------------------------------- | ----------- | ----------------------------------------------- |
| Workspace switcher with quick access to recent and favorited workspaces | ✅ Complete | Already implemented in `WorkspaceSwitcher.tsx`  |
| Aggregate dashboard showing KPIs across all managed workspaces          | ✅ Complete | Already implemented in `AggregateDashboard.tsx` |
| Cross-workspace reporting with customizable metrics and date ranges     | ❌ To Do    | New reporting UI needed                         |
| Bulk operations for scheduling, publishing, and content management      | ❌ To Do    | New bulk operations UI and API                  |
| Role-based access control per workspace with inheritance options        | ⚠️ Partial   | Model exists, UI enforcement needed             |

---

## Implementation Steps

### Phase 1: Cross-Workspace Reporting UI

#### 1.1 Create Report Builder Component

**File**: `src/components/orbit/CrossWorkspaceReport.tsx`

```typescript
// Features:
// - Multi-select workspaces (from accessible list)
// - Date range picker with presets (7d, 30d, 90d, custom)
// - Metric selection checkboxes (followers, engagements, posts, etc.)
// - Export buttons (CSV, PDF)
// - Loading states and error handling
```

**Dependencies**:

- `@/components/ui/multi-select` (may need to create)
- `@/components/ui/date-range-picker` (may need to create)
- `@/components/ui/checkbox`

#### 1.2 Report API Endpoint

**File**: `src/app/api/workspaces/report/route.ts`

```typescript
// POST /api/workspaces/report
// - Accepts workspace IDs, date range, metrics array
// - Returns formatted report data
// - Supports CSV/JSON response format via Accept header
```

#### 1.3 Export Utilities

**File**: `src/lib/workspace/report-export.ts`

```typescript
// Functions:
// - exportToCSV(data): string
// - exportToPDF(data): Blob (using jsPDF or similar)
// - formatReportData(aggregateData, selectedMetrics): ReportData
```

**New Dependencies**:

- `jspdf` (for PDF export) or `pdfmake`
- `papaparse` (for CSV generation)

#### 1.4 Integration Page

**File**: `src/app/orbit/[workspaceSlug]/reports/page.tsx`

```typescript
// New page for cross-workspace reporting
// - Integrates CrossWorkspaceReport component
// - Handles navigation and sharing
```

---

### Phase 2: Bulk Operations

#### 2.1 Bulk Operation Types

**File**: `src/types/bulk-operations.ts`

```typescript
export type BulkOperationType =
  | "SCHEDULE_POSTS"
  | "PUBLISH_POSTS"
  | "DELETE_DRAFTS"
  | "MOVE_ASSETS"
  | "UPDATE_TAGS";

export interface BulkOperationRequest {
  type: BulkOperationType;
  workspaceIds: string[];
  targetIds: string[]; // Post IDs, draft IDs, etc.
  params: Record<string, unknown>; // Type-specific params
}

export interface BulkOperationResult {
  operationId: string;
  status: "PENDING" | "IN_PROGRESS" | "COMPLETED" | "FAILED";
  totalItems: number;
  processedItems: number;
  failedItems: number;
  errors: Array<{ itemId: string; error: string; }>;
}
```

#### 2.2 Bulk Scheduling API

**File**: `src/app/api/workspaces/bulk/schedule/route.ts`

```typescript
// POST /api/workspaces/bulk/schedule
// - Accept array of post IDs, target workspaces, schedule times
// - Validate user permissions for each workspace
// - Create scheduled posts in batches
// - Return operation ID for tracking
```

#### 2.3 Bulk Publishing API

**File**: `src/app/api/workspaces/bulk/publish/route.ts`

```typescript
// POST /api/workspaces/bulk/publish
// - Accept array of draft IDs across workspaces
// - Permission checks per workspace
// - Publish in batches with rate limiting
// - Track success/failure per item
```

#### 2.4 Bulk Content Management API

**File**: `src/app/api/workspaces/bulk/content/route.ts`

```typescript
// POST /api/workspaces/bulk/content
// Operations: delete drafts, move assets, update tags
// - Workspace-scoped operations
// - Transaction support for data integrity
```

#### 2.5 Bulk Operations UI

**File**: `src/components/orbit/BulkOperationsDialog.tsx`

```typescript
// Modal dialog for bulk operations
// - Operation type selection
// - Workspace multi-select
// - Item selection (posts, drafts, assets)
// - Confirmation step with summary
// - Progress tracking
// - Results display
```

#### 2.6 Database Model for Operation Tracking

**File**: `prisma/schema.prisma`

```prisma
model BulkOperation {
  id            String   @id @default(cuid())
  userId        String
  type          String   // BulkOperationType enum
  workspaceIds  String[] // Array of workspace IDs
  status        String   @default("PENDING")
  totalItems    Int
  processedItems Int     @default(0)
  failedItems   Int      @default(0)
  errors        Json?
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  completedAt   DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("bulk_operations")
}
```

---

### Phase 3: Role-Based Access Control UI

#### 3.1 Permission Service

**File**: `src/lib/workspace/permissions.ts`

```typescript
// Functions:
// - canSchedulePosts(userId, workspaceId): boolean
// - canPublishPosts(userId, workspaceId): boolean
// - canManageContent(userId, workspaceId): boolean
// - canPerformBulkOperation(userId, workspaceIds, operation): WorkspacePermissionMap
// - hasMinimumRole(userId, workspaceId, minRole): boolean

// Use WorkspaceRole enum: OWNER > ADMIN > MEMBER > VIEWER
```

**Update**: `src/lib/permissions/permissions.ts` (if it exists)

#### 3.2 Workspace Settings - Role Inheritance

**File**: `src/app/orbit/[workspaceSlug]/settings/members/page.tsx`

```typescript
// Enhanced member management page
// - Show current role per member
// - Role inheritance toggle (future feature)
// - Permission matrix display
```

#### 3.3 Permission Guards in Bulk Operations

**File**: `src/lib/workspace/bulk-operation-guards.ts`

```typescript
// Pre-flight permission checks
// - validateBulkSchedulePermissions(userId, workspaceIds): ValidationResult
// - validateBulkPublishPermissions(userId, workspaceIds): ValidationResult
// - filterAllowedWorkspaces(userId, workspaceIds, operation): string[]
```

---

### Phase 4: Database Views for Performance

#### 4.1 Create Materialized View (PostgreSQL)

**File**: `prisma/migrations/XXXXXX_workspace_aggregate_view/migration.sql`

```sql
-- Create materialized view for aggregate queries
CREATE MATERIALIZED VIEW workspace_aggregate_metrics AS
SELECT
  w.id as workspace_id,
  w.name as workspace_name,
  w.slug as workspace_slug,
  COUNT(DISTINCT sa.id) as social_account_count,
  COUNT(DISTINCT CASE WHEN sp.status = 'SCHEDULED' THEN sp.id END) as scheduled_post_count,
  COUNT(DISTINCT CASE WHEN sp.status = 'PUBLISHED' THEN sp.id END) as published_post_count,
  COALESCE(SUM(sm.followers), 0) as total_followers,
  COALESCE(SUM(sm.impressions), 0) as total_impressions,
  COALESCE(SUM(sm.likes + sm.comments + sm.shares), 0) as total_engagements,
  MAX(sp.created_at) as last_activity_at
FROM workspaces w
LEFT JOIN social_accounts sa ON sa.workspace_id = w.id
LEFT JOIN scheduled_posts sp ON sp.workspace_id = w.id
LEFT JOIN social_metrics sm ON sm.account_id = sa.id
GROUP BY w.id, w.name, w.slug;

-- Create index for fast lookups
CREATE INDEX idx_workspace_aggregate_metrics_workspace_id
  ON workspace_aggregate_metrics(workspace_id);

-- Refresh function
CREATE OR REPLACE FUNCTION refresh_workspace_aggregate_metrics()
RETURNS void AS $$
BEGIN
  REFRESH MATERIALIZED VIEW CONCURRENTLY workspace_aggregate_metrics;
END;
$$ LANGUAGE plpgsql;
```

#### 4.2 Scheduled Refresh Job

**File**: `src/app/api/cron/refresh-workspace-metrics/route.ts`

```typescript
// Vercel Cron Job to refresh materialized view
// Runs every 15 minutes
// POST /api/cron/refresh-workspace-metrics
```

**Update**: `vercel.json`

```json
{
  "crons": [
    {
      "path": "/api/cron/refresh-workspace-metrics",
      "schedule": "*/15 * * * *"
    }
  ]
}
```

#### 4.3 Query Service Update

**File**: `src/lib/workspace/aggregate-queries.ts`

```typescript
// Add function to query materialized view
export async function getAggregateKPIsFromView(
  workspaceIds: string[],
): Promise<AggregateKPIs> {
  // Query the materialized view for better performance
  // Fallback to regular queries if view doesn't exist
}
```

---

### Phase 5: Metadata Caching Enhancement

#### 5.1 Cache Service

**File**: `src/lib/workspace/workspace-cache.ts`

```typescript
// Server-side caching using Vercel KV (Redis)
export class WorkspaceCache {
  static async getWorkspaceMetadata(workspaceId: string): Promise<Workspace | null>;
  static async setWorkspaceMetadata(workspaceId: string, data: Workspace): Promise<void>;
  static async invalidateWorkspace(workspaceId: string): Promise<void>;
  static async getCachedFavorites(userId: string): Promise<string[]>;
  static async getCachedRecents(userId: string): Promise<string[]>;
}
```

**Dependencies**: Already available

- `@vercel/kv` (already in package.json)

#### 5.2 Cache Integration in API

**File**: `src/app/api/workspaces/route.ts`

```typescript
// Update GET /api/workspaces to use cache
// - Check cache first (Vercel KV)
// - Fallback to database
// - Cache for 5 minutes
```

---

## Files to Create

1. `src/components/orbit/CrossWorkspaceReport.tsx`
2. `src/app/api/workspaces/report/route.ts`
3. `src/lib/workspace/report-export.ts`
4. `src/app/orbit/[workspaceSlug]/reports/page.tsx`
5. `src/types/bulk-operations.ts`
6. `src/app/api/workspaces/bulk/schedule/route.ts`
7. `src/app/api/workspaces/bulk/publish/route.ts`
8. `src/app/api/workspaces/bulk/content/route.ts`
9. `src/components/orbit/BulkOperationsDialog.tsx`
10. `src/lib/workspace/bulk-operation-guards.ts`
11. `src/lib/workspace/workspace-cache.ts`
12. `src/app/api/cron/refresh-workspace-metrics/route.ts`
13. `prisma/migrations/XXXXXX_workspace_aggregate_view/migration.sql`
14. `prisma/migrations/XXXXXX_bulk_operations_model/migration.sql`

## Files to Modify

1. `prisma/schema.prisma` - Add BulkOperation model
2. `src/lib/workspace/aggregate-queries.ts` - Add view-based queries
3. `src/lib/permissions/permissions.ts` - Add workspace permission checks
4. `src/app/api/workspaces/route.ts` - Integrate caching
5. `src/types/workspace.ts` - Add bulk operation types (if needed)
6. `vercel.json` - Add cron job configuration
7. `src/components/orbit/AggregateDashboard.tsx` - Link to reports page
8. `src/app/orbit/[workspaceSlug]/layout.tsx` - Add navigation to reports
9. `package.json` - Add dependencies (jspdf, papaparse)

---

## Testing Considerations

### Unit Tests

- `src/lib/workspace/report-export.test.ts` - Export utilities
- `src/lib/workspace/bulk-operation-guards.test.ts` - Permission guards
- `src/lib/workspace/workspace-cache.test.ts` - Cache service
- `src/components/orbit/CrossWorkspaceReport.test.tsx` - Report component
- `src/components/orbit/BulkOperationsDialog.test.tsx` - Bulk ops UI

### Integration Tests

- `src/app/api/workspaces/report/route.test.ts` - Report API
- `src/app/api/workspaces/bulk/*/route.test.ts` - Bulk operation APIs
- `src/lib/workspace/aggregate-queries.test.ts` - View-based queries

### E2E Tests

- `e2e/features/workspace-reports.feature` - Report generation flow
- `e2e/features/bulk-operations.feature` - Bulk scheduling and publishing
- `e2e/features/workspace-rbac.feature` - Permission enforcement

---

## Potential Risks & Blockers

### 1. PostgreSQL Materialized View Support

**Risk**: Vercel Postgres may have limitations on materialized views
**Mitigation**:

- Test in development first
- Fallback to regular queries if views not supported
- Consider using regular views instead

### 2. Bulk Operation Performance

**Risk**: Bulk operations on hundreds of items could timeout
**Mitigation**:

- Implement job queue system (consider BullMQ or similar)
- Process in batches (e.g., 50 items at a time)
- Return operation ID immediately, process asynchronously

### 3. Permission Complexity

**Risk**: Complex permission inheritance could be confusing
**Mitigation**:

- Start with simple role hierarchy (OWNER > ADMIN > MEMBER > VIEWER)
- Defer inheritance options to future iteration
- Document permission matrix clearly in UI

### 4. Cache Invalidation

**Risk**: Stale cached data after workspace updates
**Mitigation**:

- Implement TTL (5 minutes)
- Invalidate cache on mutations
- Use cache versioning

---

## Dependencies

### New Package Dependencies

```json
{
  "jspdf": "^2.5.2",
  "papaparse": "^5.4.1",
  "@types/papaparse": "^5.3.14"
}
```

### Existing Dependencies (Already Available)

- `@vercel/kv` - For server-side caching
- `@tanstack/react-query` - For client-side data fetching
- `zod` - For validation schemas

---

## Implementation Order

**Recommended sequence** (can be parallelized within phases):

1. **Phase 1**: Cross-Workspace Reporting (2-3 days)
   - High value, low risk
   - Completes acceptance criteria #3

2. **Phase 3**: RBAC UI Enforcement (1-2 days)
   - Required for secure bulk operations
   - Completes acceptance criteria #5

3. **Phase 2**: Bulk Operations (3-4 days)
   - Depends on RBAC
   - Completes acceptance criteria #4

4. **Phase 5**: Metadata Caching (1 day)
   - Performance optimization
   - Can run in parallel with above

5. **Phase 4**: Database Views (1-2 days)
   - Performance optimization
   - Can be added last
   - Requires database migration planning

**Total Estimated Effort**: 8-12 days (medium complexity)

---

## Success Metrics

- [ ] Users can generate custom reports across multiple workspaces
- [ ] Reports can be exported as CSV and PDF
- [ ] Users can schedule posts across 5+ workspaces in one action
- [ ] Bulk operations respect workspace roles (VIEWER cannot publish)
- [ ] Workspace switching is fast (<100ms from cache)
- [ ] Aggregate dashboard loads in <2s for 20+ workspaces

---

## Future Enhancements (Out of Scope)

- **Role inheritance**: Child workspaces inherit permissions from parent
- **Custom roles**: Beyond OWNER/ADMIN/MEMBER/VIEWER
- **Scheduled reports**: Automatically generate and email reports
- **Bulk import**: Import content from CSV to multiple workspaces
- **Workspace templates**: Copy settings from one workspace to many
- **API access**: Bulk operations via REST API

---

**Plan Created**: 2026-01-29
**Estimated Completion**: Q1 2026
**Risk Level**: Medium
**Business Value**: High (Agency features unlock new customer segment)
