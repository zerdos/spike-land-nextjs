# Implementation Plan: Fix TypeScript Build Error for PlatformTransition Import

**Issue:** #914
**Priority:** P0 (BLOCKING)
**Type:** Bug Fix

## Summary

The production build is failing with a TypeScript error when trying to import `PlatformTransition` type from `@spike-npm-land/shared/types` in the `TransitionFlow.tsx` component. The error occurs during the Next.js build process in CI/CD.

## Root Cause Analysis

After investigating the codebase, I found that:

1. ✅ The `PlatformTransition` type **exists** in `packages/shared/src/types/attribution.ts`
2. ✅ It's **properly exported** from `packages/shared/src/types/index.ts` (line 389)
3. ✅ The package.json **has the `/types` export** configured correctly (lines 14-18)
4. ✅ The shared package **has been built** (confirmed `dist/types/` exists)
5. ✅ Other files successfully use the same import pattern (e.g., `journey-analyzer.ts`, `JourneyTab.tsx`)
6. ✅ The CI workflow **builds the shared package** before the main app (lines 209-210 then 212-213)

**The real issue:** TypeScript's module resolution is failing during the Next.js production build, likely due to:
- The monorepo workspace dependency not being properly resolved
- Possible build order timing issue where TypeScript checks happen before shared package artifacts are available
- Missing explicit workspace protocol in package.json dependencies

## Verification Steps

### Step 1: Verify Current Import Usage
Check all files using the shared package to confirm the pattern:
```bash
grep -r "@spike-npm-land/shared" src/ --include="*.ts" --include="*.tsx"
```

### Step 2: Check Workspace Configuration
Verify that the shared package is properly linked as a workspace dependency.

### Step 3: Local Build Test
Run the production build locally to reproduce:
```bash
yarn build
```

## Proposed Solution

**Option A: Add Explicit Workspace Dependency (RECOMMENDED)**

Add the shared package as an explicit workspace dependency in the root `package.json`:

```json
{
  "dependencies": {
    "@spike-npm-land/shared": "workspace:*"
  }
}
```

This ensures TypeScript and the build system can properly resolve the workspace package during compilation.

**Option B: Update tsconfig paths (Alternative)**

If Option A doesn't work, add an explicit path mapping in `tsconfig.json`:

```json
{
  "compilerOptions": {
    "paths": {
      "@/*": ["./src/*"],
      "@spike-npm-land/shared": ["./packages/shared/src"],
      "@spike-npm-land/shared/*": ["./packages/shared/src/*"]
    }
  }
}
```

**Recommended Approach:** Start with Option A as it's the cleanest solution for monorepo dependencies.

## Implementation Steps

### 1. Add Workspace Dependency
**File:** `package.json` (root)

**Action:** Add the shared package as a workspace dependency in the `dependencies` section:
```json
"@spike-npm-land/shared": "workspace:*"
```

**Location:** After line 113, in the dependencies section

### 2. Update Yarn Lock
**Command:**
```bash
yarn install
```

This will update the yarn.lock file to reflect the new dependency relationship.

### 3. Verify Build Locally
**Command:**
```bash
yarn build
```

**Expected Result:** Build should complete successfully without TypeScript errors.

### 4. Create Test to Prevent Regression
**File:** Create `src/lib/tracking/__tests__/platform-transition-import.test.ts`

**Purpose:** Ensure the import works correctly

```typescript
import { describe, it, expect } from 'vitest';
import type { PlatformTransition } from '@spike-npm-land/shared/types';

describe('PlatformTransition Type Import', () => {
  it('should import PlatformTransition type without errors', () => {
    // Type-only test - if this compiles, the import works
    const transition: PlatformTransition = {
      from: 'ORGANIC',
      to: 'PAID',
      count: 10,
    };

    expect(transition.from).toBe('ORGANIC');
    expect(transition.to).toBe('PAID');
    expect(transition.count).toBe(10);
  });
});
```

## Files to Modify

1. **`package.json`** (root)
   - Add `@spike-npm-land/shared` as a workspace dependency
   - Location: dependencies section (after line 113)

2. **`yarn.lock`**
   - Auto-updated by `yarn install`
   - No manual changes needed

## Files to Create

1. **`src/lib/tracking/__tests__/platform-transition-import.test.ts`**
   - Regression test for type import
   - Ensures the import path works correctly
   - Should be included in unit test coverage

## Testing Strategy

### Unit Tests
- ✅ Create import test for PlatformTransition type
- ✅ Run full unit test suite to ensure no regressions
- ✅ Verify 100% coverage is maintained

### Build Verification
- ✅ Run `yarn build` locally to verify TypeScript compilation
- ✅ Verify shared package builds before main app
- ✅ Check that dist artifacts are created correctly

### CI/CD Verification
- ✅ Push to feature branch and create PR
- ✅ Monitor CI pipeline "Build Application" job
- ✅ Verify all checks pass (lint, tests, build, e2e)
- ✅ Ensure Vercel preview deployment succeeds

## Potential Risks

### Low Risk
- Adding workspace dependency is a standard monorepo pattern
- Other workspace packages (code, testing.spike.land) likely use similar setup
- No breaking changes to existing code

### Edge Cases
- If Option A doesn't work, fallback to Option B (tsconfig paths)
- Ensure build order in CI remains correct (shared package first)

## Success Criteria

1. ✅ `yarn build` completes without TypeScript errors
2. ✅ CI/CD pipeline passes all checks
3. ✅ Vercel deployment succeeds
4. ✅ Import test passes with 100% coverage
5. ✅ No regressions in other files using shared package imports

## Rollback Plan

If the fix causes issues:

1. Revert the package.json change
2. Run `yarn install` to restore yarn.lock
3. Original build error will return but no new issues introduced

## Related Issues

- Introduced by: #912 (Attribution Studio feature)
- Related to: #514 (Cross-Platform Attribution)

## Estimated Complexity

**Simple** - This is a configuration fix requiring minimal code changes:
- 1 line added to package.json
- 1 test file created
- Standard monorepo dependency resolution pattern

## Notes

- The import path `@spike-npm-land/shared/types` is actually **correct**
- The issue is module resolution, not an incorrect import
- The shared package is properly configured with exports
- Other files successfully use the same import pattern
- This is a common monorepo dependency resolution issue
