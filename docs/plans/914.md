# Implementation Plan: Fix TypeScript Build Error - Missing Module '@spike-npm-land/shared/types'

**Issue**: #914
**Priority**: P0 (BLOCKING)
**Type**: Bug Fix
**Complexity**: Simple

## Problem Summary

The production build fails with a TypeScript error when trying to import `PlatformTransition` type from `@spike-npm-land/shared/types`. This was introduced in PR #912 (Attribution Studio feature).

### Error

```
./src/components/admin/marketing/journey/TransitionFlow.tsx:4:41
Type error: Cannot find module '@spike-npm-land/shared/types' or its corresponding type declarations.
```

### Affected Files

- `src/components/admin/marketing/journey/TransitionFlow.tsx:4`
- `src/lib/tracking/journey-analyzer.ts:9`
- `src/components/admin/marketing/tabs/JourneyTab.tsx:9`

## Root Cause Analysis

The issue is **NOT** with the import path or the shared package configuration. The configuration is correct:

1. ✅ `packages/shared/package.json` exports `./types` subpath correctly
2. ✅ `packages/shared/tsup.config.ts` builds `types/index` entry point
3. ✅ `packages/shared/src/types/index.ts` exports `PlatformTransition` type
4. ✅ `packages/shared/src/types/attribution.ts` defines the type correctly

**The real issue**: The shared package needs to be **built** before the Next.js build runs in CI/CD. Currently, the CI workflow doesn't build the shared package before running `yarn build`, which causes TypeScript to fail when trying to resolve the `@spike-npm-land/shared/types` module.

### Why it works locally but fails in CI

- **Locally**: Developers typically run `yarn install` which triggers `postinstall`, and may have previously built the shared package manually
- **CI**: Fresh environment starts without built dist files for the shared package

## Solution

Add a prebuild step to ensure the shared package is built before the Next.js build runs.

### Option 1: Add to package.json scripts (RECOMMENDED)

Modify the root `package.json` to add a prebuild script that builds the shared package.

### Option 2: Update CI workflow

Explicitly build the shared package in the CI workflow before running the Next.js build.

**Recommendation**: Option 1 is preferred because it ensures the build works correctly both locally and in CI, following the principle of "works the same everywhere."

## Implementation Steps

### Step 1: Update Root package.json

**File**: `package.json`

Add a `prebuild` script that runs before the `build` script:

```json
{
  "scripts": {
    "prebuild": "yarn workspace @spike-npm-land/shared build",
    "build": "yarn db:generate && DATABASE_URL='postgresql://dummy:dummy@dummy/dummy' NODE_OPTIONS='--max-old-space-size=4096' next build --webpack"
  }
}
```

This leverages npm/yarn's built-in lifecycle scripts - `prebuild` automatically runs before `build`.

### Step 2: Verify the Fix

Run a clean build to verify:

```bash
# Clean any existing dist files
rm -rf packages/shared/dist

# Run the build (prebuild should run automatically)
yarn build
```

The build should succeed without TypeScript errors.

### Step 3: Update Documentation (Optional)

If needed, add a note to the development documentation explaining the build dependency between packages.

## Files to Modify

| File           | Change                | Reason                                               |
| -------------- | --------------------- | ---------------------------------------------------- |
| `package.json` | Add `prebuild` script | Ensures shared package is built before Next.js build |

## Testing Strategy

### Unit Tests

- No unit test changes required (this is a build configuration fix)

### Integration Tests

- Verify CI build succeeds after the change
- Test locally with clean environment: `rm -rf packages/shared/dist && yarn build`

### Manual Testing

1. Clean workspace: `rm -rf packages/shared/dist node_modules/.cache`
2. Run build: `yarn build`
3. Verify build completes without TypeScript errors
4. Check that TransitionFlow.tsx builds successfully

## Success Criteria

- [ ] `yarn build` succeeds without TypeScript errors
- [ ] CI/CD pipeline "Build Application" job passes
- [ ] TransitionFlow.tsx component builds successfully
- [ ] All three affected files import `PlatformTransition` without errors

## Rollback Plan

If the prebuild approach causes issues:

1. Remove the `prebuild` script from package.json
2. Revert to explicit build command in CI workflow
3. Add shared package build as a separate CI job dependency

## Risks & Considerations

### Low Risk

- The change is minimal and uses standard npm/yarn lifecycle hooks
- The build dependency is already implicitly required - we're just making it explicit

### Build Time Impact

- Adds ~2-5 seconds to build time for the shared package build
- This is acceptable for a P0 bug fix that unblocks production deployments

### Workspace Dependencies

- Yarn workspaces handles the build order automatically
- No manual dependency ordering required

## Related Issues

- Introduced by: #912 (Attribution Studio feature)
- Related type system improvements: #797

## Additional Notes

`★ Insight ─────────────────────────────────────`
**Why the import path is correct**:
The import `@spike-npm-land/shared/types` works because:

1. The package.json `exports` field maps `./types` to `dist/types/index.{js,d.ts}`
2. TypeScript's module resolution follows the `exports` field
3. The tsup config builds a separate entry point for `types/index`

**Why it failed in CI**:
TypeScript looks for `.d.ts` files during type checking. Without running
`yarn build` in the shared package, the `dist/types/index.d.ts` file
doesn't exist, causing the "Cannot find module" error.
`─────────────────────────────────────────────────`

## Verification Checklist

After implementation:

- [ ] Local build succeeds: `yarn build`
- [ ] Clean build succeeds: `rm -rf packages/shared/dist && yarn build`
- [ ] CI build passes on PR
- [ ] Vercel deployment succeeds
- [ ] No TypeScript errors in IDE for affected files
