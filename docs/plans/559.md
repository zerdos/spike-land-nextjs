# Implementation Plan: Template Library (#559)

**Issue**: [Story] ORB-049: Build template library
**Parent Epic**: #517 (Epic 3.5: Content Library)
**Complexity**: Medium

## Summary

Build a template library system for saving and reusing post templates across different social media platforms with variable placeholder support. This will integrate with the existing Content Library and Content Composer (Calendar) features.

## Architecture Decision

Following the existing **Crisis Response Templates** pattern found in `src/lib/crisis/response-templates.ts`, we will:

1. Use a service class pattern for template operations
2. Store templates in Prisma database with workspace ownership
3. Use simple string replacement for variable substitution (similar to crisis templates)
4. Leverage existing Asset models for preview thumbnails

## Database Schema Changes

### New Tables

**`ContentTemplate`**

```prisma
model ContentTemplate {
  id          String   @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Template metadata
  name        String
  description String?  @db.Text
  category    String?  // e.g., "product-launch", "event", "promotion"

  // Content
  content     String   @db.Text
  variables   String[] // Array of variable names like ["product_name", "date", "price"]

  // Platform-specific variants
  platform    SocialPlatform? // null = universal, specific = platform-specific

  // Preview/thumbnail
  previewAssetId String?
  previewAsset   Asset? @relation(fields: [previewAssetId], references: [id], onDelete: SetNull)

  // Template inheritance (for brand consistency)
  parentId    String?
  parent      ContentTemplate?  @relation("TemplateInheritance", fields: [parentId], references: [id], onDelete: SetNull)
  children    ContentTemplate[] @relation("TemplateInheritance")

  // Metadata
  usageCount  Int      @default(0)
  isActive    Boolean  @default(true)

  // Audit
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([workspaceId])
  @@index([workspaceId, category])
  @@index([workspaceId, platform])
  @@index([workspaceId, isActive])
}
```

## Files to Create

### 1. Service Layer (`src/lib/templates/`)

**`src/lib/templates/types.ts`**

- Define TypeScript interfaces for template operations
- Variable placeholder types
- Search/filter parameters
- Platform-specific template options

**`src/lib/templates/template-service.ts`**

- `TemplateService` class with static methods:
  - `create()` - Create new template
  - `update()` - Update existing template
  - `delete()` - Delete template
  - `getById()` - Get template by ID
  - `search()` - Search/filter templates
  - `render()` - Render template with variable substitution
  - `duplicate()` - Duplicate template (for variants)
  - `incrementUsage()` - Track template usage

**`src/lib/templates/variable-parser.ts`**

- Parse template content for variables (extract `{{variable_name}}`)
- Validate variable substitution
- Render template with values
- Support Handlebars-like syntax: `{{product_name}}`, `{{date}}`

**`src/lib/templates/index.ts`**

- Export service and types

### 2. API Routes (`src/app/api/orbit/`)

**`src/app/api/orbit/[workspaceSlug]/templates/route.ts`**

- GET: List templates (with filters: category, platform, search)
- POST: Create new template

**`src/app/api/orbit/[workspaceSlug]/templates/[templateId]/route.ts`**

- GET: Get template by ID
- PATCH: Update template
- DELETE: Delete template

**`src/app/api/orbit/[workspaceSlug]/templates/[templateId]/render/route.ts`**

- POST: Render template with provided variables

**`src/app/api/orbit/[workspaceSlug]/templates/[templateId]/duplicate/route.ts`**

- POST: Duplicate template (for creating variants)

### 3. UI Components (`src/components/orbit/templates/`)

**`src/components/orbit/templates/TemplateLibrary.tsx`**

- Main template library view
- Grid/list display of templates
- Search and filter controls
- Category tabs

**`src/components/orbit/templates/TemplateCard.tsx`**

- Individual template card with preview
- Quick actions (edit, duplicate, delete, insert)
- Usage count badge
- Platform indicator

**`src/components/orbit/templates/CreateTemplateDialog.tsx`**

- Modal for creating new templates
- Form fields: name, description, category, platform, content
- Variable insertion helper
- Preview thumbnail upload

**`src/components/orbit/templates/EditTemplateDialog.tsx`**

- Modal for editing existing templates
- Prefilled form
- Variable management

**`src/components/orbit/templates/TemplatePreview.tsx`**

- Preview template with sample data
- Variable substitution preview
- Platform-specific preview formatting

**`src/components/orbit/templates/TemplateVariableInput.tsx`**

- Input component for inserting variables into content
- Dropdown of available variables
- Insert button for `{{variable_name}}`

**`src/components/orbit/templates/TemplateCategoryFilter.tsx`**

- Category filter chips/tabs
- Custom category creation

### 4. Template Picker (for Calendar Integration)

**`src/components/orbit/templates/TemplatePickerDialog.tsx`**

- Modal for selecting template from library
- Search and filter
- Platform filtering (show only relevant templates)
- Preview on hover
- "Insert" action fills Calendar composer

**`src/components/orbit/templates/QuickInsertButton.tsx`**

- Small button in Calendar composer toolbar
- Opens TemplatePickerDialog
- Icon: template/layout icon from lucide-react

### 5. Page Routes

**`src/app/orbit/[workspaceSlug]/templates/page.tsx`**

- Template library page
- Uses `TemplateLibrary` component
- Breadcrumb: Orbit > Templates

### 6. Hooks

**`src/hooks/use-templates.ts`**

- `useTemplates()` - Fetch templates with filters
- `useTemplate()` - Fetch single template
- `useCreateTemplate()` - Create template mutation
- `useUpdateTemplate()` - Update template mutation
- `useDeleteTemplate()` - Delete template mutation
- `useRenderTemplate()` - Render template with variables

## Files to Modify

### 1. Database Schema

**`src/generated/prisma/schema.prisma`**

- Add `ContentTemplate` model (see above)
- Add relation to `User` model: `contentTemplates ContentTemplate[]`
- Add relation to `Workspace` model: `contentTemplates ContentTemplate[]`
- Add relation to `Asset` model: `templatePreviews ContentTemplate[]`

### 2. Calendar Integration

**`src/app/orbit/[workspaceSlug]/calendar/CalendarClient.tsx`**

- Add template picker button to composer toolbar
- Handle template insertion (fill content + variables)
- Add state for selected template

**`src/components/orbit/calendar/` (if composer is separate component)**

- Add `TemplatePickerDialog` integration
- Pre-fill content when template selected

### 3. Sidebar Navigation

**`src/app/orbit/[workspaceSlug]/OrbitSidebar.tsx`**

- Add "Templates" menu item under Content section
- Icon: `FileText` or `Layout` from lucide-react
- Route: `/orbit/[workspaceSlug]/templates`

### 4. Type Exports

**`packages/shared/src/types/index.ts`** (if using shared package)

- Export template types for cross-package usage

## Implementation Steps

### Phase 1: Database & Service Layer (Backend Foundation)

1. Add `ContentTemplate` model to `schema.prisma`
2. Run `yarn prisma generate` and `yarn prisma migrate dev`
3. Create `src/lib/templates/types.ts` with interfaces
4. Create `src/lib/templates/variable-parser.ts` with placeholder logic
5. Create `src/lib/templates/template-service.ts` with CRUD operations
6. Write unit tests for service layer
7. Create `src/lib/templates/index.ts` exports

### Phase 2: API Routes

1. Create `src/app/api/orbit/[workspaceSlug]/templates/route.ts` (GET, POST)
2. Create `src/app/api/orbit/[workspaceSlug]/templates/[templateId]/route.ts` (GET, PATCH, DELETE)
3. Create render and duplicate endpoints
4. Write API route tests

### Phase 3: React Hooks

1. Create `src/hooks/use-templates.ts` with React Query hooks
2. Test hooks integration

### Phase 4: UI Components (Template Library)

1. Create `TemplateCard.tsx` - Individual template display
2. Create `TemplateLibrary.tsx` - Main library view
3. Create `CreateTemplateDialog.tsx` - Template creation
4. Create `EditTemplateDialog.tsx` - Template editing
5. Create `TemplatePreview.tsx` - Template preview with variables
6. Create `TemplateCategoryFilter.tsx` - Category filtering
7. Create `TemplateVariableInput.tsx` - Variable insertion helper

### Phase 5: Template Library Page

1. Create `src/app/orbit/[workspaceSlug]/templates/page.tsx`
2. Integrate all library components
3. Add to sidebar navigation in `OrbitSidebar.tsx`
4. Write E2E tests for template library

### Phase 6: Calendar Integration (Quick Insert)

1. Create `TemplatePickerDialog.tsx` - Template picker modal
2. Create `QuickInsertButton.tsx` - Toolbar button
3. Modify `CalendarClient.tsx` to integrate template picker
4. Implement content insertion with variable placeholders
5. Write E2E tests for template insertion workflow

## Testing Considerations

### Unit Tests

- Template service CRUD operations
- Variable parser (placeholder extraction, substitution)
- Template rendering with edge cases (missing variables, special characters)

### Integration Tests

- API routes (auth, permissions, validation)
- Database constraints (workspace ownership, cascading deletes)

### E2E Tests (Playwright + Cucumber)

```gherkin
Feature: Template Library

Scenario: Create a new template
  Given I am logged in to workspace "acme"
  When I navigate to "/orbit/acme/templates"
  And I click "Create Template"
  And I fill in template form with:
    | name        | Product Launch     |
    | category    | product-launch     |
    | platform    | TWITTER            |
    | content     | Introducing {{product_name}}! Available {{date}} for only {{price}}. |
  And I add variables: product_name, date, price
  And I click "Create"
  Then I should see "Product Launch" template in the list

Scenario: Insert template into calendar
  Given I have a template "Product Launch" with variables
  When I navigate to "/orbit/acme/calendar"
  And I click "New Post"
  And I click "Insert Template" button
  And I search for "Product Launch"
  And I select "Product Launch" template
  Then the composer content should contain "Introducing {{product_name}}!"
  And I should see variable inputs for: product_name, date, price
```

## Variable Substitution Implementation

### Syntax

Use Handlebars-like syntax: `{{variable_name}}`

### Parser Logic

```typescript
// Extract variables from template
const extractVariables = (content: string): string[] => {
  const regex = /\{\{(\w+)\}\}/g;
  const matches = content.matchAll(regex);
  return [...new Set([...matches].map(m => m[1]))];
};

// Render template with values
const renderTemplate = (content: string, values: Record<string, string>): string => {
  let rendered = content;
  for (const [key, value] of Object.entries(values)) {
    const regex = new RegExp(`\\{\\{${key}\\}\\}`, "g");
    rendered = rendered.replace(regex, value);
  }
  return rendered;
};
```

### Alternative: Handlebars.js

**Pros**: Supports conditionals, loops, helpers
**Cons**: Adds dependency, more complex for simple use case
**Decision**: Start with simple string replacement, migrate to Handlebars if complex logic needed

## Preview Thumbnail Strategy

### Option 1: Screenshot Generation

- Generate preview from rendered template
- Store as Asset in R2
- Requires server-side rendering

### Option 2: Manual Upload

- User uploads preview image
- Links to Asset via `previewAssetId`
- Simpler, more flexible

**Chosen**: Option 2 (Manual Upload) for MVP, Option 1 for future enhancement

## Template Inheritance

### Use Case

Brand wants all product launch templates to inherit:

- Brand colors
- Logo placement
- Hashtag strategy

### Implementation

- `parentId` field creates hierarchy
- Child templates can override specific fields
- UI shows "Based on: [Parent Name]"
- Future: Auto-update children when parent changes

**MVP Scope**: Schema support, manual duplication only (no auto-inheritance)

## Potential Risks & Blockers

### Risk: Variable Validation

**Issue**: User forgets to fill variable when using template
**Mitigation**:

- Show warning if variables unfilled
- Highlight missing variables in preview
- Block publish if required variables missing

### Risk: Platform Compatibility

**Issue**: Template designed for Twitter doesn't work on LinkedIn (character limits)
**Mitigation**:

- Show platform-specific templates only
- Display character count in preview
- Allow platform variants of same template

### Risk: Template Versioning

**Issue**: User edits template, breaks existing scheduled posts
**Mitigation**:

- Templates are copied to posts, not referenced
- Editing template doesn't affect existing posts
- Future: Version history

## Out of Scope (Future Enhancements)

- AI-generated template suggestions
- Template analytics (conversion rates per template)
- Template marketplace/sharing between workspaces
- Rich text editor for templates (Markdown support)
- Conditional logic in variables (if/else)
- Template scheduling (suggest templates based on calendar)
- Multi-language template variants
- Template approval workflow

## Dependencies

- Existing: `Asset` model (for preview thumbnails)
- Existing: `Workspace` model (for ownership)
- Existing: `SocialPlatform` enum (for platform-specific templates)
- Existing: Calendar/Content Composer (for insertion)

## Success Criteria (Acceptance Criteria)

- [x] Save posts as reusable templates
- [x] Platform-specific template variants
- [x] Variable placeholders (e.g., `{{product_name}}`, `{{date}}`)
- [x] Quick insert from template into Content Composer
- [x] Template categories and search functionality

## Timeline Estimate

**Note**: Per CLAUDE.md guidelines, no time estimates provided. Work broken into phases above for incremental delivery.

## Related Issues

- Parent: #517 (Epic 3.5: Content Library)
- Related: Calendar feature (content composer)
- Reference: Crisis Response Templates implementation (#588)
