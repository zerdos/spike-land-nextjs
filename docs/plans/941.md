# Implementation Plan: E2E Tests for Full Conversion Workflow

**Issue**: #941
**Created**: 2026-01-29
**Complexity**: Medium

## Summary

Create comprehensive E2E tests that verify the complete user conversion workflow from landing page visit through sign-up to completing a value-delivering action. This ensures the critical user journey works end-to-end without friction.

## Background Context

### Current State

- Spike Land has extensive E2E test infrastructure with Cucumber + Playwright
- Existing tests cover individual features (landing page, authentication, tokens, image enhancement, etc.)
- Missing: Holistic end-to-end conversion flow tests that span multiple features
- Well-established patterns in `e2e/step-definitions/authentication.steps.ts`, `tokens.steps.ts` and `common.steps.ts`
- 60+ existing feature files demonstrate mature test infrastructure
- CI/CD pipeline runs tests via `.github/workflows/ci-cd.yml`

### Conversion Workflow Definition

Based on detailed codebase analysis (examining landing page, auth flows, token system, and existing tests), the conversion workflows are:

**Primary Conversion Path: Token Purchase**

1. **Landing** → User visits home page (/)
2. **CTA Click** → User clicks "Restore Your Photos" or "Get Started" CTA
3. **Sign In** → User redirected to /auth/signin
4. **Authentication** → User signs in via GitHub/Google OAuth
5. **Action Page** → User lands on protected page (e.g., /apps/pixel/enhance)
6. **Token Balance Check** → User sees token balance display
7. **Purchase Trigger** → User clicks "Get Tokens" button (low balance) or "+" button
8. **Package Selection** → User selects token package in purchase modal
9. **Checkout** → User redirected to Stripe checkout
10. **Success** → User returns with tokens credited

**Alternative Path: Voucher Redemption**

1. **Landing** → User visits home page (/)
2. **Sign In** → User signs in
3. **Action Page** → User navigates to enhance page
4. **Purchase Modal** → User opens purchase modal
5. **Voucher Entry** → User enters voucher code (e.g., LAUNCH100)
6. **Redemption** → Voucher validated and tokens credited
7. **Success** → Modal closes, balance updated

**Alternative Path: Tier Subscription**

1. **Landing** → User visits home page (/)
2. **Sign In** → User signs in
3. **Settings** → User navigates to /settings/subscription
4. **Tier Selection** → User selects tier (BASIC/STANDARD/PREMIUM)
5. **Checkout** → User completes Stripe checkout
6. **Success** → Tier upgraded, tokens granted

### Success Criteria (from Issue)

- [x] ✅ Define the full conversion workflow steps (analyzed in detail above)
- [ ] Create a Cucumber/Playwright test suite covering this flow
- [ ] Ensure tests run in CI/CD pipeline
- [ ] Verify success scenarios and common failure paths

## Technical Approach

### 1. Feature File Structure

Create `e2e/features/conversion-workflow.feature` with scenarios covering:

**Happy Path Scenarios:**

- Unauthenticated user → Sign up → First image enhancement → Success
- Unauthenticated user → Sign up → Create first app → Success
- Landing page CTA → Sign up → Token purchase → Enhancement

**Edge Cases & Failure Paths:**

- User abandons sign-up midway (tracks drop-off)
- User signs up but doesn't complete action (incomplete conversion)
- Authentication failure recovery
- Insufficient tokens scenario during enhancement
- Network failure during critical action

**Analytics & Tracking:**

- Verify conversion events are tracked
- Verify UTM parameters are captured
- Verify session tracking across the flow

### 2. Step Definitions

Create `e2e/step-definitions/conversion-steps.ts` with reusable steps:

**New Steps Needed:**

```typescript
// Landing page interactions
Given("I arrive at the landing page from {string} campaign");
When("I click the {string} CTA button");

// Conversion flow tracking
Then("a {string} conversion event should be tracked");
Then("the session should have UTM parameters");

// Value delivery verification
Then("I should see my enhanced image");
Then("I should see my created app in the dashboard");
Then("I should see {int} tokens deducted from my balance");

// Abandonment & recovery
When("I abandon the sign-up flow");
Then("I should be able to resume from where I left off");
```

**Leverage Existing Steps:**

- Authentication: Reuse from `authentication.steps.ts` (login, session mocking)
- Common actions: Reuse from `common.steps.ts` (button clicks, navigation, success messages)
- Image enhancement: Reuse from `image-enhancement.steps.ts`

### 3. Test Data & Mocking Strategy

**Mock Services:**

- Authentication: Use existing mock session pattern
- API endpoints: Mock `/api/images/enhance`, `/api/tokens/balance`
- Tracking: Mock `/api/tracking/event` to verify events
- Analytics: Mock campaign attribution endpoints

**Test Data:**

```typescript
// Test user profiles
const TEST_USER = {
  name: "Test User",
  email: "test@example.com",
  tokens: 100,
};

// Test campaigns
const UTM_PARAMS = {
  source: "google",
  medium: "cpc",
  campaign: "launch_2026",
  content: "hero_cta",
};
```

### 4. CI/CD Integration

**Execution Strategy:**

- Add to existing Playwright CI workflow
- Use `@conversion` tag for conversion flow tests
- Run on every PR and merge to main
- Parallel execution with other E2E tests

**Smoke Test Priority:**

- Mark critical happy path as `@smoke`
- Should complete in < 2 minutes
- Fail fast on conversion flow issues

## Files to Create

### 1. `e2e/features/conversion-workflow.feature`

**Purpose**: Comprehensive conversion flow test scenarios
**Size**: ~200-300 lines
**Sections**:

- Happy path conversions (3-4 scenarios)
- Edge cases (5-6 scenarios)
- Failure recovery (2-3 scenarios)
- Analytics tracking verification (2-3 scenarios)

### 2. `e2e/step-definitions/conversion-steps.ts`

**Purpose**: Custom step definitions for conversion workflows
**Size**: ~300-400 lines
**Key Functions**:

- `mockCampaignAttribution()` - Mock UTM tracking
- `mockConversionEvent()` - Mock analytics events
- `verifyConversionTracked()` - Assert event was logged
- Steps for landing page CTAs
- Steps for conversion tracking
- Steps for value delivery verification

## Files to Modify

### 1. `e2e/step-definitions/common.steps.ts`

**Changes**:

- Add generic "primary CTA button" selector if not exists
- Ensure "conversion event" verification helpers exist

### 2. `.github/workflows/ci-cd.yml` (if needed)

**Changes**:

- Verify conversion tests are included in E2E test run
- Add `@conversion` tag to workflow if filtering tests

### 3. `e2e/support/helpers/wait-helper.ts` (if needed)

**Changes**:

- Add `waitForConversionEvent()` helper if needed for async event tracking

## Implementation Steps

### Phase 1: Setup & Basic Structure (30 min)

1. Create `e2e/features/conversion-workflow.feature`
2. Define Background and basic scenario structure
3. Add happy path scenario: "User signs up and enhances first image"

### Phase 2: Core Conversion Scenarios (1 hour)

1. Implement step definitions in `conversion-steps.ts`
2. Add UTM parameter tracking steps
3. Add conversion event verification steps
4. Complete 3-4 happy path scenarios

### Phase 3: Edge Cases & Failure Paths (45 min)

1. Add abandonment scenarios
2. Add failure recovery scenarios
3. Add insufficient tokens scenario
4. Add network failure handling

### Phase 4: Analytics Tracking (30 min)

1. Add conversion event tracking verification
2. Add UTM parameter capture verification
3. Add session tracking across flow

### Phase 5: Testing & CI Integration (30 min)

1. Run tests locally with `yarn test:e2e:local`
2. Fix any failing assertions
3. Verify tests pass in CI pipeline
4. Add smoke test tags to critical scenarios

## Testing Strategy

### Unit Test Coverage

- No new unit tests required (E2E only)
- Existing tracking and analytics functions are already unit tested

### E2E Test Scenarios

**Critical Path (Must Pass):**

1. ✅ Unauthenticated user → Sign up → First enhancement → Success
2. ✅ Landing CTA → Authentication → Token balance check → Enhancement

**Important Scenarios:**
3. ✅ User with campaign attribution → Sign up → Action → Event tracked
4. ✅ User abandons sign-up → Returns later → Resumes from dashboard
5. ✅ User attempts action with insufficient tokens → Purchase flow

**Edge Cases:**
6. ✅ Authentication failure → Retry → Success
7. ✅ Network failure during enhancement → Retry → Success

### Test Execution

```bash
# Run all conversion tests
yarn test:e2e:local --grep "@conversion"

# Run smoke tests only (critical path)
yarn test:e2e:local --grep "@smoke.*@conversion"

# Run specific scenario
yarn test:e2e:local --grep "User signs up and enhances first image"
```

## Potential Risks & Mitigations

### Risk 1: Flaky Tests Due to Async Operations

**Mitigation**:

- Use robust wait strategies from `wait-helper.ts`
- Add explicit waits for conversion events
- Use `waitForPageReady()` between navigation steps

### Risk 2: Authentication Mock Complexity

**Mitigation**:

- Leverage existing auth mocking patterns from `authentication.steps.ts`
- Use the well-tested `mockSession()` helper
- Don't reinvent authentication mocking

### Risk 3: CI/CD Performance Impact

**Mitigation**:

- Tag tests appropriately (`@fast`, `@smoke`, `@conversion`)
- Run conversion tests in parallel with other suites
- Set reasonable timeouts (max 2 min per scenario)

### Risk 4: Test Data Dependencies

**Mitigation**:

- Use self-contained test data (no DB dependencies)
- Mock all external services
- Clean up test data after each scenario

## Success Metrics

### Test Coverage

- [ ] 100% of conversion workflow steps covered
- [ ] At least 3 happy path scenarios
- [ ] At least 5 edge case scenarios
- [ ] Analytics tracking verified

### CI/CD Performance

- [ ] Tests complete in < 5 minutes total
- [ ] No flaky tests (100% pass rate over 10 runs)
- [ ] Tests run on every PR

### Quality Indicators

- [ ] All scenarios pass locally
- [ ] All scenarios pass in CI
- [ ] No false positives or negatives
- [ ] Clear failure messages when tests fail

## Example Scenario Structure

```gherkin
Feature: Full Conversion Workflow
  As a product owner
  I want to verify the complete user conversion journey
  So that I can ensure users successfully experience value

  Background:
    Given I am not logged in

  @smoke @conversion
  Scenario: New user completes first image enhancement
    # Landing
    When I visit "/" with UTM parameters:
      | source   | google        |
      | medium   | cpc           |
      | campaign | launch_2026   |
    Then I should see the hero section
    And I should see "Get Started" button

    # Sign Up
    When I click the "Get Started" button
    Then I should be on the "/auth/signin" page
    When I log in as "New User" with email "newuser@example.com"

    # Token Setup (New user gets welcome tokens)
    Then I should have 100 tokens

    # Action - Image Enhancement
    When I visit "/apps/pixel"
    And I upload an image "test-photo.jpg"
    And I click the "Enhance" button
    Then I should see "Enhancement in progress" text

    # Success
    When I wait for enhancement to complete
    Then I should see my enhanced image
    And I should see a success message
    And I should see 98 tokens remaining

    # Conversion Tracking
    And a "first_enhancement" conversion event should be tracked
    And the session should have UTM parameters:
      | source   | google        |
      | campaign | launch_2026   |
```

## Dependencies

**Existing Infrastructure:**

- ✅ Cucumber + Playwright framework
- ✅ Authentication mock helpers
- ✅ Common step definitions
- ✅ Wait helpers for async operations

**New Dependencies:**

- None (uses existing test infrastructure)

## Timeline Estimate

| Phase                    | Duration  | Status      |
| ------------------------ | --------- | ----------- |
| Setup & Structure        | 30 min    | Not Started |
| Core Scenarios           | 1 hour    | Not Started |
| Edge Cases               | 45 min    | Not Started |
| Analytics Tracking       | 30 min    | Not Started |
| Testing & CI Integration | 30 min    | Not Started |
| **Total**                | **3 hrs** |             |

## Related Issues

- #545 - Conversion funnel tracking (related analytics)
- Authentication feature tests (existing)
- Image enhancement E2E tests (existing)

## Notes

- Follow existing E2E test patterns in the codebase
- Leverage mock helpers from `authentication.steps.ts`
- Use data-testid attributes where available for selectors
- Keep scenarios focused and readable
- Add clear comments explaining complex mocking

---

**Plan Status**: Ready for Implementation
**Next Steps**:

1. Get user approval for plan
2. Create feature file with scenarios
3. Implement step definitions
4. Run tests locally
5. Verify CI integration
