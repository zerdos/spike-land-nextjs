# Implementation Plan: E2E Tests for Full Conversion Workflow

**Issue:** #941
**Complexity:** Medium
**Estimated Files to Modify:** 2 files to create

---

## Summary

This plan outlines the implementation of comprehensive E2E tests for the full conversion workflow on spike.land. Based on analysis of the codebase, the conversion workflow follows this path:

**Visitors → Signups → Enhancements → Purchases**

This workflow is already tracked in the marketing funnel analytics (`/api/admin/marketing/analytics/funnel`) and visualized in the admin dashboard. The E2E tests will verify this critical user journey from landing to purchase.

---

## Conversion Workflow Stages

Based on the `src/app/api/admin/marketing/analytics/funnel/route.ts` implementation:

1. **Visitors** - User lands on the platform (/)
2. **Signups** - User completes sign-in/registration (`/auth/signin`)
3. **Enhancements** - User performs image enhancement action (`/apps/pixel`)
4. **Purchases** - User completes token purchase (`/tokens`)

---

## Files to Create

### 1. `e2e/features/conversion-workflow.feature`

**Purpose:** Define the conversion workflow scenarios in Gherkin/BDD format.

**Content Structure:**

```gherkin
Feature: Full Conversion Workflow
  As a new user
  I want to complete the full conversion workflow
  So that I can use the platform's paid features

  Background:
    Given I am not logged in

  @conversion @critical
  Scenario: Happy path - Complete conversion flow
    # Stage 1: Visitor
    When I visit "/"
    Then the page should load successfully
    And I should see "See the Transformation" heading

    # Stage 2: Signup
    When I click the primary CTA button
    Then I should be redirected to sign-in page
    When I log in as "Conversion User" with email "conversion@example.com"
    Then I should see the user avatar

    # Stage 3: Enhancement
    When I visit "/apps/pixel"
    Then the page should load successfully
    And I should see "AI Photo Restoration" text
    When I have 10 tokens
    And I upload a test image
    And I click the enhance button
    Then I should see a success message

    # Stage 4: Purchase
    When I visit "/tokens"
    Then the page should load successfully
    And I should see token package options
    When I select a token package
    Then I should be redirected to Stripe checkout

  @conversion @critical
  Scenario: Partial conversion - Signup only
    # Test drop-off after signup stage
    When I visit "/"
    And I click the primary CTA button
    Then I should be redirected to sign-in page
    When I log in as "Partial User" with email "partial@example.com"
    Then I should see the user avatar
    # User stops here - doesn't proceed to enhancement

  @conversion @critical
  Scenario: Partial conversion - Signup + Enhancement
    # Test drop-off after enhancement stage
    When I visit "/"
    And I click the primary CTA button
    Then I should be redirected to sign-in page
    When I log in as "Active User" with email "active@example.com"
    Then I should see the user avatar
    When I visit "/apps/pixel"
    And I have 10 tokens
    And I upload a test image
    And I click the enhance button
    Then I should see a success message
    # User stops here - doesn't purchase tokens

  @conversion @error-path
  Scenario: Conversion blocked - Insufficient tokens
    # Test failure path when user has no tokens
    When I log in as "Broke User" with email "broke@example.com"
    And I visit "/apps/pixel"
    And I have 0 tokens
    And I upload a test image
    Then the enhance button should be disabled
    And I should see an insufficient tokens warning

  @conversion @error-path
  Scenario: Conversion blocked - Invalid image upload
    # Test failure path with invalid file
    When I log in as "Test User" with email "test@example.com"
    And I visit "/apps/pixel"
    And I have 10 tokens
    And I attempt to upload an invalid file
    Then I should see "Image upload shows validation error" message
```

### 2. `e2e/step-definitions/conversion-steps.ts`

**Purpose:** Implement step definitions for conversion workflow scenarios.

**Key Steps to Implement:**

- Image upload handling (already exists in `image-enhancement.steps.ts` - can reuse)
- Token balance mocking (already exists in `common.steps.ts` - can reuse)
- Stripe checkout verification (already exists in `common.steps.ts` - can reuse)
- Token package selection
- Upload invalid file validation

**New Steps Required:**

```typescript
// Token package selection
When("I select a token package", async function(this: CustomWorld) {
  const packageOption = this.page.locator('[data-testid="token-package"]').first();
  await expect(packageOption).toBeVisible();
  await packageOption.click();
});

Then("I should see token package options", async function(this: CustomWorld) {
  const packages = this.page.locator('[data-testid="token-package"]');
  await expect(packages.first()).toBeVisible();
});

// Invalid file upload
When("I attempt to upload an invalid file", async function(this: CustomWorld) {
  // Simulate uploading a non-image file (e.g., .txt file)
  const fileInput = this.page.locator('input[type="file"]');
  await fileInput.setInputFiles({
    name: "test.txt",
    mimeType: "text/plain",
    buffer: Buffer.from("This is not an image"),
  });
  await this.page.waitForTimeout(500);
});

// Test image upload (reuse existing)
When("I upload a test image", async function(this: CustomWorld) {
  // Use existing image upload logic from image-enhancement.steps.ts
  const fileInput = this.page.locator('input[type="file"]');
  await fileInput.setInputFiles("e2e/fixtures/test-image.jpg");
  await this.page.waitForTimeout(500);
});
```

**Reusable Steps (from existing files):**

- `I am not logged in` - authentication.steps.ts
- `I visit "/"` - authentication.steps.ts
- `I should see the user avatar` - authentication.steps.ts
- `I have {int} tokens` - common.steps.ts
- `I click the enhance button` - common.steps.ts
- `I should see a success message` - common.steps.ts
- `the enhance button should be disabled` - common.steps.ts
- `I should see an insufficient tokens warning` - common.steps.ts
- `I should be redirected to Stripe checkout` - common.steps.ts

---

## Integration with CI/CD

### Current E2E Test Execution

The `.github/workflows/ci-cd.yml` already includes E2E test execution:

**Job:** `e2e-tests` (runs after deployment)
**Shard Strategy:** Tests are sharded across 4 parallel jobs for performance
**Database:** Uses E2E-specific database (`DATABASE_URL_E2E`)

### What Needs to Be Done

1. **No CI/CD changes required** - The existing pipeline will automatically discover and run the new `.feature` file
2. **Tagging Strategy:**
   - Use `@conversion` tag for all conversion workflow tests
   - Use `@critical` tag for full happy-path scenarios
   - Use `@error-path` tag for failure scenarios
3. **Test Execution:**
   - Tests will run in CI/CD after Vercel preview deployment
   - Tests will use mocked authentication (via `authentication.steps.ts`)
   - Tests will use mocked API responses for tokens and Stripe

---

## Testing Considerations

### Success Scenarios

1. **Full Conversion:** Visitor → Signup → Enhancement → Purchase ✅
2. **Partial Conversions:** Test each drop-off point
   - Visitor → Signup only
   - Visitor → Signup → Enhancement only

### Failure Scenarios

1. **Insufficient Tokens:** User attempts enhancement without tokens
2. **Invalid File Upload:** User uploads non-image file
3. **Network Errors:** Simulate API failures (can be added later)

### Edge Cases

1. **Already Authenticated User:** User starts at later stage
2. **Multiple Enhancements:** User performs multiple enhancements before purchase
3. **Back Navigation:** User navigates back through funnel stages

---

## Dependencies

### Existing Test Infrastructure (No Changes Needed)

- ✅ Playwright + Cucumber setup (`e2e/` directory)
- ✅ Authentication mocking (`authentication.steps.ts`)
- ✅ Token balance mocking (`common.steps.ts`)
- ✅ Image upload helpers (`image-enhancement.steps.ts`)
- ✅ Stripe checkout validation (`common.steps.ts`)
- ✅ CI/CD pipeline with E2E execution

### Required Test Fixtures

- ✅ `e2e/fixtures/test-image.jpg` - Already exists

---

## Potential Risks & Mitigations

### Risk 1: Flaky Tests Due to Async Operations

**Mitigation:** Use existing `waitForPageReady` helper and proper `waitForTimeout` calls.

### Risk 2: Stripe Checkout Mock Reliability

**Mitigation:** Use existing Stripe redirect validation from `common.steps.ts` - already battle-tested.

### Risk 3: Test Data Pollution

**Mitigation:** Use unique email addresses per scenario (e.g., `conversion@example.com`, `partial@example.com`).

---

## Out of Scope

The following are explicitly **NOT** included in this implementation:

1. **Unit Tests:** This issue focuses only on E2E tests
2. **Component-Level Tests:** Individual component testing remains separate
3. **Real Stripe Integration:** Tests will mock Stripe checkout (not actual payment processing)
4. **Real OAuth Flow:** Tests will mock authentication (not real OAuth providers)
5. **Analytics Verification:** Tests will not verify that analytics events are tracked
6. **Performance Testing:** This focuses on functional E2E testing only

---

## Implementation Checklist

- [ ] Create `e2e/features/conversion-workflow.feature` with 5 scenarios
- [ ] Create `e2e/step-definitions/conversion-steps.ts` with new step definitions
- [ ] Verify all existing step definitions are reusable
- [ ] Run tests locally with `yarn test:e2e:local`
- [ ] Verify tests pass in CI/CD pipeline
- [ ] Document any new test patterns in `e2e/README.md` (optional)

---

## Acceptance Criteria Verification

✅ **Define the full conversion workflow steps**

- Visitors → Signups → Enhancements → Purchases

✅ **Create a Cucumber/Playwright test suite covering this flow**

- `.feature` file with 5 scenarios (happy path + partial conversions + errors)

✅ **Ensure tests run in CI/CD pipeline**

- No changes needed - existing pipeline will discover new tests

✅ **Verify success scenarios and common failure paths**

- Happy path: Full conversion workflow
- Partial conversions: Drop-off after each stage
- Failure paths: Insufficient tokens, invalid uploads

---

## Notes for Implementation

### Best Practices to Follow

1. **Reuse Existing Steps:** Maximize reuse of step definitions from:
   - `common.steps.ts` (buttons, navigation, assertions)
   - `authentication.steps.ts` (login, logout, session)
   - `image-enhancement.steps.ts` (image uploads, enhancements)

2. **Consistent Naming:** Follow existing pattern:
   - Scenario names: `<Action> - <Expected Outcome>`
   - Step definitions: Use existing patterns from `common.steps.ts`

3. **Test Data Management:**
   - Use descriptive email addresses per scenario
   - Mock token balances appropriately
   - Use existing `test-image.jpg` fixture

4. **Error Handling:**
   - All error scenarios should be tagged with `@error-path`
   - Use existing error validation patterns from `common.steps.ts`

---

## Conclusion

This implementation plan provides a comprehensive approach to testing the full conversion workflow on spike.land. By reusing existing test infrastructure and step definitions, the implementation will be straightforward and maintainable. The tests will integrate seamlessly with the existing CI/CD pipeline without requiring any configuration changes.
