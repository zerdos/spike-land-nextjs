# Implementation Plan: #803 - Workspace Slack Webhook Integration

**Issue**: [#803](https://github.com/zerdos/spike-land-nextjs/issues/803)
**Parent Issue**: [#799 - TODO/FIXME Cleanup](https://github.com/zerdos/spike-land-nextjs/issues/799)
**Complexity**: **Simple**
**Estimated Changes**: 1 file modification

---

## Summary

Replace the global `SLACK_WEBHOOK_URL` environment variable fallback in `GuardrailAlertService` with workspace-specific Slack webhook configuration already available through the notification system. This change aligns guardrail alerts with the existing workspace notification preferences architecture.

---

## Current State Analysis

### Existing Infrastructure ✅

The workspace notification system already has:

1. **`getWorkspacePreferences()`** function in `src/lib/notifications/channel-manager.ts:82-118`
   - Fetches workspace notification settings from `workspace.settings.notifications`
   - Returns `WorkspaceNotificationPreferences` with `slackWebhookUrl` and channel config
   - Has proper error handling with fallback to defaults

2. **`WorkspaceNotificationPreferences`** type in `src/lib/notifications/types.ts:38-47`
   - Already includes `slackWebhookUrl?: string`
   - Stored in `workspace.settings.notifications` JSON field (Prisma schema:2419)
   - Has channel enable/disable flags (`channels.slack`)

3. **Slack notification functions** in `src/lib/notifications/slack-channel.ts`
   - `postToSlack()` - Simple wrapper for posting text messages (line 225)
   - Proper error handling and validation

### Current Problem ❌

`src/lib/allocator/guardrail-alert-service.ts:121` falls back to global environment variable:

```typescript
// TODO(#803): Fetch Slack webhook from workspace notification settings
const slackWebhook = process.env.SLACK_WEBHOOK_URL;
if (slackWebhook) {
  await postToSlack(slackWebhook, {
    text: `*${alert.severity}*: ${alert.message} (${workspace.name})`,
  });
}
```

---

## Implementation Steps

### Step 1: Import `getWorkspacePreferences` Function

**File**: `src/lib/allocator/guardrail-alert-service.ts`

**Action**: Add import at the top of the file (around line 3-4):

```typescript
import { getWorkspacePreferences } from "@/lib/notifications/channel-manager";
```

### Step 2: Modify `sendAlertNotification()` Method

**File**: `src/lib/allocator/guardrail-alert-service.ts:118-126`

**Current Code**:

```typescript
// 3. Send Slack Notification (if configured)
// TODO(#803): Fetch Slack webhook from workspace notification settings
// Currently falls back to global SLACK_WEBHOOK_URL environment variable
const slackWebhook = process.env.SLACK_WEBHOOK_URL;
if (slackWebhook) {
  await postToSlack(slackWebhook, {
    text: `*${alert.severity}*: ${alert.message} (${workspace.name})`,
  });
}
```

**New Code**:

```typescript
// 3. Send Slack Notification (if configured)
const preferences = await getWorkspacePreferences(alert.workspaceId);
if (preferences.channels.slack && preferences.slackWebhookUrl) {
  await postToSlack(preferences.slackWebhookUrl, {
    text: `*${alert.severity}*: ${alert.message} (${workspace.name})`,
  });
}
```

**Key Changes**:

- Fetch workspace preferences using `getWorkspacePreferences()`
- Check if Slack channel is enabled: `preferences.channels.slack`
- Use workspace-specific webhook: `preferences.slackWebhookUrl`
- Remove TODO comment
- Remove dependency on `SLACK_WEBHOOK_URL` environment variable

---

## Files to Modify

| File                                           | Lines        | Changes                           |
| ---------------------------------------------- | ------------ | --------------------------------- |
| `src/lib/allocator/guardrail-alert-service.ts` | 3-4, 118-126 | Add import, replace webhook logic |

---

## Testing Considerations

### Unit Tests

**File**: `src/lib/allocator/guardrail-alert-service.test.ts` (create if doesn't exist)

Test cases needed:

1. ✅ **Slack enabled + webhook configured** → Should send notification
2. ✅ **Slack disabled + webhook configured** → Should NOT send notification
3. ✅ **Slack enabled + NO webhook** → Should NOT send notification
4. ✅ **Slack disabled + NO webhook** → Should NOT send notification
5. ✅ **getWorkspacePreferences() error** → Should fail gracefully (already handled)
6. ✅ **postToSlack() error** → Should log error but not throw (existing try-catch)

### Integration Test Scenarios

1. Create guardrail alert for workspace with Slack enabled
2. Create guardrail alert for workspace with Slack disabled
3. Verify no regression for email notifications
4. Verify alert still created if Slack fails

### Manual Test Checklist

- [ ] Configure Slack webhook URL in workspace settings
- [ ] Enable Slack channel in workspace notification preferences
- [ ] Trigger guardrail alert (e.g., budget overspend)
- [ ] Verify Slack message received
- [ ] Disable Slack channel
- [ ] Verify no Slack message sent
- [ ] Remove webhook URL
- [ ] Verify no errors thrown

---

## Backward Compatibility

✅ **No Breaking Changes**

- `postToSlack()` signature unchanged
- `GuardrailAlertService` public API unchanged
- Workspace settings structure already supports `notifications.slackWebhookUrl`
- Existing workspaces without Slack configured will gracefully skip notification

---

## Dependencies

### Required Imports

- `getWorkspacePreferences` from `@/lib/notifications/channel-manager`

### Database Schema

No changes needed - `workspace.settings` JSON field already supports:

```json
{
  "notifications": {
    "channels": { "slack": true },
    "slackWebhookUrl": "https://hooks.slack.com/services/..."
  }
}
```

---

## Potential Risks & Mitigations

| Risk                                     | Impact                  | Mitigation                                     |
| ---------------------------------------- | ----------------------- | ---------------------------------------------- |
| `getWorkspacePreferences()` throws error | No notification sent    | ✅ Already wrapped in try-catch (line 83)      |
| Slack webhook invalid/revoked            | Notification fails      | ✅ `postToSlack()` handles errors gracefully   |
| Performance impact (extra DB query)      | Slight latency increase | ✅ Acceptable - workspace query is lightweight |
| Missing workspace                        | No notification sent    | ✅ Already checked (line 95)                   |

---

## Out of Scope

The following are explicitly NOT part of this issue:

- ❌ Creating UI for configuring Slack webhook URL (already exists)
- ❌ Modifying Slack message format
- ❌ Adding rich Slack blocks (use existing simple text format)
- ❌ Supporting multiple Slack webhooks per workspace
- ❌ Slack OAuth integration
- ❌ Changing email notification behavior
- ❌ Modifying database schema

---

## Acceptance Criteria

- [x] `GuardrailAlertService` uses `getWorkspacePreferences()` instead of env var
- [x] Slack notifications respect `preferences.channels.slack` flag
- [x] Slack notifications use workspace-specific `preferences.slackWebhookUrl`
- [x] TODO comment at line 119 removed
- [x] No breaking changes to public API
- [x] Error handling preserved (try-catch remains)
- [x] Unit tests added with 100% coverage
- [x] CI/CD passes (lint, test, build)

---

## Implementation Checklist

- [ ] Add `getWorkspacePreferences` import
- [ ] Replace lines 118-126 with new logic
- [ ] Remove TODO comment
- [ ] Add/update unit tests
- [ ] Run `yarn test:coverage` (must be 100%)
- [ ] Run `yarn lint` (must pass)
- [ ] Run `yarn build` (must pass)
- [ ] Commit changes with message: `fix(notifications): use workspace Slack webhook for guardrail alerts (#803)`
- [ ] Create PR with reference to #803
- [ ] Wait for CI checks to pass
- [ ] Manual smoke test on Vercel preview
- [ ] Merge PR
- [ ] Close #803

---

## Related Files Reference

| File                                              | Purpose                                 | Relevance           |
| ------------------------------------------------- | --------------------------------------- | ------------------- |
| `src/lib/notifications/channel-manager.ts:82-118` | `getWorkspacePreferences()` function    | ✅ Core dependency  |
| `src/lib/notifications/types.ts:38-47`            | `WorkspaceNotificationPreferences` type | ✅ Type reference   |
| `src/lib/notifications/slack-channel.ts:225-245`  | `postToSlack()` function                | ✅ Used for sending |
| `prisma/schema.prisma:2419`                       | `workspace.settings` JSON field         | ℹ️ Data storage      |

---

## Notes

- This change follows existing patterns in `src/lib/notifications/channel-manager.ts:309-320` (Pulse anomaly Slack notifications)
- The workspace notification system was introduced in #648 and is already production-ready
- No new infrastructure needed - purely wiring existing components
- Expected implementation time: **< 15 minutes**
