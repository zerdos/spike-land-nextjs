# Implementation Plan for Issue #920: Ralph Script ENOENT Errors

## Issue Summary

The Ralph orchestrator is failing to sync worktrees with main, encountering `spawnSync /bin/sh ENOENT` errors when executing git commands via Node.js `execSync`. This is preventing the worktree synchronization from completing successfully.

**Root Cause**: All `execSync` calls in the Ralph scripts are missing the `shell: true` option, which causes Node.js to fail when trying to locate the shell executable on certain systems (particularly newer macOS versions like Sequoia).

**Error**: `ENOENT` means "Error NO ENTry" - the system cannot find `/bin/sh`. This happens because:

1. Node.js `execSync` doesn't explicitly specify a shell by default in all environments
2. The shell resolution can fail on newer macOS or restricted environments
3. Without `shell: true`, Node.js tries to spawn the command directly without going through the shell

**Security Note**: The Ralph scripts intentionally use `execSync` with fully controlled inputs (validated ticket IDs, branch names). All inputs are validated before use and there is no user input or external data being interpolated into commands. The scripts include security comments documenting this (see worktree-manager.ts:5-8 and worktree-pool.ts:14-16).

## Acceptance Criteria

- [ ] All `execSync` calls include `shell: true` in their options
- [ ] Worktree sync operations complete without ENOENT errors
- [ ] No regressions in existing Ralph functionality
- [ ] All affected files are updated consistently

## Files to Modify

### 1. `scripts/ralph-local/worktree-manager.ts`

**Lines to update**: Multiple `execSync` calls throughout the file (13 total)

**Changes needed**:

- Line 74: `git fetch origin main` - add `shell: true`
- Line 83: `git worktree add` - add `shell: true`
- Line 95: `yarn install --immutable` - add `shell: true`
- Line 116: `git worktree add` (reuse) - add `shell: true`
- Line 160: `git worktree remove` - add `shell: true`
- Line 181: `git worktree prune` - add `shell: true`
- Line 204: `git fetch origin main` (in syncWorktreeWithMain) - add `shell: true`
- Line 212: `git merge origin/main` - add `shell: true`
- Line 229: `git status --porcelain` - add `shell: true`
- Line 255: `git worktree list --porcelain` - add `shell: true`
- Line 301: `git rev-parse --abbrev-ref HEAD` - add `shell: true`
- Line 317: `git status --porcelain` - add `shell: true`
- Line 345: `git push -u origin` - add `shell: true`

**Pattern**: Add `shell: true` to the options object for each `execSync` call

**Example transformation**:

```typescript
// Before
execSync("git fetch origin main", {
  cwd: config.workDir,
  encoding: "utf-8",
  timeout: 60000,
  stdio: "pipe",
});

// After
execSync("git fetch origin main", {
  cwd: config.workDir,
  encoding: "utf-8",
  timeout: 60000,
  stdio: "pipe",
  shell: true,
});
```

### 2. `scripts/ralph-local/worktree-pool.ts`

**Lines to update**: All `execSync` calls in the file (16 total)

**Changes needed**:

- Line 89: `git status --porcelain` - add `shell: true`
- Line 130: `git worktree remove` - add `shell: true`
- Line 139: `git worktree prune` - add `shell: true`
- Line 150: `git branch -D` - add `shell: true`
- Line 162: `git fetch origin main` - add `shell: true`
- Line 170: `git worktree add -b` - add `shell: true`
- Line 179: `yarn install --immutable` - add `shell: true`
- Line 194: `git worktree remove` (cleanup) - add `shell: true`
- Line 304: `git branch -m` - add `shell: true`
- Line 315: `git worktree prune` - add `shell: true`
- Line 324: `git status` - add `shell: true`
- Line 350: `git worktree prune` - add `shell: true`
- Line 462: `git worktree remove` (cleanup pool) - add `shell: true`
- Line 481: `git worktree prune` - add `shell: true`
- Line 493: `git branch --list` - add `shell: true`
- Line 505: `git branch -D` - add `shell: true`

### 3. `scripts/ralph-local/issue-sync.ts`

**Action required**: Search for all `execSync` calls and add `shell: true`

### 4. `scripts/ralph-local/ticket-router.ts`

**Action required**: Search for all `execSync` calls and add `shell: true`

### 5. `scripts/ralph-local/pr-manager.ts`

**Action required**: Search for all `execSync` calls and add `shell: true`

## Implementation Steps

1. **Phase 1: Update worktree-manager.ts**
   - Add `shell: true` to all 13 `execSync` calls
   - Ensure consistent formatting
   - Verify no calls were missed

2. **Phase 2: Update worktree-pool.ts**
   - Add `shell: true` to all 16 `execSync` calls
   - Pay special attention to the pool management functions
   - Verify cleanup functions are updated

3. **Phase 3: Update remaining files**
   - Search for `execSync` in issue-sync.ts, ticket-router.ts, and pr-manager.ts
   - Add `shell: true` to each occurrence
   - Maintain consistency across all files

4. **Phase 4: Verification**
   - Run the Ralph orchestrator to verify sync operations work
   - Test worktree creation and pool management
   - Ensure no ENOENT errors occur
   - Verify all git commands execute successfully

## Testing Considerations

### Manual Testing

1. Run Ralph orchestrator: `yarn ralph:local`
2. Verify worktree sync operations complete without errors
3. Test pool creation and warm worktree acquisition
4. Verify git commands execute in worktrees

### Edge Cases

- Empty worktree directories
- Stale worktrees that need cleanup
- Pool replenishment after acquisition
- Merge conflicts during sync

### Success Criteria

- No `spawnSync /bin/sh ENOENT` errors in logs
- Worktree sync completes with "âœ… Synced with main" message
- All git operations complete successfully
- Pool management functions work correctly

## Potential Risks

### Low Risk

- Adding `shell: true` is a standard fix for this issue
- No logic changes, only option additions
- Backwards compatible with existing functionality

### Mitigation

- Test on multiple systems (macOS, Linux if applicable)
- Verify with both fresh worktrees and existing worktrees
- Check that error handling still works correctly

## Dependencies

None. This is a pure bug fix with no external dependencies.

## Out of Scope

- Refactoring to use `execFile` instead of `execSync` (would require major refactor, separate task)
- Adding retry logic for git operations (separate enhancement)
- Improving error messages (separate enhancement)
- Creating a shared utility wrapper (could be done in a follow-up)

## Security Considerations

The Ralph scripts use `execSync` with controlled inputs only:

- Ticket IDs are validated with regex: `/^#\d+$/` (worktree-manager.ts:19-21)
- Branch names follow strict format: `ralph/<digits>` (worktree-manager.ts:339-342)
- Pool indices are validated integers (worktree-pool.ts:27-29)
- No user input or external data is interpolated into commands
- All commands use literal strings or validated variables

This pattern is documented in the security notes at the top of both files.

## Notes

- This is a known issue with Node.js `child_process.execSync` on newer macOS systems
- The `shell: true` option explicitly tells Node.js to spawn commands through the system shell
- All Ralph scripts use `execSync` for git and yarn commands, so this fix needs to be applied consistently
- The fix should be straightforward and low-risk since it only adds an option without changing logic

## Complexity

**Simple** - This is a straightforward fix requiring only the addition of `shell: true` to existing `execSync` calls throughout 5 files. No logic changes or refactoring needed.
