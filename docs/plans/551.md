# Implementation Plan: #551 - Variant Generator

**Issue:** [Story] ORB-060: Implement Variant Generator
**Parent Epic:** #520 (Creative Factory)
**Complexity:** Complex
**Estimated Files:** 15-20 files (create/modify)

---

## Summary

Build an AI-powered variant generator that creates ad copy variations, image suggestions, and A/B test variants from seed content. This feature is part of the Creative Factory epic (Layer 6) in Phase 4 (Scale).

The variant generator will:

1. Generate multiple copy variations with different tones, lengths, and CTAs
2. Provide AI image suggestions based on copy and target audience
3. Create A/B test variants with statistical significance calculators
4. Display variant comparison views with predicted performance scores
5. Support batch generation for multiple ad formats

---

## Architecture Overview

### Data Flow

```
Seed Content (Brief) → AI Generation → Variants → Scoring → A/B Testing → Analytics
```

### Key Components

1. **Backend Services** (src/lib/variant-generator/)
   - Copy variation generation (Claude API)
   - Image suggestion service (Gemini API)
   - Variant scoring model
   - Statistical significance calculator

2. **API Routes** (src/app/api/variant-generator/)
   - Generate copy variants
   - Generate image suggestions
   - Create A/B tests
   - Fetch variant analytics

3. **Database Models** (Prisma schema extensions)
   - AdCreativeVariant (already exists, extend)
   - VariantPerformancePrediction (new)
   - VariantGenerationJob (new)

4. **UI Components** (src/components/admin/marketing/variant-generator/)
   - Variant generator form
   - Variant comparison view
   - A/B test creator
   - Performance prediction dashboard

---

## Database Schema Changes

### New Models

```prisma
// Variant generation jobs for async processing
model VariantGenerationJob {
  id                String                @id @default(cuid())
  workspaceId       String
  briefId           String?               // Optional link to CampaignBrief
  seedContent       String                // Original content to generate variants from
  targetAudience    Json                  // Target audience parameters
  variationTypes    String[]              // ["tone", "length", "cta", "emoji"]
  requestedCount    Int                   // How many variants requested
  status            JobStatus
  progress          Int                   @default(0)
  errorMessage      String?
  createdAt         DateTime              @default(now())
  completedAt       DateTime?

  workspace         Workspace             @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  variants          AdCreativeVariant[]

  @@index([workspaceId])
  @@index([status])
  @@map("variant_generation_jobs")
}

// Performance predictions for variants
model VariantPerformancePrediction {
  id                String                @id @default(cuid())
  variantId         String                @unique
  predictedCTR      Float                 // Predicted click-through rate
  predictedER       Float                 // Predicted engagement rate
  predictedCR       Float                 // Predicted conversion rate
  confidenceScore   Float                 // 0-100, AI confidence in prediction
  factorsAnalyzed   Json                  // What factors contributed to prediction
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  variant           AdCreativeVariant     @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@map("variant_performance_predictions")
}
```

### Schema Extensions

```prisma
// Extend existing AdCreativeVariant model
model AdCreativeVariant {
  // ... existing fields ...

  // New fields for variant generation
  generationJobId   String?
  seedContent       String?               // Original content this was generated from
  variationType     String?               // "tone", "length", "cta", "emoji", "composite"
  aiPrompt          String?               // Prompt used to generate this variant
  aiModel           String?               // Model used (e.g., "claude-sonnet-4.5")
  tone              String?               // "professional", "casual", "urgent", "friendly"
  targetLength      Int?                  // Character count target

  generationJob     VariantGenerationJob? @relation(fields: [generationJobId], references: [id])
  performancePrediction VariantPerformancePrediction?

  @@index([generationJobId])
}
```

---

## Implementation Phases

### Phase 1: Foundation (Backend Services)

**Files to Create:**

1. **src/lib/variant-generator/copy-generator.ts**
   - `generateCopyVariants(params)` - Main copy generation function
   - Uses Claude API with prompt engineering for brand voice
   - Supports tone variations: professional, casual, urgent, friendly, playful
   - Supports length variations: short (100-140 chars), medium (140-200), long (200-280)
   - Supports CTA variations: action-oriented, question-based, urgency-driven
   - Returns structured variants with metadata

2. **src/lib/variant-generator/copy-generator.test.ts**
   - Test copy generation with different parameters
   - Mock Claude API responses
   - Validate output structure
   - Test error handling

3. **src/lib/variant-generator/image-suggester.ts**
   - `suggestImagesForCopy(params)` - Image suggestion service
   - Integrates with existing Gemini client (src/lib/ai/gemini-client.ts)
   - Analyzes copy to suggest visual themes
   - Returns image generation prompts based on copy + audience
   - Optionally triggers actual image generation

4. **src/lib/variant-generator/image-suggester.test.ts**
   - Test image suggestion logic
   - Mock Gemini API responses
   - Validate prompt quality

5. **src/lib/variant-generator/variant-scorer.ts**
   - `scoreVariant(variant, historicalData)` - Performance scoring model
   - Analyzes historical ad performance data
   - Calculates predicted CTR, engagement rate, conversion rate
   - Uses simple ML approach (feature extraction + weighted scoring)
   - Returns confidence score (0-100)

6. **src/lib/variant-generator/variant-scorer.test.ts**
   - Test scoring algorithm
   - Test with various historical data patterns
   - Validate score ranges

7. **src/lib/variant-generator/ab-test-calculator.ts**
   - `calculateSignificance(variantA, variantB)` - Statistical significance
   - Chi-square test for A/B testing
   - Confidence intervals
   - Sample size recommendations
   - Extends existing A/B test types (src/types/ab-test.ts)

8. **src/lib/variant-generator/ab-test-calculator.test.ts**
   - Test statistical calculations
   - Validate significance thresholds
   - Test edge cases (low sample sizes)

9. **src/lib/variant-generator/index.ts**
   - Exports all variant generator functions
   - Type definitions and interfaces

**Files to Modify:**

10. **prisma/schema.prisma**
    - Add VariantGenerationJob model
    - Add VariantPerformancePrediction model
    - Extend AdCreativeVariant model

11. **src/types/variant-generator.ts** (new)
    - TypeScript interfaces for variant generation
    - VariantGenerationParams
    - CopyVariant
    - ImageSuggestion
    - VariantScore
    - BatchGenerationRequest

---

### Phase 2: API Routes

**Files to Create:**

12. **src/app/api/variant-generator/copy/route.ts**
    - POST `/api/variant-generator/copy` - Generate copy variants
    - Request body: `{ seedContent, tone[], length[], ctaStyle[], count, targetAudience }`
    - Returns: `{ jobId, status, variants[] }`
    - Uses async job processing for large batches

13. **src/app/api/variant-generator/copy/route.test.ts**
    - Test copy generation endpoint
    - Test validation
    - Test error responses

14. **src/app/api/variant-generator/images/route.ts**
    - POST `/api/variant-generator/images` - Generate image suggestions
    - Request body: `{ copyVariantId, targetAudience, generateActual }`
    - Returns: `{ suggestions[], generatedImages[] }`

15. **src/app/api/variant-generator/images/route.test.ts**
    - Test image suggestion endpoint

16. **src/app/api/variant-generator/score/route.ts**
    - POST `/api/variant-generator/score` - Score variants
    - Request body: `{ variantIds[] }`
    - Returns: `{ scores[] }` with predictions

17. **src/app/api/variant-generator/score/route.test.ts**
    - Test scoring endpoint

18. **src/app/api/variant-generator/batch/route.ts**
    - POST `/api/variant-generator/batch` - Batch generation
    - Generates variants across multiple ad formats
    - Request body: `{ briefId, formats[], variations }`
    - Returns: `{ jobId, estimatedTime }`

19. **src/app/api/variant-generator/batch/route.test.ts**
    - Test batch generation

20. **src/app/api/variant-generator/jobs/[jobId]/route.ts**
    - GET `/api/variant-generator/jobs/:jobId` - Check job status
    - Returns: `{ id, status, progress, variants[], error }`

21. **src/app/api/variant-generator/jobs/[jobId]/route.test.ts**
    - Test job status endpoint

---

### Phase 3: UI Components

**Files to Create:**

22. **src/components/admin/marketing/variant-generator/VariantGeneratorForm.tsx**
    - Main form for generating variants
    - Input: seed content (text area)
    - Options: tone, length, CTA style, count
    - Target audience selector (links to CampaignBrief if available)
    - Submit → starts generation job

23. **src/components/admin/marketing/variant-generator/VariantGeneratorForm.test.tsx**
    - Test form interactions
    - Test validation

24. **src/components/admin/marketing/variant-generator/VariantList.tsx**
    - Displays generated variants
    - Shows copy text, tone, length, predicted score
    - Actions: select for A/B test, edit, delete, generate images

25. **src/components/admin/marketing/variant-generator/VariantList.test.tsx**
    - Test variant display
    - Test actions

26. **src/components/admin/marketing/variant-generator/VariantComparisonView.tsx**
    - Side-by-side comparison of variants
    - Shows predicted performance scores
    - Visual diff highlighting (tone, length, CTA differences)
    - Recommendation: which variant to use

27. **src/components/admin/marketing/variant-generator/VariantComparisonView.test.tsx**
    - Test comparison logic
    - Test visual rendering

28. **src/components/admin/marketing/variant-generator/AbTestCreator.tsx**
    - Create A/B test from selected variants
    - Configure test parameters (duration, sample size)
    - Show statistical significance calculator
    - Preview test setup

29. **src/components/admin/marketing/variant-generator/AbTestCreator.test.tsx**
    - Test A/B test creation

30. **src/components/admin/marketing/variant-generator/PerformanceDashboard.tsx**
    - Shows predicted vs actual performance
    - Charts for CTR, engagement, conversion rates
    - Winner recommendation based on statistical significance

31. **src/components/admin/marketing/variant-generator/PerformanceDashboard.test.tsx**
    - Test dashboard rendering

32. **src/components/admin/marketing/variant-generator/ImageSuggestionPanel.tsx**
    - Shows AI-generated image suggestions for a copy variant
    - Preview image generation prompts
    - Option to generate actual images (uses existing image generation flow)

33. **src/components/admin/marketing/variant-generator/ImageSuggestionPanel.test.tsx**
    - Test image suggestions

---

### Phase 4: Page Integration

**Files to Create:**

34. **src/app/admin/marketing/variant-generator/page.tsx**
    - Main page for variant generator
    - Layout: seed content form + variant list + comparison view
    - Integrates all components

35. **src/app/admin/marketing/variant-generator/[jobId]/page.tsx**
    - Job status page (for batch operations)
    - Shows progress, completed variants
    - Auto-refresh until complete

**Files to Modify:**

36. **src/components/admin/marketing/MarketingLayout.tsx**
    - Add "Variant Generator" tab to marketing navigation

37. **src/app/admin/marketing/layout.tsx**
    - Ensure variant generator route is accessible

---

### Phase 5: Integration & Polish

**Files to Create:**

38. **src/lib/variant-generator/brand-voice-adapter.ts**
    - Analyzes workspace brand profile
    - Adapts generation prompts to match brand voice
    - Uses BrandProfile from database

39. **src/lib/variant-generator/brand-voice-adapter.test.ts**
    - Test brand voice adaptation

**Files to Modify:**

40. **src/lib/calendar/ai-content-service.ts**
    - Integrate variant generator for content suggestions
    - Use variant generator when creating calendar content suggestions

41. **src/types/ab-test.ts**
    - Extend with variant generator types
    - Add performance prediction types

42. **prisma/seed.ts**
    - Add sample variant generation jobs for development
    - Add sample performance predictions

---

## API Endpoints Summary

| Method | Endpoint                             | Purpose                    |
| ------ | ------------------------------------ | -------------------------- |
| POST   | `/api/variant-generator/copy`        | Generate copy variants     |
| POST   | `/api/variant-generator/images`      | Generate image suggestions |
| POST   | `/api/variant-generator/score`       | Score variants             |
| POST   | `/api/variant-generator/batch`       | Batch generation           |
| GET    | `/api/variant-generator/jobs/:jobId` | Check job status           |

---

## Dependencies

### External APIs

- **Claude API** (Anthropic) - Copy generation with brand voice
- **Gemini API** (Google) - Image analysis and suggestions
- **Existing services:**
  - `src/lib/ai/gemini-client.ts` - Already configured
  - `src/lib/calendar/ai-content-service.ts` - Pattern to follow

### Database

- Prisma migrations for new models
- Seed data for testing

### UI Libraries

- shadcn/ui components (already in use)
- Recharts for performance charts (already in use in marketing)
- Radix UI primitives (already in use)

---

## Testing Strategy

### Unit Tests (100% coverage required)

- All lib functions must have .test.ts files
- Mock external API calls
- Test edge cases and error handling

### Integration Tests

- API route tests with supertest
- Database integration tests

### E2E Tests

- Create Cucumber feature file: `e2e/features/variant-generator.feature`
- Test complete flow: seed → generate → compare → A/B test

---

## Acceptance Criteria Mapping

| Acceptance Criterion                                                      | Implementation                                    |
| ------------------------------------------------------------------------- | ------------------------------------------------- |
| Generate multiple copy variations with different tones, lengths, and CTAs | `copy-generator.ts` + API routes                  |
| AI image suggestions based on copy and target audience                    | `image-suggester.ts` + integration with Gemini    |
| A/B test variant creation with statistical significance calculators       | `ab-test-calculator.ts` + AbTestCreator component |
| Variant comparison view with predicted performance scores                 | `VariantComparisonView.tsx` + `variant-scorer.ts` |
| Batch generation for creating variants across multiple ad formats         | `batch` API route + async job processing          |

---

## Technical Notes & Decisions

### 1. Claude API Usage

- Use `claude-sonnet-4.5` for copy generation (high quality, cost-effective)
- Prompt engineering templates for each tone/style
- System prompt includes brand voice from BrandProfile

### 2. Image Generation

- Leverage existing Gemini integration (gemini-client.ts)
- Image suggestions are prompts first, actual generation is optional
- Reuse image generation flow from pixel pipeline

### 3. Variant Scoring Model

- **Phase 1 (MVP):** Simple weighted scoring based on heuristics
  - Copy length vs platform optimal
  - CTA presence and position
  - Tone match with audience
  - Historical performance patterns (if data exists)
- **Future:** Train ML model on actual performance data

### 4. Statistical Significance

- Use chi-square test for A/B testing
- Minimum sample size: 100 per variant
- Confidence level: 95% (configurable)
- Early stopping if significance reached before planned duration

### 5. Batch Processing

- Use existing job queue pattern (similar to image enhancement jobs)
- Progress tracking in database
- Webhook/polling for status updates

---

## Risks & Mitigations

### Risk 1: API Cost Overruns

**Mitigation:**

- Rate limiting on variant generation (max 10 variants per request)
- Cache frequently used generation patterns
- Provide token cost estimation before generation

### Risk 2: Poor Quality Variants

**Mitigation:**

- Allow manual editing of generated variants
- Provide feedback mechanism to improve prompts
- Start with conservative generation (fewer variants, test quality)

### Risk 3: Performance Predictions Inaccuracy

**Mitigation:**

- Clearly label predictions as estimates
- Show confidence scores
- Collect actual performance data to refine model over time

### Risk 4: Complex UI State Management

**Mitigation:**

- Use React Server Components where possible
- Keep client state minimal (form state, selections only)
- Rely on database for job status (poll via API)

---

## Future Enhancements (Out of Scope for #551)

1. **Multi-language variant generation**
   - Generate variants in different languages
   - Requires additional translation API

2. **Video ad variant generation**
   - Generate video scripts
   - Suggest video scenes based on copy

3. **Automated variant deployment**
   - Directly publish winning variants to ad platforms
   - Requires marketing API integrations

4. **Continuous learning model**
   - Train scoring model on actual performance data
   - Improve predictions over time

---

## Migration Strategy

### Database Migration

```bash
# Generate migration
npx prisma migrate dev --name add_variant_generator_models

# Apply to staging
npx prisma migrate deploy
```

### Rollout Plan

1. Deploy backend services + API routes first (no UI)
2. Test API endpoints manually
3. Deploy UI components to staging
4. Beta test with limited users
5. Full production release

---

## Testing Checklist

Before marking as complete:

- [ ] All unit tests pass with 100% coverage
- [ ] API routes return expected responses
- [ ] Database migrations run successfully
- [ ] UI components render without errors
- [ ] E2E tests pass on staging
- [ ] Claude API integration works (real API calls)
- [ ] Gemini API integration works (real API calls)
- [ ] Performance predictions are reasonable
- [ ] A/B test calculations are accurate
- [ ] Batch generation completes within reasonable time (<2 min for 10 variants)
- [ ] No console errors in browser
- [ ] Mobile responsive (marketing admin is desktop-first, but should work on tablet)

---

## Estimated Timeline

- **Phase 1 (Foundation):** 2-3 days
- **Phase 2 (API Routes):** 1-2 days
- **Phase 3 (UI Components):** 2-3 days
- **Phase 4 (Page Integration):** 1 day
- **Phase 5 (Polish & Testing):** 1-2 days

**Total:** 7-11 days

---

## Related Issues

- **Parent:** #520 (Creative Factory Epic)
- **Dependencies:**
  - Database schema must support workspaces (already done)
  - Marketing layout must be accessible (already done)
  - AI services (Gemini, Claude) must be configured

---

## Notes for Implementer

1. **Start with Phase 1** - Get the backend services working first with comprehensive tests
2. **Use existing patterns:**
   - Copy from `ai-content-service.ts` for AI integration patterns
   - Copy from `ab-tests/` components for A/B testing UI
   - Copy from image enhancement jobs for async job processing
3. **Claude API Key:** Ensure `ANTHROPIC_API_KEY` is set in environment
4. **Test Coverage:** Run `yarn test:coverage` frequently - 100% required
5. **Commit Often:** Small, focused commits with descriptive messages
6. **Follow CLAUDE.md:** Especially ticket-driven development and CI/CD verification

---

## Questions & Clarifications Needed

1. **Brand Voice Data:** Do we have existing brand profiles to test against, or should we create sample data?
2. **Historical Performance Data:** Is there existing ad performance data to train the scoring model, or start with heuristics?
3. **Token Budget:** What's the acceptable cost per variant generation? (estimate: $0.01-0.05 per variant)
4. **Image Generation Tier:** Should image suggestions auto-generate images, or just provide prompts? (suggest: prompts only, user can trigger generation)

---

**Plan Status:** Ready for Implementation
**Last Updated:** 2026-01-29
