# Implementation Plan: Issue #939 - Real Platform APIs replacing Stubs

**Issue:** #939
**Title:** Feature: Implement Real Platform APIs replacing Stubs
**Planning Date:** 2026-01-29
**Complexity:** Medium

## Summary

Replace stub/placeholder implementations with real API integrations for social platforms. Currently, TikTok is marked as "not yet implemented" with a stub error message. The existing platforms (YouTube, Facebook, Instagram, Twitter, LinkedIn, Discord) are already implemented with real API calls. This plan focuses on implementing TikTok and ensuring all platforms have proper error handling for rate limiting and authentication.

## Current State Analysis

### Implemented Platforms (Real APIs)

The following platforms already have full API implementations:

- **Twitter** (`src/lib/social/clients/twitter.ts`)
  - Uses Twitter API v2 with OAuth 2.0 PKCE
  - Implements: posts, search, metrics, auth

- **Facebook** (`src/lib/social/clients/facebook.ts`)
  - Uses Facebook Graph API v21.0
  - Implements: posts, pages, metrics, auth, comments

- **Instagram** (`src/lib/social/clients/instagram.ts`)
  - Uses Facebook Graph API (Instagram Business)
  - Implements: posts (with media containers), metrics, comments

- **YouTube** (`src/lib/social/clients/youtube.ts`)
  - Uses YouTube Data API v3 with Google OAuth 2.0
  - Implements: channel info, videos, metrics, auth

- **LinkedIn** (`src/lib/social/clients/linkedin.ts`)
  - Uses LinkedIn Marketing API v2
  - Implements: posts, organization management, auth

- **Discord** (`src/lib/social/clients/discord.ts`)
  - Uses Discord Bot API (bot authentication, not OAuth)
  - Implements: guild management, messages, embeds

### Stub Implementation

- **TikTok** (stub in `src/lib/social/index.ts:60,105`)
  - Currently throws error: "Platform TIKTOK is not yet implemented"
  - No client file exists yet

## Implementation Plan

### Phase 1: TikTok API Research & Setup

#### 1.1 API Documentation Review

- Review TikTok for Developers: https://developers.tiktok.com/
- Identify which API to use:
  - **TikTok Login Kit** (user authentication)
  - **Content Posting API** (for creators)
  - **Display API** (for fetching user data)
- Determine authentication flow (OAuth 2.0)
- Identify required scopes and permissions

#### 1.2 Developer Account Setup

- Create TikTok Developer account
- Register application
- Obtain OAuth credentials (Client ID, Client Secret)
- Configure callback URLs
- Note rate limits and restrictions

**Files to create:**

- None (configuration only)

**Environment variables to add:**

```bash
# TikTok API (Social Posting)
TIKTOK_CLIENT_ID=your-tiktok-client-id
TIKTOK_CLIENT_SECRET=your-tiktok-client-secret
TIKTOK_CALLBACK_URL=https://spike.land/api/social/tiktok/callback
```

### Phase 2: TikTok Client Implementation

#### 2.1 Create TikTok Client Class

Create `src/lib/social/clients/tiktok.ts` implementing `ISocialClient` interface.

**Required methods:**

- `getAuthUrl(redirectUri, state)` - OAuth authorization URL
- `exchangeCodeForTokens(code, redirectUri)` - Token exchange
- `refreshAccessToken(refreshToken)` - Token refresh
- `getAccountInfo()` - User profile data
- `createPost(content, options)` - Post video/content
- `getPosts(limit)` - Fetch user's posts
- `getMetrics()` - Account-level metrics
- `setAccessToken(token)` - Token setter

**Special considerations:**

- TikTok posts require video content (similar to Instagram requiring images)
- Video upload may require multi-step process (upload → process → publish)
- Handle video processing delays with polling/webhooks
- Map TikTok-specific metrics to `SocialMetricsData` format

**Files to create:**

- `src/lib/social/clients/tiktok.ts`
- `src/lib/social/clients/tiktok.test.ts`

#### 2.2 Update Social Client Factory

Modify `src/lib/social/index.ts` to remove TikTok stub and add real implementation.

**Changes:**

```typescript
// Before (line 59-60)
case "TIKTOK":
  throw new Error(`Platform ${platform} is not yet implemented`);

// After
case "TIKTOK": {
  const { TikTokClient } = await import("./clients/tiktok");
  return new TikTokClient(options);
}
```

**Files to modify:**

- `src/lib/social/index.ts` (lines 59-60, 104-105)

### Phase 3: OAuth Callback Routes

#### 3.1 Create TikTok Callback Route

Create API route for OAuth callback handling.

**Implementation:**

- Exchange authorization code for tokens
- Store tokens in database (encrypted)
- Fetch user profile
- Link to workspace/connection
- Handle errors (auth denied, invalid code, etc.)

**Files to create:**

- `src/app/api/social/tiktok/callback/route.ts`
- `src/app/api/social/tiktok/callback/route.test.ts`

**Pattern:** Follow existing patterns from:

- `src/app/api/social/facebook/callback/route.ts`
- `src/app/api/social/twitter/callback/route.ts`

#### 3.2 Create TikTok Connect Route

Create route to initiate OAuth flow.

**Files to create:**

- `src/app/api/social/tiktok/connect/route.ts`

### Phase 4: Rate Limiting & Error Handling

#### 4.1 Implement Rate Limit Handling

Add rate limit detection and retry logic to all platform clients.

**Strategy:**

- Detect 429 (Too Many Requests) responses
- Extract retry-after headers
- Implement exponential backoff
- Add rate limit tracking service

**Files to modify:**

- `src/lib/social/clients/youtube.ts`
- `src/lib/social/clients/facebook.ts`
- `src/lib/social/clients/instagram.ts`
- `src/lib/social/clients/twitter.ts`
- `src/lib/social/clients/linkedin.ts`
- `src/lib/social/clients/tiktok.ts` (new)

**Files to create:**

- `src/lib/social/rate-limiter.ts` (shared rate limit utility)
- `src/lib/social/rate-limiter.test.ts`

#### 4.2 Enhance Authentication Error Handling

Improve error handling for authentication failures.

**Error types to handle:**

- **Token expired** - Trigger refresh flow
- **Invalid token** - Mark connection as invalid, notify user
- **Insufficient permissions** - Log specific missing scopes
- **Account suspended** - Mark connection as suspended
- **API quota exceeded** - Backoff and retry

**Implementation:**

```typescript
export class SocialAuthError extends Error {
  constructor(
    message: string,
    public platform: SocialPlatform,
    public errorType: "expired" | "invalid" | "permissions" | "quota" | "suspended",
    public recoverable: boolean = false,
  ) {
    super(message);
    this.name = "SocialAuthError";
  }
}
```

**Files to create:**

- `src/lib/social/errors.ts`
- `src/lib/social/errors.test.ts`

**Files to modify:**

- All client files to use `SocialAuthError`
- `src/lib/social/token-refresh.ts` (add error type handling)

### Phase 5: Environment Configuration

#### 5.1 Update Environment Documentation

Add TikTok configuration to `.env.example`.

**Files to modify:**

- `.env.example` (add TikTok section after YouTube)

#### 5.2 Add Environment Validation

Ensure environment variables are validated on startup.

**Files to modify:**

- `src/types/env.d.ts` (add TikTok types)
- `scripts/env-check.ts` (add TikTok validation)

### Phase 6: Testing

#### 6.1 Unit Tests

Create comprehensive unit tests for TikTok client.

**Test coverage:**

- OAuth flow (auth URL generation, token exchange)
- Post creation (video upload, processing, publishing)
- Error handling (rate limits, auth errors)
- Token refresh
- Metrics fetching

**Files to create:**

- `src/lib/social/clients/tiktok.test.ts`

#### 6.2 Integration Tests

Add E2E tests for TikTok OAuth flow.

**Files to modify:**

- `e2e/features/social-connections.feature` (add TikTok scenarios)
- `e2e/step-definitions/orbit-social.steps.ts` (add TikTok steps)

#### 6.3 Rate Limit Tests

Test rate limiting behavior across all platforms.

**Files to create:**

- `src/lib/social/rate-limiter.test.ts`
- `src/lib/social/clients/rate-limit-integration.test.ts`

### Phase 7: Documentation

#### 7.1 Update API Reference

Document new TikTok integration.

**Files to modify:**

- `docs/API_REFERENCE.md` (add TikTok endpoints)

#### 7.2 Update Platform Support Matrix

Document which platforms support which features.

**Files to create:**

- `docs/SOCIAL_PLATFORMS.md`

**Content:**

| Platform  | Post | Comment | Like | Metrics | Video | Image |
| --------- | ---- | ------- | ---- | ------- | ----- | ----- |
| Twitter   | ✅   | ✅      | ✅   | ✅      | ❌    | ✅    |
| Facebook  | ✅   | ✅      | ✅   | ✅      | ❌    | ✅    |
| Instagram | ✅   | ✅      | ❌   | ✅      | ❌    | ✅    |
| YouTube   | ❌   | ❌      | ❌   | ✅      | ✅    | ❌    |
| LinkedIn  | ✅   | ❌      | ❌   | ✅      | ❌    | ✅    |
| TikTok    | ✅   | ✅      | ❌   | ✅      | ✅    | ❌    |
| Discord   | ✅   | ❌      | ❌   | ❌      | ❌    | ✅    |

## Data Mapping Requirements

### TikTok → SocialPost Mapping

```typescript
{
  id: video.id,
  platformPostId: video.id,
  platform: "TIKTOK",
  content: video.desc,
  mediaUrls: [video.video.cover_url],
  publishedAt: new Date(video.create_time * 1000),
  url: video.share_url,
  metrics: {
    likes: video.stats.digg_count,
    comments: video.stats.comment_count,
    shares: video.stats.share_count,
    impressions: video.stats.play_count,
  }
}
```

### TikTok → SocialAccountInfo Mapping

```typescript
{
  platformId: user.open_id,
  username: user.username,
  displayName: user.display_name,
  profileUrl: `https://www.tiktok.com/@${user.username}`,
  avatarUrl: user.avatar_url,
  followersCount: user.follower_count,
  followingCount: user.following_count,
}
```

## Backward Compatibility

- **Database schema:** No changes required (SocialPlatform enum already includes TIKTOK)
- **API contracts:** New TikTok client implements existing `ISocialClient` interface
- **Frontend:** No breaking changes (platform dropdown already supports TIKTOK)
- **Existing data:** No migration needed

## Potential Risks & Mitigations

### Risk 1: TikTok API Access Restrictions

**Impact:** High
**Probability:** Medium
**Mitigation:**

- TikTok has strict app review requirements
- May require business verification
- Content Posting API access is restricted to approved creators
- **Fallback:** Implement Display API first (read-only), defer posting to Phase 2

### Risk 2: Video Upload Complexity

**Impact:** High
**Probability:** High
**Mitigation:**

- Video processing can take minutes
- Large files may timeout
- **Solution:** Implement async polling similar to Instagram container status
- Add job queue for long-running uploads

### Risk 3: Rate Limits Vary by Platform

**Impact:** Medium
**Probability:** High
**Mitigation:**

- Each platform has different rate limit rules
- Some use time-based windows, others use quota buckets
- **Solution:** Create platform-specific rate limit strategies
- Store rate limit state in database/cache

### Risk 4: Token Refresh Edge Cases

**Impact:** Medium
**Probability:** Medium
**Mitigation:**

- Some platforms don't return new refresh token on refresh
- Refresh tokens can expire (LinkedIn: 365 days)
- **Solution:** Store refresh token expiry dates
- Proactively refresh before expiration
- Alert users before refresh token expires

## Testing Considerations

### Manual Testing Checklist

- [ ] TikTok OAuth flow completes successfully
- [ ] Access token is encrypted and stored
- [ ] User profile data is fetched correctly
- [ ] Video posts can be created (if approved)
- [ ] Metrics are fetched and mapped correctly
- [ ] Rate limit errors are handled gracefully
- [ ] Token refresh works before expiry
- [ ] Invalid token triggers re-authentication
- [ ] Test with multiple TikTok accounts
- [ ] Test connection deletion and re-connection

### Test Data Requirements

- Valid TikTok developer credentials
- Multiple test TikTok accounts
- Sample videos for upload testing
- Mock API responses for unit tests

## Definition of Done

- [ ] TikTok client fully implements `ISocialClient`
- [ ] OAuth flow works end-to-end
- [ ] Tokens are encrypted and stored securely
- [ ] Rate limiting is implemented for all platforms
- [ ] Authentication errors are properly categorized
- [ ] Unit tests achieve 100% coverage
- [ ] Integration tests pass on CI/CD
- [ ] Documentation is updated
- [ ] `.env.example` includes TikTok credentials
- [ ] Environment validation includes TikTok
- [ ] PR is reviewed and approved
- [ ] All CI/CD checks pass (tests, build, E2E)
- [ ] Manual testing checklist completed

## Files Summary

### Files to Create (11)

1. `src/lib/social/clients/tiktok.ts` - TikTok API client
2. `src/lib/social/clients/tiktok.test.ts` - Unit tests
3. `src/app/api/social/tiktok/callback/route.ts` - OAuth callback
4. `src/app/api/social/tiktok/callback/route.test.ts` - Callback tests
5. `src/app/api/social/tiktok/connect/route.ts` - Initiate OAuth
6. `src/lib/social/rate-limiter.ts` - Shared rate limit utility
7. `src/lib/social/rate-limiter.test.ts` - Rate limiter tests
8. `src/lib/social/errors.ts` - Social auth errors
9. `src/lib/social/errors.test.ts` - Error tests
10. `src/lib/social/clients/rate-limit-integration.test.ts` - Integration tests
11. `docs/SOCIAL_PLATFORMS.md` - Platform support matrix

### Files to Modify (13)

1. `src/lib/social/index.ts` - Remove TikTok stub
2. `src/lib/social/clients/youtube.ts` - Add rate limiting
3. `src/lib/social/clients/facebook.ts` - Add rate limiting
4. `src/lib/social/clients/instagram.ts` - Add rate limiting
5. `src/lib/social/clients/twitter.ts` - Add rate limiting
6. `src/lib/social/clients/linkedin.ts` - Add rate limiting
7. `src/lib/social/token-refresh.ts` - Enhanced error handling
8. `.env.example` - Add TikTok credentials
9. `src/types/env.d.ts` - Add TikTok env types
10. `scripts/env-check.ts` - Add TikTok validation
11. `docs/API_REFERENCE.md` - Document TikTok endpoints
12. `e2e/features/social-connections.feature` - Add TikTok scenarios
13. `e2e/step-definitions/orbit-social.steps.ts` - Add TikTok steps

## Estimated Effort

- **Phase 1 (Research):** 2-4 hours
- **Phase 2 (TikTok Client):** 4-6 hours
- **Phase 3 (OAuth Routes):** 2-3 hours
- **Phase 4 (Rate Limiting):** 4-6 hours
- **Phase 5 (Environment):** 1 hour
- **Phase 6 (Testing):** 3-4 hours
- **Phase 7 (Documentation):** 1-2 hours

**Total:** 17-26 hours (2-3 days for one developer)

## Dependencies

- TikTok Developer Account approval
- Access to TikTok Content Posting API (restricted)
- Valid OAuth credentials from TikTok
- Test TikTok accounts for E2E testing

## Notes

- All existing platforms (YouTube, Facebook, Instagram, Twitter, LinkedIn) already use real APIs
- The only "stub" is TikTok, which throws "not yet implemented" error
- Rate limiting and enhanced auth error handling will benefit all platforms
- Consider implementing TikTok Display API first (read-only) before Content Posting API
- Discord uses bot authentication (not OAuth), so it doesn't need OAuth callback routes
