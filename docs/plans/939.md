# Implementation Plan: Real Platform APIs replacing Stubs

**Issue**: #939
**Type**: Feature Enhancement\
**Complexity**: Complex
**Focus**: Engagement Fetchers (NOT Social Clients)
**Planning Date**: 2026-01-29

---

## ‚ö†Ô∏è Correction: Engagement Fetchers, Not Social Clients

**Previous Plan Scope**: TikTok social client implementation\
**Actual Issue Scope**: Replace stub engagement fetchers with real API calls

The social clients (`src/lib/social/clients/*.ts`) are **already implemented** with real APIs.\
The **stubs** are in `src/lib/social/platform-api/*/engagement-fetcher.ts`.

---

## Summary

Replace stub implementations in four platform engagement fetchers with real API integrations. These fetchers currently return hardcoded zeros for post engagement metrics (likes, comments, shares, impressions, reach) and audience insights (demographics, interests). This is part of the Organic-to-Ad conversion feature (#567).

---

## Current State Analysis

### Stub Implementations (All return zeros)

1. `src/lib/social/platform-api/twitter/engagement-fetcher.ts` - TODO comments, returns zeros
2. `src/lib/social/platform-api/facebook/engagement-fetcher.ts` - TODO comments, returns zeros
3. `src/lib/social/platform-api/linkedin/engagement-fetcher.ts` - TODO comments, returns zeros
4. `src/lib/social/platform-api/tiktok/engagement-fetcher.ts` - TODO comments, returns zeros

### Working Reference Implementations

- `src/lib/social/clients/twitter.ts` - Full Twitter API v2 (for posting/OAuth)
- `src/lib/social/clients/facebook.ts` - Full Facebook Graph API (765 lines)
- `src/lib/social/clients/youtube.ts` - Full YouTube Data API v3 (807 lines)
- Error pattern: `TwitterHttpError` with status codes

### Interface Contract

```typescript
interface PlatformEngagementFetcher {
  platform: SocialPlatform;
  fetchEngagement(postId: string, accessToken: string): Promise<EngagementDataResponse>;
  fetchAudienceInsights(postId: string, accessToken: string): Promise<AudienceInsights>;
}
```

---

## Implementation Phases

### Phase 1: Twitter Engagement Fetcher

**File**: `src/lib/social/platform-api/twitter/engagement-fetcher.ts`

**API**: `GET /2/tweets/:id` with `tweet.fields=public_metrics,organic_metrics`

**Required Scopes**: `tweet.read`, `users.read`\
**Rate Limit**: 75 requests per 15 min

**Note**: `organic_metrics` requires Twitter API Pro ($5,000/month). Gracefully degrade to `public_metrics` only.

---

### Phase 2: Facebook/Instagram Engagement Fetcher

**File**: `src/lib/social/platform-api/facebook/engagement-fetcher.ts`

**API**: `GET /{post-id}/insights?metric=post_impressions,post_engaged_users,...`

**Required Permissions**: `pages_read_engagement`, `pages_read_user_content`, `read_insights`\
**Rate Limit**: 200 calls per hour per user

**Note**: Instagram insights require Business Account linked to Facebook Page.

---

### Phase 3: LinkedIn Engagement Fetcher

**File**: `src/lib/social/platform-api/linkedin/engagement-fetcher.ts`

**API**: `GET /v2/organizationalEntityShareStatistics?q=organizationalEntity&organizationalEntity=urn:li:share:{id}`

**Required Scopes**: `r_organization_social`, `rw_organization_admin`\
**Rate Limit**: 500,000 calls per day (application level)

**Note**: LinkedIn uses URN format (`urn:li:share:123`). Convert if needed.

---

### Phase 4: TikTok Engagement Fetcher

**File**: `src/lib/social/platform-api/tiktok/engagement-fetcher.ts`

**API**: `POST /v2/video/query/` with `fields=[like_count, comment_count, share_count, view_count]`

**Required Scopes**: `video.list`\
**Rate Limit**: 1,000 requests per day

**Note**: Research API (for demographics) is invite-only. Gracefully degrade if unavailable.

---

## Phase 5: Shared Infrastructure

### Error Handling

**New File**: `src/lib/social/platform-api/errors.ts`

```typescript
export class PlatformApiError extends Error {
  constructor(
    public platform: SocialPlatform,
    message: string,
    public code?: string,
    public retryable = false
  ) { ... }
}

export class RateLimitError extends PlatformApiError { ... }
export class AuthenticationError extends PlatformApiError { ... }
export class InsufficientPermissionsError extends PlatformApiError { ... }
```

### Retry Logic

**Update**: `src/lib/social/platform-api/engagement-fetcher-factory.ts`

Add `fetchWithRetry()` method with exponential backoff for rate limits.

---

## Files to Modify/Create

### Core Implementation (4 files)

1. ‚úèÔ∏è `src/lib/social/platform-api/twitter/engagement-fetcher.ts`
2. ‚úèÔ∏è `src/lib/social/platform-api/facebook/engagement-fetcher.ts`
3. ‚úèÔ∏è `src/lib/social/platform-api/linkedin/engagement-fetcher.ts`
4. ‚úèÔ∏è `src/lib/social/platform-api/tiktok/engagement-fetcher.ts`

### New Infrastructure (3 files)

5. ‚ûï `src/lib/social/platform-api/errors.ts`
6. ‚ûï `src/lib/social/platform-api/config.ts` (API base URLs, versions)
7. ‚ûï `src/lib/social/platform-api/__tests__/integration.test.ts`

### Unit Tests (4 files)

8. ‚ûï `src/lib/social/platform-api/twitter/engagement-fetcher.test.ts`
9. ‚ûï `src/lib/social/platform-api/facebook/engagement-fetcher.test.ts`
10. ‚ûï `src/lib/social/platform-api/linkedin/engagement-fetcher.test.ts`
11. ‚ûï `src/lib/social/platform-api/tiktok/engagement-fetcher.test.ts`

### Config Updates (2 files)

12. ‚úèÔ∏è `.env.example` (add TikTok credentials if missing)
13. ‚úèÔ∏è `src/lib/social/platform-api/engagement-fetcher-factory.ts` (retry logic)

---

## Testing Strategy

### Unit Test Requirements

- **100% coverage** (existing project requirement)
- Success cases with valid metrics
- Rate limiting (429) handling
- Authentication errors (401)
- Invalid post ID (404)
- Network errors

### Manual Testing

- [ ] Twitter: Test with real tweet ID + OAuth token
- [ ] Facebook: Test with page post ID + Page token
- [ ] LinkedIn: Test with share URN + organization token
- [ ] TikTok: Test with video ID + creator token
- [ ] Verify rate limit retry behavior
- [ ] Verify error messages are user-friendly

---

## Risks & Mitigations

### 1. API Access Requirements ‚ö†Ô∏è

**Risk**: Some metrics require elevated access

- Twitter `organic_metrics`: API Pro plan ($5,000/month)
- TikTok Research API: Invite-only

**Mitigation**: Graceful degradation - use available metrics, document limitations

### 2. Rate Limiting Complexity üö®

**Risk**: Each platform has different rate limit structures

**Mitigation**: Platform-specific retry strategies, exponential backoff with jitter

### 3. Token Expiry ‚è∞

**Risk**: Tokens expire at different intervals (2h-60d)

**Mitigation**: Token refresh logic, expiry checks before calls

### 4. Data Mapping Inconsistencies üîÑ

**Risk**: "Reach" means different things per platform

**Mitigation**: Document metric definitions, use optional fields

---

## Out of Scope

‚ùå YouTube engagement fetchers (don't exist yet)\
‚ùå Discord engagement fetchers (don't exist yet)\
‚ùå Real-time metrics streaming (webhooks)\
‚ùå Historical analytics\
‚ùå Paid ad metrics
‚ùå Creating TikTok social client (separate feature)
‚ùå Caching layer

---

## Success Criteria

### Functional

- [ ] All four fetchers return real data (not zeros)
- [ ] Rate limiting handled gracefully
- [ ] Auth errors provide actionable messages
- [ ] Engagement rate calculations accurate
- [ ] Audience insights return available data

### Non-Functional

- [ ] 100% unit test coverage
- [ ] All tests pass in CI/CD
- [ ] No breaking changes to interface
- [ ] Error logs include platform, code, retry info

---

## Implementation Order (Recommended)

1. **Twitter** (Simplest) - Well-documented API, clear rate limits
2. **Facebook** (Medium) - Complex insights API, good docs
3. **LinkedIn** (Medium-Hard) - URN-based, good analytics
4. **TikTok** (Hardest) - Newer API, limited access

---

## References

- [Twitter API v2 Metrics](https://developer.twitter.com/en/docs/twitter-api/metrics)
- [Facebook Graph API Insights](https://developers.facebook.com/docs/graph-api/reference/insights)
- [LinkedIn Share Statistics](https://learn.microsoft.com/en-us/linkedin/marketing/integrations/community-management/shares/share-statistics)
- [TikTok Display API](https://developers.tiktok.com/doc/display-api-get-started/)

**Related Issues**: #567 (Organic-to-Ad Derivation - parent feature)

---

**Plan Author**: Claude Sonnet 4.5 (Ralph Wiggum Planning Agent - Corrected Scope)\
**Date**: 2026-01-29
