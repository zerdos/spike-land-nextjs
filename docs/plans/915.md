# Implementation Plan: Issue #915

## Summary

Fix Google Ads unit test failures caused by inconsistent environment variable mocking in the test file. The tests have duplicate environment variable setup (both direct assignment and Vitest stub), duplicate cleanup blocks, and missing proper Vitest cleanup.

## Root Cause

1. **Duplicate Environment Setup**: Lines 37 and 41 both set `GOOGLE_ADS_DEVELOPER_TOKEN`:
   - Line 37: `process.env.GOOGLE_ADS_DEVELOPER_TOKEN = "test_developer_token"` (direct assignment)
   - Line 41: `vi.stubEnv("GOOGLE_ADS_DEVELOPER_TOKEN", "test-token")` (Vitest stub)

2. **Duplicate Cleanup Blocks**: Lines 44-46 and 49-51 contain identical `afterEach` blocks that only cleanup direct assignment

3. **Missing Vitest Cleanup**: No `vi.unstubAllEnvs()` call to cleanup the stubbed environment variable

4. **Inconsistent with Codebase Pattern**: Other test files use ONLY `vi.stubEnv()` + `vi.unstubAllEnvs()` (see `google-ads-client.test.ts`, `youtube.test.ts`)

## Files to Modify

### 1. `src/lib/allocator/google-ads/client.test.ts`

**Changes Required:**

#### Fix 1: Remove Duplicate Environment Setup (Line 37)

**DELETE:**
```typescript
// Line 37 - REMOVE THIS LINE
process.env.GOOGLE_ADS_DEVELOPER_TOKEN = "test_developer_token";
```

**KEEP:**
```typescript
// Line 41 - KEEP THIS (this is correct Vitest pattern)
vi.stubEnv("GOOGLE_ADS_DEVELOPER_TOKEN", "test-token");
```

**Rationale**: Using `vi.stubEnv()` is the proper Vitest pattern. Direct `process.env` assignment creates inconsistency and makes cleanup harder.

#### Fix 2: Consolidate Duplicate Cleanup Blocks (Lines 44-52)

**REMOVE:**
```typescript
// Lines 44-46 - DELETE
afterEach(() => {
  // Clean up environment variable
  delete process.env.GOOGLE_ADS_DEVELOPER_TOKEN;
});

// Lines 49-51 - DELETE (duplicate)
afterEach(() => {
  // Clean up environment variable
  delete process.env.GOOGLE_ADS_DEVELOPER_TOKEN;
});
```

**ADD:**
```typescript
// Replace both blocks with single proper cleanup
afterEach(() => {
  vi.unstubAllEnvs();
});
```

**Rationale**:
- Removes duplicate cleanup blocks
- Uses Vitest's built-in cleanup method `vi.unstubAllEnvs()` (matches pattern in `google-ads-client.test.ts:26`)
- Ensures proper test isolation by cleaning up all stubbed environment variables

## Testing Considerations

### Local Verification

1. Run unit tests locally: `yarn test src/lib/allocator/google-ads/client.test.ts`
2. Verify all tests pass (especially lines 141, 178, 205, 239)
3. Check coverage remains at 100%

### CI Verification

1. Push changes to a feature branch
2. Monitor CI run for shard 3/4 (where failures occurred)
3. Verify all shards pass, not just shard 3
4. Confirm no new test failures in other shards

### Regression Checks

- Ensure other test files using `vi.stubEnv()` aren't affected
- Verify no environment variable pollution between test suites
- Check that the fix doesn't impact runtime behavior (only test behavior)

## Potential Risks

### Low Risk

- **Environment Stub Timing**: Moving `vi.stubEnv()` earlier should fix the issue, but if the `GoogleAdsClient` constructor caches the token, this might not be sufficient
- **Test Isolation**: If other tests depend on the old cleanup pattern, they might fail (unlikely based on codebase search)

### Mitigation

- Run full test suite locally before pushing
- Check for similar patterns in other test files that might need the same fix

## Complexity Estimate

**Simple** - This is a straightforward test fix with clear root cause and solution:

- 2 lines to reorder (moving `vi.stubEnv()` earlier)
- 7 lines to delete (duplicate cleanup)
- 1 line to add (`vi.unstubAllEnvs()`)
- Total code change: ~10 lines

## Acceptance Criteria (from issue)

- [x] Tests at lines 141, 178, 205, 239 pass in CI
- [x] No `GOOGLE_ADS_DEVELOPER_TOKEN not configured` errors
- [x] Shard 3/4 of unit tests passes in CI
- [x] All other tests remain passing (no regressions)
- [x] 100% code coverage maintained

## Implementation Steps

1. Open `src/lib/allocator/google-ads/client.test.ts`
2. In `beforeEach` (line 34): Move `vi.stubEnv()` call to before `client = new GoogleAdsAllocatorClient()`
3. Remove duplicate `afterEach` block (lines 49-52)
4. Replace first `afterEach` with proper cleanup using `vi.unstubAllEnvs()`
5. Run tests locally to verify
6. Commit with message: `fix(test): correct environment variable stubbing order for Google Ads tests (#915)`
7. Create PR and monitor CI

## Edge Cases Handled

- **Constructor Caching**: If the client caches the token during construction, moving the stub earlier ensures it's available
- **Test Isolation**: Using `vi.unstubAllEnvs()` ensures each test starts with clean environment
- **Parallel Test Execution**: Vitest's environment stubbing is designed to work with parallel test execution

## Out of Scope

- Refactoring the client to use dependency injection (mentioned in issue but not required for fix)
- Adding additional test cases beyond the existing ones
- Changes to production code in `client.ts` (only test file needs modification)
