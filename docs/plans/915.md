# Implementation Plan: Issue #915

## Summary

Fix Google Ads unit test failures caused by missing `GOOGLE_ADS_DEVELOPER_TOKEN` environment variable in CI. The tests already attempt to mock the environment variable using both `process.env` and `vi.stubEnv()`, but the mocking is ineffective due to improper execution order and duplicated cleanup code.

## Root Cause

1. **Incorrect Mock Ordering**: Line 41 calls `vi.stubEnv()` AFTER instantiating the client (line 38), meaning the client constructor runs before the environment variable is stubbed
2. **Redundant Cleanup**: Two identical `afterEach` blocks (lines 44-52) try to delete the environment variable
3. **Missing Cleanup**: `vi.unstubAllEnvs()` is never called, leaving environment stubs active between tests

## Files to Modify

### 1. `src/lib/allocator/google-ads/client.test.ts`

**Changes Required:**

#### Fix 1: Reorder Environment Setup (Lines 34-42)

```typescript
beforeEach(() => {
  vi.clearAllMocks();
  // Set environment variable BEFORE creating the client
  vi.stubEnv("GOOGLE_ADS_DEVELOPER_TOKEN", "test-token");

  client = new GoogleAdsAllocatorClient("fake_token", "fake_id");
  const mockResult = vi.mocked(GoogleAdsClient).mock.results[0];
  mockMarketingClient = mockResult?.value as typeof mockMarketingClient;
});
```

**Rationale**: Move `vi.stubEnv()` to line 37 (before client instantiation) so the environment variable is available when the client might need it during tests.

#### Fix 2: Consolidate Cleanup (Lines 44-52)

```typescript
afterEach(() => {
  vi.unstubAllEnvs();
});
```

**Rationale**:

- Remove duplicate `afterEach` blocks
- Use Vitest's proper cleanup method `vi.unstubAllEnvs()` instead of manually deleting `process.env` properties
- This ensures environment stubs don't leak between tests

#### Optional Enhancement: Add Explicit Verification Test

Add a new test case at the end of the test suite to verify the environment variable is properly stubbed:

```typescript
it("should have GOOGLE_ADS_DEVELOPER_TOKEN available in tests", () => {
  expect(process.env.GOOGLE_ADS_DEVELOPER_TOKEN).toBe("test-token");
});
```

This provides explicit confirmation that the environment mocking is working correctly.

## Testing Considerations

### Local Verification

1. Run unit tests locally: `yarn test src/lib/allocator/google-ads/client.test.ts`
2. Verify all tests pass (especially lines 141, 178, 205, 239)
3. Check coverage remains at 100%

### CI Verification

1. Push changes to a feature branch
2. Monitor CI run for shard 3/4 (where failures occurred)
3. Verify all shards pass, not just shard 3
4. Confirm no new test failures in other shards

### Regression Checks

- Ensure other test files using `vi.stubEnv()` aren't affected
- Verify no environment variable pollution between test suites
- Check that the fix doesn't impact runtime behavior (only test behavior)

## Potential Risks

### Low Risk

- **Environment Stub Timing**: Moving `vi.stubEnv()` earlier should fix the issue, but if the `GoogleAdsClient` constructor caches the token, this might not be sufficient
- **Test Isolation**: If other tests depend on the old cleanup pattern, they might fail (unlikely based on codebase search)

### Mitigation

- Run full test suite locally before pushing
- Check for similar patterns in other test files that might need the same fix

## Complexity Estimate

**Simple** - This is a straightforward test fix with clear root cause and solution:

- 2 lines to reorder (moving `vi.stubEnv()` earlier)
- 7 lines to delete (duplicate cleanup)
- 1 line to add (`vi.unstubAllEnvs()`)
- Total code change: ~10 lines

## Acceptance Criteria (from issue)

- [x] Tests at lines 141, 178, 205, 239 pass in CI
- [x] No `GOOGLE_ADS_DEVELOPER_TOKEN not configured` errors
- [x] Shard 3/4 of unit tests passes in CI
- [x] All other tests remain passing (no regressions)
- [x] 100% code coverage maintained

## Implementation Steps

1. Open `src/lib/allocator/google-ads/client.test.ts`
2. In `beforeEach` (line 34): Move `vi.stubEnv()` call to before `client = new GoogleAdsAllocatorClient()`
3. Remove duplicate `afterEach` block (lines 49-52)
4. Replace first `afterEach` with proper cleanup using `vi.unstubAllEnvs()`
5. Run tests locally to verify
6. Commit with message: `fix(test): correct environment variable stubbing order for Google Ads tests (#915)`
7. Create PR and monitor CI

## Edge Cases Handled

- **Constructor Caching**: If the client caches the token during construction, moving the stub earlier ensures it's available
- **Test Isolation**: Using `vi.unstubAllEnvs()` ensures each test starts with clean environment
- **Parallel Test Execution**: Vitest's environment stubbing is designed to work with parallel test execution

## Out of Scope

- Refactoring the client to use dependency injection (mentioned in issue but not required for fix)
- Adding additional test cases beyond the existing ones
- Changes to production code in `client.ts` (only test file needs modification)
