# Implementation Plan: Analytics Dashboard for Conversion Performance

**Issue:** #942
**Complexity:** Medium
**Estimated Files:** 8 new, 2 modified

---

## Summary

Create a comprehensive conversion performance analytics dashboard within the existing `/admin/marketing/` section. This will add a new "Conversions" tab to visualize conversion rates, total conversions, and trends over time with filtering by date range and campaign.

**Key Implementation Notes:**

- Leverage existing `MarketingLayout.tsx` tab infrastructure
- Reuse `DateRangePicker`, `AttributionToggle`, and `MetricCards` components
- Follow established API route patterns in `/api/admin/marketing/analytics/`
- Use existing `metrics-cache.ts` caching layer for performance
- Utilize Recharts (already in package.json v3.7.0)
- Query from existing `CampaignAttribution`, `VisitorSession`, and `AnalyticsEvent` tables

---

## Acceptance Criteria Mapping

1. ‚úÖ **Create a new Dashboard page or section**
   ‚Üí Add `ConversionsTab.tsx` component to existing marketing dashboard tabs

2. ‚úÖ **Visualize conversion rates, total conversions, and trends over time**
   ‚Üí Line chart for daily conversions, bar chart for conversion type breakdown, metric cards for KPIs

3. ‚úÖ **Allow filtering by date range or campaign**
   ‚Üí Reuse existing `DateRangePicker` and add campaign selector dropdown

4. ‚úÖ **Backend endpoint to aggregate conversion data**
   ‚Üí Create `/api/admin/marketing/analytics/conversions/route.ts` with cache support

---

## Files to Create

### 1. **src/components/admin/marketing/tabs/ConversionsTab.tsx**

**Purpose:** Main conversion analytics UI component

**Key Features:**

- Date range picker (7d, 30d, 90d, custom)
- Campaign filter dropdown (populated from database)
- Attribution model toggle (first-touch/last-touch)
- KPI metric cards:
  - Total conversions (with % change vs previous period)
  - Conversion rate (with % change)
  - Average conversion value (with % change)
  - Conversion breakdown by type (SIGNUP, ENHANCEMENT, PURCHASE)
- Line chart: Daily conversions over time
- Bar chart: Conversions by campaign
- Pie chart: Conversion type distribution
- Loading skeleton states
- Error handling UI

**Dependencies:**

- Recharts (`LineChart`, `BarChart`, `PieChart`)
- shadcn/ui components (`Card`, `Select`, `Button`, `Skeleton`)
- `DateRangePicker`, `AttributionToggle`, `MetricCards` (existing)
- `lucide-react` icons

**Data Fetching:**

```typescript
GET /api/admin/marketing/analytics/conversions?startDate={ISO}&endDate={ISO}&attributionModel={model}&utmCampaign={campaign}
```

**Testing Requirements:**

- Unit tests for component rendering
- Loading/error state tests
- Date range change handling
- Campaign filter interaction
- Chart data transformation

---

### 2. **src/app/api/admin/marketing/analytics/conversions/route.ts**

**Purpose:** API endpoint to aggregate conversion data

**Query Parameters:**

- `startDate` (required): ISO date string
- `endDate` (required): ISO date string
- `attributionModel` (optional): "FIRST_TOUCH" | "LAST_TOUCH" (default: "FIRST_TOUCH")
- `utmCampaign` (optional): Filter by specific campaign

**Response Schema:**

```typescript
interface ConversionsResponse {
  metrics: {
    totalConversions: number;
    totalConversionsChange: number; // % vs previous period
    conversionRate: number; // percentage
    conversionRateChange: number;
    avgConversionValue: number; // in cents
    avgConversionValueChange: number;
    byType: {
      SIGNUP: number;
      ENHANCEMENT: number;
      PURCHASE: number;
    };
  };
  daily: Array<{
    date: string; // YYYY-MM-DD
    conversions: number;
    conversionRate: number;
    value: number; // total value in cents
  }>;
  byCampaign: Array<{
    campaign: string;
    conversions: number;
    conversionRate: number;
    value: number;
  }>;
  byType: Array<{
    type: ConversionType;
    count: number;
    percentage: number;
  }>;
}
```

**Implementation Steps:**

1. Authenticate user (NextAuth v5)
2. Verify admin role (`requireAdminByUserId`)
3. Validate query parameters (Zod schema)
4. Generate cache key: `"conversions:{startDate}:{endDate}:{attributionModel}:{utmCampaign}"`
5. Check cache (`getCachedMetrics`)
6. If cache miss:
   - Query `CampaignAttribution` table:
     - Filter by `convertedAt` between startDate and endDate
     - Filter by `attributionType` matching attributionModel
     - Filter by `utmCampaign` if provided (via join to `VisitorSession`)
     - Aggregate by date, campaign, and type
   - Calculate comparison metrics (previous period)
   - Transform data for frontend
   - Cache results with 5-minute TTL (`setCachedMetrics`)
7. Return JSON response

**Database Queries:**

```sql
-- Total conversions in date range
SELECT COUNT(*) as totalConversions,
       SUM(conversionValue) as totalValue
FROM CampaignAttribution
WHERE convertedAt BETWEEN ? AND ?
  AND attributionType = ?
  AND utmCampaign = ? (if provided);

-- Daily conversions
SELECT DATE(convertedAt) as date,
       COUNT(*) as conversions,
       SUM(conversionValue) as value
FROM CampaignAttribution
WHERE convertedAt BETWEEN ? AND ?
  AND attributionType = ?
GROUP BY DATE(convertedAt)
ORDER BY date;

-- Conversions by campaign
SELECT ca.utmCampaign as campaign,
       COUNT(*) as conversions,
       SUM(ca.conversionValue) as value
FROM CampaignAttribution ca
WHERE ca.convertedAt BETWEEN ? AND ?
  AND ca.attributionType = ?
GROUP BY ca.utmCampaign;

-- Conversions by type
SELECT conversionType,
       COUNT(*) as count
FROM CampaignAttribution
WHERE convertedAt BETWEEN ? AND ?
  AND attributionType = ?
GROUP BY conversionType;
```

**Testing Requirements:**

- Unit tests for route handler
- Auth/admin role tests (401, 403)
- Query parameter validation tests
- Cache hit/miss scenarios
- Database query mocking
- Response format validation
- Error handling (500)

---

### 3. **src/app/api/admin/marketing/analytics/conversions/route.test.ts**

**Purpose:** Unit tests for conversions API route

**Test Cases:**

- ‚úÖ Returns 401 when not authenticated
- ‚úÖ Returns 403 when user is not admin
- ‚úÖ Returns 400 when startDate is missing
- ‚úÖ Returns 400 when endDate is missing
- ‚úÖ Returns 400 when date format is invalid
- ‚úÖ Returns cached data when available
- ‚úÖ Queries database and caches when cache miss
- ‚úÖ Filters by campaign when utmCampaign provided
- ‚úÖ Uses correct attribution model
- ‚úÖ Calculates change percentages correctly
- ‚úÖ Handles empty results gracefully
- ‚úÖ Returns 500 on database error

**Mocking:**

- NextAuth session
- Prisma client
- Cache functions (`getCachedMetrics`, `setCachedMetrics`)

---

### 4. **src/components/admin/marketing/tabs/ConversionsTab.test.tsx**

**Purpose:** Unit tests for ConversionsTab component

**Test Cases:**

- ‚úÖ Renders loading skeleton initially
- ‚úÖ Renders error message on fetch failure
- ‚úÖ Renders metric cards with correct values
- ‚úÖ Renders daily conversions line chart
- ‚úÖ Renders campaign bar chart
- ‚úÖ Renders conversion type pie chart
- ‚úÖ Date range picker updates fetch params
- ‚úÖ Campaign filter updates fetch params
- ‚úÖ Attribution toggle updates fetch params
- ‚úÖ Handles empty data state
- ‚úÖ Chart tooltips display correct data

**Mocking:**

- `fetch` API responses
- Date range picker interactions
- Select dropdown interactions

---

### 5. **src/lib/tracking/conversion-analytics.ts**

**Purpose:** Helper functions for conversion analytics calculations

**Functions:**

```typescript
/**
 * Calculate conversion rate from sessions and conversions
 */
export function calculateConversionRate(
  conversions: number,
  sessions: number,
): number;

/**
 * Calculate percentage change between two values
 */
export function calculateChange(
  current: number,
  previous: number,
): number;

/**
 * Group conversions by date
 */
export function groupConversionsByDate(
  conversions: CampaignAttribution[],
): Record<string, number>;

/**
 * Group conversions by campaign
 */
export function groupConversionsByCampaign(
  conversions: CampaignAttribution[],
): Record<string, { count: number; value: number; }>;

/**
 * Get date range for previous period (for comparison)
 */
export function getPreviousPeriod(
  startDate: Date,
  endDate: Date,
): { startDate: Date; endDate: Date; };

/**
 * Format currency value (cents to dollars)
 */
export function formatCurrency(cents: number): string;
```

**Testing Requirements:**

- Unit tests for all helper functions
- Edge cases (zero values, negative changes, etc.)

---

### 6. **src/lib/tracking/conversion-analytics.test.ts**

**Purpose:** Unit tests for conversion analytics helpers

**Test Cases:**

- ‚úÖ calculateConversionRate handles zero sessions
- ‚úÖ calculateChange returns positive/negative percentages
- ‚úÖ groupConversionsByDate aggregates correctly
- ‚úÖ groupConversionsByCampaign sums values
- ‚úÖ getPreviousPeriod calculates correct range
- ‚úÖ formatCurrency displays dollars with 2 decimals

---

### 7. **src/lib/validations/analytics-query.ts**

**Purpose:** Zod schemas for analytics query parameter validation

**Schemas:**

```typescript
import { z } from "zod";

export const conversionsQuerySchema = z.object({
  startDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  endDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  attributionModel: z
    .enum(["FIRST_TOUCH", "LAST_TOUCH"])
    .optional()
    .default("FIRST_TOUCH"),
  utmCampaign: z.string().optional(),
});

export type ConversionsQuery = z.infer<typeof conversionsQuerySchema>;
```

**Testing Requirements:**

- Unit tests for schema validation
- Valid/invalid date formats
- Optional parameter defaults

---

### 8. **src/lib/validations/analytics-query.test.ts**

**Purpose:** Unit tests for analytics query schemas

**Test Cases:**

- ‚úÖ Accepts valid ISO dates
- ‚úÖ Rejects invalid date formats
- ‚úÖ Defaults attributionModel to FIRST_TOUCH
- ‚úÖ Accepts optional utmCampaign
- ‚úÖ Rejects unknown attribution models

---

## Files to Modify

### 9. **src/components/admin/marketing/MarketingLayout.tsx**

**Changes:**

- Add "Conversions" tab to navigation
- Import and render `ConversionsTab` component
- Update tab routing logic

**Diff:**

```typescript
// Add to imports
import { ConversionsTab } from "./tabs/ConversionsTab";

// Add to tabs array
const tabs = [
  { id: "overview", label: "Overview", component: OverviewTab },
  { id: "funnel", label: "Funnel", component: FunnelTab },
  { id: "campaigns", label: "Campaigns", component: CampaignsTab },
  +{ id: "conversions", label: "Conversions", component: ConversionsTab },
  { id: "attribution", label: "Attribution", component: AttributionTab },
  // ... other tabs
];
```

**Testing:**

- Verify new tab appears in navigation
- Verify tab switching works
- Update existing tests to include new tab

---

### 10. **src/components/admin/marketing/MarketingLayout.test.tsx**

**Changes:**

- Add test case for Conversions tab rendering
- Update tab count assertion

**Diff:**

```typescript
+ it("renders Conversions tab", () => {
+   render(<MarketingLayout />);
+   expect(screen.getByText("Conversions")).toBeInTheDocument();
+ });

- expect(tabs).toHaveLength(6);
+ expect(tabs).toHaveLength(7);
```

---

## Database Queries

**No schema changes required** - All data exists in current tables:

1. **CampaignAttribution** - Primary conversion data source
   - `convertedAt` - Timestamp for date filtering
   - `conversionType` - SIGNUP, ENHANCEMENT, PURCHASE
   - `conversionValue` - Monetary value (in cents)
   - `attributionType` - Attribution model
   - `utmCampaign` - Campaign name (via VisitorSession join)

2. **VisitorSession** - Session data for conversion rate calculation
   - Links to CampaignAttribution via `conversionId`
   - Contains UTM parameters for campaign filtering

**Existing Indexes:**

- ‚úÖ `CampaignAttribution_convertedAt_idx`
- ‚úÖ `CampaignAttribution_conversionType_idx`
- ‚úÖ `CampaignAttribution_attributionType_idx`
- ‚úÖ `CampaignAttribution_utmCampaign_idx`

---

## Testing Considerations

### Unit Tests (100% coverage required)

1. **API Route Tests:**
   - Authentication/authorization
   - Query parameter validation
   - Cache hit/miss scenarios
   - Database query mocking
   - Error handling

2. **Component Tests:**
   - Rendering with data
   - Loading/error states
   - User interactions (date picker, filters)
   - Chart rendering

3. **Helper Function Tests:**
   - Calculation accuracy
   - Edge cases (zero values, nulls)
   - Date range handling

### E2E Tests (Cucumber)

Create `e2e/features/conversion-analytics.feature`:

```gherkin
Feature: Conversion Analytics Dashboard
  As an admin user
  I want to view conversion performance metrics
  So that I can analyze campaign effectiveness

  Scenario: View conversion analytics
    Given I am logged in as an admin
    When I navigate to "/admin/marketing"
    And I click on the "Conversions" tab
    Then I should see conversion metrics
    And I should see a daily conversions chart
    And I should see a campaign breakdown chart

  Scenario: Filter conversions by date range
    Given I am on the Conversions tab
    When I select "Last 30 days" from the date picker
    Then the charts should update with 30-day data
    And the metrics should reflect the 30-day period

  Scenario: Filter conversions by campaign
    Given I am on the Conversions tab
    When I select "Summer Sale 2025" from the campaign filter
    Then the data should only show conversions from that campaign
```

### Performance Tests

- Load test API with 10,000+ conversion records
- Verify cache effectiveness (< 100ms for cached responses)
- Test chart rendering with large datasets

---

## Potential Risks & Mitigations

### 1. **Performance with Large Datasets**

**Risk:** Slow queries when fetching 100k+ conversion records

**Mitigation:**

- Use existing `CampaignMetricsCache` with 5-minute TTL
- Leverage indexed columns (`convertedAt`, `attributionType`, `utmCampaign`)
- Paginate campaign breakdown if > 100 campaigns
- Consider pre-aggregated daily rollups for year+ queries (future enhancement)

### 2. **Attribution Model Complexity**

**Risk:** Users confused by different attribution models showing different numbers

**Mitigation:**

- Default to `FIRST_TOUCH` (most common)
- Add tooltip explaining attribution models
- Show attribution model in metric card labels
- Link to documentation on attribution methodology

### 3. **Campaign Filter Scalability**

**Risk:** Dropdown with 1000+ campaigns is unusable

**Mitigation:**

- Use searchable Select component (shadcn/ui Combobox)
- Show only top 20 campaigns by default
- Add "Load more" or search functionality
- Consider campaign grouping/hierarchy (future)

### 4. **Date Range Edge Cases**

**Risk:** Invalid date ranges (end before start, future dates)

**Mitigation:**

- Validate dates in Zod schema
- Disable invalid date selections in DatePicker
- Show user-friendly error messages
- Default to "Last 7 days" on initial load

### 5. **Empty State Handling**

**Risk:** New accounts with zero conversions show confusing UI

**Mitigation:**

- Show empty state illustration
- Add helpful message: "No conversions yet. Track your first conversion by..."
- Link to tracking setup documentation
- Show sample data option (future)

---

## Out of Scope

As specified in the issue, the following are **NOT** included in this implementation:

- ‚ùå Advanced predictive analytics (ML models, forecasting)
- ‚ùå Cohort analysis
- ‚ùå Custom conversion goal creation
- ‚ùå Real-time conversion tracking (dashboard updates without refresh)
- ‚ùå CSV/Excel export functionality (existing in separate endpoint)
- ‚ùå Conversion event stream visualization
- ‚ùå Multi-touch attribution beyond first/last touch
- ‚ùå A/B test integration (separate tab exists)

These can be addressed in Phase 2 if needed.

---

## Implementation Order

**Recommended sequence for minimal risk:**

1. ‚úÖ Create validation schemas (`analytics-query.ts` + tests)
2. ‚úÖ Create helper functions (`conversion-analytics.ts` + tests)
3. ‚úÖ Create API route (`/conversions/route.ts` + tests)
4. ‚úÖ Create tab component (`ConversionsTab.tsx` + tests)
5. ‚úÖ Update MarketingLayout to add tab
6. ‚úÖ Create E2E tests
7. ‚úÖ Manual QA on Vercel preview
8. ‚úÖ Merge when all CI checks pass

---

## Rollout Plan

1. **Feature Flag (Optional):** Add `ENABLE_CONVERSIONS_TAB` env var for gradual rollout
2. **Documentation:** Update admin user guide with conversion analytics section
3. **Monitoring:** Track API response times and cache hit rates
4. **Feedback:** Add feedback button in tab for user input

---

## Definition of Done

- ‚úÖ All 8 new files created with complete implementation
- ‚úÖ MarketingLayout updated to include Conversions tab
- ‚úÖ 100% unit test coverage
- ‚úÖ E2E tests passing
- ‚úÖ All CI checks passing (lint, build, tests)
- ‚úÖ Manual QA on Vercel preview URL
- ‚úÖ No console errors in browser
- ‚úÖ Responsive design (mobile, tablet, desktop)
- ‚úÖ Dark mode support
- ‚úÖ Code review approved
- ‚úÖ Documentation updated (if needed)

---

## Estimated Effort

- **API Development:** 3-4 hours
- **Component Development:** 4-5 hours
- **Testing (unit + E2E):** 3-4 hours
- **QA & Refinement:** 2-3 hours
- **Total:** ~12-16 hours

---

## References

- **Database Schema:** `/prisma/schema.prisma` (lines 1517-1700)
- **Existing Marketing Dashboard:** `/src/app/admin/marketing/`
- **API Route Pattern:** `/src/app/api/admin/marketing/analytics/overview/route.ts`
- **Cache Layer:** `/src/lib/tracking/metrics-cache.ts`
- **Attribution Models:** `/src/lib/tracking/attribution.ts`
- **Recharts Documentation:** https://recharts.org/

---

**Plan Ready for Implementation** üöÄ
