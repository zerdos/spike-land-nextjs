# Implementation Plan: Analytics Dashboard for Conversion Performance

**Issue**: #942
**Created**: 2026-01-29
**Status**: Ready for Implementation

## Summary

Create a comprehensive analytics dashboard focused on conversion performance metrics. The dashboard will visualize conversion rates, total conversions, trends over time, and provide filtering capabilities by date range and campaign. This feature extends the existing marketing analytics infrastructure with a dedicated conversion-focused view.

## Context

The application already has:

- Marketing analytics infrastructure with `CampaignAttribution`, `VisitorSession`, and `CampaignMetricsCache` models
- Existing API routes for analytics at `/api/admin/marketing/analytics/overview`
- Recharts already installed and used in `src/app/admin/analytics/page.tsx` and `src/components/admin/marketing/tabs/OverviewTab.tsx`
- Admin marketing pages structure at `src/app/admin/marketing/`
- Date range filtering and attribution model components

## Database Schema

The following existing models will be used:

### CampaignAttribution

- `conversionType`: ConversionType enum (SIGNUP, ENHANCEMENT, PURCHASE)
- `conversionValue`: Float (token/revenue value)
- `convertedAt`: DateTime
- `platform`: String (FACEBOOK, GOOGLE_ADS, ORGANIC, DIRECT)
- `utmCampaign`, `utmSource`, `utmMedium`: String

### VisitorSession

- `sessionStart`, `sessionEnd`: DateTime
- `visitorId`: String (for unique visitor tracking)
- `userId`: String (linked after conversion)
- `utmSource`, `utmMedium`, `utmCampaign`: String

### Conversion Types (Existing Enum)

```prisma
enum ConversionType {
  SIGNUP
  ENHANCEMENT
  PURCHASE
}
```

## Implementation Steps

### 1. Create Analytics Service Layer

**File**: `src/services/analytics.ts` (NEW)

**Purpose**: Centralize analytics data aggregation logic

**Exports**:

```typescript
export interface ConversionMetrics {
  totalConversions: number;
  conversionsByType: {
    signups: number;
    enhancements: number;
    purchases: number;
  };
  conversionRate: number;
  averageConversionValue: number;
  conversionTrends: Array<{
    date: string;
    conversions: number;
    rate: number;
  }>;
}

export interface CampaignPerformance {
  campaignName: string;
  conversions: number;
  conversionRate: number;
  revenue: number;
}

export async function getConversionMetrics(
  startDate: Date,
  endDate: Date,
  attributionModel: AttributionType,
  campaignFilter?: string,
): Promise<ConversionMetrics>;

export async function getCampaignPerformance(
  startDate: Date,
  endDate: Date,
  attributionModel: AttributionType,
): Promise<CampaignPerformance[]>;
```

**Key Logic**:

- Query `CampaignAttribution` for conversion data
- Calculate conversion rates against `VisitorSession` data
- Group by date for trends
- Filter by campaign if specified
- Use existing metrics cache pattern from `src/lib/tracking/metrics-cache.ts`

### 2. Create Backend API Route

**File**: `src/app/api/admin/marketing/analytics/conversions/route.ts` (NEW)

**Endpoint**: `GET /api/admin/marketing/analytics/conversions`

**Query Parameters**:

- `startDate`: ISO date string (required)
- `endDate`: ISO date string (required)
- `attributionModel`: "FIRST_TOUCH" | "LAST_TOUCH" (default: "FIRST_TOUCH")
- `campaignFilter`: string (optional)

**Response Format**:

```typescript
{
  metrics: ConversionMetrics;
  campaigns: CampaignPerformance[];
}
```

**Implementation Notes**:

- Follow pattern from `src/app/api/admin/marketing/analytics/overview/route.ts`
- Use `requireAdminByUserId` for authorization
- Implement metrics caching with 5-minute TTL
- Use `tryCatch` helper for error handling
- Return structured JSON response

### 3. Create Analytics Components

#### 3.1 Conversion Rate Chart Component

**File**: `src/components/analytics/ConversionRateChart.tsx` (NEW)

**Purpose**: Line chart showing conversion rate trends over time

**Props**:

```typescript
interface ConversionRateChartProps {
  data: Array<{ date: string; conversions: number; rate: number; }>;
  loading?: boolean;
}
```

**Features**:

- Recharts `LineChart` with dual Y-axes (conversions count + rate percentage)
- Responsive container
- Tooltip with formatted values
- Loading skeleton state

#### 3.2 Campaign Performance Table Component

**File**: `src/components/analytics/CampaignPerformanceTable.tsx` (NEW)

**Purpose**: Sortable table showing campaign-level conversion metrics

**Props**:

```typescript
interface CampaignPerformanceTableProps {
  campaigns: CampaignPerformance[];
  loading?: boolean;
}
```

**Features**:

- Sortable columns (name, conversions, rate, revenue)
- Click-to-filter by campaign
- Loading skeleton with 5 rows
- Responsive design

#### 3.3 Conversion Funnel Component

**File**: `src/components/analytics/ConversionFunnel.tsx` (NEW)

**Purpose**: Visualize conversion funnel (Visitors → Signups → Enhancements → Purchases)

**Props**:

```typescript
interface ConversionFunnelProps {
  data: {
    visitors: number;
    signups: number;
    enhancements: number;
    purchases: number;
  };
  loading?: boolean;
}
```

**Features**:

- Bar chart or funnel chart using Recharts
- Show dropoff rates between stages
- Highlight conversion bottlenecks

### 4. Create Dashboard Page

**File**: `src/app/dashboard/analytics/page.tsx` (NEW)

**Route**: `/dashboard/analytics`

**Layout**:

```
┌─────────────────────────────────────────────┐
│  Analytics Dashboard                         │
│  [Date Range Picker] [Attribution Toggle]   │
│  [Campaign Filter Dropdown]                  │
├─────────────────────────────────────────────┤
│  ┌─────────┐ ┌─────────┐ ┌─────────┐       │
│  │ Total   │ │ Conv.   │ │ Avg     │       │
│  │ Conv.   │ │ Rate    │ │ Value   │       │
│  └─────────┘ └─────────┘ └─────────┘       │
├─────────────────────────────────────────────┤
│  Conversion Rate Trends (Line Chart)        │
├─────────────────────────────────────────────┤
│  Conversion Funnel                          │
├─────────────────────────────────────────────┤
│  Campaign Performance Table                 │
└─────────────────────────────────────────────┘
```

**Implementation**:

- Client component ("use client")
- Use existing `DateRangePicker` component from `src/components/admin/marketing/DateRangePicker.tsx`
- Use existing `AttributionToggle` component from `src/components/admin/marketing/AttributionToggle.tsx`
- Fetch data from `/api/admin/marketing/analytics/conversions`
- Loading states with skeletons
- Error handling with Card display

### 5. Update Navigation (Optional but Recommended)

**File**: `src/app/admin/marketing/layout.tsx`

**Change**: Add "Conversions" tab to navigation if it uses a tab layout

## Files to Create

1. `src/services/analytics.ts` - Analytics service layer (~200 lines)
2. `src/app/api/admin/marketing/analytics/conversions/route.ts` - API route (~150 lines)
3. `src/components/analytics/ConversionRateChart.tsx` - Chart component (~100 lines)
4. `src/components/analytics/CampaignPerformanceTable.tsx` - Table component (~150 lines)
5. `src/components/analytics/ConversionFunnel.tsx` - Funnel chart (~100 lines)
6. `src/app/dashboard/analytics/page.tsx` - Main dashboard page (~250 lines)

## Files to Modify

1. `src/app/admin/marketing/layout.tsx` - Add navigation link (if applicable)

## Testing Considerations

### Unit Tests

1. `src/services/analytics.test.ts`
   - Test conversion rate calculations
   - Test date grouping for trends
   - Test campaign filtering
   - Mock Prisma queries

2. `src/app/api/admin/marketing/analytics/conversions/route.test.ts`
   - Test authorization
   - Test query parameter validation
   - Test response format
   - Test error handling

3. Component tests for each analytics component
   - Test loading states
   - Test empty data states
   - Test data rendering
   - Test user interactions (sorting, filtering)

### E2E Tests

Create `e2e/features/analytics-dashboard.feature`:

```gherkin
Feature: Analytics Dashboard

  Scenario: View conversion analytics
    Given I am logged in as admin
    When I navigate to "/dashboard/analytics"
    Then I should see conversion metrics
    And I should see a conversion rate chart
    And I should see campaign performance data

  Scenario: Filter by date range
    Given I am on the analytics dashboard
    When I select "Last 7 Days" date range
    Then the charts should update with filtered data

  Scenario: Filter by campaign
    Given I am on the analytics dashboard
    When I select a campaign from the filter
    Then only that campaign's data should be shown
```

## Dependencies

**No new dependencies required** - all libraries already installed:

- `recharts@3.7.0` ✓ (already in package.json)
- `react-hook-form@7.71.1` ✓ (for form controls)
- `@radix-ui/*` ✓ (for UI components)

## Backward Compatibility

- New feature - no breaking changes
- Uses existing database schema
- Extends existing API patterns
- No migrations required

## Performance Considerations

1. **Caching**: Use `CampaignMetricsCache` model for 5-minute cache
2. **Query Optimization**:
   - Add indexes on `convertedAt` if not present
   - Use date range filters in WHERE clauses
   - Aggregate in database, not in application code
3. **Pagination**: Campaign table should support pagination if >100 campaigns

## Security Considerations

1. **Authorization**: Admin-only access via `requireAdminByUserId`
2. **Input Validation**: Validate date ranges with Zod schemas
3. **SQL Injection**: Use Prisma query builder (parameterized queries)
4. **Rate Limiting**: API routes inherit existing rate limiting

## Potential Risks

1. **Data Volume**: If conversion data is large, queries may be slow
   - **Mitigation**: Implement pagination and date range limits
   - **Mitigation**: Use database indexes

2. **Cache Invalidation**: Stale data in metrics cache
   - **Mitigation**: 5-minute TTL is acceptable for analytics
   - **Mitigation**: Add manual refresh button

3. **Campaign Filter Performance**: Many campaigns could slow dropdown
   - **Mitigation**: Implement autocomplete/search for campaign filter
   - **Mitigation**: Limit to active campaigns only

## Out of Scope

As specified in the issue:

- Advanced predictive analytics (phase 2)
- Real-time conversion tracking (phase 2)
- Export to CSV/PDF (phase 2)
- Custom date range comparison (phase 2)
- Conversion attribution modeling beyond first/last touch (phase 2)

## Estimated Complexity

**Medium** (3-4 days of development)

- Backend service and API: 1 day
- Frontend components: 1-2 days
- Testing: 1 day
- Integration and bug fixes: 0.5 day

## Success Criteria

✓ Dashboard loads with conversion metrics
✓ Date range filtering works correctly
✓ Campaign filtering works correctly
✓ Attribution model toggle works
✓ Charts display data accurately
✓ Loading states are smooth
✓ Error states are handled gracefully
✓ Unit tests achieve 100% coverage
✓ E2E tests pass
✓ Page is admin-only accessible

## References

- Existing analytics: `src/app/admin/analytics/page.tsx`
- Overview tab: `src/components/admin/marketing/tabs/OverviewTab.tsx`
- API pattern: `src/app/api/admin/marketing/analytics/overview/route.ts`
- Database schema: `prisma/schema.prisma` (lines 1517-1660)
