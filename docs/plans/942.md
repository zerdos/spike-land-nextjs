# Implementation Plan: Analytics Dashboard for Conversion Performance (#942)

## Summary

Create a dedicated analytics dashboard page that provides comprehensive conversion performance visualization with filtering capabilities. This dashboard will aggregate conversion data (signups, enhancements, purchases) and display trends over time using Recharts, following existing patterns in the marketing admin section.

## Requirements Analysis

**Acceptance Criteria:**

- ✅ Create a new Dashboard page or section
- ✅ Visualize conversion rates, total conversions, and trends over time
- ✅ Allow filtering by date range or campaign
- ✅ Backend endpoint to aggregate conversion data

**Out of Scope:**

- Advanced predictive analytics (phase 2)

## Architecture Overview

This feature will follow the existing patterns established in the marketing analytics section:

- Client-side React components with hooks for data fetching
- API routes following RESTful conventions
- Recharts for visualization (already in use)
- Reusable components from `src/components/admin/marketing/`
- Date range picker and campaign filtering

## Files to Create

### 1. Dashboard Page

**Path:** `src/app/dashboard/analytics/page.tsx`

**Purpose:** Main dashboard page that displays conversion performance analytics

**Implementation Details:**

- Server component wrapper (for metadata and layout)
- Import and render `ConversionAnalyticsTab` client component
- Add metadata for SEO
- Follows pattern from `src/app/admin/marketing/page.tsx`

```tsx
/**
 * Conversion Performance Analytics Dashboard
 *
 * Displays comprehensive conversion metrics and trends
 */

import { ConversionAnalyticsTab } from "@/components/analytics/ConversionAnalyticsTab";
import { Metadata } from "next";

export const metadata: Metadata = {
  title: "Conversion Analytics | Spike Land",
  description: "Track conversion performance and trends",
};

export default function ConversionAnalyticsPage() {
  return (
    <div className="container py-6">
      <h1 className="text-3xl font-bold mb-6">Conversion Performance</h1>
      <ConversionAnalyticsTab />
    </div>
  );
}
```

### 2. Analytics Service

**Path:** `src/services/analytics.ts`

**Purpose:** Client-side service for fetching analytics data

**Implementation Details:**

- Typed fetch functions for conversion data
- Error handling with proper types
- Date formatting utilities
- Reusable across components

```typescript
/**
 * Analytics Service
 *
 * Client-side utilities for fetching analytics data
 */

export interface ConversionMetrics {
  totalConversions: number;
  signups: number;
  enhancements: number;
  purchases: number;
  signupRate: number;
  enhancementRate: number;
  purchaseRate: number;
  signupsChange: number;
  enhancementsChange: number;
  purchasesChange: number;
}

export interface ConversionTrend {
  date: string;
  signups: number;
  enhancements: number;
  purchases: number;
  conversionRate: number;
}

export interface ConversionAnalyticsData {
  metrics: ConversionMetrics;
  trends: ConversionTrend[];
  campaigns: Array<{ id: string; name: string; }>;
}

export interface AnalyticsFilters {
  startDate: string;
  endDate: string;
  campaign?: string;
}

export async function fetchConversionAnalytics(
  filters: AnalyticsFilters,
): Promise<ConversionAnalyticsData> {
  const params = new URLSearchParams({
    startDate: filters.startDate,
    endDate: filters.endDate,
  });

  if (filters.campaign && filters.campaign !== "all") {
    params.set("campaign", filters.campaign);
  }

  const response = await fetch(`/api/analytics/conversions?${params}`);

  if (!response.ok) {
    throw new Error("Failed to fetch conversion analytics");
  }

  return response.json();
}
```

### 3. Conversion Analytics Tab Component

**Path:** `src/components/analytics/ConversionAnalyticsTab.tsx`

**Purpose:** Main client component for the dashboard

**Implementation Details:**

- Uses existing `DateRangePicker` component
- Uses existing `MetricCards` component
- Implements Recharts LineChart for trends
- Campaign filter dropdown
- Loading states with Skeleton components
- Error handling
- Follows pattern from `src/components/admin/marketing/tabs/OverviewTab.tsx`

**Key Features:**

- 4 metric cards: Total Conversions, Signups, Enhancements, Purchases (with % change)
- Line chart showing trends over time for all conversion types
- Date range picker (7d, 30d, 90d, custom)
- Campaign filter dropdown
- Responsive grid layout

### 4. Conversion Metrics Cards Component

**Path:** `src/components/analytics/ConversionMetricsCards.tsx`

**Purpose:** Reusable metric cards for conversion data

**Implementation Details:**

- Extends existing `MetricCards` pattern
- Custom formatting for conversion metrics
- Color-coded trend indicators
- Responsive grid layout

### 5. Conversion Trends Chart Component

**Path:** `src/components/analytics/ConversionTrendsChart.tsx`

**Purpose:** Line chart showing conversion trends over time

**Implementation Details:**

- Recharts LineChart with multiple lines
- Color-coded by conversion type
- Responsive container
- Tooltip with formatted dates
- Legend for conversion types

### 6. Backend API Route

**Path:** `src/app/api/analytics/conversions/route.ts`

**Purpose:** API endpoint to aggregate conversion data

**Implementation Details:**

- GET endpoint with query parameters (startDate, endDate, campaign)
- Auth middleware to require authentication
- Query validation using Zod
- Aggregate queries to Prisma
- Calculate metrics and trends
- Return structured JSON response
- Pattern follows `src/app/api/admin/marketing/analytics/overview/route.ts`

**Database Queries:**

1. Get conversions from `CampaignAttribution` table filtered by:
   - Date range (`convertedAt` field)
   - Optional campaign filter (`utmCampaign` field)
   - Conversion types: SIGNUP, ENHANCEMENT, PURCHASE

2. Calculate previous period metrics for trend comparison

3. Group conversions by date for trend visualization

4. Get unique campaigns for filter dropdown

**Response Structure:**

```typescript
{
  metrics: {
    totalConversions: number;
    signups: number;
    enhancements: number;
    purchases: number;
    signupRate: number;
    enhancementRate: number;
    purchaseRate: number;
    signupsChange: number;
    enhancementsChange: number;
    purchasesChange: number;
  },
  trends: Array<{
    date: string;
    signups: number;
    enhancements: number;
    purchases: number;
    conversionRate: number;
  }>,
  campaigns: Array<{
    id: string;
    name: string;
  }>
}
```

### 7. Unit Tests for Analytics Service

**Path:** `src/services/analytics.test.ts`

**Purpose:** Test analytics service functions

**Tests:**

- Fetch conversion analytics with valid filters
- Handle API errors gracefully
- Properly format query parameters
- Handle optional campaign filter

### 8. Unit Tests for Conversion Analytics Tab

**Path:** `src/components/analytics/ConversionAnalyticsTab.test.tsx`

**Purpose:** Test main dashboard component

**Tests:**

- Renders loading state
- Renders error state
- Renders data with metrics and charts
- Date range picker interaction
- Campaign filter interaction
- Fetches data on mount and filter changes

### 9. Unit Tests for Backend API

**Path:** `src/app/api/analytics/conversions/route.test.ts`

**Purpose:** Test API route handler

**Tests:**

- Returns 401 for unauthenticated requests
- Returns 400 for invalid date formats
- Returns conversion data with valid parameters
- Filters by campaign when provided
- Calculates metrics correctly
- Handles database errors gracefully

## Files to Modify

### 1. Database Schema (Already Exists)

**Path:** `prisma/schema.prisma`

**No changes needed** - The schema already has:

- `CampaignAttribution` table with:
  - `conversionType` enum (SIGNUP, ENHANCEMENT, PURCHASE)
  - `convertedAt` timestamp
  - `utmCampaign` field
  - `conversionValue` for revenue tracking
- Proper indexes on `conversionType` and `convertedAt`

### 2. Shared Types (Optional Enhancement)

**Path:** `packages/shared/src/types/analytics.ts`

**Changes:** Add shared types for analytics data structures (if needed for cross-package usage)

**Note:** Can use local types in `src/services/analytics.ts` if not sharing with other packages.

## Database Queries

### Main Conversion Metrics Query

```typescript
// Get all conversions in date range
const conversions = await prisma.campaignAttribution.findMany({
  where: {
    convertedAt: {
      gte: startDate,
      lte: endDate,
    },
    ...(campaign && { utmCampaign: campaign }),
  },
  select: {
    conversionType: true,
    convertedAt: true,
    conversionValue: true,
    utmCampaign: true,
  },
});

// Aggregate by type
const signups = conversions.filter(c => c.conversionType === "SIGNUP").length;
const enhancements = conversions.filter(c => c.conversionType === "ENHANCEMENT").length;
const purchases = conversions.filter(c => c.conversionType === "PURCHASE").length;
```

### Daily Trends Query

```typescript
// Group by date and conversion type
const trendMap = new Map<string, {
  signups: number;
  enhancements: number;
  purchases: number;
}>();

for (const conversion of conversions) {
  const dateKey = conversion.convertedAt.toISOString().split("T")[0];
  const day = trendMap.get(dateKey) || { signups: 0, enhancements: 0, purchases: 0 };

  if (conversion.conversionType === "SIGNUP") day.signups++;
  if (conversion.conversionType === "ENHANCEMENT") day.enhancements++;
  if (conversion.conversionType === "PURCHASE") day.purchases++;

  trendMap.set(dateKey, day);
}
```

## Component Hierarchy

```
ConversionAnalyticsPage (Server Component)
└── ConversionAnalyticsTab (Client Component)
    ├── DateRangePicker (Reusable)
    ├── CampaignFilterSelect (New or Reuse)
    ├── MetricCards (Reusable)
    │   ├── MetricCard (Reusable)
    │   ├── MetricCard (Reusable)
    │   ├── MetricCard (Reusable)
    │   └── MetricCard (Reusable)
    └── ConversionTrendsChart (New)
        └── Recharts LineChart
```

## Testing Considerations

### Unit Tests Required

1. ✅ Analytics service functions
2. ✅ ConversionAnalyticsTab component
3. ✅ API route handler
4. ✅ Helper functions (date formatting, calculations)

### E2E Tests (Future)

- Navigate to dashboard
- Filter by date range
- Filter by campaign
- Verify metrics display
- Verify charts render

### Test Coverage Target

- Maintain 100% coverage requirement
- Mock Prisma queries
- Mock fetch calls in components
- Test all loading/error states

## Performance Considerations

### Database Optimization

- Leverage existing indexes on `convertedAt` and `conversionType`
- Use metrics caching (similar to overview route) for 5-minute cache
- Consider materialized views for large datasets (future optimization)

### Frontend Optimization

- Use React.memo for chart components
- Debounce filter changes
- Implement loading skeletons
- Lazy load charts if needed

## Error Handling

### API Route Errors

- 401: Unauthorized (no session)
- 400: Invalid parameters (Zod validation)
- 500: Database errors (catch and log)

### Client-Side Errors

- Display error message in Card component
- Provide retry mechanism
- Log errors to console
- Handle empty data states

## Security Considerations

### Authentication

- Require authenticated user (use `auth()` from `@/auth`)
- Consider role-based access if needed (admin-only?)
- No authorization needed per issue spec (dashboard accessible to all users)

### Input Validation

- Validate date ranges (start < end)
- Sanitize campaign filter input
- Use Zod schemas for type safety

## Accessibility

- Proper ARIA labels for charts
- Keyboard navigation for filters
- Color contrast for text/charts
- Screen reader friendly metric cards
- Focus management for interactive elements

## Mobile Responsiveness

- Responsive grid layouts (Tailwind)
- Stacked layout on mobile
- Touch-friendly filter controls
- Optimized chart sizes
- Scrollable tables if needed

## Future Enhancements (Out of Scope)

- Export to CSV/PDF
- Predictive analytics
- Cohort analysis
- A/B test integration
- Real-time updates
- Custom date range comparisons
- Revenue metrics
- Multi-campaign comparison

## Implementation Steps

1. ✅ Create API route with data aggregation logic
2. ✅ Create analytics service functions
3. ✅ Create ConversionAnalyticsTab component
4. ✅ Create supporting chart components
5. ✅ Create dashboard page
6. ✅ Write unit tests for API route
7. ✅ Write unit tests for service
8. ✅ Write unit tests for components
9. ✅ Manual testing and validation
10. ✅ Code review and refinement

## Estimated Complexity

**Medium** - This feature involves:

- New API endpoint with database queries ✅
- Multiple React components ✅
- Recharts integration (already in use) ✅
- Existing patterns to follow ✅
- Good test coverage required ✅

## Dependencies

### External Packages (Already Installed)

- `recharts` - Chart library
- `zod` - Schema validation
- `date-fns` - Date utilities (optional)

### Internal Dependencies

- `@/components/ui/*` - shadcn/ui components
- `@/components/admin/marketing/DateRangePicker` - Date picker component
- `@/components/admin/marketing/MetricCards` - Metric card components
- `@/lib/prisma` - Database client
- `@/auth` - Authentication
- `@prisma/client` - Generated Prisma types

## Risks and Mitigations

### Risk: Large Dataset Performance

**Mitigation:**

- Implement metrics caching (5-minute TTL)
- Add pagination for large date ranges
- Consider date range limits (max 90 days)

### Risk: Complex Aggregation Queries

**Mitigation:**

- Use efficient Prisma queries
- Leverage existing database indexes
- Profile query performance
- Consider adding compound indexes if needed

### Risk: Chart Rendering Performance

**Mitigation:**

- Limit data points displayed (group by week/month for large ranges)
- Use React.memo
- Implement virtualization if needed

### Risk: Test Coverage Below 100%

**Mitigation:**

- Write tests alongside implementation
- Cover all code paths
- Mock external dependencies properly

## Rollout Strategy

### Development

1. Feature branch: `feature/analytics-dashboard-942`
2. Implement with TDD approach
3. Local testing with dev database
4. Code review before merge

### Testing

1. Unit tests (100% coverage)
2. Manual testing with various filters
3. Cross-browser testing
4. Mobile device testing

### Deployment

1. Merge to main after approval
2. CI/CD pipeline verification
3. Monitor for errors in production
4. Gather user feedback

## Success Metrics

- ✅ All acceptance criteria met
- ✅ 100% test coverage
- ✅ No runtime errors
- ✅ Page load < 2 seconds
- ✅ Responsive on all devices
- ✅ Accessible (WCAG 2.1 AA)

## Open Questions

❓ **Should the dashboard require admin role?**

- Issue doesn't specify authorization
- Marketing analytics are admin-only
- Recommendation: Keep dashboard accessible to all authenticated users for now

✅ **Resolved: Accessible to all authenticated users**

❓ **What date range should be the default?**

- Recommendation: 30 days (matches existing patterns)

✅ **Resolved: 30 days default**

❓ **Should we cache the metrics?**

- Recommendation: Yes, 5-minute cache (matches overview route)

✅ **Resolved: Use metrics caching**

## References

- Similar patterns: `src/app/admin/marketing/page.tsx`
- API pattern: `src/app/api/admin/marketing/analytics/overview/route.ts`
- Component pattern: `src/components/admin/marketing/tabs/OverviewTab.tsx`
- Funnel logic: `src/app/api/admin/marketing/analytics/funnel/route.ts`
- Database schema: `prisma/schema.prisma` (lines 1619-1630, 1719-1721)
