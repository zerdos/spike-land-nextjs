# Implementation Plan: #843 - AI Image Generation for Posts

**Issue**: [Phase 7] AI Image Generation for Posts
**Epic**: #836 - Spike Land Pivot
**Complexity**: Medium
**Estimated Files**: 8 new, 3 modified

---

## Summary

Integrate AI image generation capabilities into the Orbit post composer, allowing users to generate and enhance images for social media posts using brand-aware prompts. This builds on existing Pixel image generation infrastructure and Brand Brain personality settings.

---

## Technical Context

### Existing Infrastructure

1. **Image Generation API**: `/api/mcp/generate` (route.ts:53-168)
   - Already supports text-to-image generation
   - Accepts: `prompt`, `tier` (TIER_1K/2K/4K), `negativePrompt`, `aspectRatio`
   - Returns: `jobId` for polling generation status
   - Uses `/api/mcp/jobs/{jobId}` for status polling

2. **Brand Brain Integration**:
   - `useBrandProfile` hook fetches workspace brand settings
   - Includes: `toneDescriptors`, `mission`, `values`, `guardrails`, `vocabulary`
   - Pattern shown in `src/lib/relay/generate-drafts.ts:326-350`

3. **Dialog Pattern**:
   - shadcn/ui Dialog components (`src/components/ui/dialog.tsx`)
   - Used consistently across Orbit components

4. **Post Model** (Prisma schema):
   - `SocialPost` includes `metadata: Json?` field
   - `PostAsset` join table links posts to assets
   - Posts have `status` (DRAFT, SCHEDULED, PUBLISHED)

---

## Architecture Decisions

### 1. Composer Location

**Decision**: Create new composer directory at `src/components/orbit/composer/`

**Rationale**:

- Currently no post composer exists in the Orbit module
- Separates composer concerns from existing relay/inbox features
- Allows for future expansion (scheduling, multi-platform, etc.)

### 2. Image Storage

**Decision**: Use existing Asset system (R2 + Prisma Asset model)

**Rationale**:

- Consistent with platform architecture
- Leverages existing `PostAsset` join table
- Supports multi-image posts

### 3. Brand-Aware Prompt Building

**Decision**: Create dedicated `BrandImagePromptBuilder` component

**Rationale**:

- Mirrors `generateDrafts` pattern for brand voice integration
- Allows users to see how brand settings affect prompts
- Provides transparency and control

---

## Implementation Steps

### Phase 1: Core Components (New Files)

#### 1.1 Image Generation Dialog

**File**: `src/components/orbit/composer/ImageGenerationDialog.tsx`

**Purpose**: Main dialog for generating new images from text prompts

**Key Features**:

- Text input for base prompt
- Optional negative prompt input
- Tier selection (TIER_1K/2K/4K with token cost display)
- Aspect ratio selector
- Brand-aware prompt preview
- Generation progress tracking

**Dependencies**:

- `useBrandProfile` hook
- `/api/mcp/generate` endpoint
- `/api/mcp/jobs/{jobId}` for polling
- `Dialog`, `Button`, `Input`, `Select` from shadcn/ui

**State Management**:

```typescript
interface GenerationState {
  prompt: string;
  negativePrompt: string;
  tier: EnhancementTier;
  aspectRatio: AspectRatio;
  isGenerating: boolean;
  jobId: string | null;
  generatedImageUrl: string | null;
  error: string | null;
}
```

**API Flow**:

1. User enters prompt ‚Üí Build brand-aware prompt ‚Üí Display preview
2. Click "Generate" ‚Üí POST to `/api/mcp/generate`
3. Receive `jobId` ‚Üí Start polling `/api/mcp/jobs/{jobId}`
4. On completion ‚Üí Display image ‚Üí Allow save or regenerate

---

#### 1.2 Image Enhancement Dialog

**File**: `src/components/orbit/composer/ImageEnhancementDialog.tsx`

**Purpose**: Modify existing images with text prompts

**Key Features**:

- Image upload/selection
- Enhancement prompt input
- Same tier/aspect ratio controls
- Before/after preview
- Brand-aware enhancement suggestions

**Dependencies**:

- `/api/mcp/modify` endpoint
- Image upload utilities
- Brand Brain settings

**Differences from Generation Dialog**:

- Accepts image input (URL or base64)
- No aspect ratio selector (auto-detected from input)
- Shows original image alongside result

---

#### 1.3 Brand Image Prompt Builder

**File**: `src/components/orbit/composer/BrandImagePromptBuilder.tsx`

**Purpose**: Utility component for building brand-aware image prompts

**Key Features**:

- Reads Brand Brain `toneDescriptors`, `mission`, `values`
- Enhances user prompt with brand personality
- Shows "You typed" vs "Enhanced prompt" comparison
- Allows toggling brand enhancement on/off

**Enhancement Logic**:

```typescript
function enhancePromptWithBrand(
  userPrompt: string,
  brandProfile: BrandProfile | null,
): string {
  if (!brandProfile) return userPrompt;

  const toneAdjectives = getToneAdjectives(brandProfile.toneDescriptors);
  const brandContext = buildBrandContext(brandProfile.mission, brandProfile.values);

  return `${userPrompt}. Style: ${toneAdjectives.join(", ")}. Brand essence: ${brandContext}`;
}

function getToneAdjectives(tone: ToneDescriptors): string[] {
  const adjectives = [];

  if (tone.formalCasual > 70) adjectives.push("casual", "approachable");
  else if (tone.formalCasual < 30) adjectives.push("professional", "polished");

  if (tone.seriousPlayful > 70) adjectives.push("playful", "vibrant");
  else if (tone.seriousPlayful < 30) adjectives.push("serious", "refined");

  if (tone.reservedEnthusiastic > 70) adjectives.push("energetic", "bold");
  else if (tone.reservedEnthusiastic < 30) adjectives.push("understated", "elegant");

  return adjectives;
}
```

---

#### 1.4 Post Composer (Main Component)

**File**: `src/components/orbit/composer/PostComposer.tsx`

**Purpose**: Main composer interface for creating social media posts

**Key Features**:

- Text editor for post content
- Image attachment grid
- Platform selector (future: multi-platform)
- Character count per platform
- Draft/Schedule/Publish actions

**Integration Points**:

- "Generate Image" button ‚Üí Opens `ImageGenerationDialog`
- "Enhance Image" button ‚Üí Opens `ImageEnhancementDialog` (on selected image)
- Saves generated images as `Asset` records
- Links assets to post via `PostAsset` join table

---

### Phase 2: Supporting Files

#### 2.1 Prompt Builder Utilities

**File**: `src/lib/ai/prompt-builder.ts`

**Purpose**: Shared utilities for brand-aware prompt enhancement

**Exports**:

```typescript
export function enhanceImagePrompt(
  userPrompt: string,
  brandProfile: BrandProfile | null,
  options?: {
    includeColorPalette?: boolean;
    includeMission?: boolean;
  },
): string;

export function extractToneAdjectives(
  toneDescriptors: ToneDescriptors,
): string[];

export function buildBrandContext(
  mission: string | null,
  values: string[] | null,
): string;
```

**Tests**: `src/lib/ai/prompt-builder.test.ts`

---

#### 2.2 Image Generation Hook

**File**: `src/hooks/useImageGeneration.ts`

**Purpose**: React hook for managing image generation state

**Exports**:

```typescript
export function useImageGeneration(workspaceId: string) {
  return {
    // State
    isGenerating: boolean;
    jobId: string | null;
    generatedImage: { url: string; jobId: string } | null;
    error: Error | null;

    // Actions
    generateImage: (params: GenerateImageParams) => Promise<void>;
    pollJobStatus: (jobId: string) => Promise<void>;
    reset: () => void;
  };
}
```

**Polling Logic**:

- Poll every 2s for first 10s
- Then every 5s until completion
- Max 2 minutes timeout
- Handle COMPLETED, FAILED, TIMEOUT states

**Tests**: `src/hooks/useImageGeneration.test.ts`

---

#### 2.3 Type Definitions

**File**: `src/types/image-generation.ts`

**Purpose**: TypeScript types for image generation features

**Types**:

```typescript
export interface GenerateImageParams {
  prompt: string;
  negativePrompt?: string;
  tier: EnhancementTier;
  aspectRatio: AspectRatio;
  useBrandEnhancement?: boolean;
}

export interface EnhanceImageParams {
  imageUrl: string;
  prompt: string;
  tier: EnhancementTier;
}

export interface ImageGenerationResult {
  jobId: string;
  imageUrl: string;
  tokensCost: number;
  generatedAt: Date;
}
```

---

### Phase 3: Test Files

All components require corresponding `.test.tsx` files with 100% coverage:

1. `src/components/orbit/composer/ImageGenerationDialog.test.tsx`
2. `src/components/orbit/composer/ImageEnhancementDialog.test.tsx`
3. `src/components/orbit/composer/BrandImagePromptBuilder.test.tsx`
4. `src/components/orbit/composer/PostComposer.test.tsx`
5. `src/lib/ai/prompt-builder.test.ts`
6. `src/hooks/useImageGeneration.test.ts`

**Key Test Scenarios**:

- ‚úÖ Dialog open/close behavior
- ‚úÖ Form validation (empty prompts, tier selection)
- ‚úÖ Brand profile integration (with/without profile)
- ‚úÖ API call mocking (generate, poll, error states)
- ‚úÖ Token cost calculation display
- ‚úÖ Image preview/display
- ‚úÖ Error handling (rate limits, insufficient tokens, generation failures)

---

## Files to Create

### New Component Files (8 files)

```
src/components/orbit/composer/
‚îú‚îÄ‚îÄ ImageGenerationDialog.tsx
‚îú‚îÄ‚îÄ ImageGenerationDialog.test.tsx
‚îú‚îÄ‚îÄ ImageEnhancementDialog.tsx
‚îú‚îÄ‚îÄ ImageEnhancementDialog.test.tsx
‚îú‚îÄ‚îÄ BrandImagePromptBuilder.tsx
‚îú‚îÄ‚îÄ BrandImagePromptBuilder.test.tsx
‚îú‚îÄ‚îÄ PostComposer.tsx
‚îî‚îÄ‚îÄ PostComposer.test.tsx
```

### New Library Files (4 files)

```
src/lib/ai/
‚îú‚îÄ‚îÄ prompt-builder.ts
‚îî‚îÄ‚îÄ prompt-builder.test.ts

src/hooks/
‚îú‚îÄ‚îÄ useImageGeneration.ts
‚îî‚îÄ‚îÄ useImageGeneration.test.ts
```

### New Type File (1 file)

```
src/types/
‚îî‚îÄ‚îÄ image-generation.ts
```

### Re-exports

```
src/components/orbit/composer/index.ts (barrel export)
```

---

## Files to Modify

### 1. Orbit Sidebar Navigation

**File**: `src/app/orbit/[workspaceSlug]/OrbitSidebar.tsx`

**Change**: Add "Composer" navigation item

**Location**: After "Relay" section (line ~150)

**Code**:

```tsx
{
  name: "Composer",
  href: `/orbit/${workspaceSlug}/composer`,
  icon: PencilIcon, // or ImageIcon
  permission: "orbit:compose:access"
}
```

---

### 2. Permission Definitions

**File**: `src/lib/permissions/permissions.ts`

**Change**: Add composer permissions

**Code**:

```typescript
export const ORBIT_PERMISSIONS = {
  // ... existing permissions

  // Composer
  "orbit:compose:access": "Access post composer",
  "orbit:compose:generate-image": "Generate AI images for posts",
  "orbit:compose:enhance-image": "Enhance images with AI",
} as const;
```

---

### 3. New Page Route

**File**: `src/app/orbit/[workspaceSlug]/composer/page.tsx` (NEW)

**Purpose**: Main composer page in Orbit

**Code**:

```tsx
import { PostComposer } from "@/components/orbit/composer";
import { PermissionGate } from "@/components/orbit/PermissionGate";

export default function ComposerPage() {
  return (
    <PermissionGate permission="orbit:compose:access">
      <div className="container py-6">
        <h1 className="text-3xl font-bold mb-6">Create Post</h1>
        <PostComposer />
      </div>
    </PermissionGate>
  );
}
```

**Test File**: `src/app/orbit/[workspaceSlug]/composer/page.test.tsx`

---

## API Integration Details

### Existing Endpoints (No Changes Required)

#### 1. Generate Image

- **Endpoint**: `POST /api/mcp/generate`
- **Request**: `{ prompt, tier, negativePrompt?, aspectRatio? }`
- **Response**: `{ success, jobId, tokensCost }`

#### 2. Check Job Status

- **Endpoint**: `GET /api/mcp/jobs/{jobId}`
- **Response**: `{ status, result?, error? }`
- **Status Values**: `PENDING`, `PROCESSING`, `COMPLETED`, `FAILED`

#### 3. Modify Image

- **Endpoint**: `POST /api/mcp/modify`
- **Request**: `{ image_url, prompt, tier }`
- **Response**: `{ success, jobId, tokensCost }`

#### 4. Brand Profile

- **Endpoint**: `GET /api/workspaces/{workspaceId}/brand-profile`
- **Response**: `{ brandProfile, guardrails, vocabulary }`

---

## Edge Cases & Considerations

### 1. No Brand Profile

**Scenario**: User hasn't set up Brand Brain

**Handling**:

- Still allow image generation
- Show notice: "Set up Brand Brain for brand-aware prompts"
- Use generic, platform-appropriate prompts

### 2. Insufficient Tokens

**Scenario**: User lacks tokens for selected tier

**Handling**:

- Display current balance in dialog
- Disable tier options beyond available tokens
- Show "Add tokens" link to billing page

### 3. Rate Limiting

**Scenario**: User hits rate limit (10 req/min per `/api/mcp/generate`)

**Handling**:

- Display clear error message with retry-after time
- Show countdown timer
- Auto-retry when limit resets

### 4. Generation Timeout

**Scenario**: Job doesn't complete within 2 minutes

**Handling**:

- Stop polling after timeout
- Display error with `jobId` for support
- Allow user to check status manually later

### 5. Long Prompts

**Scenario**: User enters >4000 character prompt

**Handling**:

- Validate on client side
- Show character count (current/4000)
- Truncate with warning if needed

---

## Testing Strategy

### Unit Tests (100% Coverage Required)

- All components with RTL + Vitest
- All hooks with mock API responses
- All utility functions with edge cases

### Integration Tests (E2E)

**File**: `e2e/features/orbit-composer.feature`

**Scenarios**:

```gherkin
Feature: Orbit Post Composer with AI Image Generation

  Scenario: Generate image for post
    Given I am logged in as a workspace admin
    And I navigate to "/orbit/my-workspace/composer"
    When I click "Generate Image"
    And I enter prompt "a modern tech startup office"
    And I select tier "TIER_1K"
    And I select aspect ratio "16:9"
    And I click "Generate"
    Then I should see a loading indicator
    And after 5 seconds I should see the generated image
    And I should see "Image generated successfully"

  Scenario: Generate with brand awareness
    Given I have a Brand Brain profile configured
    And I navigate to "/orbit/my-workspace/composer"
    When I open the image generation dialog
    And I enter prompt "product launch celebration"
    Then I should see the enhanced prompt preview
    And the preview should include my brand tone descriptors

  Scenario: Handle insufficient tokens
    Given my account has 1 token remaining
    When I open the image generation dialog
    And I select tier "TIER_4K" (costs 10 tokens)
    Then the Generate button should be disabled
    And I should see "Insufficient tokens"
```

---

## Potential Risks & Mitigations

### Risk 1: API Response Delays

**Impact**: Users wait too long for images

**Mitigation**:

- Show clear loading states
- Allow background generation (close dialog, poll in background)
- Send notification when complete

### Risk 2: Brand Enhancement Quality

**Impact**: Enhanced prompts don't match brand voice

**Mitigation**:

- Show preview of enhanced prompt
- Allow manual override/editing
- Provide toggle to disable enhancement

### Risk 3: Cost Transparency

**Impact**: Users consume tokens unexpectedly

**Mitigation**:

- Display token cost BEFORE generation
- Show current balance in dialog
- Confirm before expensive tiers (TIER_4K)

---

## Performance Considerations

### 1. Polling Optimization

- Use exponential backoff (2s ‚Üí 5s)
- Cancel polling on dialog close
- Cleanup intervals on unmount

### 2. Image Loading

- Show placeholder/skeleton during load
- Optimize image display with Next.js Image component
- Cache generated images locally (session storage)

### 3. Brand Profile Caching

- Use `useBrandProfile` hook (already implements caching)
- Refetch only on workspace change
- Don't re-fetch on every dialog open

---

## Future Enhancements (Out of Scope)

These are NOT included in this ticket:

1. ‚ùå Vibe coding integration (Phase 8)
2. ‚ùå Documentation updates (Phase 9)
3. ‚ùå Batch image generation
4. ‚ùå Image editing tools (crop, filters)
5. ‚ùå Template library
6. ‚ùå Multi-image carousel generation
7. ‚ùå Video generation

---

## Success Criteria Checklist

- [ ] `ImageGenerationDialog` component created with full functionality
- [ ] `ImageEnhancementDialog` component created with full functionality
- [ ] `BrandImagePromptBuilder` component created with brand integration
- [ ] `PostComposer` integrates all components
- [ ] All components connect to `/api/mcp/generate` endpoint
- [ ] Brand Brain settings properly enhance prompts
- [ ] All tests pass with 100% coverage
- [ ] CI/CD passes (build, tests, E2E)
- [ ] No TypeScript errors
- [ ] Accessible (keyboard navigation, ARIA labels)
- [ ] Responsive (mobile, tablet, desktop)

---

## Implementation Order

1. **Day 1**: Core utilities and types
   - `src/lib/ai/prompt-builder.ts` + tests
   - `src/types/image-generation.ts`
   - `src/hooks/useImageGeneration.ts` + tests

2. **Day 2**: Brand-aware components
   - `BrandImagePromptBuilder.tsx` + tests

3. **Day 3**: Generation dialogs
   - `ImageGenerationDialog.tsx` + tests
   - `ImageEnhancementDialog.tsx` + tests

4. **Day 4**: Main composer
   - `PostComposer.tsx` + tests
   - Page route + navigation

5. **Day 5**: Integration & E2E
   - E2E tests
   - Bug fixes
   - CI/CD verification

---

## Dependencies

### NPM Packages (Already Available)

- ‚úÖ `@radix-ui/react-dialog` (shadcn/ui)
- ‚úÖ `@tanstack/react-query` (already used in `useBrandProfile`)
- ‚úÖ `zod` (validation)
- ‚úÖ `react-hook-form` (forms)

### Internal Dependencies

- ‚úÖ `/api/mcp/generate` endpoint
- ‚úÖ `/api/mcp/modify` endpoint
- ‚úÖ `/api/mcp/jobs/{jobId}` endpoint
- ‚úÖ `useBrandProfile` hook
- ‚úÖ Brand Brain data structures

### No External Dependencies Required ‚ú®

---

## Rollback Plan

If critical issues arise:

1. **Immediate**: Remove composer route from sidebar navigation
2. **Same PR**: Add feature flag `ENABLE_ORBIT_COMPOSER` (env var)
3. **Wrap Route**: Conditionally render composer page based on flag
4. **Disable in Production**: Set flag to `false` until issues resolved

---

## Monitoring & Observability

Post-deployment metrics to track:

1. **Usage Metrics**:
   - Number of images generated per day
   - Tier distribution (1K vs 2K vs 4K)
   - Brand enhancement adoption rate

2. **Performance Metrics**:
   - Average generation time
   - API error rate
   - Polling timeout rate

3. **Business Metrics**:
   - Token consumption per workspace
   - Conversion: free trial ‚Üí paid (if applicable)

---

## Related Issues

- **Parent Epic**: #836 - Spike Land Pivot
- **Depends On**: None (all dependencies exist)
- **Blocks**: #??? (Phase 8 - Vibe Coding)
- **Related**: #945 (Brand Brain features)

---

## Questions & Assumptions

### Assumptions Made:

1. ‚úÖ Posts can have multiple images (via `PostAsset` join table)
2. ‚úÖ Generated images saved as `Asset` records in R2
3. ‚úÖ Composer is workspace-scoped (not user-scoped)
4. ‚úÖ Existing MCP endpoints handle authentication/authorization

### Questions for Stakeholder:

1. Should composer support scheduled posts initially? (Assuming NO for MVP)
2. Should we limit max images per post? (Assuming NO for MVP)
3. Should generated images be visible in main Asset library? (Assuming YES)

---

**Plan Created**: 2026-01-29
**Plan Author**: Ralph Wiggum Planning Agent
**Status**: Ready for Implementation üöÄ
