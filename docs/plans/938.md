# Implementation Plan: Gemini AI Integration for Audience Analysis

**Issue**: #938
**Created**: 2026-01-29
**Updated**: 2026-01-29 (Ralph Wiggum Planning Agent)
**Complexity**: Medium

## Summary

Integrate Google's Gemini AI to analyze campaign audience data and provide actionable insights about demographics, interests, and targeting strategies. This will help users optimize their marketing campaigns by understanding audience patterns and receiving AI-powered recommendations.

## ⚠️ IMPORTANT: File Path Clarifications

The issue specifies THREE exact file paths to create:

1. ✅ `packages/testing.spike.land/src/ai/gemini.ts` - Backend worker Gemini client
2. ✅ `src/services/audience-analysis.ts` - Web app service layer (NOT `src/lib/ai/`)
3. ✅ `src/app/api/audience/analyze/route.ts` - API endpoint (NOT `[briefId]` dynamic route)

**Previous plan assumed** `src/lib/ai/audience-analysis.ts` and `[briefId]` routes - **this is INCORRECT**.

We must follow the issue's exact specifications.

## Acceptance Criteria

- [x] Implement Gemini AI client in the backend
- [ ] Create a service to analyze audience data using Gemini
- [ ] Endpoint to trigger analysis and retrieve results
- [ ] Store analysis results in the database
- [ ] Handle API errors and rate limits gracefully

## Technical Approach

### 1. Database Schema Updates

**File**: `prisma/schema.prisma`

Add a new model to store audience analysis results:

```prisma
model AudienceAnalysis {
  id          String   @id @default(cuid())
  briefId     String   @unique
  insights    Json     // AI-generated insights about the audience
  suggestions Json     // Targeting recommendations
  score       Float?   // Overall audience definition quality score (0-100)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  brief CampaignBrief @relation(fields: [briefId], references: [id], onDelete: Cascade)

  @@map("audience_analyses")
}
```

Update `CampaignBrief` model to include the analysis relation:

```prisma
model CampaignBrief {
  // ... existing fields ...
  audienceAnalysis AudienceAnalysis?
}
```

**Migration**: Create a new migration file in `prisma/migrations/`

### 2. Extend Gemini Client

**File**: `src/lib/ai/gemini-client.ts`

The Gemini client already exists and has a `generateAgentResponse` function. We'll use this existing function for audience analysis. No changes needed to this file - it already supports:

- Text-based analysis using `gemini-3-flash-preview` model
- Chat history support
- System prompts
- Error handling

### 3. Create Audience Analysis Service

**File**: `src/services/audience-analysis.ts` ⭐ (Per issue spec - NEW directory!)

This service will:

- Fetch campaign brief and target audience data
- Format data for Gemini AI prompt
- Call `generateAgentResponse` with specialized prompts
- Parse and structure AI response
- Handle errors and timeouts

**Interface**:

```typescript
interface AudienceInsights {
  demographicAnalysis: {
    ageRangeAssessment: string;
    genderDistribution: string;
    locationRelevance: string;
  };
  interestAlignment: {
    primaryInterests: string[];
    secondaryInterests: string[];
    conflictingInterests: string[];
  };
  behaviorPatterns: {
    identifiedBehaviors: string[];
    targetingOpportunities: string[];
  };
  recommendations: {
    refinements: string[];
    expansions: string[];
    warnings: string[];
  };
}

interface AnalyzeAudienceResult {
  score: number; // 0-100
  insights: AudienceInsights;
  suggestions: string[];
  rawAnalysis: string;
}

export async function analyzeAudience(
  briefId: string,
): Promise<AnalyzeAudienceResult>;
```

**Prompt Strategy**:

```typescript
const AUDIENCE_ANALYSIS_SYSTEM_PROMPT = `
You are an expert marketing analyst specializing in audience targeting and segmentation.
Analyze the provided target audience data and provide actionable insights.

Format your response as JSON with this structure:
{
  "score": <0-100 quality score>,
  "insights": { ... },
  "suggestions": [ ... ]
}
`;
```

### 4. Create API Endpoint

**File**: `src/app/api/audience/analyze/route.ts` ⭐ (Per issue spec - NOT dynamic route!)

**Endpoint**: `POST /api/audience/analyze` AND `GET /api/audience/analyze`

**Authentication**: Required (NextAuth session)

**POST Request Body**:

```json
{
  "briefId": "clx123..."
}
```

**GET Query Params**:

```
?briefId=clx123...
```

**Response**:

```typescript
{
  "success": true,
  "analysis": {
    "score": 85,
    "insights": { ... },
    "suggestions": [ ... ]
  },
  "cached": false
}
```

**Flow**:

1. Authenticate user via NextAuth
2. Verify user owns the campaign brief
3. Check if analysis already exists (cache)
4. If not cached, call `analyzeAudience()` service
5. Store results in `AudienceAnalysis` table
6. Return structured response

**Error Handling**:

- 401: Unauthorized (no session)
- 403: Forbidden (user doesn't own brief)
- 404: Brief not found
- 422: Incomplete audience data (missing required fields)
- 429: Rate limit exceeded (Gemini API)
- 500: Internal error (Gemini API failure, database error)
- 503: Service unavailable (Gemini API timeout)

### 5. Validation Schemas

**File**: `packages/shared/src/validations/audience-analysis.ts` (NEW)

Create Zod schemas for:

- API request validation
- AI response validation
- Database storage validation

```typescript
export const AudienceInsightsSchema = z.object({
  demographicAnalysis: z.object({
    ageRangeAssessment: z.string(),
    genderDistribution: z.string(),
    locationRelevance: z.string(),
  }),
  // ... other fields
});

export const AnalyzeAudienceResponseSchema = z.object({
  score: z.number().min(0).max(100),
  insights: AudienceInsightsSchema,
  suggestions: z.array(z.string()),
});
```

### 6. Rate Limiting & Error Handling

**Considerations**:

- Gemini API has rate limits (queries per minute, tokens per request)
- Implement exponential backoff for 429 errors
- Set timeout for Gemini requests (30 seconds max)
- Cache successful analyses to reduce API calls
- Log all API errors for monitoring

**Implementation**:

```typescript
// Use existing pattern from gemini-client.ts
const ANALYSIS_TIMEOUT_MS = 30 * 1000; // 30 seconds
const MAX_RETRIES = 3;
const RETRY_DELAY_MS = 1000; // Exponential backoff starting point
```

## Files to Create

### Backend Worker (Cloudflare)

1. **⭐ Gemini Client**: `packages/testing.spike.land/src/ai/gemini.ts` (per issue spec)
   - Standalone Gemini client for Cloudflare Worker environment
   - `analyzeAudience()` function with structured JSON output
   - Error handling, rate limits, timeout (30s)
   - TypeScript types: `AudienceData`, `AudienceInsights`

2. **Tests**: `packages/testing.spike.land/src/ai/gemini.test.ts`
   - Unit tests with 100% coverage
   - Mock Gemini API responses
   - Rate limit and timeout scenarios

### Web App (Next.js)

3. **⭐ Service**: `src/services/audience-analysis.ts` (per issue spec)
   - Business logic layer for audience analysis
   - Database queries (fetch audience data)
   - Call Gemini via `generateStructuredResponse<T>()`
   - Result caching and storage

4. **Service Tests**: `src/services/audience-analysis.test.ts`
   - Unit tests for service with 100% coverage
   - Mock database and Gemini client calls
   - Test error scenarios

5. **⭐ API Route**: `src/app/api/audience/analyze/route.ts` (per issue spec)
   - POST endpoint to trigger analysis (accepts `briefId` in body)
   - GET endpoint to retrieve cached results (accepts `briefId` query param)
   - Authentication & authorization
   - Zod input validation

6. **API Tests**: `src/app/api/audience/analyze/route.test.ts`
   - Integration tests for both POST and GET
   - Auth/authorization tests (401, 403)
   - Input validation tests (400)
   - Error handling tests (500)

### Database & Dependencies

7. **Migration**: `prisma/migrations/YYYYMMDD_add_audience_analysis/migration.sql`
   - Add `AudienceAnalysis` model
   - Add relation to `CampaignBrief`

8. **Backend Package**: `packages/testing.spike.land/package.json`
   - Add `"@google/genai": "^0.21.0"` to dependencies

## Files to Modify

1. **Prisma Schema**: `prisma/schema.prisma`
   - Add `AudienceAnalysis` model
   - Update `CampaignBrief` relation

2. **Shared Package Exports**: `packages/shared/src/validations/index.ts`
   - Export new validation schemas

3. **Type Definitions**: `src/types/audience.ts` (if needed)
   - TypeScript types for audience analysis

## Testing Considerations

### Unit Tests (100% Coverage Required)

**Service Tests** (`audience-analysis.test.ts`):

- ✅ Successfully analyzes complete audience data
- ✅ Handles missing/incomplete audience fields
- ✅ Correctly formats Gemini prompt
- ✅ Parses AI response JSON correctly
- ✅ Handles malformed AI responses
- ✅ Respects timeout limits
- ✅ Retries on transient failures
- ✅ Returns cached results when available

**API Route Tests** (`route.test.ts`):

- ✅ Requires authentication
- ✅ Verifies brief ownership
- ✅ Returns 404 for non-existent brief
- ✅ Returns 422 for incomplete audience data
- ✅ Handles Gemini API errors gracefully
- ✅ Stores analysis results in database
- ✅ Returns cached results on subsequent requests

**Validation Tests** (`audience-analysis.test.ts`):

- ✅ Validates complete analysis response
- ✅ Rejects invalid score ranges
- ✅ Validates nested insights structure
- ✅ Validates suggestions array

### E2E Tests (Cucumber)

**Feature**: `e2e/features/audience-analysis.feature`

```gherkin
Feature: Audience Analysis with Gemini AI

  Scenario: Analyze campaign audience
    Given I am logged in
    And I have a campaign brief with complete audience data
    When I request audience analysis
    Then I should receive AI-generated insights
    And the analysis should be stored in the database

  Scenario: Handle incomplete audience data
    Given I am logged in
    And I have a campaign brief with incomplete audience data
    When I request audience analysis
    Then I should receive a 422 error
    And the error should explain which fields are missing
```

## Environment Variables

**File**: `.env.example`

Already exists:

```bash
GEMINI_API_KEY=your-gemini-api-key-here
```

No new environment variables needed.

## API Documentation

**File**: `docs/API_REFERENCE.md`

Add new section:

````markdown
## Audience Analysis API

### Analyze Campaign Audience

Trigger AI-powered analysis of campaign target audience using Google Gemini.

**Endpoint**: `POST /api/audience/[briefId]/analyze`

**Authentication**: Required (Session)

**Path Parameters**:

| Parameter | Type   | Description              |
| --------- | ------ | ------------------------ |
| briefId   | string | Campaign brief ID (cuid) |

**Response** (200 OK):

```json
{
  "success": true,
  "analysis": {
    "score": 85,
    "insights": {
      "demographicAnalysis": { ... },
      "interestAlignment": { ... },
      "behaviorPatterns": { ... },
      "recommendations": { ... }
    },
    "suggestions": [
      "Consider expanding age range to 25-34 for better reach",
      "Add 'sustainable living' to interests based on behavior patterns"
    ]
  },
  "cached": false
}
```
````

**Error Responses**:

- `401`: Unauthorized - no active session
- `403`: Forbidden - user doesn't own this brief
- `404`: Campaign brief not found
- `422`: Incomplete audience data
- `429`: Rate limit exceeded
- `500`: Internal server error
- `503`: Gemini API timeout

```
## Potential Risks & Mitigations

### Risk 1: Gemini API Rate Limits
**Mitigation**:
- Implement caching (store analysis results)
- Add exponential backoff retry logic
- Return 429 with retry-after header

### Risk 2: AI Response Quality
**Mitigation**:
- Use structured JSON output format
- Validate AI responses with Zod schemas
- Provide fallback error messages
- Log unexpected responses for improvement

### Risk 3: Cost Management
**Mitigation**:
- Cache analysis results (don't re-analyze unchanged data)
- Use nano model (gemini-2.5-flash-image) if available for cost savings
- Monitor API usage via logs

### Risk 4: Response Time
**Mitigation**:
- Set aggressive timeout (30 seconds)
- Return cached results immediately
- Consider async processing for complex analyses

### Risk 5: Data Privacy
**Mitigation**:
- Don't log sensitive audience data
- Only send necessary fields to Gemini
- Follow existing GDPR compliance patterns

## Implementation Order

1. ✅ **Database Schema** (migration)
   - Enables data storage
   - Blocks: API endpoint, service

2. ✅ **Validation Schemas** (Zod)
   - Type safety for service and API
   - Blocks: Service, API endpoint

3. ✅ **Audience Analysis Service**
   - Core business logic
   - Blocks: API endpoint
   - Includes: Unit tests (100% coverage)

4. ✅ **API Endpoint**
   - External interface
   - Depends on: Service, validation
   - Includes: Integration tests

5. ✅ **E2E Tests** (Cucumber)
   - End-to-end validation
   - Depends on: API endpoint

6. ✅ **Documentation Updates**
   - API reference docs
   - User guide updates

## Success Metrics

- ✅ All unit tests pass (100% coverage)
- ✅ All integration tests pass
- ✅ E2E tests pass
- ✅ No TypeScript errors
- ✅ Linter passes
- ✅ API responds within 5 seconds (cached)
- ✅ API responds within 30 seconds (uncached)
- ✅ Error rate < 1% (excluding user errors like 422)

## Notes

- The issue mentions `packages/testing.spike.land/src/ai/gemini.ts`, but this file doesn't exist. Based on the existing architecture, we're implementing in the main Next.js app (`src/lib/ai/`) following established patterns.

- The issue mentions `src/services/audience-analysis.ts`, but the project uses `src/lib/` for services. We'll follow the existing convention: `src/lib/ai/audience-analysis.ts`

- The existing `gemini-client.ts` already has the `generateAgentResponse` function we need. No modifications to that file are required.

- We're using the typed `CampaignTargetAudience` model (Phase 4) rather than the JSON columns, as this is the modern approach in the codebase.

- Rate limiting should be handled at the API gateway level (Vercel) and within the Gemini client retry logic.

## Out of Scope

- ❌ Real-time chat with the audience (per issue)
- ❌ Fine-tuning Gemini models (per issue)
- ❌ Frontend UI for displaying analysis results
- ❌ Webhook notifications when analysis completes
- ❌ Comparative analysis between multiple campaigns
- ❌ Historical trend analysis
- ❌ Export analysis to PDF/CSV
```
