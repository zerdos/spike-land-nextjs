# Implementation Plan: Epic #520 - Creative Factory

## Overview

This epic introduces a Creative Factory module for creating, managing, and optimizing creative assets for marketing campaigns. It consists of three main components:

1. **Brief Builder (ORB-059)**: Campaign brief wizard with objectives and targeting
2. **Variant Generator (ORB-060)**: AI-powered ad copy and image variation generator
3. **Fatigue Detector (ORB-061)**: Performance decay analysis and refresh recommendations

## Dependencies

✅ **Epic 3.5 - Content Library**: Already implemented

- Asset management system exists (`Asset`, `AssetFolder`, `AssetTag` models)
- Asset upload/storage infrastructure in place
- File management UI components available

✅ **Existing Infrastructure**:

- Campaign Brief models already exist (`CampaignBrief`, `CampaignTargetAudience`, `CampaignObjective`)
- Gemini AI integration for content generation
- Spike Land image generation/modification MCP tools
- Token system for AI operations

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────┐
│                    Creative Factory Module                   │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌───────────────┐  ┌───────────────┐  ┌─────────────────┐ │
│  │ Brief Builder │  │   Variant     │  │    Fatigue      │ │
│  │   (ORB-059)   │──│   Generator   │──│    Detector     │ │
│  │               │  │  (ORB-060)    │  │   (ORB-061)     │ │
│  └───────┬───────┘  └───────┬───────┘  └────────┬────────┘ │
│          │                  │                     │          │
│          └──────────────────┴─────────────────────┘          │
│                             │                                │
└─────────────────────────────┼────────────────────────────────┘
                              │
                ┌─────────────┴─────────────┐
                │   Content Library (Epic 3.5) │
                │   - Assets                    │
                │   - Folders                   │
                │   - Tags                      │
                └───────────────────────────────┘
```

---

## Story 1: ORB-059 - Brief Builder

### Summary

Create a multi-step wizard for building marketing campaign briefs with objectives, targeting, and creative direction.

### Database Schema Changes

#### 1.1 Brief Template System

```prisma
model BriefTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Template structure (JSON schema for form fields)
  fieldsSchema Json // Defines custom fields for this template type

  // Default values
  defaultObjectives String[] // Default objective types
  defaultChannels   String[] // e.g., ["facebook", "google_ads"]

  isPublic    Boolean  @default(false) // Public templates available to all
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  briefs CampaignBrief[]

  @@index([workspaceId])
  @@map("brief_templates")
}
```

#### 1.2 Extend CampaignBrief Model

```prisma
// Add to existing CampaignBrief model:
model CampaignBrief {
  // ... existing fields ...

  templateId String?
  template   BriefTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  // Creative direction
  toneOfVoice      String? // e.g., "professional", "casual", "humorous"
  keyMessages      String[] // Main messages to communicate
  callToAction     String? // Primary CTA
  brandGuidelines  Json? // Colors, fonts, style preferences

  // Budget and timeline
  budgetAmount  Float?
  budgetCurrency String? @default("GBP")
  startDate     DateTime?
  endDate       DateTime?

  // Relationships
  creativeSets CreativeSet[]
}
```

#### 1.3 Creative Channels

```prisma
model CreativeChannel {
  id       String @id @default(cuid())
  briefId  String
  brief    CampaignBrief @relation(fields: [briefId], references: [id], onDelete: Cascade)

  platform String // e.g., "facebook", "instagram", "google_ads", "linkedin"

  // Platform-specific requirements
  adFormats String[] // e.g., ["single_image", "carousel", "video"]
  dimensions Json // Platform-specific size requirements

  createdAt DateTime @default(now())

  @@index([briefId])
  @@map("creative_channels")
}
```

### API Endpoints

#### 1.4 Brief Templates API

**POST /api/orbit/[workspaceSlug]/briefs/templates**

- Create new brief template
- Body: `{ name, description, fieldsSchema, defaultObjectives, defaultChannels }`

**GET /api/orbit/[workspaceSlug]/briefs/templates**

- List all available templates (workspace + public)
- Query params: `page`, `search`

**GET /api/orbit/[workspaceSlug]/briefs/templates/[templateId]**

- Get template details

#### 1.5 Brief Builder API

**POST /api/orbit/[workspaceSlug]/briefs**

- Create new campaign brief
- Body: `{ name, templateId?, targetAudience, objectives, channels, ... }`

**PATCH /api/orbit/[workspaceSlug]/briefs/[briefId]**

- Update brief (wizard progress)

**GET /api/orbit/[workspaceSlug]/briefs**

- List all briefs for workspace
- Query params: `status`, `page`, `search`

**GET /api/orbit/[workspaceSlug]/briefs/[briefId]**

- Get brief details with all relationships

### UI Components

#### 1.6 Brief Builder Wizard

**Location**: `src/app/orbit/[workspaceSlug]/briefs/new/page.tsx`

**Steps**:

1. **Template Selection** (optional)
   - List of templates with preview
   - "Start from scratch" option

2. **Campaign Details**
   - Name, description
   - Start/end dates
   - Budget (optional)

3. **Objectives & KPIs**
   - Select objective types (AWARENESS, ENGAGEMENT, CONVERSION, etc.)
   - Set target metrics (impressions, clicks, conversions)
   - Define success criteria

4. **Target Audience**
   - Demographics (age, gender, location)
   - Interests & behaviors
   - Custom segments

5. **Creative Direction**
   - Tone of voice
   - Key messages (multi-input)
   - Call to action
   - Brand guidelines (color picker, file upload)

6. **Channels & Formats**
   - Select platforms (checkboxes)
   - Ad formats per platform
   - Dimension requirements

7. **Review & Submit**
   - Summary of all inputs
   - Edit any step
   - Save as draft or activate

**Components to Create**:

- `src/components/orbit/briefs/BriefWizard.tsx`
- `src/components/orbit/briefs/TemplateSelector.tsx`
- `src/components/orbit/briefs/ObjectivesForm.tsx`
- `src/components/orbit/briefs/AudienceBuilder.tsx`
- `src/components/orbit/briefs/CreativeDirectionForm.tsx`
- `src/components/orbit/briefs/ChannelSelector.tsx`
- `src/components/orbit/briefs/BriefSummary.tsx`

#### 1.7 Brief Management

**Location**: `src/app/orbit/[workspaceSlug]/briefs/page.tsx`

- Table view of all briefs
- Filter by status (DRAFT, ACTIVE, COMPLETED)
- Search by name
- Quick actions: Edit, Duplicate, Archive

---

## Story 2: ORB-060 - Variant Generator

### Summary

AI-powered generator that creates multiple ad copy and image variations based on campaign brief.

### Database Schema Changes

#### 2.1 Creative Sets

```prisma
model CreativeSet {
  id          String   @id @default(cuid())
  name        String
  briefId     String
  brief       CampaignBrief @relation(fields: [briefId], references: [id], onDelete: Cascade)

  // Generation metadata
  generatedAt     DateTime @default(now())
  generatedById   String
  generatedBy     User @relation(fields: [generatedById], references: [id], onDelete: Cascade)

  // AI model used
  modelVersion    String // e.g., "gemini-2.0-flash"
  generationPrompt String @db.Text

  // Performance tracking
  status CreativeSetStatus @default("DRAFT")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  variants CreativeVariant[]

  @@index([briefId])
  @@map("creative_sets")
}

enum CreativeSetStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
}
```

#### 2.2 Creative Variants

```prisma
model CreativeVariant {
  id            String   @id @default(cuid())
  setId         String
  set           CreativeSet @relation(fields: [setId], references: [id], onDelete: Cascade)

  variantType   CreativeVariantType

  // Text variants
  headline      String?
  bodyText      String? @db.Text
  callToAction  String?

  // Image variants
  assetId       String?
  asset         Asset? @relation(fields: [assetId], references: [id], onDelete: SetNull)

  // Generation job (for images)
  imageJobId    String? @unique
  imageJob      McpGenerationJob? @relation(fields: [imageJobId], references: [id], onDelete: SetNull)

  // Variant metadata
  variantNumber Int // e.g., 1, 2, 3 within the set

  // Performance metrics (populated by ORB-061)
  impressions   Int @default(0)
  clicks        Int @default(0)
  conversions   Int @default(0)
  ctr           Float @default(0) // Click-through rate

  status        VariantStatus @default("PENDING")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  performanceHistory CreativePerformance[]

  @@index([setId])
  @@index([assetId])
  @@map("creative_variants")
}

enum CreativeVariantType {
  TEXT_ONLY
  IMAGE_ONLY
  COMBINED // Text + Image
}

enum VariantStatus {
  PENDING      // Awaiting generation
  GENERATING   // AI generation in progress
  READY        // Ready to use
  ACTIVE       // Currently in use
  PAUSED       // Temporarily disabled
  FAILED       // Generation failed
}
```

### API Endpoints

#### 2.3 Variant Generation API

**POST /api/orbit/[workspaceSlug]/briefs/[briefId]/generate-variants**

- Generate creative variants from brief
- Body: `{ setName?, variantCount: number, includeImages: boolean, includeText: boolean }`
- Response: `{ setId, jobId (if generating images) }`

**GET /api/orbit/[workspaceSlug]/creative-sets/[setId]/variants**

- List all variants in a set
- Query params: `status`, `type`

**PATCH /api/orbit/[workspaceSlug]/creative-sets/[setId]/variants/[variantId]**

- Update variant (edit text, replace image)
- Body: `{ headline?, bodyText?, callToAction?, assetId? }`

**DELETE /api/orbit/[workspaceSlug]/creative-sets/[setId]/variants/[variantId]**

- Delete variant

**POST /api/orbit/[workspaceSlug]/creative-sets/[setId]/variants/[variantId]/regenerate**

- Regenerate specific variant

### Generation Service

#### 2.4 Variant Generation Logic

**Location**: `src/lib/creative-factory/variant-generator.ts`

```typescript
export async function generateCreativeVariants(params: {
  brief: CampaignBrief;
  count: number;
  includeText: boolean;
  includeImages: boolean;
  userId: string;
}): Promise<{ setId: string; variants: CreativeVariant[] }> {
  // 1. Create CreativeSet
  const set = await prisma.creativeSet.create({ ... });

  // 2. Generate text variants using Gemini
  if (params.includeText) {
    const textVariants = await generateTextVariants({
      brief: params.brief,
      count: params.count,
    });
    // Save to DB
  }

  // 3. Generate image variants using MCP
  if (params.includeImages) {
    const imageVariants = await generateImageVariants({
      brief: params.brief,
      count: params.count,
    });
    // Save to DB with imageJobId
  }

  // 4. Return set with pending variants
  return { setId: set.id, variants };
}

async function generateTextVariants(params: {
  brief: CampaignBrief;
  count: number;
}): Promise<TextVariant[]> {
  const gemini = getGeminiClient();

  const prompt = `
    Create ${params.count} ad copy variations for a marketing campaign.

    Campaign Brief:
    - Objective: ${params.brief.objectivesTyped.map(o => o.type).join(", ")}
    - Target Audience: ${JSON.stringify(params.brief.targetAudienceTyped)}
    - Tone: ${params.brief.toneOfVoice}
    - Key Messages: ${params.brief.keyMessages.join(", ")}
    - CTA: ${params.brief.callToAction}

    For each variation, provide:
    - headline (max 40 characters)
    - bodyText (max 125 characters)
    - callToAction (max 20 characters)

    Return as JSON array.
  `;

  const result = await gemini.generateContent(prompt);
  return JSON.parse(result.response.text());
}

async function generateImageVariants(params: {
  brief: CampaignBrief;
  count: number;
}): Promise<ImageVariant[]> {
  const variants: ImageVariant[] = [];

  for (let i = 0; i < params.count; i++) {
    const imagePrompt = `
      Marketing ad image for:
      - Product/Service: ${params.brief.name}
      - Tone: ${params.brief.toneOfVoice}
      - Key Message: ${params.brief.keyMessages[i % params.brief.keyMessages.length]}
      - Brand Guidelines: ${JSON.stringify(params.brief.brandGuidelines)}
    `;

    // Use MCP generate_image
    const job = await mcpGenerationService.generate({
      prompt: imagePrompt,
      tier: "TIER_2K",
      aspectRatio: "16:9", // From channel requirements
    });

    variants.push({
      imageJobId: job.id,
      variantNumber: i + 1,
    });
  }

  return variants;
}
```

### UI Components

#### 2.5 Variant Generator UI

**Location**: `src/app/orbit/[workspaceSlug]/briefs/[briefId]/generate/page.tsx`

**Features**:

- Preview brief summary
- Generation options:
  - Number of variants (slider: 3-10)
  - Include text variants (checkbox)
  - Include image variants (checkbox)
  - Select platforms/formats
- Token cost calculator (2 tokens per image variant)
- Generate button

**Location**: `src/app/orbit/[workspaceSlug]/creative-sets/[setId]/page.tsx`

**Features**:

- Grid view of all variants
- Filter by type (text/image/combined)
- Preview cards with:
  - Thumbnail (for images)
  - Headline/body text
  - Performance metrics (impressions, CTR)
  - Status badge
- Actions:
  - Edit variant
  - Regenerate specific variant
  - Delete variant
  - Mark as active/paused

**Components to Create**:

- `src/components/orbit/creative-factory/VariantGenerator.tsx`
- `src/components/orbit/creative-factory/VariantCard.tsx`
- `src/components/orbit/creative-factory/VariantEditor.tsx`
- `src/components/orbit/creative-factory/GenerationProgress.tsx`

---

## Story 3: ORB-061 - Fatigue Detector

### Summary

Analyze performance metrics to detect creative fatigue and recommend refresh timing.

### Database Schema Changes

#### 3.1 Performance Tracking

```prisma
model CreativePerformance {
  id        String   @id @default(cuid())
  variantId String
  variant   CreativeVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  // Time window
  date      DateTime @db.Date

  // Performance metrics
  impressions Int @default(0)
  clicks      Int @default(0)
  conversions Int @default(0)
  spend       Float @default(0)

  // Calculated metrics
  ctr         Float @default(0) // clicks / impressions
  cpc         Float @default(0) // spend / clicks
  cvr         Float @default(0) // conversions / clicks

  createdAt DateTime @default(now())

  @@unique([variantId, date])
  @@index([variantId])
  @@index([date])
  @@map("creative_performance")
}
```

#### 3.2 Fatigue Detection

```prisma
model CreativeFatigueAlert {
  id        String   @id @default(cuid())
  variantId String
  variant   CreativeVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  // Detection metadata
  detectedAt     DateTime @default(now())
  severity       FatigueSeverity

  // Fatigue metrics
  ctrDecayPercent Float // % decline in CTR
  daysActive      Int   // Days variant has been active

  // Recommendation
  recommendedAction String // "REFRESH", "PAUSE", "REPLACE"
  estimatedRefreshDate DateTime?

  // Status
  isResolved    Boolean @default(false)
  resolvedAt    DateTime?
  resolvedById  String?
  resolvedBy    User? @relation(fields: [resolvedById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([variantId])
  @@index([severity])
  @@map("creative_fatigue_alerts")
}

enum FatigueSeverity {
  LOW      // 10-20% decay
  MEDIUM   // 20-40% decay
  HIGH     // 40%+ decay
  CRITICAL // Consistent decline over 7+ days
}
```

### API Endpoints

#### 3.3 Performance & Fatigue API

**POST /api/orbit/[workspaceSlug]/creative-sets/[setId]/variants/[variantId]/performance**

- Record performance data (called by external integrations or manual upload)
- Body: `{ date, impressions, clicks, conversions, spend }`

**GET /api/orbit/[workspaceSlug]/creative-sets/[setId]/variants/[variantId]/performance**

- Get performance history
- Query params: `startDate`, `endDate`

**GET /api/orbit/[workspaceSlug]/fatigue-alerts**

- List all fatigue alerts
- Query params: `severity`, `isResolved`, `page`

**PATCH /api/orbit/[workspaceSlug]/fatigue-alerts/[alertId]/resolve**

- Mark alert as resolved
- Body: `{ action: "REFRESHED" | "PAUSED" | "REPLACED" }`

### Fatigue Detection Algorithm

#### 3.4 Detection Service

**Location**: `src/lib/creative-factory/fatigue-detector.ts`

```typescript
export async function detectCreativeFatigue(variantId: string): Promise<{
  hasFatigue: boolean;
  severity?: FatigueSeverity;
  metrics: FatigueMetrics;
}> {
  // 1. Get performance history (last 30 days)
  const performance = await prisma.creativePerformance.findMany({
    where: {
      variantId,
      date: {
        gte: subDays(new Date(), 30),
      },
    },
    orderBy: { date: "asc" },
  });

  if (performance.length < 7) {
    return { hasFatigue: false, metrics: {} };
  }

  // 2. Calculate CTR trend
  const ctrTrend = calculateCTRTrend(performance);

  // 3. Detect decay patterns
  const decay = detectDecayPattern(ctrTrend);

  // 4. Determine severity
  let severity: FatigueSeverity | undefined;
  let hasFatigue = false;

  if (decay.percentDecline >= 40) {
    severity = "HIGH";
    hasFatigue = true;
  } else if (decay.percentDecline >= 20) {
    severity = "MEDIUM";
    hasFatigue = true;
  } else if (decay.percentDecline >= 10) {
    severity = "LOW";
    hasFatigue = true;
  }

  // 5. Check for critical pattern (consistent decline over 7 days)
  if (decay.consecutiveDeclineDays >= 7) {
    severity = "CRITICAL";
    hasFatigue = true;
  }

  return {
    hasFatigue,
    severity,
    metrics: {
      ctrDecayPercent: decay.percentDecline,
      daysActive: performance.length,
      currentCTR: performance[performance.length - 1].ctr,
      peakCTR: Math.max(...performance.map(p => p.ctr)),
    },
  };
}

function calculateCTRTrend(performance: CreativePerformance[]): number[] {
  // Moving average to smooth out noise
  const window = 3;
  const smoothed: number[] = [];

  for (let i = 0; i < performance.length; i++) {
    const start = Math.max(0, i - window + 1);
    const slice = performance.slice(start, i + 1);
    const avg = slice.reduce((sum, p) => sum + p.ctr, 0) / slice.length;
    smoothed.push(avg);
  }

  return smoothed;
}

function detectDecayPattern(ctrTrend: number[]): {
  percentDecline: number;
  consecutiveDeclineDays: number;
} {
  const peak = Math.max(...ctrTrend);
  const current = ctrTrend[ctrTrend.length - 1];
  const percentDecline = ((peak - current) / peak) * 100;

  // Count consecutive declining days
  let consecutiveDeclineDays = 0;
  for (let i = ctrTrend.length - 1; i > 0; i--) {
    if (ctrTrend[i] < ctrTrend[i - 1]) {
      consecutiveDeclineDays++;
    } else {
      break;
    }
  }

  return { percentDecline, consecutiveDeclineDays };
}
```

#### 3.5 Cron Job

**Location**: `src/app/api/cron/detect-fatigue/route.ts`

- Runs daily
- Scans all ACTIVE variants
- Creates alerts for detected fatigue
- Sends notifications to workspace owners

### UI Components

#### 3.6 Fatigue Dashboard

**Location**: `src/app/orbit/[workspaceSlug]/fatigue/page.tsx`

**Features**:

- Alert summary cards (by severity)
- Table of active alerts:
  - Variant thumbnail/name
  - Severity badge
  - CTR decay %
  - Days active
  - Recommended action
  - Quick resolve button
- Performance charts:
  - CTR trend over time
  - Comparison with other variants

**Components to Create**:

- `src/components/orbit/creative-factory/FatigueDashboard.tsx`
- `src/components/orbit/creative-factory/FatigueAlertCard.tsx`
- `src/components/orbit/creative-factory/PerformanceChart.tsx`
- `src/components/orbit/creative-factory/RefreshRecommendations.tsx`

---

## Testing Requirements

### Unit Tests

- [ ] Brief template CRUD operations
- [ ] Brief wizard form validation
- [ ] Variant generation service
- [ ] Text variant generation (Gemini)
- [ ] Image variant generation (MCP)
- [ ] Fatigue detection algorithm
- [ ] CTR trend calculation
- [ ] Decay pattern detection

### Integration Tests

- [ ] Brief creation flow (API)
- [ ] Variant generation flow (API + AI)
- [ ] Performance tracking (API)
- [ ] Fatigue alert creation (cron)

### E2E Tests

- [ ] Complete brief wizard flow
- [ ] Generate variants from brief
- [ ] View and manage creative sets
- [ ] Fatigue alert resolution

---

## Migration Strategy

### Phase 1: Database Schema

1. Create new models via Prisma migration
2. Add relationships to existing models
3. Backfill any existing campaign data

### Phase 2: API & Services

1. Implement brief builder API
2. Implement variant generator
3. Implement fatigue detector
4. Add cron job

### Phase 3: UI Components

1. Brief wizard
2. Variant generator
3. Creative set manager
4. Fatigue dashboard

### Phase 4: Integration

1. Integrate with Content Library
2. Connect to MCP image generation
3. Test end-to-end flow
4. Performance optimization

---

## File Changes Summary

### New Files to Create

#### Database

- `prisma/migrations/XXXXXX_creative_factory/migration.sql`

#### Services

- `src/lib/creative-factory/variant-generator.ts`
- `src/lib/creative-factory/variant-generator.test.ts`
- `src/lib/creative-factory/fatigue-detector.ts`
- `src/lib/creative-factory/fatigue-detector.test.ts`
- `src/lib/creative-factory/text-generator.ts`
- `src/lib/creative-factory/image-generator.ts`

#### API Routes

- `src/app/api/orbit/[workspaceSlug]/briefs/templates/route.ts`
- `src/app/api/orbit/[workspaceSlug]/briefs/templates/[templateId]/route.ts`
- `src/app/api/orbit/[workspaceSlug]/briefs/route.ts`
- `src/app/api/orbit/[workspaceSlug]/briefs/[briefId]/route.ts`
- `src/app/api/orbit/[workspaceSlug]/briefs/[briefId]/generate-variants/route.ts`
- `src/app/api/orbit/[workspaceSlug]/creative-sets/[setId]/variants/route.ts`
- `src/app/api/orbit/[workspaceSlug]/creative-sets/[setId]/variants/[variantId]/route.ts`
- `src/app/api/orbit/[workspaceSlug]/creative-sets/[setId]/variants/[variantId]/performance/route.ts`
- `src/app/api/orbit/[workspaceSlug]/fatigue-alerts/route.ts`
- `src/app/api/orbit/[workspaceSlug]/fatigue-alerts/[alertId]/resolve/route.ts`
- `src/app/api/cron/detect-fatigue/route.ts`

#### Pages

- `src/app/orbit/[workspaceSlug]/briefs/page.tsx`
- `src/app/orbit/[workspaceSlug]/briefs/new/page.tsx`
- `src/app/orbit/[workspaceSlug]/briefs/[briefId]/page.tsx`
- `src/app/orbit/[workspaceSlug]/briefs/[briefId]/generate/page.tsx`
- `src/app/orbit/[workspaceSlug]/creative-sets/page.tsx`
- `src/app/orbit/[workspaceSlug]/creative-sets/[setId]/page.tsx`
- `src/app/orbit/[workspaceSlug]/fatigue/page.tsx`

#### Components

- `src/components/orbit/briefs/BriefWizard.tsx`
- `src/components/orbit/briefs/TemplateSelector.tsx`
- `src/components/orbit/briefs/ObjectivesForm.tsx`
- `src/components/orbit/briefs/AudienceBuilder.tsx`
- `src/components/orbit/briefs/CreativeDirectionForm.tsx`
- `src/components/orbit/briefs/ChannelSelector.tsx`
- `src/components/orbit/briefs/BriefSummary.tsx`
- `src/components/orbit/briefs/BriefCard.tsx`
- `src/components/orbit/creative-factory/VariantGenerator.tsx`
- `src/components/orbit/creative-factory/VariantCard.tsx`
- `src/components/orbit/creative-factory/VariantEditor.tsx`
- `src/components/orbit/creative-factory/GenerationProgress.tsx`
- `src/components/orbit/creative-factory/FatigueDashboard.tsx`
- `src/components/orbit/creative-factory/FatigueAlertCard.tsx`
- `src/components/orbit/creative-factory/PerformanceChart.tsx`
- `src/components/orbit/creative-factory/RefreshRecommendations.tsx`

#### Hooks

- `src/hooks/use-briefs.ts`
- `src/hooks/use-creative-sets.ts`
- `src/hooks/use-fatigue-alerts.ts`

#### Types

- `src/types/creative-factory.ts`

### Files to Modify

#### Database

- `prisma/schema.prisma` - Add new models and relationships

#### Navigation

- `src/app/orbit/[workspaceSlug]/layout.tsx` - Add navigation links for briefs/creative-sets/fatigue

---

## Acceptance Criteria Validation

### ✅ Campaign brief wizard with objectives and targeting

- Multi-step wizard for campaign brief creation
- Support for objectives (AWARENESS, ENGAGEMENT, CONVERSION, etc.)
- Target audience builder (demographics, interests, behaviors)
- Creative direction inputs (tone, messages, CTA)

### ✅ AI generates ad copy and image variations

- Text variants via Gemini AI
- Image variants via Spike Land MCP
- Configurable variant count (3-10)
- Token-based billing for image generation

### ✅ Detect creative fatigue from performance decay

- Daily cron job scanning active variants
- CTR decay analysis with moving averages
- Multi-level severity (LOW, MEDIUM, HIGH, CRITICAL)
- Alert creation for detected fatigue

### ✅ Suggest refresh timing based on historical patterns

- Recommended actions (REFRESH, PAUSE, REPLACE)
- Estimated refresh dates
- Performance trend visualization
- Alert resolution tracking

---

## Risks & Considerations

### Technical Risks

1. **AI Generation Quality**: Gemini/MCP may produce low-quality variants
   - Mitigation: Allow manual editing of all variants

2. **Token Costs**: High variant counts could be expensive
   - Mitigation: Token cost calculator in UI, configurable limits

3. **Performance Data Lag**: External platforms may have delayed metrics
   - Mitigation: Manual upload option, clear data staleness indicators

4. **Fatigue Detection Accuracy**: Algorithm may produce false positives
   - Mitigation: Adjustable thresholds, manual override

### Product Risks

1. **User Complexity**: Wizard may be too complex for small campaigns
   - Mitigation: Template system, "Start from scratch" option

2. **Integration Dependency**: Requires Content Library to be stable
   - Mitigation: Already implemented and tested

---

## Timeline Estimate

### ORB-059: Brief Builder (5-7 days)

- Database schema: 1 day
- API endpoints: 2 days
- Wizard UI: 2-3 days
- Testing: 1 day

### ORB-060: Variant Generator (7-10 days)

- Database schema: 1 day
- Generation services: 3-4 days
- API endpoints: 2 days
- UI components: 2-3 days
- Testing: 1 day

### ORB-061: Fatigue Detector (5-7 days)

- Database schema: 1 day
- Detection algorithm: 2-3 days
- API endpoints: 1 day
- Dashboard UI: 1-2 days
- Testing: 1 day

**Total: 17-24 days** (3-5 weeks for full implementation)

---

## Success Metrics

### Adoption Metrics

- Number of briefs created per workspace
- Variant generation requests per week
- Average variants per brief

### Quality Metrics

- User satisfaction with generated variants (survey)
- Manual edit rate (% of variants edited after generation)
- Variant activation rate (% of generated variants actually used)

### Performance Metrics

- Fatigue detection accuracy (true positives vs false positives)
- Average CTR improvement after refresh
- Time saved vs manual creation

---

## Next Steps

1. **Review & Approval**: Get stakeholder sign-off on plan
2. **Database Design**: Create Prisma migration files
3. **API Spec**: Document API contracts
4. **UI Mockups**: Create wireframes for wizard and dashboards
5. **Implementation**: Follow phased rollout per story
