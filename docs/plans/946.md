# Implementation Plan: Phase 5 - AI Content Calendar with Scheduling

**Issue**: #946
**Epic**: #836 (Phase 5)
**Status**: Ready for Implementation
**Complexity**: Medium
**Estimated Effort**: 1-2 weeks

## Executive Summary

This plan implements Phase 5 of the Orbit pivot: AI-powered content calendar with post scheduling and social platform integration. **GOOD NEWS**: Most of the infrastructure already exists! This phase focuses on verification, enhancement, and integration rather than building from scratch.

### What Already Exists ‚úÖ

- ‚úÖ **Database Schema**: `ScheduledPost`, `ScheduledPostAccount`, `PostingTimeRecommendation` models complete
- ‚úÖ **Calendar UI**: `CalendarClient.tsx`, month view, post cards, dialogs all implemented
- ‚úÖ **AI Services**: Content generation, optimal time suggestions, weekly planning services
- ‚úÖ **Publishing Logic**: `publishing-service.ts` with full social platform integration
- ‚úÖ **Cron Job**: `/api/cron/publish-scheduled-posts/route.ts` exists and functional
- ‚úÖ **Social Clients**: Twitter, LinkedIn, Facebook, Instagram posting implemented
- ‚úÖ **Subscription Service**: `WorkspaceSubscriptionService` with limit checks

### What Needs Work üîß

1. **Verify** database schema matches requirements
2. **Enhance** AI content generation to use Brand Brain
3. **Add** subscription limit enforcement to scheduling endpoints
4. **Improve** calendar UI with AI suggestions display
5. **Test** end-to-end scheduling and publishing flow
6. **Document** the complete system

---

## Acceptance Criteria Breakdown

### 1. Database Schema Verified for Scheduling ‚úÖ

**Status**: COMPLETE - Schema exists and is well-designed

**Current Schema** (`prisma/schema.prisma:2797-2910`):

The schema is already complete with all necessary models:

- `ScheduledPost` - Core post scheduling with status, metadata, timezone, recurrence
- `ScheduledPostAccount` - Many-to-many relation with social accounts, platform-specific IDs
- `PostingTimeRecommendation` - AI-based optimal posting times
- `Workspace` - Subscription limits (maxScheduledPosts, etc.)

**Verification Tasks**:

- [ ] Run `yarn db:generate` to update Prisma client
- [ ] Verify indexes exist for performance queries
- [ ] Test database queries for scheduled posts

---

### 2. AI Content Generation Implemented ‚úÖ

**Status**: LARGELY COMPLETE - Needs Brand Brain integration

**Existing Services** (`src/lib/calendar/`):

- ‚úÖ `ai-content-service.ts` - Generates content suggestions
- ‚úÖ `optimal-time-service.ts` - Best posting time recommendations
- ‚úÖ `weekly-plan-service.ts` - Weekly content planning
- ‚úÖ `content-gaps.ts` - Identifies content gaps

**Existing API Endpoints**:

- ‚úÖ `POST /api/orbit/[workspaceSlug]/calendar/generate-content`
- ‚úÖ `GET /api/orbit/[workspaceSlug]/calendar/recommendations`
- ‚úÖ `GET /api/orbit/[workspaceSlug]/calendar/optimal-times`
- ‚úÖ `POST /api/orbit/[workspaceSlug]/calendar/weekly-plan`

**Enhancement Needed**: Brand Brain Integration

**Files to Modify**:

1. `src/lib/calendar/ai-content-service.ts`
   - Fetch workspace's `BrandProfile`
   - Include brand voice, tone, keywords in AI prompts
   - Ensure generated content matches brand identity

**Implementation**:

```typescript
// Fetch Brand Brain context
const workspace = await prisma.workspace.findUnique({
  where: { id: workspaceId },
  include: { brandProfile: true },
});

// Enhance AI prompt with brand context
const prompt = `
Brand: ${brandContext?.brandName}
Voice: ${brandContext?.brandVoice}
Tone: ${brandContext?.brandTone}
Target Audience: ${brandContext?.targetAudience}
Key Messages: ${brandContext?.keyMessages}

Generate ${count} engaging post ideas that match this brand identity...
`;
```

---

### 3. Calendar UI Enhanced ‚úÖ

**Status**: COMPLETE with minor enhancements needed

**Existing Components** (`src/components/calendar/`):

- ‚úÖ `CalendarClient.tsx` - Main calendar logic
- ‚úÖ `CalendarMonthView.tsx` - Monthly calendar display
- ‚úÖ `CalendarDayCell.tsx` - Individual day cells
- ‚úÖ `ScheduledPostCard.tsx` - Post preview cards
- ‚úÖ `CreatePostDialog.tsx` - Post creation modal
- ‚úÖ `AITimeOptimizer.tsx` - Best time suggestions
- ‚úÖ `WeeklyPlanGenerator.tsx` - Weekly content planner
- ‚úÖ `ContentSuggestionCard.tsx` - AI suggestion display
- ‚úÖ `BestTimeRecommendations.tsx` - Optimal time chips
- ‚úÖ `BestTimeHeatmap.tsx` - Engagement heatmap

**Minor Enhancements**:

1. Display AI suggestions inline on calendar
2. Add "Quick Schedule" button on suggestion cards
3. Visual distinction between scheduled vs suggested posts

**Files to Modify**:

- `src/components/calendar/CalendarDayCell.tsx` - Add suggestions display
- `src/components/calendar/ContentSuggestionCard.tsx` - Add schedule button

---

### 4. Post Scheduling Logic Implemented ‚úÖ

**Status**: COMPLETE - Needs subscription limit enforcement

**Existing Implementation**:

‚úÖ **Publishing Service** (`src/lib/calendar/publishing-service.ts`):

- Processes scheduled posts due for publishing
- Handles retry logic (3 attempts)
- Updates post status and platform IDs
- Supports all social platforms

‚úÖ **Cron Job** (`src/app/api/cron/publish-scheduled-posts/route.ts`):

- Runs every minute via Vercel Cron
- Processes up to 50 due posts per run
- Protected by `CRON_SECRET`
- Logs results for monitoring

**Enhancement Needed**: Subscription Limit Enforcement

**Files to Modify**:

1. `src/app/api/calendar/posts/route.ts` (POST handler)
   - Add `WorkspaceSubscriptionService.canCreateScheduledPost()` check
   - Return upgrade prompt if limit reached

**Implementation**:

```typescript
import { WorkspaceSubscriptionService } from "@/lib/subscription";

export async function POST(request: NextRequest) {
  // Check subscription limit
  const limitCheck = await WorkspaceSubscriptionService.canCreateScheduledPost(
    workspace.id
  );

  if (!limitCheck.allowed) {
    return NextResponse.json({
      error: "LIMIT_REACHED",
      message: limitCheck.message,
      upgradeRequired: true,
      currentTier: workspace.subscriptionTier,
    }, { status: 403 });
  }

  // Create scheduled post (existing code)
  const post = await prisma.scheduledPost.create({ ... });
  return NextResponse.json({ success: true, post });
}
```

---

### 5. Social Platform Integration Complete ‚úÖ

**Status**: COMPLETE - Well-implemented

**Existing Social Clients** (`src/lib/social/clients/`):

‚úÖ **Twitter Client** (`twitter.ts`):

- `createPost()` - POST /2/tweets
- Supports: text, media, reply threading
- Returns: tweet ID and URL

‚úÖ **LinkedIn Client** (`linkedin.ts`):

- `createPost()` - POST /ugcPosts
- Supports: organization posts, media, links
- Returns: LinkedIn URN

‚úÖ **Facebook Client** (`facebook.ts`):

- `createPost()` - POST /{page-id}/feed
- Supports: text, photo, video, links
- Returns: Facebook post ID

‚úÖ **Instagram Client** (`instagram.ts`):

- `createPost()` - POST /{ig-user-id}/media
- Supports: image, video, carousel (requires media)
- Returns: Instagram post ID

**Verification Tasks**:

- [ ] Test Twitter posting with real account
- [ ] Test LinkedIn organization posting
- [ ] Test Facebook page posting
- [ ] Test Instagram media posting
- [ ] Verify retry logic works for failures

**No Code Changes Required** - System is production-ready

---

### 6. Subscription Limits Enforced üîß

**Status**: PARTIALLY COMPLETE - Needs integration

**Existing Subscription Service** (`src/lib/subscription/workspace-subscription.ts`):

‚úÖ **Limit Checking Methods**:

- `canCreateScheduledPost(workspaceId)` - Check post limit
- `canUseAiCredits(workspaceId, amount)` - Check AI credits
- `consumeAiCredits(workspaceId, amount)` - Deduct credits

**Tier Limits** (`src/lib/subscription/tier-config.ts`):

| Tier    | maxScheduledPosts | monthlyAiCredits |
| ------- | ----------------- | ---------------- |
| FREE    | 30                | 100              |
| STARTER | Unlimited         | 500              |
| PRO     | Unlimited         | 2000             |

**Integration Points** - Files to Modify:

1. **Post Creation API** ‚úÖ
   - `src/app/api/calendar/posts/route.ts`
   - Add limit check before creating post

2. **AI Content Generation** üîß
   - `src/app/api/orbit/[workspaceSlug]/calendar/generate-content/route.ts`
   - Check AI credits before generation (5 credits per suggestion)
   - Consume credits after successful generation

3. **Optimal Time Recommendations** üîß
   - `src/app/api/orbit/[workspaceSlug]/calendar/optimal-times/route.ts`
   - Check AI credits (2 credits per call)

4. **Weekly Plan Generation** üîß
   - `src/app/api/orbit/[workspaceSlug]/calendar/weekly-plan/route.ts`
   - Check AI credits (10 credits per week plan)

**UI Component to Create**:

- `src/components/orbit/calendar/UpgradePrompt.tsx` - Reusable upgrade prompt

---

### 7. All Tests Passing ‚úÖ

**Current Test Coverage**:

‚úÖ **Unit Tests** (100% coverage):

- `src/lib/calendar/ai-content-service.test.ts` - AI generation
- `src/lib/calendar/publishing-service.test.ts` - Publishing logic
- `src/lib/calendar/scheduled-posts.test.ts` - Post queries
- `src/lib/subscription/workspace-subscription.test.ts` - Limits
- `src/lib/social/clients/*.test.ts` - Social platform clients

**New Tests to Create**:

1. **E2E Feature File** - `e2e/features/orbit-calendar-scheduling.feature`

```gherkin
Feature: AI Content Calendar with Scheduling

  Scenario: Generate AI content suggestions
    When I navigate to the calendar page
    And I click "Generate AI Suggestions"
    Then I should see 5 content suggestions
    And the suggestions should match my brand voice

  Scenario: Schedule a post from AI suggestion
    Given I have AI content suggestions
    When I click "Schedule This" on a suggestion
    And I select tomorrow at 2pm
    Then the post should appear on the calendar

  Scenario: Subscription limit enforcement
    Given I have 30 scheduled posts (FREE tier limit)
    When I try to schedule another post
    Then I should see an upgrade prompt

  Scenario: Automatic publishing
    Given I have a post scheduled for 1 minute ago
    When the cron job runs
    Then the post should be published to Twitter
    And the post status should be "PUBLISHED"
```

2. **Step Definitions** - `e2e/step-definitions/calendar-steps.ts`

**Files to Create**:

- `e2e/features/orbit-calendar-scheduling.feature`
- `e2e/step-definitions/calendar-steps.ts` (if not exists)

---

## Implementation Strategy

### Phase 1: Verification & Setup (Day 1-2)

1. **Database Migration**
   ```bash
   yarn db:generate
   yarn db:migrate
   yarn test:coverage
   ```

2. **Verify Cron Configuration** (`vercel.json`)
   ```json
   {
     "crons": [
       {
         "path": "/api/cron/publish-scheduled-posts",
         "schedule": "* * * * *" // Every minute
       }
     ]
   }
   ```

3. **Test Social Platform Connections**
   - Connect test accounts
   - Verify OAuth flows
   - Test posting manually

### Phase 2: Subscription Limit Integration (Day 3-4)

1. **Post Creation Limits**
   - Modify `src/app/api/calendar/posts/route.ts`
   - Add `canCreateScheduledPost()` check
   - Test with E2E

2. **AI Credit Limits** (3 files)
   - `generate-content/route.ts` - Check & consume credits
   - `optimal-times/route.ts` - Check & consume credits
   - `weekly-plan/route.ts` - Check & consume credits

3. **Upgrade Prompt Component**
   - Create `src/components/orbit/calendar/UpgradePrompt.tsx`

### Phase 3: Brand Brain Integration (Day 5-6)

1. **Modify AI Content Service**
   - Update `src/lib/calendar/ai-content-service.ts`
   - Fetch `BrandProfile` from workspace
   - Include brand context in prompts

2. **UI Enhancement**
   - Display brand voice indicator
   - Show "Brand-aligned" badge on suggestions

### Phase 4: UI Enhancements (Day 7-8)

1. **Calendar Display**
   - Show AI suggestions inline
   - Add "Quick Schedule" buttons
   - Visual distinction for suggestions

2. **AI Time Optimizer**
   - Enhanced heatmap visualization
   - Engagement score display

### Phase 5: Testing & Documentation (Day 9-10)

1. **E2E Test Suite**
   - Create feature file
   - Implement step definitions
   - Run full test suite

2. **Documentation**
   - Update `docs/FEATURES.md`
   - Create user guide
   - Document API endpoints

### Phase 6: Deployment (Day 11+)

1. **Create PR** referencing #946
2. **Deploy to Staging** - Run E2E tests
3. **Deploy to Production** - Monitor for errors

---

## Files Summary

### Files to Verify (No Changes) ‚úÖ

**Schema** (1 file):

- ‚úÖ `prisma/schema.prisma` - ScheduledPost models (lines 2797-2910)

**Publishing** (2 files):

- ‚úÖ `src/lib/calendar/publishing-service.ts`
- ‚úÖ `src/app/api/cron/publish-scheduled-posts/route.ts`

**Social Clients** (4 files):

- ‚úÖ `src/lib/social/clients/twitter.ts`
- ‚úÖ `src/lib/social/clients/linkedin.ts`
- ‚úÖ `src/lib/social/clients/facebook.ts`
- ‚úÖ `src/lib/social/clients/instagram.ts`

**Calendar UI** (10 files):

- ‚úÖ `src/app/orbit/[workspaceSlug]/calendar/page.tsx`
- ‚úÖ `src/app/orbit/[workspaceSlug]/calendar/CalendarClient.tsx`
- ‚úÖ `src/components/calendar/CalendarMonthView.tsx`
- ‚úÖ `src/components/calendar/CalendarDayCell.tsx`
- ‚úÖ `src/components/calendar/ScheduledPostCard.tsx`
- ‚úÖ `src/components/calendar/CreatePostDialog.tsx`
- ‚úÖ `src/components/calendar/AITimeOptimizer.tsx`
- ‚úÖ `src/components/calendar/WeeklyPlanGenerator.tsx`
- ‚úÖ `src/components/calendar/ContentSuggestionCard.tsx`
- ‚úÖ `src/components/calendar/BestTimeRecommendations.tsx`

### Files to Modify (6 files) üîß

**AI Services** (1 file):

1. `src/lib/calendar/ai-content-service.ts`
   - Add Brand Brain integration

**API Routes** (4 files):
2. `src/app/api/calendar/posts/route.ts`

- Add subscription limit check

3. `src/app/api/orbit/[workspaceSlug]/calendar/generate-content/route.ts`
   - Add AI credit check and consumption

4. `src/app/api/orbit/[workspaceSlug]/calendar/optimal-times/route.ts`
   - Add AI credit check (2 credits)

5. `src/app/api/orbit/[workspaceSlug]/calendar/weekly-plan/route.ts`
   - Add AI credit check (10 credits)

**UI Components** (1 file):
6. `src/components/calendar/CalendarDayCell.tsx`

- Add AI suggestions display

### Files to Create (4 files) ‚≠ê

**UI Components** (1 file):

1. `src/components/orbit/calendar/UpgradePrompt.tsx`
   - Reusable upgrade prompt component

**E2E Tests** (2 files):
2. `e2e/features/orbit-calendar-scheduling.feature`

- Comprehensive E2E scenarios

3. `e2e/step-definitions/calendar-steps.ts`
   - Step implementations

**Documentation** (1 file):
4. `docs/guides/AI_CALENDAR_USER_GUIDE.md`

- User-facing guide

---

## Testing Strategy

### Unit Tests (100% Coverage)

**Existing Tests to Update**:

- `src/lib/calendar/ai-content-service.test.ts` - Add Brand Brain tests

**Test Coverage**:

- Brand voice inclusion in prompts
- AI credit consumption
- Subscription limit enforcement
- Publishing flow
- Retry logic

### E2E Tests (Playwright + Cucumber)

**Critical Paths**:

1. Generate AI suggestions ‚Üí brand-aligned content
2. Schedule post ‚Üí publish automatically
3. Hit subscription limit ‚Üí upgrade prompt
4. Weekly plan generation ‚Üí optimal times

### Manual Testing Checklist

**Pre-Deployment (Staging)**:

- [ ] Connect all 4 social platforms
- [ ] Generate AI suggestions
- [ ] Schedule posts for next 5 minutes
- [ ] Test all 3 subscription tiers
- [ ] Verify cron job runs
- [ ] Test limit enforcement

**Post-Deployment (Production)**:

- [ ] Monitor cron job logs (24 hours)
- [ ] Check publishing success rate
- [ ] Verify credits reset at midnight
- [ ] Monitor error rates

---

## Risk Assessment

### High Risk ‚ö†Ô∏è

1. **Cron Job Failures**
   - Mitigation: Error logging, retry logic, alerts
   - Fallback: Manual republish capability

2. **Social Platform API Changes**
   - Mitigation: Error handling, version pinning
   - Fallback: Manual posting

3. **Subscription Limit Bypass**
   - Mitigation: Server-side validation only
   - Fallback: Audit logs

### Medium Risk ‚öôÔ∏è

4. **AI Credit Calculation**
   - Mitigation: Unit tests, database constraints
   - Fallback: Monthly reset monitoring

5. **Timezone Handling**
   - Mitigation: All UTC storage, timezone field
   - Fallback: Display in user timezone

### Low Risk ‚úì

6. **UI Performance**
   - Mitigation: Pagination, lazy loading
   - Fallback: Date range filtering

---

## Success Metrics

### Acceptance Criteria Checklist

- [ ] Database schema verified
- [ ] AI content with Brand Brain
- [ ] Calendar UI enhanced
- [ ] Subscription limits enforced
- [ ] Social platforms working
- [ ] All tests passing

### Performance Targets

- **Cron Job**: 50 posts in < 30 seconds
- **AI Generation**: 5 suggestions in < 5 seconds
- **Calendar Load**: < 200ms
- **Publishing Success**: > 95%

### User Experience Metrics

- **AI Acceptance**: > 60% suggestions scheduled
- **Publishing Success**: > 95% on-time
- **Limit Enforcement**: 0% false positives
- **Upgrade Conversion**: > 10% of limit-hitting users

---

## Dependencies

### External Services

- Vercel Cron (configured)
- Social Platform APIs (credentials in .env)
- AI Service (OpenAI/Anthropic)

### Internal Dependencies

- Phase 3 (Subscriptions) - Must be deployed first
- Brand Brain - BrandProfile model
- Social Accounts - Connected accounts

### Environment Variables

```bash
CRON_SECRET=<secret>
TWITTER_CLIENT_ID=<id>
LINKEDIN_CLIENT_ID=<id>
FACEBOOK_APP_ID=<id>
INSTAGRAM_APP_ID=<id>
OPENAI_API_KEY=<key>
```

---

## Rollback Plan

### If Deployment Fails

1. **Immediate**: `vercel rollback`
2. **Database**: No destructive migrations
3. **Cron Jobs**: Disable via Vercel dashboard

### Feature Flags (Emergency)

```typescript
// Disable AI suggestions
const AI_SUGGESTIONS_ENABLED = process.env.ENABLE_AI_SUGGESTIONS !== "false";

// Disable auto-publishing
const AUTO_PUBLISH_ENABLED = process.env.ENABLE_AUTO_PUBLISH !== "false";
```

---

## Conclusion

Phase 5 (AI Content Calendar) is **80% complete** thanks to existing infrastructure. The remaining 20% focuses on:

1. **Integration** - Brand Brain, subscription limits
2. **Enhancement** - UI improvements, better AI
3. **Testing** - E2E coverage, verification

**Estimated Effort**: 1-2 weeks with testing

**Complexity**: Medium (integration, not greenfield)

**Key Success Factor**: Thorough cron job testing before production

**Next Steps**:

1. Review plan with stakeholders
2. Set up staging environment
3. Begin Phase 1: Verification

---

**Document Version**: 2.0 (Updated)
**Created**: 2026-01-29
**Author**: Planning Agent (Ralph Wiggum)
**Status**: Ready for Implementation
**Issue**: #946
**Epic**: #836 (Phase 5)
