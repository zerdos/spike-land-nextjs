# Implementation Plan: Fix Vercel Production Deployment Failure

**Issue**: #916
**Related Issue**: #914
**Priority**: P0 - BLOCKING
**Complexity**: Simple

## Summary

The Vercel production deployment is failing because the build configuration doesn't build the `@spike-npm-land/shared` package before running `next build`. This causes TypeScript to fail when importing types from `@spike-npm-land/shared/types` in components like `TransitionFlow.tsx`.

## Root Cause Analysis

### The Problem

1. **What's happening**: Next.js build fails with:
   ```
   Type error: Cannot find module '@spike-npm-land/shared/types' or its corresponding type declarations.
   ```

2. **Why it's happening**:
   - The shared package uses a monorepo structure with workspace dependencies
   - The package exports are defined in `packages/shared/package.json` under the `exports` field
   - These exports point to built files in `packages/shared/dist/`
   - **Vercel's build command doesn't build the shared package first**
   - When Next.js tries to resolve `@spike-npm-land/shared/types`, the dist files don't exist yet

3. **Evidence**:
   - CI/CD workflow (`.github/workflows/ci-cd.yml:210`) DOES build shared package: `yarn workspace @spike-npm-land/shared build`
   - Vercel config (`vercel.json:4`) DOES NOT build shared package
   - Other files successfully import from `@spike-npm-land/shared/types`:
     - `src/lib/tracking/journey-analyzer.ts`
     - `src/components/admin/marketing/tabs/JourneyTab.tsx`
   - The import path `@spike-npm-land/shared/types` is correct per `packages/shared/package.json` exports

## Files to Modify

### 1. `vercel.json` (Line 4)

**Current**:

```json
"buildCommand": "prisma generate --no-hints && DATABASE_URL='postgresql://dummy:dummy@dummy/dummy' NODE_OPTIONS='--max-old-space-size=4096' next build --turbopack",
```

**Change to**:

```json
"buildCommand": "yarn workspace @spike-npm-land/shared build && prisma generate --no-hints && DATABASE_URL='postgresql://dummy:dummy@dummy/dummy' NODE_OPTIONS='--max-old-space-size=4096' next build --turbopack",
```

**Rationale**:

- Build the shared package BEFORE running `next build`
- Matches the CI/CD workflow pattern
- Ensures `packages/shared/dist/` exists when TypeScript resolves module imports
- Uses `yarn workspace` command which works with Vercel's npm installation (converted from yarn via installCommand)

## Alternative Considered (NOT Recommended)

### Alternative: Change Import Path

We could change the import in `TransitionFlow.tsx` from:

```typescript
import type { PlatformTransition } from "@spike-npm-land/shared/types";
```

To:

```typescript
import type { PlatformTransition } from "@spike-npm-land/shared";
```

**Why NOT to do this**:

- The current import path is correct and follows the package's intended export structure
- Other files use the same pattern successfully
- The package.json explicitly defines a `./types` export subpath
- This would only mask the build ordering problem
- The shared package build step is required regardless for the dist files to exist

## Testing Strategy

### Pre-Deployment Testing

1. **Local build verification**:
   ```bash
   rm -rf packages/shared/dist
   yarn workspace @spike-npm-land/shared build && yarn build
   ```
   - Should succeed without TypeScript errors

2. **Vercel preview deployment**:
   - Push to a feature branch
   - Verify Vercel preview build succeeds
   - Check build logs confirm shared package is built first

### Post-Deployment Verification

1. **Production deployment**:
   - Merge to main
   - Monitor Vercel production build
   - Verify deployment status changes from "Error" to "Ready"

2. **Smoke test**:
   - Visit https://spike.land/admin/marketing
   - Verify TransitionFlow component renders without errors
   - Check browser console for TypeScript errors

## Potential Risks

### Low Risk Items

- **Build time increase**: Minimal (shared package builds in ~6 seconds)
- **Workspace command compatibility**: Vercel uses npm but should handle `yarn workspace` commands after npm installation

### Mitigation

- The change is minimal and follows established patterns from CI/CD
- Can be quickly reverted if issues arise
- Preview deployment will catch any build issues before production

## Success Criteria

1. ✅ Vercel production build completes successfully
2. ✅ No TypeScript module resolution errors
3. ✅ All existing imports from `@spike-npm-land/shared/types` work correctly
4. ✅ TransitionFlow component functions properly in production
5. ✅ Build time remains under 5 minutes

## Out of Scope

- Refactoring import patterns across the codebase
- Optimizing shared package build time
- Converting to different module resolution strategies
- Fixing any other unrelated Vercel configuration issues

## Implementation Notes

- This is a one-line change to `vercel.json`
- No code changes required in components
- The fix aligns Vercel's build process with the existing CI/CD workflow
- After this fix, both CI and Vercel will build the shared package before the main app

## Rollback Plan

If the deployment fails:

1. Revert the `vercel.json` change
2. Redeploy immediately using the previous working commit
3. Investigate build logs for unexpected errors
4. Consider the alternative approach of modifying import paths if workspace command fails
