# Implementation Plan: ORB-042 - Create Workflow Data Model

**Issue:** #545
**Epic:** #515 (Orchestration Canvas)
**Status:** Planning Complete
**Complexity:** Medium

## Summary

The workflow data model is **already substantially implemented** in the Prisma schema. This task involves completing the remaining acceptance criteria that are currently missing or partially implemented:

1. ✅ **Already Done**: Workflow entity with basic structure
2. ✅ **Already Done**: WorkflowStep entity with sequence ordering and dependencies
3. ✅ **Already Done**: Condition branching support (BranchType enum)
4. ✅ **Already Done**: Workflow versioning (WorkflowVersion model)
5. ⚠️ **Partially Done**: Workflow execution state tracking (WorkflowRun exists but needs enhancements)
6. ❌ **Missing**: Explicit triggers and actions collections structure
7. ❌ **Missing**: Enhanced DSL for comprehensive import/export

## Current State Analysis

### Existing Models (prisma/schema.prisma:3891-4036)

The schema already includes:

```prisma
- Workflow (main entity)
- WorkflowVersion (versioning support)
- WorkflowStep (with branching via parentStepId, branchType, branchCondition)
- WorkflowRun (execution tracking)
- WorkflowRunLog (detailed execution logs)
- WorkflowSchedule (cron triggers)
- WorkflowWebhook (webhook triggers)
- WorkflowEventSubscription (event-based triggers)
```

### Existing Enums (prisma/schema.prisma:4330-4371)

```prisma
- WorkflowStatus (DRAFT, ACTIVE, ARCHIVED)
- WorkflowStepType (TRIGGER, ACTION, CONDITION)
- WorkflowRunStatus (RUNNING, COMPLETED, FAILED, CANCELLED)
- BranchType (IF_TRUE, IF_FALSE, SWITCH_CASE, DEFAULT)
- StepRunStatus (PENDING, RUNNING, COMPLETED, FAILED, SKIPPED)
- WorkflowEventType (6 event types defined)
```

### Existing TypeScript Types (src/types/workflow.ts)

Comprehensive types are already defined for:

- WorkflowStepData, WorkflowVersionData, WorkflowData
- DSL format (WorkflowDSL, WorkflowStepDSL, WorkflowBranchDSL)
- Validation types
- Trigger types (schedule, webhook, event)
- Execution context and results

### Existing Implementation (src/lib/workflows/)

- ✅ `workflow-dsl.ts` - DSL import/export utilities (JSON & YAML)
- ✅ `workflow-validator.ts` - Validation logic
- ✅ `workflow-service.ts` - CRUD operations
- ✅ `workflow-executor.ts` - Execution engine
- ✅ Comprehensive test coverage for all utilities

## Acceptance Criteria Mapping

### 1. Workflow entity with triggers and actions collections ⚠️

**Current State:** Triggers are separate entities (WorkflowSchedule, WorkflowWebhook, WorkflowEventSubscription)

**Gap:** No explicit "actions library" or action configuration schema

**Plan:**

- Define action type schemas in TypeScript
- Create action registry/catalog
- Document available action types

### 2. WorkflowStep entity with sequence ordering and dependencies ✅

**Current State:** Fully implemented

- `sequence` field for ordering
- `dependencies` JSON field for step dependencies
- Self-referential relationship for branching

**No changes needed**

### 3. Condition branching support (if/else, switch) ✅

**Current State:** Fully implemented via:

- `BranchType` enum (IF_TRUE, IF_FALSE, SWITCH_CASE, DEFAULT)
- `branchCondition` field for condition expressions
- `parentStepId` for branch hierarchy

**No changes needed**

### 4. Workflow versioning for safe editing and rollback ✅

**Current State:** Fully implemented

- `WorkflowVersion` model with version number
- `isPublished` flag for draft vs published
- `publishedAt` timestamp
- Cascade deletion protection

**No changes needed**

### 5. Workflow execution state tracking ⚠️

**Current State:** Partially implemented

- `WorkflowRun` tracks overall execution
- `WorkflowRunLog` tracks step-level logs

**Gap:** Missing per-step execution state in WorkflowRun

**Plan:**

- Add `stepExecutions` JSON field to WorkflowRun to track individual step states
- This enables better progress tracking and resumability

## Files to Modify

### 1. prisma/schema.prisma

**Location:** Lines 3957-3969 (WorkflowRun model)

**Changes:**

```prisma
model WorkflowRun {
  id         String            @id @default(cuid())
  workflowId String
  workflow   Workflow          @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  status     WorkflowRunStatus
  startedAt  DateTime          @default(now())
  endedAt    DateTime?

  // NEW: Track individual step execution states
  stepExecutions Json? // Map<stepId, { status, startedAt, endedAt, output, error }>

  // NEW: Context data from trigger
  triggerType String? // "schedule" | "webhook" | "event" | "manual"
  triggerData Json?   // Payload/context from trigger

  logs       WorkflowRunLog[]

  @@index([workflowId])
  @@index([status])
  @@map("workflow_runs")
}
```

### 2. src/types/workflow.ts

**Location:** End of file (~line 323)

**Changes:**

- Add `WorkflowActionType` enum for action catalog
- Add action configuration schemas
- Add step execution state type
- Update `WorkflowRunData` interface

**New Types:**

```typescript
/**
 * Available action types in the workflow system
 */
export enum WorkflowActionType {
  // Social Media Actions
  POST_TO_SOCIAL = "POST_TO_SOCIAL",
  SCHEDULE_POST = "SCHEDULE_POST",
  REPLY_TO_COMMENT = "REPLY_TO_COMMENT",

  // Notification Actions
  SEND_EMAIL = "SEND_EMAIL",
  SEND_SLACK_MESSAGE = "SEND_SLACK_MESSAGE",
  CREATE_NOTIFICATION = "CREATE_NOTIFICATION",

  // AI Actions
  GENERATE_CONTENT = "GENERATE_CONTENT",
  ANALYZE_SENTIMENT = "ANALYZE_SENTIMENT",
  MODERATE_CONTENT = "MODERATE_CONTENT",

  // Data Actions
  UPDATE_DATABASE = "UPDATE_DATABASE",
  LOG_EVENT = "LOG_EVENT",
  TRIGGER_WEBHOOK = "TRIGGER_WEBHOOK",

  // Control Flow
  DELAY = "DELAY",
  CONDITIONAL_BRANCH = "CONDITIONAL_BRANCH",
  LOOP = "LOOP",
}

/**
 * Step execution state within a workflow run
 */
export interface StepExecutionState {
  stepId: string;
  status: StepRunStatus;
  startedAt?: Date;
  endedAt?: Date;
  output?: Record<string, unknown>;
  error?: string;
  retryCount?: number;
}

/**
 * Action configuration schemas by type
 */
export type ActionConfig =
  | PostToSocialConfig
  | SendEmailConfig
  | GenerateContentConfig
  | DelayConfig
  | WebhookConfig;

export interface PostToSocialConfig {
  actionType: WorkflowActionType.POST_TO_SOCIAL;
  platform: string;
  accountId: string;
  content: string;
  mediaUrls?: string[];
}

export interface SendEmailConfig {
  actionType: WorkflowActionType.SEND_EMAIL;
  to: string | string[];
  subject: string;
  body: string;
  templateId?: string;
}

export interface GenerateContentConfig {
  actionType: WorkflowActionType.GENERATE_CONTENT;
  prompt: string;
  maxTokens?: number;
  temperature?: number;
  outputVariable?: string;
}

export interface DelayConfig {
  actionType: WorkflowActionType.DELAY;
  duration: number; // milliseconds
  until?: Date;
}

export interface WebhookConfig {
  actionType: WorkflowActionType.TRIGGER_WEBHOOK;
  url: string;
  method: "GET" | "POST" | "PUT" | "PATCH" | "DELETE";
  headers?: Record<string, string>;
  body?: Record<string, unknown>;
}
```

### 3. src/lib/workflows/workflow-service.ts

**Location:** Add new function after existing functions

**Changes:**

- Update `WorkflowRunData` mapping to include new fields
- Add helper to initialize step executions

**New Code:**

```typescript
/**
 * Initializes step execution tracking for a new workflow run
 */
export function initializeStepExecutions(
  steps: WorkflowStep[],
): Record<string, StepExecutionState> {
  return steps.reduce((acc, step) => {
    acc[step.id] = {
      stepId: step.id,
      status: "PENDING" as StepRunStatus,
    };
    return acc;
  }, {} as Record<string, StepExecutionState>);
}

/**
 * Updates step execution state within a workflow run
 */
export async function updateStepExecution(
  runId: string,
  stepId: string,
  update: Partial<StepExecutionState>,
): Promise<void> {
  const run = await prisma.workflowRun.findUnique({
    where: { id: runId },
    select: { stepExecutions: true },
  });

  if (!run) {
    throw new Error(`Workflow run ${runId} not found`);
  }

  const executions = (run.stepExecutions as Record<string, StepExecutionState>) ?? {};
  executions[stepId] = {
    ...executions[stepId],
    ...update,
  };

  await prisma.workflowRun.update({
    where: { id: runId },
    data: { stepExecutions: executions },
  });
}
```

### 4. src/lib/workflows/actions/index.ts (NEW FILE)

**Location:** Create new directory and file

**Purpose:** Action registry and documentation

**Content:**

```typescript
/**
 * Workflow Actions Registry
 *
 * This file documents all available workflow actions and their configurations.
 * Each action type should have:
 * - TypeScript type definition
 * - JSON schema for validation
 * - Documentation
 * - Example usage
 */

import type { WorkflowActionType } from "@/types/workflow";

export interface ActionDefinition {
  type: WorkflowActionType;
  name: string;
  description: string;
  category: "social" | "notification" | "ai" | "data" | "control";
  configSchema: object; // JSON Schema
  exampleConfig: object;
  requiredPermissions?: string[];
}

/**
 * Registry of all available workflow actions
 */
export const ACTION_REGISTRY: Record<WorkflowActionType, ActionDefinition> = {
  // Define each action type with schema and examples
  // This will be populated in the implementation phase
};

/**
 * Get action definition by type
 */
export function getActionDefinition(type: WorkflowActionType): ActionDefinition | null {
  return ACTION_REGISTRY[type] ?? null;
}

/**
 * Validate action configuration against schema
 */
export function validateActionConfig(type: WorkflowActionType, config: unknown): boolean {
  // Implementation to validate config against JSON schema
  return true;
}
```

### 5. docs/WORKFLOW_ACTIONS.md (NEW FILE)

**Purpose:** Documentation of all available workflow actions

**Content:** Comprehensive documentation including:

- Action categories
- Configuration schemas
- Example workflows
- Best practices
- Security considerations

## Files to Create

1. **src/lib/workflows/actions/index.ts** - Action registry
2. **src/lib/workflows/actions/social.ts** - Social media actions
3. **src/lib/workflows/actions/notifications.ts** - Notification actions
4. **src/lib/workflows/actions/ai.ts** - AI-powered actions
5. **src/lib/workflows/actions/data.ts** - Data manipulation actions
6. **src/lib/workflows/actions/control.ts** - Control flow actions
7. **docs/WORKFLOW_ACTIONS.md** - Action documentation

## Testing Considerations

### Unit Tests

**New test files:**

- `src/lib/workflows/actions/index.test.ts` - Action registry tests
- `src/lib/workflows/actions/social.test.ts` - Social action tests
- `src/lib/workflows/workflow-service.test.ts` - Update with new step execution tracking

**Existing tests to update:**

- `src/lib/workflows/workflow-executor.test.ts` - Test new execution state tracking
- `src/lib/workflows/workflow-service.test.ts` - Test new service methods

### Integration Tests

- Test workflow creation with action configurations
- Test workflow execution with step state tracking
- Test DSL import/export with new action types
- Test backward compatibility with existing workflows

### Test Coverage

Maintain 100% code coverage requirement:

- All new functions must have tests
- All new types must be validated in tests
- Edge cases for action validation

## Database Migration

### Migration File: `migrations/XXX_enhance_workflow_execution_tracking.sql`

```sql
-- Add step execution tracking to workflow runs
ALTER TABLE workflow_runs
  ADD COLUMN step_executions JSONB,
  ADD COLUMN trigger_type TEXT,
  ADD COLUMN trigger_data JSONB;

-- Create index for querying by trigger type
CREATE INDEX idx_workflow_runs_trigger_type ON workflow_runs(trigger_type);

-- Update existing runs with empty step executions
UPDATE workflow_runs
SET step_executions = '{}'::jsonb
WHERE step_executions IS NULL;
```

### Post-Migration Verification

```sql
-- Verify schema changes
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'workflow_runs'
  AND column_name IN ('step_executions', 'trigger_type', 'trigger_data');

-- Verify index creation
SELECT indexname
FROM pg_indexes
WHERE tablename = 'workflow_runs'
  AND indexname = 'idx_workflow_runs_trigger_type';
```

## Horizontal Scalability Considerations

The current design supports horizontal scalability through:

1. **Stateless Execution**: Workflow execution state stored in database, not in-memory
2. **Event-Driven**: Triggers use database polling or webhooks
3. **Idempotent Steps**: Step execution tracking enables retry and recovery
4. **Version Isolation**: Each workflow run uses a specific version

**Recommendations for future scalability:**

- Implement workflow execution queue (Redis/BullMQ)
- Add distributed locking for concurrent executions
- Consider step-level job distribution
- Implement execution timeouts and health checks

## DSL Import/Export Enhancement

The existing DSL implementation (src/lib/workflows/workflow-dsl.ts) already supports:

- ✅ JSON and YAML formats
- ✅ Workflow structure with steps and branches
- ✅ Dependencies between steps
- ✅ Branching conditions

**Enhancements needed:**

1. Add action type validation in DSL parser
2. Include trigger configurations in DSL export
3. Add DSL schema version for future compatibility
4. Document DSL specification

## Potential Risks & Blockers

### Low Risk

- Schema changes are additive (no breaking changes)
- Existing workflows continue to work
- New fields are optional

### Medium Risk

- Action configurations may need iteration based on usage
- DSL format may need refinement for complex workflows

### Mitigation Strategies

1. Keep new fields optional to maintain backward compatibility
2. Version the DSL format for future changes
3. Comprehensive testing of migration
4. Feature flag for new execution tracking features

## Implementation Steps

### Phase 1: Database Schema (Estimated: 2 hours)

1. Update Prisma schema with new fields
2. Generate migration
3. Test migration locally
4. Update generated types

### Phase 2: TypeScript Types (Estimated: 1 hour)

1. Add action type enums
2. Define action config interfaces
3. Update workflow run types
4. Update imports across codebase

### Phase 3: Action Registry (Estimated: 3 hours)

1. Create action registry structure
2. Define initial action types
3. Implement validation utilities
4. Add comprehensive documentation

### Phase 4: Service Updates (Estimated: 2 hours)

1. Update workflow service for step execution tracking
2. Add helper methods for state management
3. Update existing CRUD operations
4. Ensure backward compatibility

### Phase 5: Testing (Estimated: 3 hours)

1. Write unit tests for new functionality
2. Update existing tests
3. Add integration tests
4. Verify 100% coverage

### Phase 6: Documentation (Estimated: 2 hours)

1. Create WORKFLOW_ACTIONS.md
2. Update DATABASE_SCHEMA.md
3. Add migration guide
4. Document DSL enhancements

**Total Estimated Time: 13 hours**

## Success Criteria

- [ ] All acceptance criteria met
- [ ] Database migration runs successfully
- [ ] 100% test coverage maintained
- [ ] No breaking changes to existing workflows
- [ ] Comprehensive action documentation created
- [ ] CI/CD pipeline passes all checks
- [ ] Code review approved
- [ ] Documentation updated

## Dependencies

**Upstream:**

- None (schema already exists)

**Downstream:**

- ORB-043: Visual workflow editor (will use action registry)
- ORB-044: Workflow triggers (will use enhanced execution tracking)
- ORB-045: Actions library (will use action definitions)

## Notes

The workflow data model is in excellent shape. Most of the core structure is already implemented with:

- ✅ Solid database schema
- ✅ Comprehensive TypeScript types
- ✅ DSL import/export utilities
- ✅ Validation logic
- ✅ Execution engine
- ✅ Test coverage

This task primarily involves **enhancing** the existing implementation rather than building from scratch. The main additions are:

1. **Action type catalog** - Define and document available actions
2. **Enhanced execution tracking** - Better granularity for step states
3. **Trigger context** - Store trigger type and data in runs

These enhancements set the foundation for the visual workflow builder (ORB-043) and enable better debugging and monitoring of workflow executions.

## Open Questions

1. Should we implement a plugin system for custom actions?
2. Do we need workflow templates/presets?
3. Should step execution history be archived separately for long-running workflows?
4. Do we need rate limiting for workflow executions?

**Recommendation:** Address these in future stories after validating core functionality with users.
