# Implementation Plan: Issue #944 - Workspace Subscription Tiers

**Issue**: #944
**Epic**: #836 (Phase 3)
**Type**: Feature Implementation
**Complexity**: Medium
**Estimated Time**: 3-5 days

## Overview

Implement workspace-level subscription tiers (FREE/PRO/BUSINESS) for the Orbit app to replace token-based pricing with workspace subscriptions. The goal is to enable tiered feature access based on workspace subscription level with limits on social accounts, scheduled posts, A/B tests, AI credits, and team members.

## Current State Analysis

### ✅ Already Implemented

The codebase already has substantial infrastructure in place:

1. **Database Schema** (`prisma/schema.prisma`):
   - ✅ `WorkspaceSubscriptionTier` enum (FREE/PRO/BUSINESS)
   - ✅ `Workspace` model with subscription fields:
     - `subscriptionTier`, `maxSocialAccounts`, `maxScheduledPosts`
     - `maxAbTests`, `monthlyAiCredits`, `usedAiCredits`
     - `maxTeamMembers`, `billingCycleStart`, `stripeSubscriptionId`

2. **Subscription Service** (`src/lib/subscription/workspace-subscription.ts`):
   - ✅ `WorkspaceSubscriptionService` class with full limit checking
   - ✅ Methods: `canAddSocialAccount`, `canCreateScheduledPost`, `canCreateAbTest`
   - ✅ Methods: `canUseAiCredits`, `consumeAiCredits`, `resetMonthlyCredits`
   - ✅ Methods: `upgradeTier`, `findWorkspacesForCreditReset`

3. **Tier Configuration** (`src/lib/subscription/tier-config.ts`):
   - ✅ `WORKSPACE_TIER_LIMITS` with all tier configurations
   - ✅ Helper functions: `isUpgrade`, `isDowngrade`, `getTierLimits`, `getNextTier`

4. **Credit Reset Cron** (`src/app/api/cron/reset-workspace-credits/route.ts`):
   - ✅ Daily cron job to reset monthly AI credits
   - ✅ Finds workspaces with billing anniversary
   - ✅ Protected with `CRON_SECRET`

5. **Stripe Integration** (`src/lib/stripe/client.ts`):
   - ⚠️ Has old `SUBSCRIPTION_PLANS` (hobby/creator/studio)
   - ⚠️ Missing workspace tier Stripe configuration
   - ✅ Webhook handler exists (`src/app/api/stripe/webhook/route.ts`)

### ❌ Missing Components

1. **Stripe Checkout API** for workspace subscriptions
2. **Upgrade prompt components** for when limits are hit
3. **Billing management page** for workspaces
4. **Limit enforcement** in API routes
5. **Environment variables** for Stripe Price IDs
6. **Vercel cron configuration** in `vercel.json`
7. **Documentation** of actual pricing ($0/$29/$99 vs current doc showing $0/$29/$99)
8. **Tests** for new integration points

## Technical Approach

### Phase 1: Stripe Configuration & API Routes (Day 1)

#### 1.1 Update Stripe Client Configuration

**File**: `src/lib/stripe/client.ts`

**Changes**:

- Update `TIER_SUBSCRIPTIONS` pricing to match plan ($29 and $99)
- Verify environment variable names match
- Remove old `SUBSCRIPTION_PLANS` (hobby/creator/studio) if unused

**Expected Code**:

```typescript
export const WORKSPACE_TIER_PRICES = {
  FREE: { priceUSD: 0, stripePriceId: null },
  PRO: { priceUSD: 29, stripePriceId: process.env.STRIPE_PRICE_WORKSPACE_PRO || "" },
  BUSINESS: { priceUSD: 99, stripePriceId: process.env.STRIPE_PRICE_WORKSPACE_BUSINESS || "" },
} as const;
```

#### 1.2 Create Workspace Subscription Checkout API

**File**: `src/app/api/workspace/[workspaceId]/subscription/checkout/route.ts`

**Purpose**: Create Stripe checkout session for workspace tier upgrade

**Request Body**:

```typescript
{
  tier: "PRO" | "BUSINESS";
}
```

**Implementation**:

1. Validate user has access to workspace
2. Check if upgrade or downgrade
3. Create Stripe checkout session with workspace metadata
4. Return checkout URL

**Response**:

```typescript
{
  success: true,
  sessionId: string,
  url: string
}
```

#### 1.3 Update Stripe Webhook Handler

**File**: `src/app/api/stripe/webhook/route.ts`

**Changes**:

- Add workspace subscription handling in `checkout.session.completed`
- Add workspace tier upgrade logic
- Set `billingCycleStart` on first subscription
- Call `WorkspaceSubscriptionService.upgradeTier()`

**Metadata to include**:

```typescript
metadata: {
  workspaceId: string,
  tier: "PRO" | "BUSINESS",
  userId: string
}
```

#### 1.4 Create Subscription Management API

**File**: `src/app/api/workspace/[workspaceId]/subscription/route.ts`

**Methods**:

- `GET`: Get current subscription info
- `POST`: Update subscription (upgrade/downgrade/cancel)
- `DELETE`: Cancel subscription

### Phase 2: Limit Enforcement (Day 2)

#### 2.1 Enforce Limits in Social Account API

**File**: `src/app/api/orbit/[workspaceSlug]/accounts/route.ts` (or wherever social accounts are created)

**Changes**:

```typescript
// Before creating social account
const check = await WorkspaceSubscriptionService.canAddSocialAccount(workspaceId);
if (!check.allowed) {
  return NextResponse.json(
    {
      error: check.message,
      upgradeRequired: true,
      currentTier: workspace.subscriptionTier,
    },
    { status: 402 }, // Payment Required
  );
}
```

#### 2.2 Enforce Limits in Post Scheduling API

**File**: `src/app/api/orbit/[workspaceSlug]/posts/schedule/route.ts` (or similar)

**Changes**:

```typescript
const check = await WorkspaceSubscriptionService.canCreateScheduledPost(workspaceId);
if (!check.allowed) {
  return NextResponse.json(
    { error: check.message, upgradeRequired: true },
    { status: 402 },
  );
}
```

#### 2.3 Enforce Limits in AI Feature APIs

**Files**: Any API route that uses AI (content generation, image generation, etc.)

**Changes**:

```typescript
const creditCost = 10; // Example cost
const result = await WorkspaceSubscriptionService.consumeAiCredits(workspaceId, creditCost);
if (!result.success) {
  return NextResponse.json(
    { error: result.error, upgradeRequired: true },
    { status: 402 },
  );
}
```

#### 2.4 Enforce Team Member Limits

**File**: `src/app/api/orbit/[workspaceSlug]/members/route.ts` (or similar)

**Changes**:

```typescript
const check = await WorkspaceSubscriptionService.canAddTeamMember(workspaceId);
if (!check.allowed) {
  return NextResponse.json(
    { error: check.message, upgradeRequired: true },
    { status: 402 },
  );
}
```

### Phase 3: UI Components (Day 3)

#### 3.1 Create Upgrade Prompt Component

**File**: `src/components/orbit/subscription/upgrade-prompt.tsx`

**Purpose**: Modal/banner shown when user hits limit

**Props**:

```typescript
interface UpgradePromptProps {
  feature: "social_accounts" | "scheduled_posts" | "ai_credits" | "team_members";
  currentTier: WorkspaceSubscriptionTier;
  currentCount: number;
  limit: number;
  workspaceSlug: string;
}
```

**Features**:

- Show feature limit reached message
- Display tier comparison table
- "Upgrade to PRO" / "Upgrade to BUSINESS" button
- Redirect to Stripe checkout

#### 3.2 Create Subscription Info Card

**File**: `src/components/orbit/subscription/subscription-info-card.tsx`

**Purpose**: Display current subscription status and limits

**Features**:

- Current tier badge
- Usage bars for each limit
- Link to billing page

#### 3.3 Create Billing Management Page

**File**: `src/app/orbit/[workspaceSlug]/settings/billing/page.tsx`

**Features**:

- Current subscription tier
- Billing cycle information
- Usage statistics for all limits
- Upgrade/downgrade buttons
- Cancel subscription button
- Invoice history (if applicable)

#### 3.4 Update Pricing Page

**File**: `src/app/pricing/page.tsx`

**Changes**:

- Verify displays workspace tiers (FREE/PRO/BUSINESS)
- Show $0, $29, $99 pricing
- Feature comparison table
- "Get Started" buttons link to workspace creation or upgrade

### Phase 4: Vercel Configuration (Day 4)

#### 4.1 Update Vercel Cron Configuration

**File**: `vercel.json`

**Add**:

```json
{
  "crons": [
    {
      "path": "/api/cron/reset-workspace-credits",
      "schedule": "0 0 * * *"
    }
  ]
}
```

#### 4.2 Environment Variables

**Required in Vercel Dashboard**:

```bash
STRIPE_PRICE_WORKSPACE_PRO=price_xxx
STRIPE_PRICE_WORKSPACE_BUSINESS=price_xxx
CRON_SECRET=xxx
```

**Note**: These need to be created in Stripe Dashboard first

### Phase 5: Testing (Day 5)

#### 5.1 Unit Tests

**Files to Create**:

1. `src/app/api/workspace/[workspaceId]/subscription/checkout/route.test.ts`
   - Test successful checkout session creation
   - Test invalid tier
   - Test unauthorized access
   - Test downgrade prevention

2. `src/app/api/workspace/[workspaceId]/subscription/route.test.ts`
   - Test GET subscription info
   - Test POST tier change
   - Test DELETE cancellation

3. `src/components/orbit/subscription/upgrade-prompt.test.tsx`
   - Test renders for each feature type
   - Test upgrade button click
   - Test tier comparison display

4. `src/app/api/stripe/webhook/route.test.ts` (update existing)
   - Test workspace subscription webhook handling
   - Test tier upgrade on checkout completion
   - Test billing cycle start setting

#### 5.2 Integration Tests

**Scenarios to Test**:

1. **Full upgrade flow**:
   - User hits social account limit (FREE tier)
   - Upgrade prompt shows
   - Click upgrade to PRO
   - Complete Stripe checkout
   - Webhook updates workspace tier
   - User can now add more accounts

2. **AI credit consumption**:
   - Workspace uses AI feature
   - Credits deducted from `usedAiCredits`
   - When limit hit, upgrade prompt shows
   - After upgrade, more credits available

3. **Monthly credit reset**:
   - Cron job runs
   - Workspaces with billing anniversary reset
   - `usedAiCredits` set to 0

#### 5.3 E2E Tests

**File**: `e2e/features/workspace-subscription.feature`

```gherkin
Feature: Workspace Subscription Management

  Scenario: Upgrade workspace from FREE to PRO
    Given I am logged in as workspace owner
    And my workspace is on FREE tier
    When I try to add a 4th social account
    Then I see an upgrade prompt
    When I click "Upgrade to PRO"
    And I complete the Stripe checkout
    Then my workspace is upgraded to PRO
    And I can add up to 10 social accounts

  Scenario: Hit AI credit limit
    Given I am on FREE tier with 100 monthly credits
    And I have used 95 credits
    When I try to use an AI feature costing 10 credits
    Then I see "Insufficient AI credits" message
    And I see upgrade prompt for PRO tier

  Scenario: Monthly credit reset
    Given I am on PRO tier
    And my billing cycle started 30 days ago
    And I have used 800 of 1000 credits
    When the monthly credit reset cron runs
    Then my used credits are reset to 0
    And I have 1000 credits available
```

**Step Definitions File**: `e2e/step-definitions/workspace-subscription.steps.ts`

### Phase 6: Documentation (Concurrent with implementation)

#### 6.1 Update API Documentation

**File**: `docs/API_REFERENCE.md`

**Add**:

- `/api/workspace/[id]/subscription/checkout` - Create checkout session
- `/api/workspace/[id]/subscription` - Manage subscription
- Document 402 status code for limit errors

#### 6.2 Update Subscription Documentation

**File**: `docs/SUBSCRIPTION_TIERS.md`

**Update**:

- Verify pricing matches implementation ($29/$99)
- Add Stripe checkout flow documentation
- Add webhook handling details
- Add troubleshooting section

#### 6.3 Update Developer Guide

**File**: `CLAUDE.md` or `docs/DEVELOPMENT.md`

**Add**:

- How to set up Stripe products for workspace tiers
- How to test subscription flows locally
- How to test webhooks with Stripe CLI

## Files to Create

### API Routes

- [ ] `src/app/api/workspace/[workspaceId]/subscription/checkout/route.ts`
- [ ] `src/app/api/workspace/[workspaceId]/subscription/checkout/route.test.ts`
- [ ] `src/app/api/workspace/[workspaceId]/subscription/route.ts`
- [ ] `src/app/api/workspace/[workspaceId]/subscription/route.test.ts`

### UI Components

- [ ] `src/components/orbit/subscription/upgrade-prompt.tsx`
- [ ] `src/components/orbit/subscription/upgrade-prompt.test.tsx`
- [ ] `src/components/orbit/subscription/subscription-info-card.tsx`
- [ ] `src/components/orbit/subscription/subscription-info-card.test.tsx`
- [ ] `src/app/orbit/[workspaceSlug]/settings/billing/page.tsx`
- [ ] `src/app/orbit/[workspaceSlug]/settings/billing/page.test.tsx`

### Utilities

- [ ] `src/hooks/useWorkspaceSubscription.ts` (optional helper hook)
- [ ] `src/hooks/useWorkspaceSubscription.test.ts`

### E2E Tests

- [ ] `e2e/features/workspace-subscription.feature`
- [ ] `e2e/step-definitions/workspace-subscription.steps.ts`

## Files to Modify

### Stripe Integration

- [ ] `src/lib/stripe/client.ts` - Update workspace tier pricing
- [ ] `src/app/api/stripe/webhook/route.ts` - Add workspace subscription handling
- [ ] `src/app/api/stripe/webhook/route.test.ts` - Add workspace subscription tests

### Limit Enforcement (create files if they don't exist)

- [ ] `src/app/api/orbit/[workspaceSlug]/accounts/route.ts` - Social account limits
- [ ] `src/app/api/orbit/[workspaceSlug]/posts/schedule/route.ts` - Scheduled post limits
- [ ] `src/app/api/orbit/[workspaceSlug]/members/route.ts` - Team member limits
- [ ] AI feature API routes - AI credit consumption

### UI Pages

- [ ] `src/app/pricing/page.tsx` - Verify workspace tier display
- [ ] `src/app/pricing/page.test.tsx` - Update tests

### Configuration

- [ ] `vercel.json` - Add cron job configuration
- [ ] `.env.example` - Add Stripe price ID examples

### Documentation

- [ ] `docs/API_REFERENCE.md` - Add subscription endpoints
- [ ] `docs/SUBSCRIPTION_TIERS.md` - Verify pricing and flow
- [ ] `CLAUDE.md` - Add Stripe setup instructions

## Environment Variables Required

```bash
# Stripe Workspace Subscription Price IDs
STRIPE_PRICE_WORKSPACE_PRO=price_xxx
STRIPE_PRICE_WORKSPACE_BUSINESS=price_xxx

# Cron Job Security
CRON_SECRET=random_secret_string

# Existing (should already be configured)
STRIPE_SECRET_KEY=sk_live_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
```

## Testing Strategy

### Unit Test Coverage (100% Required)

- [ ] All new API routes: 100% coverage
- [ ] All new components: 100% coverage
- [ ] Webhook handling: 100% coverage
- [ ] Limit enforcement logic: 100% coverage

### Integration Test Scenarios

1. **Checkout Flow**:
   - Create checkout → Complete payment → Webhook → Tier upgraded

2. **Limit Enforcement**:
   - Hit limit → 402 error → Upgrade prompt → Upgrade → Access granted

3. **Credit Reset**:
   - Cron runs → Credits reset for anniversary workspaces

### E2E Test Coverage

- [ ] Full upgrade flow (FREE → PRO)
- [ ] Hit social account limit
- [ ] Hit AI credit limit
- [ ] Monthly credit reset
- [ ] Billing page management

## Potential Risks & Mitigations

| Risk                                  | Impact | Mitigation                                                                                |
| ------------------------------------- | ------ | ----------------------------------------------------------------------------------------- |
| **Stripe webhook failures**           | High   | Implement retry logic, comprehensive logging, fallback manual processing                  |
| **Double billing on tier change**     | High   | Check existing subscription before creating new one, use Stripe's update subscription API |
| **Credit reset on wrong day**         | Medium | Thorough testing of date calculation, add monitoring/alerts                               |
| **Existing workspaces stuck on FREE** | Medium | Run migration to set default limits for all workspaces                                    |
| **Downgrade loses data**              | Medium | Prevent immediate deletion, show warning before downgrade                                 |

## Success Criteria (from Acceptance Criteria)

- [x] Database schema verified with subscription fields ✅ (Already exists)
- [ ] Subscription service implemented ✅ (Already exists, needs API integration)
- [ ] Stripe checkout integration complete
- [ ] Limit enforcement on gated features
- [ ] Upgrade prompts created
- [ ] Credit reset cron job implemented ✅ (Already exists, needs Vercel config)
- [ ] All tests passing (100% coverage)

## Deployment Checklist

### Before Deployment

1. [ ] Create Stripe products and prices for PRO and BUSINESS tiers
2. [ ] Set environment variables in Vercel
3. [ ] Test webhook locally with Stripe CLI
4. [ ] Run full test suite locally
5. [ ] Run E2E tests in preview environment

### Deployment Steps

1. [ ] Deploy to preview environment
2. [ ] Verify cron job configuration in Vercel dashboard
3. [ ] Test full upgrade flow in preview
4. [ ] Test webhook delivery from Stripe
5. [ ] Deploy to production
6. [ ] Monitor webhook logs for 24 hours
7. [ ] Verify cron job runs successfully

### Post-Deployment

1. [ ] Monitor error logs
2. [ ] Check Stripe webhook delivery success rate
3. [ ] Verify credit reset runs correctly
4. [ ] Collect user feedback on upgrade flow

## Out of Scope

As per issue #944:

- ❌ A/B testing features (Phase 4)
- ❌ Calendar features (Phase 5)
- ❌ Analytics features (Phase 6)

These features have limits pre-configured but enforcement is not part of this phase.

## Timeline

| Day       | Tasks                                                 |
| --------- | ----------------------------------------------------- |
| **Day 1** | Stripe configuration, checkout API, webhook updates   |
| **Day 2** | Limit enforcement in all API routes                   |
| **Day 3** | UI components (upgrade prompt, billing page)          |
| **Day 4** | Vercel config, environment setup, integration testing |
| **Day 5** | E2E tests, documentation, deployment prep             |

## Dependencies

- Stripe account with products configured
- Vercel cron job support (included in all plans)
- Existing `WorkspaceSubscriptionService` (✅ implemented)
- Existing database schema (✅ implemented)

## Backward Compatibility

- ✅ All existing FREE tier workspaces continue to work
- ✅ No data loss on upgrade/downgrade
- ✅ Existing limits preserved
- ✅ Token system for Pixel app unaffected

---

**Plan Status**: Ready for Implementation
**Created**: 2026-01-29
**Author**: Planning Agent (Ralph Wiggum)
**Approver**: Awaiting user approval
