# Implementation Plan: Orchestration Canvas - Visual Workflow Builder

**Issue**: #515
**Epic**: [Epic] Orchestration Canvas - Visual Workflow Builder
**Phase**: 3 (Autonomy)
**Layer**: 4 (Orchestration)
**Priority**: p1

## Executive Summary

This epic enhances the existing workflow infrastructure into a production-ready visual workflow builder. The backend (database models, execution engine, triggers, action library) is **90% complete**. The primary focus is on delivering a polished drag-and-drop UI and expanding the action library to meet the acceptance criteria.

## Current State Analysis

### ‚úÖ Already Implemented (90% Complete)

1. **Database Models** (100% Complete)
   - `Workflow`, `WorkflowVersion`, `WorkflowStep`, `WorkflowRun`, `WorkflowRunLog`
   - `WorkflowSchedule`, `WorkflowWebhook`, `WorkflowEventSubscription`
   - Enums: `WorkflowStatus`, `WorkflowStepType`, `BranchType`, `WorkflowEventType`

2. **Execution Engine** (100% Complete)
   - `src/lib/workflows/workflow-executor.ts` - Full step execution with branching
   - Dependency resolution and parallel execution
   - Step handler registry pattern
   - Built-in handlers: trigger, condition, log, delay

3. **Trigger System** (90% Complete)
   - Schedule triggers with cron expressions
   - Webhook triggers with HMAC verification
   - Event subscriptions with filters
   - API routes for trigger management

4. **Action Library** (60% Complete)
   - 5 actions: send_notification, update_record, call_ai_agent, post_to_platform, conditional
   - Dispatcher pattern with validation
   - Interpolation support for dynamic values

5. **API Routes** (80% Complete)
   - Workflow CRUD: `/api/workspaces/[workspaceId]/workflows/*`
   - Trigger management: `/api/workspaces/[workspaceId]/workflows/[workflowId]/triggers/*`
   - Webhook endpoint: `/api/workflows/webhook/[token]/route.ts`
   - Manual execution: `/api/workspaces/[workspaceId]/workflows/[workflowId]/run/*`

6. **React Flow Integration** (10% Complete)
   - `reactflow@11.11.4` installed
   - Basic scaffold at `src/components/orbit/workflow-editor/index.tsx`
   - Empty NodePalette component

### ‚ùå Missing Pieces (10% Remaining)

1. **Visual Editor UX** (Critical)
   - Drag-and-drop node palette
   - Custom node types for triggers, actions, conditions
   - Connection validation
   - Node configuration panels
   - Canvas state persistence

2. **Action Library Expansion** (Important)
   - Need to ensure all acceptance criteria actions exist
   - Better action metadata for UI

3. **Testing & Polish** (Important)
   - E2E tests for workflow creation
   - Visual regression tests for canvas

## Stories Breakdown

### ORB-042: Create Workflow data model ‚úÖ COMPLETE

**Status**: 100% Complete
**Complexity**: N/A (Already done)

The database models already exist and support all required features including versioning, branching, triggers, and run logs.

### ORB-043: Build visual workflow editor üöß IN PROGRESS

**Status**: 10% Complete
**Complexity**: Medium
**Estimated Effort**: 2-3 days

**Current State**:

- React Flow installed and basic scaffold exists
- Page route exists at `/orbit/[workspaceSlug]/workflows`

**What Needs to be Built**:

1. **Custom Node Types** (`src/components/orbit/workflow-editor/nodes/`)
   - `TriggerNode.tsx` - Entry point nodes (schedule, webhook, event)
   - `ActionNode.tsx` - Action execution nodes with icon badges
   - `ConditionNode.tsx` - Diamond-shaped decision nodes
   - `GroupNode.tsx` - Container for organizing flows

2. **Node Palette** (`src/components/orbit/workflow-editor/NodePalette.tsx`)
   - Draggable node templates
   - Categorized by type (Triggers, Actions, Logic)
   - Search/filter functionality
   - Icons for each node type

3. **Canvas Features** (`src/components/orbit/workflow-editor/`)
   - `WorkflowCanvas.tsx` - Main canvas with React Flow
   - `ConnectionValidator.ts` - Validate connections (no trigger-to-trigger, etc.)
   - `CanvasToolbar.tsx` - Save, Run, Version controls
   - `MiniMap.tsx` - Overview navigation for large workflows

4. **Configuration Panels** (`src/components/orbit/workflow-editor/config/`)
   - `NodeConfigPanel.tsx` - Right sidebar for node settings
   - `TriggerConfigForm.tsx` - Cron, webhook, event config forms
   - `ActionConfigForm.tsx` - Dynamic form based on action type
   - `ConditionConfigForm.tsx` - Expression builder

5. **State Management** (`src/components/orbit/workflow-editor/hooks/`)
   - `useWorkflowEditor.ts` - Canvas state, undo/redo
   - `useWorkflowPersistence.ts` - Auto-save, version management
   - `useNodeValidation.ts` - Real-time validation feedback

6. **UI Polish**
   - Loading states
   - Error boundaries
   - Keyboard shortcuts (Cmd+S, Delete, Cmd+Z)
   - Tooltips and help text

**Key Files to Create**:

```
src/components/orbit/workflow-editor/
‚îú‚îÄ‚îÄ index.tsx (‚úÖ exists, needs enhancement)
‚îú‚îÄ‚îÄ NodePalette.tsx (‚úÖ exists, needs implementation)
‚îú‚îÄ‚îÄ WorkflowCanvas.tsx (NEW)
‚îú‚îÄ‚îÄ CanvasToolbar.tsx (NEW)
‚îú‚îÄ‚îÄ ConnectionValidator.ts (NEW)
‚îú‚îÄ‚îÄ nodes/
‚îÇ   ‚îú‚îÄ‚îÄ TriggerNode.tsx (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ ActionNode.tsx (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ ConditionNode.tsx (NEW)
‚îÇ   ‚îî‚îÄ‚îÄ GroupNode.tsx (NEW)
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ NodeConfigPanel.tsx (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ TriggerConfigForm.tsx (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ ActionConfigForm.tsx (NEW)
‚îÇ   ‚îî‚îÄ‚îÄ ConditionConfigForm.tsx (NEW)
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useWorkflowEditor.ts (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ useWorkflowPersistence.ts (NEW)
‚îÇ   ‚îî‚îÄ‚îÄ useNodeValidation.ts (NEW)
‚îî‚îÄ‚îÄ types.ts (NEW)
```

**Key Files to Modify**:

```
src/components/orbit/workflow-editor/index.tsx - Main component refactor
src/app/orbit/[workspaceSlug]/workflows/page.tsx - Add workspace context
```

**Acceptance Criteria**:

- ‚úÖ Drag-and-drop workflow canvas
- ‚úÖ Connect triggers to actions
- ‚úÖ Visual feedback for valid/invalid connections
- ‚úÖ Node configuration panels
- ‚úÖ Auto-save functionality
- ‚úÖ Canvas zoom and pan
- ‚úÖ Keyboard shortcuts

### ORB-044: Implement workflow triggers ‚úÖ 90% COMPLETE

**Status**: 90% Complete
**Complexity**: Simple
**Estimated Effort**: 0.5 day

**What Exists**:

- Database models for all trigger types
- Trigger execution in `src/lib/workflows/triggers/`
- API routes for CRUD operations
- Webhook route with HMAC verification

**What Needs Work**:

1. **UI Integration** (Small)
   - Add trigger config forms to NodeConfigPanel
   - Test webhook creation flow
   - Add cron expression helper/picker
   - Event subscription UI

2. **Testing** (Small)
   - E2E test for creating schedule trigger
   - E2E test for webhook trigger
   - E2E test for event subscription

**Key Files to Modify**:

```
src/components/orbit/workflow-editor/config/TriggerConfigForm.tsx - Add form UI
src/components/orbit/workflow-editor/config/CronPicker.tsx - NEW (cron helper)
e2e/features/workflow-triggers.feature - NEW
e2e/step-definitions/workflow-triggers.steps.ts - NEW
```

**Acceptance Criteria**:

- ‚úÖ Schedule triggers with cron expressions
- ‚úÖ Webhook triggers with unique URLs
- ‚úÖ Event triggers with filter config
- ‚úÖ Trigger activation/deactivation
- ‚úÖ Test coverage for all trigger types

### ORB-045: Build workflow actions library ‚úÖ 70% COMPLETE

**Status**: 70% Complete
**Complexity**: Simple
**Estimated Effort**: 1 day

**What Exists**:

- 5 actions: send_notification, update_record, call_ai_agent, post_to_platform, conditional
- Action dispatcher with validation
- Interpolation for dynamic values

**What's Missing**:

1. **Additional Actions** (per acceptance criteria)
   - ‚úÖ send_notification (exists)
   - ‚úÖ call_ai_agent (exists)
   - ‚ùå http_request - Make external API calls
   - ‚ùå transform_data - Map/filter/transform JSON
   - ‚ùå delay - Wait for specified duration (exists in executor, need action)
   - ‚ùå parallel_execution - Run multiple actions concurrently
   - ‚ùå loop - Iterate over arrays

2. **Action Metadata** (for UI)
   - Icons, descriptions, categories
   - Input/output schemas
   - Example configurations

3. **Action Testing**
   - Unit tests for each action
   - Integration tests with workflow executor

**Key Files to Create**:

```
src/lib/workflows/actions/http-request.ts (NEW)
src/lib/workflows/actions/transform-data.ts (NEW)
src/lib/workflows/actions/parallel-execution.ts (NEW)
src/lib/workflows/actions/loop.ts (NEW)
src/lib/workflows/actions/metadata.ts (NEW) - Action registry with UI metadata
src/lib/workflows/actions/__tests__/http-request.test.ts (NEW)
src/lib/workflows/actions/__tests__/transform-data.test.ts (NEW)
src/lib/workflows/actions/__tests__/parallel-execution.test.ts (NEW)
src/lib/workflows/actions/__tests__/loop.test.ts (NEW)
```

**Key Files to Modify**:

```
src/lib/workflows/actions/action-dispatcher.ts - Register new actions
src/components/orbit/workflow-editor/config/ActionConfigForm.tsx - Add action forms
```

**Acceptance Criteria**:

- ‚úÖ Actions include posting, notifications, AI calls
- ‚úÖ HTTP request action for external APIs
- ‚úÖ Data transformation utilities
- ‚úÖ Looping and parallel execution
- ‚úÖ All actions have metadata for UI
- ‚úÖ 100% test coverage for actions

## Implementation Order

### Phase 1: Visual Editor Foundation (2 days)

**Priority**: Critical - Enables user interaction

1. Create custom node types (Trigger, Action, Condition)
2. Implement NodePalette with drag-and-drop
3. Build WorkflowCanvas with connection validation
4. Add basic configuration panels

**Deliverable**: Users can create simple workflows visually

### Phase 2: Action Library Expansion (1 day)

**Priority**: High - Completes acceptance criteria

1. Implement missing actions (http_request, transform_data, loop, parallel_execution)
2. Create action metadata registry
3. Add comprehensive unit tests

**Deliverable**: All acceptance criteria actions available

### Phase 3: Trigger UI Integration (0.5 day)

**Priority**: Medium - Enhances existing backend

1. Build trigger configuration forms
2. Add cron picker component
3. Create E2E tests for triggers

**Deliverable**: Triggers fully integrated in UI

### Phase 4: Polish & Testing (1 day)

**Priority**: Medium - Production readiness

1. Add keyboard shortcuts
2. Implement undo/redo
3. E2E tests for workflow creation
4. Visual regression tests
5. Error handling and loading states

**Deliverable**: Production-ready workflow builder

## Technical Architecture

### Component Hierarchy

```
WorkflowEditorPage (/orbit/[workspaceSlug]/workflows)
‚îî‚îÄ‚îÄ WorkflowEditor (main container)
    ‚îú‚îÄ‚îÄ CanvasToolbar (save, run, version)
    ‚îú‚îÄ‚îÄ NodePalette (draggable templates)
    ‚îú‚îÄ‚îÄ WorkflowCanvas (React Flow)
    ‚îÇ   ‚îú‚îÄ‚îÄ TriggerNode
    ‚îÇ   ‚îú‚îÄ‚îÄ ActionNode
    ‚îÇ   ‚îú‚îÄ‚îÄ ConditionNode
    ‚îÇ   ‚îî‚îÄ‚îÄ GroupNode
    ‚îú‚îÄ‚îÄ NodeConfigPanel (right sidebar)
    ‚îÇ   ‚îú‚îÄ‚îÄ TriggerConfigForm
    ‚îÇ   ‚îú‚îÄ‚îÄ ActionConfigForm
    ‚îÇ   ‚îî‚îÄ‚îÄ ConditionConfigForm
    ‚îî‚îÄ‚îÄ MiniMap
```

### Data Flow

```
1. User drags node from palette ‚Üí WorkflowCanvas
2. Node added to React Flow state ‚Üí useWorkflowEditor hook
3. User configures node ‚Üí NodeConfigPanel updates node data
4. User connects nodes ‚Üí ConnectionValidator checks rules
5. User clicks Save ‚Üí useWorkflowPersistence syncs to API
6. API creates WorkflowVersion with steps ‚Üí Database
7. User clicks Run ‚Üí Executes via workflow-executor.ts
```

### State Management Strategy

**Local State** (React Flow):

- Node positions, connections, selections
- Undo/redo stack

**Server State** (TanStack Query):

- Workflow metadata
- Workflow versions
- Run history

**Sync Strategy**:

- Auto-save every 30 seconds
- Manual save on Cmd+S
- Optimistic updates for UX

## Testing Strategy

### Unit Tests (Vitest)

- All action handlers (100% coverage)
- Connection validation logic
- State management hooks

### Integration Tests (Vitest)

- Workflow executor with new actions
- API routes for workflow CRUD
- Trigger execution flows

### E2E Tests (Playwright + Cucumber)

```gherkin
Feature: Workflow Canvas

Scenario: Create a simple notification workflow
  Given I am on the workflows page
  When I drag a "Schedule" trigger to the canvas
  And I configure it with cron expression "0 9 * * *"
  And I drag a "Send Notification" action
  And I connect the trigger to the action
  And I configure the notification with message "Good morning!"
  And I save the workflow
  Then the workflow should be saved
  And I should see the workflow in the list

Scenario: Execute a workflow manually
  Given I have a workflow with a notification action
  When I click "Run Workflow"
  Then the workflow should execute
  And the notification should be sent
  And I should see the run in the history
```

## Dependencies & Blockers

### Dependencies

- ‚úÖ React Flow 11.11.4 (installed)
- ‚úÖ Database models (complete)
- ‚úÖ Execution engine (complete)
- Phase 2 AI agents (mentioned in issue) - **Already available** (call_ai_agent action exists)

### Potential Blockers

- **None identified** - Backend is complete, only UI work remains

### Nice-to-Have (Future Enhancements)

- Workflow templates/marketplace
- Collaborative editing (multiplayer canvas)
- Workflow analytics dashboard
- AI-assisted workflow suggestions
- Import/export workflows (DSL exists but needs UI)

## Risk Assessment

| Risk                                        | Likelihood | Impact | Mitigation                                     |
| ------------------------------------------- | ---------- | ------ | ---------------------------------------------- |
| React Flow performance with large workflows | Medium     | Medium | Implement virtualization, lazy loading         |
| Complex branching UX confusing users        | Medium     | High   | Add visual guides, examples, tooltips          |
| Auto-save conflicts with manual edits       | Low        | Medium | Debounce + optimistic locking                  |
| Trigger execution reliability               | Low        | High   | Comprehensive monitoring, retry logic (exists) |

## Success Metrics

### Functional Metrics

- ‚úÖ All acceptance criteria met
- ‚úÖ All stories completed
- ‚úÖ 100% test coverage for new code
- ‚úÖ Zero critical bugs in production

### UX Metrics

- Users can create a workflow in < 5 minutes
- < 2% error rate on workflow execution
- 90% of workflows execute successfully on first run

### Performance Metrics

- Canvas renders < 100ms for workflows with < 50 nodes
- Auto-save completes < 500ms
- Workflow execution starts < 1s after manual trigger

## Out of Scope

The following are explicitly **NOT** part of this epic:

1. **Workflow Marketplace** - Sharing/selling workflows
2. **Collaborative Editing** - Real-time multiplayer
3. **Advanced AI Integration** - AI-generated workflows (future)
4. **Mobile Workflow Builder** - Canvas UI is desktop-only
5. **Workflow Analytics Dashboard** - Separate feature
6. **Third-party Integrations** - Zapier/Make.com equivalents (future)
7. **Workflow Templates** - Pre-built workflows (future)

## Migration Notes

**No migration required** - This is enhancement work on top of existing infrastructure.

However, if there are existing test workflows in the database:

1. They will continue to work (backward compatible)
2. They can be opened in the visual editor
3. Auto-save will create new versions (non-destructive)

## Rollout Plan

### Phase 1: Internal Testing (Week 1)

- Deploy to staging
- Team creates test workflows
- Gather feedback on UX

### Phase 2: Beta Release (Week 2)

- Enable for beta users in Orbit workspace
- Monitor execution metrics
- Fix critical bugs

### Phase 3: Production (Week 3)

- Full rollout to all workspaces
- Publish documentation
- Marketing announcement

## Documentation Requirements

### User Documentation

- [ ] Workflow builder user guide
- [ ] Trigger configuration guide
- [ ] Action reference documentation
- [ ] Example workflows (common use cases)
- [ ] Video tutorial (optional)

### Developer Documentation

- [ ] Action developer guide (how to add new actions)
- [ ] Workflow DSL specification
- [ ] API documentation for workflow endpoints
- [ ] Architecture decision records (ADRs)

## Open Questions

1. **Should we support workflow import/export in this epic?**
   - DSL exists but needs UI
   - Useful for backup/restore
   - Could be Phase 5

2. **Should we add workflow templates in this epic?**
   - Not in acceptance criteria
   - High user value
   - Could be separate story

3. **Do we need workflow versioning UI beyond auto-save?**
   - Database supports versioning
   - Manual version creation?
   - Rollback UI?

## Conclusion

This epic is **90% complete** from a backend perspective. The primary work is delivering a polished visual editor UX and expanding the action library. The implementation is straightforward with low risk due to the solid foundation already in place.

**Recommended Approach**:

- Start with Phase 1 (Visual Editor) to deliver immediate user value
- Run parallel work on Phase 2 (Actions) since it's independent
- Finish with Polish & Testing for production readiness

**Total Estimated Effort**: 4-5 days for complete implementation
