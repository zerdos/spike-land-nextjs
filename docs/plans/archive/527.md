# Implementation Plan: Issue #527 - Add Snapchat Integration

**Issue:** #527 (ORB-054)
**Title:** [Story] ORB-054: Add Snapchat integration
**Parent Epic:** #518 (Platform Integration)
**Planning Date:** 2026-01-29
**Complexity:** High

## Summary

Implement Snapchat integration for Spike Land's Orbit platform, including OAuth authentication, story posting, ad account connection, and metrics collection. This integration will support both organic content (via Snap Kit) and advertising features (via Snapchat Marketing API).

## Context from Parent Epic

This story is part of Epic #518 (Full Platform Integration - TikTok, Pinterest, YouTube, Snapchat). The codebase already has established patterns for social platform integrations with 5 fully implemented platforms:

- Twitter, Facebook, Instagram, LinkedIn, Discord ✅
- YouTube (partially implemented, needs OAuth routes)

## Acceptance Criteria (from Issue)

- [ ] Snapchat OAuth flow with proper handling for business and creator accounts
- [ ] Story posting with image/video content and interactive elements
- [ ] Ad account connection for Snap Ads Manager integration
- [ ] Metrics collection including story views, screenshots, replies, and completion rate
- [ ] Spotlight submission support for public content

## Technical Notes (from Issue)

- Use Snapchat Marketing API for ad features and Snap Kit for organic posting
- Implement media specifications validation (9:16 aspect ratio, max 60 seconds for video)
- Handle ephemeral content nature with appropriate archival strategies

## Architecture Overview

Following the established pattern in the codebase, the Snapchat integration consists of:

1. **Client Class** (`src/lib/social/clients/snapchat.ts`)
   - Implements `ISocialClient` interface
   - Handles OAuth 2.0 flow
   - Manages both Marketing API and Snap Kit endpoints
   - Normalizes responses to match platform types

2. **OAuth Routes**
   - Connect route (`src/app/api/social/snapchat/connect/route.ts`)
   - Callback route (`src/app/api/social/snapchat/callback/route.ts`)
   - CSRF protection with nonce-based state management

3. **Database Integration**
   - Add SNAPCHAT to SocialPlatform enum
   - Store encrypted tokens with workspace scoping
   - Store account metadata (account type, ad accounts, etc.)

4. **Stream & Metrics**
   - Integrate into unified stream aggregator
   - Collect metrics (story views, screenshots, replies, completion rate)
   - Support Spotlight metrics for public content

## Snapchat API Decision: Dual API Approach

Unlike other platforms, Snapchat has two separate APIs:

1. **Snap Kit** (Login Kit + Creative Kit)
   - For organic story posting
   - Personal and creator accounts
   - Ephemeral content (24-hour stories)
   - Limited API access

2. **Marketing API**
   - For advertisers
   - Ad account management
   - Campaign creation and analytics
   - Business accounts only

**Decision:** Implement BOTH APIs to support the acceptance criteria:

- Snap Kit for story posting (AC: story posting with image/video)
- Marketing API for ad accounts (AC: ad account connection)
- Unified metrics collection from both sources

## Implementation Plan

### Phase 1: Database Schema Update

**File to modify:** `prisma/schema.prisma`

```prisma
// Line ~2298
enum SocialPlatform {
  TWITTER
  LINKEDIN
  FACEBOOK
  INSTAGRAM
  TIKTOK
  YOUTUBE
  DISCORD
  SNAPCHAT  // ADD THIS
}
```

**Migration file to create:** `prisma/migrations/YYYYMMDD_add_snapchat/migration.sql`

```sql
-- Add Snapchat to SocialPlatform enum
ALTER TYPE "SocialPlatform" ADD VALUE 'SNAPCHAT';
```

**Files to modify:**

- `src/lib/constants/social-platforms.ts` (line 13-21)
  - Add "SNAPCHAT" to SOCIAL_PLATFORMS array
- `src/lib/social/types.ts` (line 512-523)
  - Add to PLATFORM_CAPABILITIES:
  ```typescript
  SNAPCHAT: { canLike: false, canReply: true, canShare: false },
  ```

**Reasoning:** Snapchat doesn't support programmatic likes, but supports replies to stories and doesn't expose share functionality.

### Phase 2: Snapchat API Setup

**Developer Account Setup:**

1. Create Snapchat Business account at https://business.snapchat.com/
2. Apply for Marketing API access (requires business verification - can take 1-2 weeks)
3. Create app in Snapchat Developer Portal at https://developers.snap.com/
4. Configure OAuth redirect URIs
5. Obtain client credentials

**Environment Variables:**

```bash
# .env
SNAPCHAT_CLIENT_ID=your-snapchat-client-id
SNAPCHAT_CLIENT_SECRET=your-snapchat-client-secret
SNAPCHAT_CALLBACK_URL=https://spike.land/api/social/snapchat/callback
```

**Required Scopes:**

For Snap Kit (organic posting):

- `snapchat-profile-api` - User profile access
- `snapchat-marketing-api` - Marketing API access (for business accounts)

For Marketing API:

- `snapchat-marketing-api` - Full marketing API access

**Documentation References:**

- Snap Kit: https://kit.snapchat.com/
- Marketing API: https://marketingapi.snapchat.com/docs/
- OAuth 2.0: https://marketingapi.snapchat.com/docs/#authentication
- Creative API: https://marketingapi.snapchat.com/docs/#creative-library

### Phase 3: Snapchat Client Implementation

**File to create:** `src/lib/social/clients/snapchat.ts` (~900 lines)

**Class Structure:**

```typescript
export class SnapchatClient implements ISocialClient {
  readonly platform = "SNAPCHAT" as const;

  private accessToken: string;
  private accountType: "PERSONAL" | "BUSINESS";
  private adAccountId?: string;

  // OAuth methods
  getAuthUrl(redirectUri: string, state: string): string;
  exchangeCodeForTokens(code: string, redirectUri: string): Promise<OAuthTokenResponse>;
  refreshAccessToken(refreshToken: string): Promise<OAuthTokenResponse>;

  // Account methods
  getAccountInfo(): Promise<SocialAccountInfo>;
  getAdAccounts(): Promise<SnapchatAdAccount[]>;

  // Story posting (Snap Kit)
  createStory(options: SnapchatStoryOptions): Promise<PostResult>;

  // Ad posting (Marketing API)
  createAdCreative(options: SnapchatAdCreativeOptions): Promise<PostResult>;

  // Unified posting (delegates to story or ad based on account type)
  createPost(content: string, options?: PostOptions): Promise<PostResult>;

  // Content retrieval
  getPosts(limit?: number): Promise<SocialPost[]>;

  // Metrics
  getMetrics(): Promise<SocialMetricsData>;
  getStoryMetrics(storyId: string): Promise<SnapchatStoryMetrics>;

  // Spotlight
  submitToSpotlight(options: SnapchatSpotlightOptions): Promise<PostResult>;

  // Media validation
  private validateMediaSpecs(mediaUrl: string): Promise<MediaValidationResult>;
}
```

**Special Implementation Requirements:**

1. **Media Validation (9:16 Aspect Ratio)**
   - Create helper function to validate aspect ratio
   - Reject non-conforming media with clear error
   - Support both images and videos

2. **Video Duration Validation (max 60 seconds)**
   - Validate video duration before upload
   - Use ffmpeg or similar to check metadata
   - Consider server-side validation

3. **Ephemeral Content Archival**
   - Store story metadata in database
   - Store thumbnail/preview images
   - Track expiration times (24 hours for stories)
   - Mark expired content in UI

4. **Dual Account Support**
   - Detect account type during OAuth
   - Store account type in metadata
   - Route createPost to appropriate API

**API Endpoints:**

Snap Kit / Login Kit:

- `POST /v1/oauth2/access_token` - Exchange code for tokens
- `GET /v1/me` - User profile
- `POST /v1/bitmoji/avatar` - Bitmoji integration (optional)

Marketing API:

- `GET /v1/me` - Organization info
- `GET /v1/me/adaccounts` - List ad accounts
- `GET /v1/adaccounts/{id}` - Ad account details
- `POST /v1/adaccounts/{id}/creatives` - Upload creative
- `GET /v1/adaccounts/{id}/stats` - Analytics
- `POST /v1/media` - Upload media to Creative Library

Creative Kit (for stories):

- Creative Kit uses deep linking and SDK, not direct API
- Stories are posted via Snapchat app with prefilled content
- Consider whether to implement or defer to Marketing API

**Type Definitions:**

```typescript
// Add to src/lib/social/types.ts

export interface SnapchatAdAccount {
  id: string;
  name: string;
  currency: string;
  status: string;
  organization_id: string;
}

export interface SnapchatStoryOptions {
  mediaUrl: string;
  mediaType: "IMAGE" | "VIDEO";
  duration?: number; // For videos
  stickers?: SnapchatSticker[];
  attachments?: SnapchatAttachment[];
}

export interface SnapchatStoryMetrics {
  views: number;
  screenshots: number;
  replies: number;
  completionRate: number;
  uniqueViewers: number;
  dropOffRate: number;
}

export interface SnapchatSpotlightOptions {
  videoUrl: string;
  caption: string;
  topics: string[];
}

export interface MediaValidationResult {
  valid: boolean;
  aspectRatio: string;
  duration?: number;
  errors: string[];
}
```

**Normalized Types Mapping:**

```typescript
// Map Snapchat responses to SocialAccountInfo
{
  platformId: user.me.id,
  username: user.me.username || user.me.display_name,
  displayName: user.me.display_name,
  profileUrl: null, // Snapchat doesn't provide public profile URLs
  avatarUrl: user.me.bitmoji_avatar_url,
  followersCount: null // Not exposed in API for privacy
}
```

**Error Handling:**

- Rate limiting (Marketing API: 100 requests/minute)
- Media upload failures
- Aspect ratio validation failures
- Account type mismatches
- Token expiration (refresh tokens valid for 60 days)

**Files to create:**

- `src/lib/social/clients/snapchat.ts` (~900 lines)
- `src/lib/social/clients/snapchat.test.ts` (~500 lines)

### Phase 4: Media Validation Utilities

**File to create:** `src/lib/social/validators/snapchat-media.ts` (~200 lines)

**Functions:**

```typescript
/**
 * Validate image/video meets Snapchat requirements
 * - Aspect ratio: 9:16 (vertical)
 * - Video duration: max 60 seconds
 * - File size: max 32 MB
 * - Formats: JPG, PNG, MP4, MOV
 */
export async function validateSnapchatMedia(
  mediaUrl: string,
  mediaType: "IMAGE" | "VIDEO",
): Promise<MediaValidationResult>;

/**
 * Get aspect ratio from image
 */
export async function getImageAspectRatio(
  imageUrl: string,
): Promise<{ width: number; height: number; ratio: string; }>;

/**
 * Get video metadata (duration, aspect ratio)
 */
export async function getVideoMetadata(
  videoUrl: string,
): Promise<{ duration: number; width: number; height: number; ratio: string; }>;

/**
 * Check if aspect ratio matches 9:16 (with tolerance)
 */
export function isVerticalAspectRatio(
  width: number,
  height: number,
  tolerance: number = 0.05,
): boolean;
```

**Implementation Notes:**

- Use browser Image API for images
- Consider ffmpeg.wasm for video validation (client-side)
- Or delegate to server-side validation endpoint
- Cache validation results to avoid re-checking

**Files to create:**

- `src/lib/social/validators/snapchat-media.ts` (~200 lines)
- `src/lib/social/validators/snapchat-media.test.ts` (~150 lines)

### Phase 5: OAuth Routes

**Connect Route:** `src/app/api/social/snapchat/connect/route.ts` (~120 lines)

Following the pattern from Facebook/LinkedIn:

```typescript
export async function GET(request: NextRequest): Promise<NextResponse> {
  // 1. Authenticate user
  const session = await auth();

  // 2. Get workspaceId and workspaceSlug from query params
  const workspaceId = searchParams.get("workspaceId");
  const workspaceSlug = searchParams.get("workspaceSlug");

  // 3. Verify workspace permissions
  await requireWorkspacePermission(session, workspaceId, "social:connect");

  // 4. Generate nonce for CSRF protection
  const nonce = crypto.randomBytes(16).toString("hex");

  // 5. Create state with userId, workspaceId, workspaceSlug, timestamp, nonce
  const state = Buffer.from(
    JSON.stringify({ userId, workspaceId, workspaceSlug, timestamp, nonce }),
  ).toString("base64url");

  // 6. Get auth URL from SnapchatClient
  const client = new SnapchatClient();
  const authUrl = client.getAuthUrl(redirectUri, state);

  // 7. Set nonce cookie and redirect
  const response = NextResponse.redirect(authUrl);
  response.cookies.set("snapchat_social_oauth_nonce", nonce, {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production",
    sameSite: "lax",
    maxAge: 600, // 10 minutes
    path: "/api/social/snapchat",
  });

  return response;
}
```

**Callback Route:** `src/app/api/social/snapchat/callback/route.ts` (~320 lines)

```typescript
export async function GET(request: NextRequest): Promise<NextResponse> {
  // 1. Authenticate user
  const session = await auth();

  // 2. Get code, state, error from query params
  const code = searchParams.get("code");
  const state = searchParams.get("state");
  const error = searchParams.get("error");

  // 3. Handle OAuth errors
  if (error) {
    return NextResponse.redirect(redirect({ error: errorDescription || error }));
  }

  // 4. Validate state parameter
  const stateData = JSON.parse(Buffer.from(state, "base64url").toString("utf-8"));

  // 5. Verify userId, workspaceId, timestamp, nonce
  if (stateData.userId !== session.user.id) {
    return NextResponse.redirect(redirect({ error: "User mismatch" }));
  }

  // 6. Verify nonce from cookie
  const storedNonce = request.cookies.get("snapchat_social_oauth_nonce")?.value;
  if (stateData.nonce !== storedNonce) {
    return NextResponse.redirect(redirect({ error: "Invalid security token" }));
  }

  // 7. Exchange code for tokens
  const client = new SnapchatClient();
  const tokens = await client.exchangeCodeForTokens(code, redirectUri);

  // 8. Get account info
  client.setAccessToken(tokens.accessToken);
  const accountInfo = await client.getAccountInfo();

  // 9. Get ad accounts (if business account)
  const adAccounts = await client.getAdAccounts().catch(() => []);

  // 10. Encrypt and store tokens
  const encryptedToken = safeEncryptToken(tokens.accessToken);

  await prisma.socialAccount.upsert({
    where: {
      workspaceId_platform_accountId: {
        workspaceId: stateData.workspaceId,
        platform: "SNAPCHAT",
        accountId: accountInfo.platformId,
      },
    },
    update: {
      accountName: accountInfo.displayName,
      accessTokenEncrypted: encryptedToken,
      tokenExpiresAt: tokens.expiresAt,
      refreshTokenEncrypted: tokens.refreshToken
        ? safeEncryptToken(tokens.refreshToken)
        : null,
      metadata: {
        accountType: adAccounts.length > 0 ? "BUSINESS" : "PERSONAL",
        adAccounts: adAccounts.map(a => ({ id: a.id, name: a.name })),
        username: accountInfo.username,
        avatarUrl: accountInfo.avatarUrl,
      },
      status: "ACTIVE",
    },
    create: {
      userId: session.user.id,
      workspaceId: stateData.workspaceId,
      platform: "SNAPCHAT",
      accountId: accountInfo.platformId,
      accountName: accountInfo.displayName,
      accessTokenEncrypted: encryptedToken,
      tokenExpiresAt: tokens.expiresAt,
      refreshTokenEncrypted: tokens.refreshToken
        ? safeEncryptToken(tokens.refreshToken)
        : null,
      metadata: {/* same as update */},
      status: "ACTIVE",
    },
  });

  // 11. Clear nonce cookie and redirect with success
  const response = NextResponse.redirect(
    redirect({ connected: "snapchat", message: "Snapchat account connected" }),
  );
  response.cookies.delete("snapchat_social_oauth_nonce");
  return response;
}
```

**Files to create:**

- `src/app/api/social/snapchat/connect/route.ts` (~120 lines)
- `src/app/api/social/snapchat/callback/route.ts` (~320 lines)

### Phase 6: Metrics Collection Integration

**File to modify:** `src/lib/social/metrics-collector.ts`

Add Snapchat to SUPPORTED_PLATFORMS array (line ~75-81):

```typescript
const SUPPORTED_PLATFORMS: SocialPlatform[] = [
  "LINKEDIN",
  "INSTAGRAM",
  "FACEBOOK",
  "TWITTER",
  "YOUTUBE",
  "SNAPCHAT", // ADD THIS
];
```

Add Snapchat case to createSocialClient function (line ~86-120):

```typescript
case "SNAPCHAT":
  return new SnapchatClient({
    accessToken,
    accountType: metadata?.accountType as "PERSONAL" | "BUSINESS",
    adAccountId: metadata?.adAccounts?.[0]?.id,
  });
```

**Metrics to Collect:**

For stories:

- Views (total and unique)
- Screenshots
- Replies
- Completion rate
- Drop-off rate

For Spotlight:

- Views
- Shares
- Time watched
- Engagement rate

For ads (Marketing API):

- Impressions
- Swipe-ups
- Conversions
- Spend

**Implementation Note:** Snapchat metrics are available via Marketing API stats endpoint. Story metrics require the account to have analytics access (typically creator/business accounts).

### Phase 7: Stream Integration

**Files to modify:**

1. `src/lib/social/index.ts` (lines ~104-120)

Add Snapchat case to createSocialClient factory:

```typescript
case "SNAPCHAT":
  return (await import("./clients/snapchat")).SnapchatClient;
```

2. `src/lib/social/stream-aggregator.ts`

Ensure Snapchat is included in stream aggregation:

- Test that SnapchatClient.getPosts() returns normalized SocialPost[]
- Handle ephemeral content expiration (filter out expired stories)

**Note:** Snapchat stories are ephemeral (24 hours). The stream aggregator should:

- Mark expired stories as "expired"
- Optionally filter them out by default
- Show archival thumbnails for expired content

### Phase 8: UI Integration

**Files to modify:**

1. `src/components/orbit/connections/ConnectionPlatformIcons.tsx`

Add Snapchat icon import and case:

```typescript
import { Ghost } from "lucide-react"; // Snapchat ghost icon

case "SNAPCHAT":
  return <Ghost className={className} />;
```

2. `src/app/orbit/[workspaceSlug]/settings/accounts/SocialAccountsClient.tsx`

Add Snapchat to platform connection options:

- Connect button for Snapchat
- Display connected Snapchat accounts
- Show account type (Personal/Business)
- Show linked ad accounts (if business)

3. `src/components/calendar/CreatePostDialog.tsx`

Add Snapchat option to platform selector:

- Show media upload for Snapchat (required)
- Validate aspect ratio (9:16)
- Show duration limit warning for videos
- Disable text-only posts for Snapchat

4. `src/components/streams/StreamFilters.tsx`

Ensure Snapchat appears in platform filters:

- Add Snapchat option to filter dropdown
- Test filtering stream by Snapchat

### Phase 9: Testing

**Unit Tests (100% Coverage Required):**

`src/lib/social/clients/snapchat.test.ts` (~500 lines):

- OAuth flow tests
- Token exchange and refresh
- Account info retrieval
- Story posting
- Ad account listing
- Metrics collection
- Media validation
- Error handling (rate limits, invalid tokens, etc.)

`src/lib/social/validators/snapchat-media.test.ts` (~150 lines):

- Aspect ratio validation
- Video duration validation
- File size validation
- Format validation

**Integration Tests:**

- OAuth callback flow with mock state
- Database storage of encrypted tokens
- Workspace permission checks
- Token refresh flow

**E2E Tests:**

Create `e2e/features/snapchat-integration.feature`:

```gherkin
Feature: Snapchat Integration

  Scenario: Connect personal Snapchat account
    Given I am logged in as a workspace admin
    When I navigate to Orbit settings
    And I click "Connect Snapchat"
    And I authorize Snapchat OAuth
    Then I should see my Snapchat account connected
    And the account type should be "Personal"

  Scenario: Connect business Snapchat account with ad accounts
    Given I am logged in as a workspace admin
    When I navigate to Orbit settings
    And I click "Connect Snapchat"
    And I authorize Snapchat Business OAuth
    Then I should see my Snapchat account connected
    And the account type should be "Business"
    And I should see my linked ad accounts

  Scenario: Post a story to Snapchat
    Given I have a connected Snapchat account
    When I navigate to Orbit calendar
    And I click "Create Post"
    And I select Snapchat as the platform
    And I upload a 9:16 vertical image
    And I add caption "Test story"
    And I click "Post Now"
    Then the story should be posted successfully
    And I should see it in my Snapchat stories

  Scenario: Validate media aspect ratio
    Given I am creating a Snapchat post
    When I upload a 16:9 horizontal image
    Then I should see an error "Snapchat requires 9:16 aspect ratio"
    And the post button should be disabled

  Scenario: View Snapchat story metrics
    Given I have posted a story to Snapchat
    When I navigate to Orbit streams
    And I find my Snapchat story
    Then I should see story metrics
    And metrics should include views, screenshots, replies, completion rate
```

Create `e2e/step-definitions/snapchat-integration.steps.ts`:

- Implement step definitions
- Mock Snapchat OAuth flow
- Mock API responses for testing

### Phase 10: Documentation

**Files to update:**

1. `docs/API_REFERENCE.md`

Add Snapchat OAuth endpoints:

```markdown
### Snapchat OAuth

**Connect Snapchat Account**
```

GET /api/social/snapchat/connect?workspaceId={id}&workspaceSlug={slug}

```
**Snapchat OAuth Callback**
```

GET /api/social/snapchat/callback?code={code}&state={state}

```
```

2. `docs/FEATURES.md`

Update Orbit platform support:

```markdown
### Supported Platforms

- Twitter ✅
- LinkedIn ✅
- Facebook ✅
- Instagram ✅
- TikTok (coming soon)
- YouTube (coming soon)
- Discord ✅
- Pinterest (coming soon)
- Snapchat ✅ **NEW**
```

3. `README.md`

Update platform count and list in overview.

4. Create `docs/SNAPCHAT_INTEGRATION.md` (~400 lines)

Comprehensive guide including:

- Developer account setup
- OAuth configuration
- Environment variables
- Media requirements (9:16, max 60s)
- Story posting workflow
- Ad account integration
- Metrics collection
- Troubleshooting common issues

## Files to Create

### Core Implementation

- `src/lib/social/clients/snapchat.ts` (~900 lines)
- `src/lib/social/clients/snapchat.test.ts` (~500 lines)
- `src/lib/social/validators/snapchat-media.ts` (~200 lines)
- `src/lib/social/validators/snapchat-media.test.ts` (~150 lines)

### OAuth Routes

- `src/app/api/social/snapchat/connect/route.ts` (~120 lines)
- `src/app/api/social/snapchat/callback/route.ts` (~320 lines)

### Tests

- `e2e/features/snapchat-integration.feature` (~80 lines)
- `e2e/step-definitions/snapchat-integration.steps.ts` (~200 lines)

### Documentation

- `docs/SNAPCHAT_INTEGRATION.md` (~400 lines)

**Total:** 8 new files, ~2,870 lines of code

## Files to Modify

### Database Schema

- `prisma/schema.prisma` (line ~2298) - Add SNAPCHAT to enum
- Create migration: `prisma/migrations/YYYYMMDD_add_snapchat/migration.sql`

### Constants & Types

- `src/lib/constants/social-platforms.ts` (line 13-21) - Add "SNAPCHAT"
- `src/lib/social/types.ts` (line 512-523) - Add to PLATFORM_CAPABILITIES
- `src/lib/social/types.ts` - Add Snapchat-specific types

### Core Integration

- `src/lib/social/index.ts` (lines ~104-120) - Add Snapchat case
- `src/lib/social/metrics-collector.ts` (lines ~75-81, ~86-120) - Add Snapchat support
- `src/lib/social/stream-aggregator.ts` - Ensure Snapchat included

### UI Components

- `src/components/orbit/connections/ConnectionPlatformIcons.tsx` - Add Ghost icon
- `src/app/orbit/[workspaceSlug]/settings/accounts/SocialAccountsClient.tsx` - Add connect button
- `src/components/calendar/CreatePostDialog.tsx` - Add Snapchat option with validation
- `src/components/streams/StreamFilters.tsx` - Add Snapchat filter

### Documentation

- `docs/API_REFERENCE.md` - Add Snapchat OAuth endpoints
- `docs/FEATURES.md` - Update platform list
- `README.md` - Update platform count

**Total:** 13 modified files

## Dependencies & Prerequisites

### External Dependencies

1. **Snapchat Business Account**
   - Create at https://business.snapchat.com/
   - Verify business information
   - Apply for Marketing API access (1-2 weeks approval time)

2. **Snapchat Developer Account**
   - Create at https://developers.snap.com/
   - Create OAuth app
   - Configure redirect URIs
   - Obtain client credentials

3. **API Access**
   - Marketing API access (for business features)
   - Snap Kit access (for organic posting)
   - Creative API access (for ad creatives)

### Internal Dependencies

1. **Token Encryption** - `src/lib/crypto/token-encryption.ts` ✅ (exists)
2. **Workspace Permissions** - `src/lib/permissions/workspace-middleware.ts` ✅ (exists)
3. **OAuth State Management** - Pattern established in Facebook/LinkedIn routes ✅
4. **ISocialClient Interface** - `src/lib/social/types.ts` ✅ (exists)

### Development Environment

- Node.js 18+ (for testing)
- PostgreSQL (for enum migration)
- Vitest (for unit tests)
- Playwright (for E2E tests)

## Risks & Mitigation

### Risk 1: Marketing API Access Approval Delay

**Impact:** High - Cannot implement business features without approval
**Probability:** Medium - Snapchat reviews business applications manually
**Mitigation:**

- Apply for API access early in development process
- Implement Snap Kit features first (doesn't require approval)
- Have timeline buffer for approval delays
- Consider phased rollout (organic first, then ads)

### Risk 2: Creative Kit Complexity

**Impact:** Medium - Creative Kit requires SDK integration
**Probability:** High - Web-based Creative Kit is limited
**Mitigation:**

- Focus on Marketing API for MVP
- Document Creative Kit limitations
- Consider mobile SDK for future enhancement
- Use deep linking where possible

### Risk 3: Media Validation Performance

**Impact:** Medium - Video validation can be slow
**Probability:** Medium - Depends on file size
**Mitigation:**

- Implement client-side validation where possible
- Use web workers for heavy processing
- Show progress indicators during validation
- Cache validation results

### Risk 4: Ephemeral Content Archival

**Impact:** Medium - Stories disappear after 24 hours
**Probability:** High - By design
**Mitigation:**

- Store thumbnails before expiration
- Capture metrics before content expires
- Clear UI indication of expired content
- Archive metadata for historical reporting

### Risk 5: Dual API Complexity

**Impact:** Medium - Managing two API systems
**Probability:** High - Required for full feature set
**Mitigation:**

- Clear separation of concerns in code
- Unified interface via ISocialClient
- Comprehensive error handling
- Good documentation of API differences

### Risk 6: Aspect Ratio Enforcement

**Impact:** Low - User frustration if not clear
**Probability:** Medium - Users may not understand requirement
**Mitigation:**

- Clear validation messages
- Visual aspect ratio guide in UI
- Auto-crop or suggest cropping
- Examples of correct format

## Success Metrics

### Functional Metrics

- [ ] OAuth connection success rate >95%
- [ ] Story posting success rate >90%
- [ ] Media validation accuracy 100%
- [ ] Metrics collection accuracy >95%

### Performance Metrics

- [ ] OAuth flow completion <30 seconds
- [ ] Media validation <5 seconds
- [ ] Story posting <10 seconds
- [ ] Metrics refresh <3 seconds

### Code Quality Metrics

- [ ] Unit test coverage 100%
- [ ] E2E test pass rate 100%
- [ ] TypeScript strict mode compliance
- [ ] Zero ESLint errors

## Implementation Sequence

### Week 1: Foundation (Days 1-3)

**Day 1:**

- [ ] Database schema update (add SNAPCHAT enum)
- [ ] Run migration
- [ ] Update constants and types
- [ ] Set up Snapchat developer account
- [ ] Apply for Marketing API access

**Day 2:**

- [ ] Implement SnapchatClient class structure
- [ ] Implement OAuth methods (getAuthUrl, exchangeCodeForTokens, refreshAccessToken)
- [ ] Write unit tests for OAuth

**Day 3:**

- [ ] Implement getAccountInfo and getAdAccounts
- [ ] Implement media validation utilities
- [ ] Write unit tests for validation

### Week 2: Core Features (Days 4-6)

**Day 4:**

- [ ] Implement story posting (createStory)
- [ ] Implement ad creative posting (createAdCreative)
- [ ] Implement unified createPost method
- [ ] Write unit tests for posting

**Day 5:**

- [ ] Implement getPosts (story retrieval)
- [ ] Implement getMetrics (story & ad metrics)
- [ ] Implement Spotlight submission
- [ ] Write unit tests for retrieval and metrics

**Day 6:**

- [ ] Implement OAuth connect route
- [ ] Implement OAuth callback route
- [ ] Test OAuth flow end-to-end
- [ ] Write integration tests

### Week 3: Integration & Testing (Days 7-9)

**Day 7:**

- [ ] Integrate into metrics collector
- [ ] Integrate into stream aggregator
- [ ] Update UI components (icons, connect buttons)
- [ ] Test stream filtering

**Day 8:**

- [ ] Write E2E tests (connection, posting, metrics)
- [ ] Test media validation in UI
- [ ] Test ephemeral content expiration handling
- [ ] Test dual account type support

**Day 9:**

- [ ] Documentation (API reference, features, guide)
- [ ] Code review and refinement
- [ ] Performance testing
- [ ] Bug fixes

**Total Estimated Duration:** 9 days

## Acceptance Criteria Verification

### AC 1: OAuth Flow ✅

- [ ] Personal accounts can connect
- [ ] Business accounts can connect
- [ ] Account type detected automatically
- [ ] Ad accounts listed for business accounts
- [ ] Tokens stored encrypted
- [ ] Workspace-scoped storage

### AC 2: Story Posting ✅

- [ ] Can post image stories (9:16)
- [ ] Can post video stories (9:16, max 60s)
- [ ] Interactive elements supported (stickers, attachments)
- [ ] Media validation prevents invalid uploads
- [ ] Error messages clear and helpful

### AC 3: Ad Account Connection ✅

- [ ] Ad accounts retrieved during OAuth
- [ ] Ad accounts stored in metadata
- [ ] Ad accounts displayed in UI
- [ ] Can select ad account for campaigns

### AC 4: Metrics Collection ✅

- [ ] Story views collected
- [ ] Screenshots tracked
- [ ] Replies counted
- [ ] Completion rate calculated
- [ ] Metrics displayed in UI
- [ ] Historical metrics stored

### AC 5: Spotlight Submission ✅

- [ ] Can submit videos to Spotlight
- [ ] Topic selection supported
- [ ] Spotlight metrics tracked
- [ ] Public content marked appropriately

### Technical Notes Verification ✅

- [ ] Marketing API used for ad features
- [ ] Snap Kit used for organic posting
- [ ] 9:16 aspect ratio validated
- [ ] 60-second max duration enforced
- [ ] Ephemeral content archived (thumbnails, metadata)

## Post-Implementation Tasks

### Monitoring & Observability

- [ ] Add Snapchat-specific error tracking
- [ ] Monitor OAuth success/failure rates
- [ ] Track media validation errors
- [ ] Monitor story posting success rates
- [ ] Track API rate limit usage

### User Communication

- [ ] Announce Snapchat support in changelog
- [ ] Create help documentation
- [ ] Add onboarding tooltip for Snapchat
- [ ] Email users about new integration

### Future Enhancements

- [ ] Creative Kit SDK integration (mobile)
- [ ] Auto-crop for aspect ratio
- [ ] Advanced Spotlight analytics
- [ ] Snapchat Ads campaign management UI
- [ ] Story templates library

## Notes

### Snapchat Unique Characteristics

1. **Ephemeral by Design**
   - Stories disappear after 24 hours
   - Need archival strategy
   - Metrics must be captured before expiration

2. **Strict Media Requirements**
   - 9:16 aspect ratio mandatory
   - Video max 60 seconds
   - Vertical orientation only
   - Quality guidelines for Spotlight

3. **Dual API System**
   - Snap Kit for organic content
   - Marketing API for business/ads
   - Need to support both in single client

4. **Privacy-First**
   - No public profile URLs
   - Limited follower information
   - Analytics require creator/business account

### Code Reuse from Other Platforms

- OAuth flow similar to LinkedIn (OAuth 2.0)
- Token refresh similar to Twitter
- Media validation pattern new (unique to Snapchat)
- Ephemeral content handling new (unique to Snapchat)

### Comparison to Other Platforms

| Feature            | Instagram              | Snapchat             |
| ------------------ | ---------------------- | -------------------- |
| Media Requirements | Multiple aspect ratios | 9:16 only            |
| Content Duration   | Permanent              | Ephemeral (24h)      |
| OAuth              | Via Facebook           | Direct               |
| Business Features  | Insights               | Marketing API        |
| Posting API        | Graph API              | Snap Kit + Marketing |

## Conclusion

This implementation adds Snapchat as the 8th platform to Spike Land's Orbit integration suite. The dual API approach (Snap Kit + Marketing API) provides comprehensive support for both organic story posting and advertising features.

**Key Challenges:**

1. Marketing API approval delay (1-2 weeks)
2. Strict media requirements (9:16, max 60s)
3. Ephemeral content archival
4. Dual API system complexity

**Key Strengths:**

- Follows established patterns from Facebook/Instagram
- Comprehensive metrics collection
- Support for both personal and business accounts
- Clear validation and error handling

**Business Value:**

- Completes full platform coverage for major social networks
- Supports creator and business use cases
- Enables Snapchat advertising integration
- Competitive advantage in social media management

**Estimated Effort:** 9 days
**Risk Level:** Medium-High (API approval, dual API complexity)
**Business Impact:** High (popular platform, especially for younger demographics)

---

_Plan created: 2026-01-29_
_Ready for implementation_
