# Implementation Plan: Issue #524 - Add Pinterest Integration

**Issue:** #524
**Title:** [Story] ORB-052: Add Pinterest integration
**Parent Epic:** #518 (Platform Integration)
**Planning Date:** 2026-01-29
**Complexity:** Medium

## Summary

Implement full Pinterest integration for Spike Land's Orbit platform, including OAuth 2.0 authentication, pin creation with media upload, board management, and analytics collection. This will enable users to manage Pinterest content alongside other social platforms in the unified Orbit dashboard.

## Current State Analysis

### Existing Platform Integration Architecture

Spike Land has a well-established pattern for social media integrations:

1. **Client Classes** (`src/lib/social/clients/*.ts`)
   - Implement `ISocialClient` interface
   - Provide normalized OAuth, posting, and metrics methods
   - Platform-specific API handling

2. **OAuth Routes** (`src/app/api/social/{platform}/`)
   - `connect/route.ts` - Initiates OAuth flow
   - `callback/route.ts` - Handles OAuth callback and token storage

3. **Database Schema**
   - `SocialAccount` model with encrypted tokens
   - `SocialPlatform` enum (needs PINTEREST added)
   - Workspace-scoped account storage

### Pinterest Platform Status

- **Not Currently Implemented**
- `PINTEREST` not in `SocialPlatform` enum
- No client class exists
- No OAuth routes exist
- Factory function in `src/lib/social/index.ts` does not handle Pinterest

### Pinterest API v5 Overview

**API Documentation:** https://developers.pinterest.com/docs/api/v5/

**Key Capabilities:**

- OAuth 2.0 authentication with scopes
- Pin creation with image/video upload
- Board management (create, update, delete, organize)
- Analytics API (impressions, saves, clicks, engagement)
- Rich Pins support (product, recipe, article metadata)

**Rate Limits:**

- 1000 requests per hour per user token
- 200 requests per hour for unauthenticated endpoints

**Required Scopes:**

- `boards:read` - View boards
- `boards:write` - Create/update boards
- `pins:read` - View pins
- `pins:write` - Create/publish pins
- `user_accounts:read` - Get user profile

## Acceptance Criteria

From issue #524:

- [ ] Pinterest OAuth 2.0 flow implemented with proper scopes for pins and boards
- [ ] Pin creation with image/video upload, title, description, link, and alt text
- [ ] Board management including create, update, delete, and organize pins
- [ ] Analytics collection including impressions, saves, clicks, and engagement rate
- [ ] Rich Pins support for product, recipe, and article content types

## Implementation Plan

---

### Phase 1: Database Schema Update

**Complexity:** Simple

**File to modify:** `prisma/schema.prisma`

**Changes:**

Add `PINTEREST` to the `SocialPlatform` enum:

```prisma
enum SocialPlatform {
  TWITTER
  LINKEDIN
  FACEBOOK
  INSTAGRAM
  TIKTOK
  YOUTUBE
  DISCORD
  PINTEREST  // <-- Add this
}
```

**Migration:**

```bash
yarn prisma migrate dev --name add_pinterest_platform
yarn prisma generate
```

**Impact:** Adds Pinterest as a valid platform in the database schema.

---

### Phase 2: Environment Variables

**Complexity:** Simple

**Files to modify:**

- `.env.example`
- `scripts/env-check.ts` (if Pinterest credentials should be required)

**Environment Variables:**

```bash
# Pinterest OAuth App Credentials
PINTEREST_APP_ID=your-pinterest-app-id
PINTEREST_APP_SECRET=your-pinterest-app-secret
PINTEREST_CALLBACK_URL=https://spike.land/api/social/pinterest/callback
```

**Developer Setup Required:**

1. Create Pinterest App at https://developers.pinterest.com/apps/
2. Enable OAuth 2.0
3. Configure redirect URI
4. Request required scopes (boards:read, boards:write, pins:read, pins:write, user_accounts:read)

**Note:** Add these variables to `.env.example` with placeholder values for documentation.

---

### Phase 3: Pinterest Client Implementation

**Complexity:** Medium-High

**File to create:** `src/lib/social/clients/pinterest.ts`

**Estimated size:** ~900 lines (similar to Instagram client)

**Class Structure:**

```typescript
export class PinterestClient implements ISocialClient {
  readonly platform: SocialPlatform = "PINTEREST";
  private accessToken: string;
  private refreshToken?: string;

  // OAuth Methods
  getAuthUrl(redirectUri: string, state: string): string;
  exchangeCodeForTokens(code: string, redirectUri: string): Promise<OAuthTokenResponse>;
  refreshAccessToken(refreshToken: string): Promise<OAuthTokenResponse>;

  // Account Methods
  getAccountInfo(): Promise<SocialAccountInfo>;

  // Board Methods
  getBoards(): Promise<PinterestBoard[]>;
  createBoard(
    name: string,
    description?: string,
    privacy?: "public" | "protected",
  ): Promise<PinterestBoard>;
  updateBoard(boardId: string, updates: Partial<PinterestBoard>): Promise<PinterestBoard>;
  deleteBoard(boardId: string): Promise<void>;

  // Pin Methods (ISocialClient interface)
  createPost(content: string, options?: PostOptions): Promise<PostResult>;
  getPosts(limit?: number): Promise<SocialPost[]>;
  deletePost(postId: string): Promise<void>;

  // Rich Pin Methods (Pinterest-specific)
  createRichPin(pinData: RichPinData): Promise<PostResult>;

  // Analytics Methods
  getMetrics(): Promise<SocialMetricsData>;
  getPinAnalytics(pinId: string): Promise<PinAnalytics>;
}
```

**Key API Endpoints:**

- `GET /v5/user_account` - Get user profile
- `GET /v5/boards` - List boards
- `POST /v5/boards` - Create board
- `PATCH /v5/boards/{board_id}` - Update board
- `DELETE /v5/boards/{board_id}` - Delete board
- `POST /v5/pins` - Create pin
- `GET /v5/pins` - List pins
- `DELETE /v5/pins/{pin_id}` - Delete pin
- `GET /v5/pins/{pin_id}/analytics` - Get pin analytics

**OAuth Flow:**

1. Generate authorization URL with scopes
2. User authorizes on Pinterest
3. Exchange authorization code for access token + refresh token
4. Refresh tokens expire after 1 year
5. Access tokens are valid for unspecified duration (use refresh token)

**Image Upload Strategy:**

Pinterest requires publicly accessible image URLs for pin creation. Two approaches:

1. **Direct URL:** If user provides image URL, pass directly to Pinterest API
2. **Upload First:** Upload image to Spike Land's storage, generate public URL, then create pin

**Recommended:** Support both approaches. Use `mediaUrls` from `PostOptions` for direct URLs.

**Rich Pins Implementation:**

Rich Pins require metadata markup. Support these types:

- Product Pins (price, availability, brand)
- Recipe Pins (ingredients, cook time, servings)
- Article Pins (headline, author, description)

Store rich pin metadata in `PostOptions.metadata` field:

```typescript
options.metadata = {
  richPinType: "product",
  product: {
    price: "29.99",
    currency: "USD",
    availability: "in_stock",
  },
};
```

**Normalized Types:**

```typescript
// Map Pinterest response to SocialAccountInfo
{
  platformId: user.id,
  username: user.username,
  displayName: user.business_name || user.username,
  profileUrl: `https://pinterest.com/${user.username}`,
  avatarUrl: user.profile_image,
  followersCount: user.follower_count
}

// Map Pinterest pin to SocialPost
{
  id: pin.id,
  platformPostId: pin.id,
  platform: 'PINTEREST',
  content: pin.description || '',
  mediaUrls: [pin.media.images.original.url],
  publishedAt: new Date(pin.created_at),
  url: pin.link || `https://pinterest.com/pin/${pin.id}`,
  metrics: {
    likes: pin.save_count || 0,
    comments: pin.comment_count || 0,
    shares: 0, // Pinterest doesn't expose shares
    impressions: pin.impression_count,
    engagementRate: pin.engagement_rate
  }
}
```

**Caching Strategy:**

Per technical notes in issue #524: "Cache board lists to reduce API calls during pin scheduling"

Implement caching in the client:

```typescript
private boardsCache: { boards: PinterestBoard[], timestamp: number } | null = null;
private CACHE_TTL = 5 * 60 * 1000; // 5 minutes

async getBoards(forceRefresh = false): Promise<PinterestBoard[]> {
  if (!forceRefresh && this.boardsCache && Date.now() - this.boardsCache.timestamp < this.CACHE_TTL) {
    return this.boardsCache.boards;
  }

  const boards = await this.fetchBoardsFromAPI();
  this.boardsCache = { boards, timestamp: Date.now() };
  return boards;
}
```

**Error Handling:**

- Handle rate limits (HTTP 429) with exponential backoff
- Handle token expiration (HTTP 401) by triggering refresh
- Validate image aspect ratios (recommend 2:3 for standard pins per technical notes)

**Files to create:**

- `src/lib/social/clients/pinterest.ts` (~900 lines)
- `src/lib/social/clients/pinterest.test.ts` (~500 lines)

**Files to modify:**

- `src/lib/social/types.ts`
  - Add Pinterest-specific types (PinterestBoard, RichPinData, PinAnalytics)
  - Update PLATFORM_CAPABILITIES: `PINTEREST: { canLike: true, canReply: true, canShare: true }`
- `src/lib/social/index.ts`
  - Add Pinterest case to `createSocialClient()` switch (after line 55)
  - Add Pinterest case to `getSocialAuthUrl()` switch (after line 98)

---

### Phase 4: OAuth Routes

**Complexity:** Medium

**Files to create:**

- `src/app/api/social/pinterest/connect/route.ts`
- `src/app/api/social/pinterest/callback/route.ts`

#### Connect Route

**File:** `src/app/api/social/pinterest/connect/route.ts`

**Estimated size:** ~110 lines (similar to Facebook connect route)

**Flow:**

1. Validate user session
2. Require `workspaceId` and `workspaceSlug` query parameters
3. Check workspace permission (`social:connect`)
4. Generate CSRF nonce
5. Build state object with userId, workspaceId, workspaceSlug, timestamp, nonce
6. Get Pinterest OAuth URL from client
7. Set secure cookie with nonce
8. Redirect to Pinterest authorization

**State Structure:**

```typescript
{
  userId: session.user.id,
  workspaceId: string,
  workspaceSlug: string,
  timestamp: Date.now(),
  nonce: string (crypto.randomBytes(16).toString('hex'))
}
```

**Cookie:**

- Name: `pinterest_oauth_nonce`
- HttpOnly: true
- Secure: true (in production)
- SameSite: lax
- Max-Age: 600 (10 minutes)

**Reference Implementation:** `src/app/api/social/facebook/connect/route.ts`

#### Callback Route

**File:** `src/app/api/social/pinterest/callback/route.ts`

**Estimated size:** ~250 lines (similar to LinkedIn callback, simpler than Facebook)

**Flow:**

1. Validate user session
2. Extract code, state, error from query params
3. Handle OAuth errors
4. Decode and validate state
5. Verify user ID matches session
6. Verify timestamp (< 10 minutes)
7. Verify nonce from cookie
8. Exchange code for tokens using PinterestClient
9. Fetch user account info
10. Encrypt tokens
11. Upsert SocialAccount to database
12. Clear nonce cookie
13. Redirect to workspace settings with success/error message

**Database Operation:**

```typescript
await prisma.socialAccount.upsert({
  where: {
    workspaceId_platform_accountId: {
      workspaceId: stateData.workspaceId,
      platform: "PINTEREST",
      accountId: accountInfo.platformId,
    },
  },
  update: {
    accountName: accountInfo.displayName,
    accessTokenEncrypted: encryptedAccessToken,
    refreshTokenEncrypted: encryptedRefreshToken,
    tokenExpiresAt: tokens.expiresAt,
    metadata: {
      username: accountInfo.username,
      profileUrl: accountInfo.profileUrl,
      avatarUrl: accountInfo.avatarUrl,
      followersCount: accountInfo.followersCount,
    },
    status: "ACTIVE",
    updatedAt: new Date(),
  },
  create: {
    userId: session.user.id,
    workspaceId: stateData.workspaceId,
    platform: "PINTEREST",
    accountId: accountInfo.platformId,
    accountName: accountInfo.displayName,
    accessTokenEncrypted: encryptedAccessToken,
    refreshTokenEncrypted: encryptedRefreshToken,
    tokenExpiresAt: tokens.expiresAt,
    metadata: {/* same as update */},
    status: "ACTIVE",
  },
});
```

**Success Redirect:**

```
/orbit/{workspaceSlug}/settings/accounts?connected=pinterest&message=Pinterest%20account%20connected%20successfully
```

**Error Redirect:**

```
/orbit/{workspaceSlug}/settings/accounts?error={errorMessage}
```

**Reference Implementation:** `src/app/api/social/linkedin/callback/route.ts`

---

### Phase 5: UI Integration

**Complexity:** Low (existing UI components should auto-support)

**Files to check/modify:**

1. **Social Accounts Settings Page**
   - File: `src/app/orbit/[workspaceSlug]/settings/accounts/SocialAccountsClient.tsx`
   - Should automatically support Pinterest via platform enum
   - Verify Pinterest logo/icon is displayed correctly
   - May need to add Pinterest brand color

2. **Platform Capabilities**
   - File: `src/lib/social/types.ts` (lines ~520)
   - Update PLATFORM_CAPABILITIES to enable Pinterest interactions in Stream:

   ```typescript
   PINTEREST: {
     canLike: true,     // Users can save pins (Pinterest's "like")
     canReply: true,    // Users can comment on pins
     canShare: true,    // Users can share pins
   }
   ```

3. **Calendar/Scheduling**
   - File: `src/app/orbit/[workspaceSlug]/calendar/CalendarClient.tsx`
   - Should automatically support Pinterest for scheduled posts
   - Verify Pinterest appears in platform selection dropdown

4. **Stream Feed**
   - File: `src/components/streams/StreamFeed.tsx`
   - Should automatically show Pinterest posts in unified stream
   - Verify pin images display correctly

**Icon/Branding:**

Add Pinterest brand assets if not already present:

- Brand color: `#E60023` (Pinterest red)
- Logo SVG (if using custom icon components)

**No new components expected** - existing platform-agnostic UI should handle Pinterest automatically.

---

### Phase 6: Testing

**Complexity:** Medium

#### Unit Tests

**File:** `src/lib/social/clients/pinterest.test.ts`

**Test Coverage Requirements (100%):**

1. **OAuth Tests**
   - `getAuthUrl()` generates correct authorization URL with scopes
   - `exchangeCodeForTokens()` handles successful token exchange
   - `exchangeCodeForTokens()` handles API errors
   - `refreshAccessToken()` refreshes expired tokens

2. **Account Tests**
   - `getAccountInfo()` returns normalized account data
   - `getAccountInfo()` handles API errors

3. **Board Tests**
   - `getBoards()` returns list of boards
   - `getBoards()` uses cache on subsequent calls
   - `createBoard()` creates new board
   - `updateBoard()` updates board metadata
   - `deleteBoard()` removes board

4. **Pin Tests**
   - `createPost()` creates pin with image URL
   - `createPost()` handles missing image URL (error)
   - `createPost()` validates aspect ratio recommendation
   - `createRichPin()` creates product pin with metadata
   - `createRichPin()` creates recipe pin with metadata
   - `getPosts()` returns normalized pin list
   - `deletePost()` removes pin

5. **Analytics Tests**
   - `getMetrics()` returns account-level analytics
   - `getPinAnalytics()` returns pin-level analytics

6. **Error Handling Tests**
   - Rate limiting (429) triggers exponential backoff
   - Token expiration (401) is detected
   - Network errors are handled gracefully

**Mocking Strategy:**

Mock Pinterest API v5 responses using `vi.mock('fetch')` or test doubles.

#### Integration Tests

**Manual Testing Checklist:**

1. OAuth Flow
   - [ ] Navigate to `/orbit/{workspace}/settings/accounts`
   - [ ] Click "Connect Pinterest"
   - [ ] Authorize on Pinterest
   - [ ] Verify redirect back to settings
   - [ ] Verify account appears in connected accounts list

2. Pin Creation
   - [ ] Create new pin with image URL
   - [ ] Verify pin appears on Pinterest
   - [ ] Create pin with board selection
   - [ ] Create pin with rich metadata (product type)

3. Board Management
   - [ ] List existing boards
   - [ ] Create new board
   - [ ] Update board name/description
   - [ ] Delete board

4. Analytics
   - [ ] View account metrics
   - [ ] View pin-level analytics (impressions, saves, clicks)

5. Token Refresh
   - [ ] Manually expire token in database
   - [ ] Trigger API call
   - [ ] Verify automatic token refresh

#### E2E Tests (Optional)

If E2E coverage is desired:

**File:** `e2e/features/pinterest-integration.feature`

```gherkin
Feature: Pinterest Integration

  Scenario: Connect Pinterest account
    Given I am logged in to Orbit workspace
    When I navigate to social accounts settings
    And I click "Connect Pinterest"
    And I authorize on Pinterest
    Then I should see my Pinterest account connected

  Scenario: Create a pin
    Given I have a connected Pinterest account
    When I create a new pin with an image URL
    Then the pin should be published to Pinterest
    And I should see the pin in my stream
```

**Step Definitions:** `e2e/step-definitions/pinterest.steps.ts`

**Note:** E2E tests for OAuth require Pinterest test credentials or mock OAuth server.

---

### Phase 7: Documentation

**Complexity:** Simple

**Files to create/modify:**

1. **API Reference**
   - File: `docs/API_REFERENCE.md`
   - Add Pinterest OAuth endpoints documentation
   - Document Pinterest-specific parameters (boards, rich pins)

2. **README**
   - File: `README.md`
   - Add Pinterest to supported platforms list
   - Add Pinterest environment variables to setup instructions

3. **Environment Example**
   - File: `.env.example`
   - Document Pinterest credentials with comments

4. **Database Schema Docs**
   - File: `docs/DATABASE_SCHEMA.md`
   - Update SocialPlatform enum documentation

**Example Documentation Snippet:**

```markdown
## Pinterest Integration

### OAuth Setup

1. Create Pinterest App at https://developers.pinterest.com/apps/
2. Configure redirect URI: `https://spike.land/api/social/pinterest/callback`
3. Request scopes: `boards:read`, `boards:write`, `pins:read`, `pins:write`, `user_accounts:read`
4. Add credentials to `.env`:
```

PINTEREST_APP_ID=your-app-id
PINTEREST_APP_SECRET=your-app-secret
PINTEREST_CALLBACK_URL=https://spike.land/api/social/pinterest/callback

```
### Rich Pins

Pinterest supports rich metadata for enhanced pins:

- **Product Pins**: Include price, availability, brand
- **Recipe Pins**: Include ingredients, cook time, servings
- **Article Pins**: Include headline, author, description

Use the `metadata` field in `createPost()` options to specify rich pin data.

### Image Requirements

- **Aspect Ratio**: 2:3 recommended for standard pins
- **Format**: JPEG or PNG
- **Size**: At least 1000px wide
- **URL**: Must be publicly accessible
```

---

## File Summary

### Files to Create (8 files)

1. `src/lib/social/clients/pinterest.ts` (~900 lines)
2. `src/lib/social/clients/pinterest.test.ts` (~500 lines)
3. `src/app/api/social/pinterest/connect/route.ts` (~110 lines)
4. `src/app/api/social/pinterest/callback/route.ts` (~250 lines)

### Files to Modify (6 files)

1. `prisma/schema.prisma`
   - Add `PINTEREST` to `SocialPlatform` enum

2. `.env.example`
   - Add Pinterest environment variables

3. `src/lib/social/types.ts`
   - Add Pinterest-specific types (PinterestBoard, RichPinData, PinAnalytics)
   - Update PLATFORM_CAPABILITIES for Pinterest

4. `src/lib/social/index.ts`
   - Add Pinterest case to `createSocialClient()` switch
   - Add Pinterest case to `getSocialAuthUrl()` switch

5. `docs/API_REFERENCE.md`
   - Document Pinterest OAuth endpoints

6. `README.md`
   - Add Pinterest to supported platforms

### Database Migration

```bash
yarn prisma migrate dev --name add_pinterest_platform
yarn prisma generate
```

---

## Implementation Order

Recommended order to minimize blocking dependencies:

1. **Phase 1: Database Schema** (Prerequisite for all other work)
2. **Phase 2: Environment Variables** (Needed for client and routes)
3. **Phase 3: Pinterest Client** (Core functionality)
4. **Phase 4: OAuth Routes** (Depends on client)
5. **Phase 5: UI Integration** (Verify existing components work)
6. **Phase 6: Testing** (Validate all phases)
7. **Phase 7: Documentation** (Final step)

**Estimated Total Time:** 3-4 days for full implementation and testing

---

## Risks and Considerations

### Image Upload Strategy

**Risk:** Pinterest requires publicly accessible image URLs. If users upload images directly to Spike Land, we need a public storage solution.

**Mitigation:**

- Use existing image upload infrastructure (`src/app/api/images/upload/route.ts`)
- Ensure uploaded images are publicly accessible (check storage bucket permissions)
- Alternative: Require users to provide direct image URLs (simpler but less user-friendly)

### Rich Pins Metadata

**Risk:** Rich Pins require proper metadata markup on the linked website (Open Graph tags).

**Mitigation:**

- Document that rich pins work best when the linked URL has proper OG tags
- Provide validation warnings if rich metadata is incomplete
- Rich pins are optional - standard pins work without metadata

### Rate Limiting

**Risk:** Pinterest has strict rate limits (1000 requests/hour per user token).

**Mitigation:**

- Implement board caching (as specified in technical notes)
- Add rate limit error handling with user-friendly messages
- Consider implementing request queue for high-volume users

### Aspect Ratio Validation

**Risk:** Pinterest recommends 2:3 aspect ratio but doesn't enforce it strictly.

**Mitigation:**

- Add non-blocking validation warning in UI if image aspect ratio is not ideal
- Allow users to proceed with non-standard ratios
- Document recommended dimensions in error messages

### Token Refresh Flow

**Risk:** Pinterest refresh tokens expire after 1 year. Long-inactive accounts may need re-authentication.

**Mitigation:**

- Implement automatic token refresh on 401 errors
- Update `SocialAccount.status` to `EXPIRED` when refresh fails
- Show reconnect prompt in UI for expired accounts
- Consider background job to proactively refresh tokens before expiration

---

## Testing Strategy

### Unit Test Coverage: 100% Required

All new code in `src/lib/social/clients/pinterest.ts` must have 100% test coverage.

### Integration Testing

Manual testing required for:

- OAuth flow end-to-end
- Pin creation with various image types
- Board CRUD operations
- Analytics data fetching
- Token refresh after expiration

### E2E Testing (Optional)

E2E tests are optional but recommended for critical paths:

- Pinterest OAuth connection flow
- Pin creation and scheduling

---

## Success Criteria

Implementation is complete when:

- [ ] All acceptance criteria from issue #524 are met
- [ ] Pinterest client implements full ISocialClient interface
- [ ] OAuth flow works end-to-end (connect → authorize → callback → store)
- [ ] Pins can be created with image URLs, titles, descriptions
- [ ] Boards can be created, updated, deleted
- [ ] Analytics data is collected and displayed
- [ ] Rich Pins support for product, recipe, article types
- [ ] Unit tests achieve 100% coverage
- [ ] Manual testing passes all integration scenarios
- [ ] Documentation is complete and accurate
- [ ] Pinterest appears in UI alongside other platforms

---

## Dependencies

### External APIs

- Pinterest API v5 (https://developers.pinterest.com/docs/api/v5/)
- Pinterest OAuth 2.0

### Internal Dependencies

- Existing `ISocialClient` interface
- Token encryption utilities (`src/lib/crypto/token-encryption.ts`)
- Prisma client and database
- Workspace permission system

### Developer Account

- Pinterest Developer account required
- OAuth app must be created and configured

---

## Notes

- Pinterest uses standard OAuth 2.0 (no PKCE required like Twitter)
- Refresh tokens are long-lived (1 year) but should be refreshed proactively
- Board caching is important for UX during pin scheduling
- Image aspect ratio of 2:3 is recommended but not enforced
- Rich Pins require proper metadata on the linked website

---

## Complexity Estimate

**Overall:** Medium

**Breakdown:**

- Database schema: Simple (enum addition)
- Client implementation: Medium-High (900 lines, complex API)
- OAuth routes: Medium (standard pattern, 2 routes)
- UI integration: Low (auto-supported by existing UI)
- Testing: Medium (comprehensive unit tests required)
- Documentation: Simple (standard updates)

**Total Estimated Lines of Code:** ~1760 new lines + ~50 lines modified
