# Implementation Plan: ORB-063 - Organic-to-Ad Derivation

**Issue:** #567
**Epic:** #521 (Content-to-Ads Loop)
**Complexity:** Complex
**Estimated Files:** 25-30 new/modified files

---

## Summary

Build a system to convert high-performing organic social media posts into ad creatives. The system will preserve engagement proof (likes, comments, shares), provide AI-powered targeting suggestions based on engaged audience analysis, recommend budgets based on reach goals and historical performance, and adapt creatives for different ad placements and formats.

---

## Acceptance Criteria

✅ **One-click conversion** of organic post to ad creative format
✅ **Engagement proof preservation** showing original likes, comments, shares
✅ **AI-powered targeting suggestions** based on engaged audience analysis
✅ **Budget recommendations** based on reach goals and historical performance
✅ **Creative adaptation** for different ad placements and formats (story, feed, reels)

---

## Technical Architecture

### 1. Database Schema Extensions

**New Tables:**

- `organic_post_conversions` - Track conversion of organic posts to ads
- `organic_post_engagers` - Store engaged audience data for targeting
- `ad_creative_variants` - Store format-specific creative adaptations

**Modified Tables:**

- `social_posts` - Add fields for performance tracking and eligibility
- `social_metrics` - Enhance with engagement breakdown data

### 2. Core Components

**Backend Services:**

- Platform API integrations (Facebook, Instagram, Twitter/X, LinkedIn, TikTok)
- Engagement data fetcher service
- Audience analysis engine (AI-powered)
- Creative adaptation service
- Budget recommendation engine

**Frontend Components:**

- Organic post selection interface
- Conversion wizard UI
- Creative preview & editor
- Targeting configuration panel
- Budget recommendation display

---

## Implementation Steps

### Phase 1: Database Schema & Types

#### Files to Create:

1. `prisma/migrations/YYYYMMDD_add_organic_to_ad_tables.sql`
   - Add `organic_post_conversions` table
   - Add `organic_post_engagers` table
   - Add `ad_creative_variants` table
   - Add indexes for performance queries

2. `src/lib/types/organic-to-ad.ts`
   - Define TypeScript types for organic-to-ad conversion
   - Platform-specific engagement data types
   - Creative variant types
   - Targeting suggestion types

#### Files to Modify:

3. `prisma/schema.prisma`
   - Add new models: `OrganicPostConversion`, `OrganicPostEngager`, `AdCreativeVariant`
   - Add relations to existing `SocialPost`, `SocialAccount` models
   - Add performance tracking fields to `SocialPost`

4. `packages/shared/src/types/index.ts`
   - Export new shared types for organic-to-ad features

### Phase 2: Platform API Integration

#### Files to Create:

5. `src/lib/social/platform-api/facebook/engagement-fetcher.ts`
   - Fetch Facebook/Instagram post engagement details
   - Extract engager demographics and interests
   - Handle pagination and rate limiting

6. `src/lib/social/platform-api/twitter/engagement-fetcher.ts`
   - Fetch Twitter/X engagement data
   - Extract audience insights from engagers

7. `src/lib/social/platform-api/linkedin/engagement-fetcher.ts`
   - Fetch LinkedIn post analytics
   - Extract professional audience demographics

8. `src/lib/social/platform-api/tiktok/engagement-fetcher.ts`
   - Fetch TikTok video analytics
   - Extract viewer demographics and interests

9. `src/lib/social/platform-api/engagement-fetcher-factory.ts`
   - Factory pattern to select appropriate fetcher
   - Unified interface for all platforms

#### Files to Modify:

10. `src/lib/social/platform-api/types.ts`
    - Add engagement data response types
    - Add audience insight types

### Phase 3: AI-Powered Audience Analysis

#### Files to Create:

11. `src/lib/ai/audience-analyzer.ts`
    - Analyze engager data to create lookalike audiences
    - Generate targeting suggestions (demographics, interests, behaviors)
    - Score targeting confidence levels

12. `src/lib/ai/audience-analyzer.test.ts`
    - Unit tests for audience analysis logic

13. `src/lib/ai/prompts/audience-analysis.ts`
    - AI prompts for audience insights
    - Templates for targeting recommendations

### Phase 4: Creative Adaptation Engine

#### Files to Create:

14. `src/lib/creative/format-adapter.ts`
    - Adapt content for different ad formats
    - Handle aspect ratio transformations
    - Generate format-specific copy variations

15. `src/lib/creative/format-adapter.test.ts`
    - Tests for format adaptation logic

16. `src/lib/creative/placement-optimizer.ts`
    - Optimize creative for specific placements (feed, story, reels)
    - Platform-specific best practices
    - Copy length and CTA optimization

17. `src/lib/creative/placement-optimizer.test.ts`
    - Tests for placement optimization

### Phase 5: Budget Recommendation Engine

#### Files to Create:

18. `src/lib/budget/organic-performance-analyzer.ts`
    - Analyze organic post performance metrics
    - Correlate engagement with potential paid reach
    - Calculate historical cost-per-engagement

19. `src/lib/budget/organic-performance-analyzer.test.ts`
    - Tests for performance analysis

20. `src/lib/budget/ad-budget-recommender.ts`
    - Generate budget recommendations based on goals
    - Calculate expected reach and engagement
    - Integrate with existing allocator logic

21. `src/lib/budget/ad-budget-recommender.test.ts`
    - Tests for budget recommendations

### Phase 6: Backend API Routes

#### Files to Create:

22. `src/app/api/organic-to-ad/fetch-engagement/route.ts`
    - API endpoint to fetch engagement data for a post
    - POST: `{ postId: string, platform: string }`
    - Returns engagement breakdown and engager insights

23. `src/app/api/organic-to-ad/analyze-audience/route.ts`
    - API endpoint to analyze engagers and generate targeting
    - POST: `{ postId: string, engagementData: object }`
    - Returns targeting suggestions with confidence scores

24. `src/app/api/organic-to-ad/adapt-creative/route.ts`
    - API endpoint to generate format-specific creatives
    - POST: `{ postId: string, formats: string[] }`
    - Returns adapted creatives for each format

25. `src/app/api/organic-to-ad/recommend-budget/route.ts`
    - API endpoint for budget recommendations
    - POST: `{ postId: string, reachGoal: number, targetingData: object }`
    - Returns budget suggestions with projected outcomes

26. `src/app/api/organic-to-ad/convert/route.ts`
    - API endpoint to execute the full conversion
    - POST: Complete conversion payload
    - Creates ad campaign in platform API
    - Returns campaign details and tracking data

### Phase 7: Frontend Components

#### Files to Create:

27. `src/components/organic-to-ad/PostSelector.tsx`
    - UI to browse and select organic posts
    - Filter by performance metrics
    - Display eligibility indicators

28. `src/components/organic-to-ad/PostSelector.test.tsx`
    - Component tests

29. `src/components/organic-to-ad/EngagementProofCard.tsx`
    - Display engagement metrics with visual proof
    - Show likes, comments, shares breakdown
    - Animated counters for impact

30. `src/components/organic-to-ad/EngagementProofCard.test.tsx`
    - Component tests

31. `src/components/organic-to-ad/TargetingSuggestions.tsx`
    - Display AI-generated targeting recommendations
    - Interactive refinement controls
    - Audience size estimates

32. `src/components/organic-to-ad/TargetingSuggestions.test.tsx`
    - Component tests

33. `src/components/organic-to-ad/CreativeVariantPreview.tsx`
    - Preview adapted creatives side-by-side
    - Format-specific mockups (feed, story, reels)
    - Edit and refine controls

34. `src/components/organic-to-ad/CreativeVariantPreview.test.tsx`
    - Component tests

35. `src/components/organic-to-ad/BudgetRecommendations.tsx`
    - Display budget suggestions with projections
    - Slider to adjust budget
    - Real-time reach and engagement estimates

36. `src/components/organic-to-ad/BudgetRecommendations.test.tsx`
    - Component tests

37. `src/components/organic-to-ad/ConversionWizard.tsx`
    - Multi-step wizard for conversion flow
    - Step 1: Select post
    - Step 2: Review engagement proof
    - Step 3: Configure targeting
    - Step 4: Adapt creatives
    - Step 5: Set budget
    - Step 6: Confirm and launch

38. `src/components/organic-to-ad/ConversionWizard.test.tsx`
    - Component tests

#### Files to Modify:

39. `src/app/admin/social-media/posts/page.tsx`
    - Add "Convert to Ad" button for eligible posts
    - Display conversion history
    - Link to conversion wizard

40. `src/components/admin/social-media/SocialMediaLayout.tsx`
    - Add "Organic-to-Ad" navigation tab

### Phase 8: Integration with Existing Systems

#### Files to Modify:

41. `src/lib/allocator/allocator-types.ts`
    - Add types for organic-derived campaigns

42. `src/lib/allocator/allocator-service.ts`
    - Integrate organic-to-ad campaigns into budget allocation
    - Track performance of organic-derived ads separately

43. `src/lib/allocator/facebook-ads/campaign-sync.ts`
    - Sync organic-to-ad campaigns with Facebook Ads API
    - Maintain linkage to original organic post

44. `src/lib/allocator/google-ads/campaign-sync.ts`
    - Sync organic-to-ad campaigns with Google Ads API (for YouTube)

### Phase 9: Analytics & Reporting

#### Files to Create:

45. `src/components/organic-to-ad/ConversionAnalytics.tsx`
    - Dashboard showing organic vs. paid performance
    - ROI analysis for converted posts
    - Attribution tracking

46. `src/components/organic-to-ad/ConversionAnalytics.test.tsx`
    - Component tests

47. `src/app/admin/social-media/conversions/page.tsx`
    - Dedicated page for organic-to-ad analytics
    - List of all conversions with performance data
    - Filters and sorting

### Phase 10: E2E Tests

#### Files to Create:

48. `e2e/features/organic-to-ad-conversion.feature`
    - Cucumber scenarios for the full conversion flow
    - Test one-click conversion
    - Test engagement proof display
    - Test targeting suggestions
    - Test creative adaptation
    - Test budget recommendations

49. `e2e/step-definitions/organic-to-ad-conversion.steps.ts`
    - Playwright step definitions

---

## Data Flow

```
1. User selects high-performing organic post
   ↓
2. System fetches engagement data via Platform API
   ↓
3. AI analyzes engagers → generates targeting suggestions
   ↓
4. System adapts creative for different formats/placements
   ↓
5. Budget engine recommends spend based on goals + historical data
   ↓
6. User reviews and confirms
   ↓
7. System creates ad campaign via Platform Ads API
   ↓
8. Campaign tracked with link to original organic post
```

---

## Dependencies

### External APIs Required:

- **Facebook Graph API** - Access to post insights, engager data, ad creation
- **Instagram Graph API** - Post insights and ad creation
- **Twitter/X API** - Tweet analytics and ad API
- **LinkedIn Marketing API** - Post analytics and campaign creation
- **TikTok for Business API** - Video analytics and ad creation

### Internal Dependencies:

- Existing `allocator` budget management system
- Existing `social_posts` and `social_accounts` infrastructure
- AI services (Gemini for audience analysis)
- Admin authentication and authorization

---

## Testing Strategy

### Unit Tests:

- All service layers (fetchers, analyzers, adapters, recommenders)
- Utility functions for data transformations
- Type validations

### Integration Tests:

- API routes with mocked platform APIs
- Database operations for new tables
- AI integration with Gemini

### Component Tests:

- All React components with user interactions
- Form validations and state management

### E2E Tests:

- Complete conversion workflow
- Edge cases (missing data, API failures)
- Multi-platform conversions

**Coverage Target:** 100% (as per project requirements)

---

## Security Considerations

1. **API Key Management:**
   - Secure storage of platform API credentials
   - Use environment variables and secrets management
   - Implement token refresh mechanisms

2. **Data Privacy:**
   - Engager data must be anonymized and aggregated
   - Comply with platform terms of service
   - No PII storage from engaged audiences

3. **Authorization:**
   - Only workspace admins can convert posts to ads
   - Verify ownership of social accounts
   - Rate limiting on conversion endpoints

4. **Budget Limits:**
   - Enforce workspace-level spending limits
   - Require approval for budgets above threshold
   - Integration with existing guardrail system

---

## Performance Considerations

1. **API Rate Limiting:**
   - Implement exponential backoff for platform APIs
   - Queue engagement fetching for bulk operations
   - Cache engagement data (TTL: 24 hours)

2. **Database Optimization:**
   - Index `organic_post_conversions` by `postId` and `createdAt`
   - Index `organic_post_engagers` by `postId` and `platform`
   - Partition large tables if needed

3. **Frontend Performance:**
   - Lazy load conversion wizard steps
   - Progressive image loading for creative previews
   - Debounce budget slider calculations

---

## Risks & Mitigations

### Risk 1: Platform API Limitations

**Impact:** High
**Mitigation:**

- Build platform-agnostic abstraction layer
- Graceful degradation when data unavailable
- Manual targeting option as fallback

### Risk 2: AI Targeting Accuracy

**Impact:** Medium
**Mitigation:**

- Provide confidence scores with suggestions
- Allow manual override and refinement
- A/B test AI suggestions vs. manual targeting

### Risk 3: Creative Adaptation Quality

**Impact:** Medium
**Mitigation:**

- Always show preview before launch
- Manual editing capability for all variants
- Platform-specific validation rules

### Risk 4: Budget Recommendation Accuracy

**Impact:** Medium
**Mitigation:**

- Conservative initial recommendations
- Learn from campaign performance over time
- User can adjust recommendations

---

## Rollout Strategy

### Phase 1: Internal Testing (Week 1-2)

- Deploy to staging environment
- Test with Spike Land's own social accounts
- Validate all platform integrations

### Phase 2: Beta Release (Week 3-4)

- Enable for select workspace (feature flag)
- Collect feedback on accuracy and usability
- Monitor API usage and costs

### Phase 3: General Availability (Week 5+)

- Roll out to all workspaces
- Announce feature in release notes
- Monitor adoption and performance

---

## Future Enhancements (Out of Scope for ORB-063)

- Automated identification of high-performers (ORB-062 Boost Detector)
- Feedback loop analytics (ORB-064)
- A/B testing organic vs. paid variants
- Multi-platform campaign coordination
- Automated creative generation with AI
- Dynamic budget reallocation based on performance

---

## Documentation Requirements

1. **User Docs:**
   - How to convert organic posts to ads
   - Understanding targeting suggestions
   - Budget recommendation interpretation
   - Best practices for creative adaptation

2. **Developer Docs:**
   - Platform API integration guide
   - Adding support for new platforms
   - Audience analyzer algorithm details
   - Budget recommendation formula

3. **API Docs:**
   - OpenAPI specs for new endpoints
   - Request/response examples
   - Error codes and handling

---

## Estimated Complexity Breakdown

- **Database & Schema:** Medium (5% of effort)
- **Platform API Integration:** High (25% of effort)
- **AI Audience Analysis:** High (20% of effort)
- **Creative Adaptation:** Medium (15% of effort)
- **Budget Recommendations:** Medium (10% of effort)
- **Frontend Components:** High (20% of effort)
- **Testing:** High (5% of effort)

**Total Estimated Files:** 49 files (25 new, 24 tests/modifications)

---

## Success Metrics

- [ ] 100% test coverage achieved
- [ ] All platform integrations functional
- [ ] Targeting suggestions >70% accuracy
- [ ] Creative adaptations pass platform validation
- [ ] Budget recommendations within ±20% of actual performance
- [ ] User completes conversion in <5 minutes
- [ ] No critical security vulnerabilities

---

## Notes

- This feature builds on existing infrastructure (allocator, social media management)
- Requires platform API access tokens from users
- AI targeting uses Gemini; consider OpenAI as alternative
- Budget recommendations leverage existing allocator logic
- Creative adaptation may require additional image processing libraries
- Consider rate limiting and cost controls for AI API usage

---

**Plan Created:** 2026-01-29
**Created By:** Ralph Wiggum Planning Agent
