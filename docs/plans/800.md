# Implementation Plan: Issue #800

## Tech Stabilization Sprint 2: Scout/Inbox Test Coverage

**Status:** Investigation Complete - Ticket May Need Revision
**Issue:** #800
**Related:** #790
**Complexity:** Simple (Investigation) → Medium (if gaps exist)

---

## Executive Summary

Issue #800 requests creation of test files for Scout and Inbox modules. However, **investigation reveals that all requested test files already exist** with comprehensive coverage. This plan documents findings and recommends next steps.

---

## Current State Analysis

### Scout Module Coverage (11 tests / 13 source files)

**Existing Test Files:**

- ✅ `competitor-analyzer.test.ts` (485 lines, comprehensive)
- ✅ `competitor-tracker.test.ts` (624 lines, comprehensive)
- ✅ `topic-config.test.ts` (501 lines, comprehensive)
- ✅ `public-api-clients/twitter.test.ts`
- ✅ `public-api-clients/facebook.test.ts`
- ✅ `public-api-clients/instagram.test.ts`
- ✅ `suggestion-manager.test.ts`
- ✅ `search-providers/twitter.test.ts`
- ✅ `workspace-metrics.test.ts`
- ✅ `topic-monitor.test.ts`
- ✅ `suggestion-generator.test.ts`

**Test Quality Observations:**

- All tests use proper Vitest + Prisma mocking patterns
- Tests cover happy paths, error handling, and edge cases
- Comprehensive coverage of public APIs
- Tests follow existing patterns in the codebase

### Inbox Module Coverage (6 tests / 10 source files)

**Existing Test Files:**

- ✅ `collectors/facebook-collector.test.ts` (495 lines)
- ✅ `collectors/instagram-collector.test.ts` (653 lines)
- ✅ `collectors/twitter-collector.test.ts` (462 lines)
- ✅ `collection-job.test.ts`
- ✅ `base-collector.test.ts`
- ✅ `inbox-manager.test.ts`

**Missing Test Files:**

- ❌ `collectors/index.test.ts` (may be export-only file)
- ❌ `types.test.ts` (type-only file, no tests needed)
- ❌ `index.test.ts` (may be export-only file)
- ❌ `collector-types.test.ts` (type-only file, no tests needed)

---

## Investigation: Why Issue #800 Exists

The issue description states:

- "Scout (16 files, 3 tests)"
- "Inbox (13 files, 3 tests)"

**Actual counts:**

- Scout: 13 source files, 11 test files
- Inbox: 10 source files, 6 test files

**Hypothesis:** The issue was created based on an earlier snapshot of the codebase. Issue #790 (created 2026-01-19) likely triggered the creation of these tests, and issue #800 (created 2026-01-20) may have been filed before those tests were completed.

---

## Recommended Actions

### Option A: Verify and Close (Recommended)

**Steps:**

1. Run targeted coverage analysis:
   ```bash
   yarn test:coverage --coverage.include='src/lib/scout/**' --coverage.include='src/lib/inbox/**'
   ```

2. Review coverage report to identify any actual gaps in:
   - Line coverage
   - Branch coverage
   - Function coverage

3. If coverage ≥ 95%:
   - Document findings in issue comment
   - Close #800 as already complete
   - Update #790 if still open

4. If coverage < 95%:
   - Proceed to Option B

### Option B: Fill Remaining Gaps (If Needed)

**Only if coverage analysis reveals specific gaps:**

1. **Identify uncovered code:**
   - Review HTML coverage report in `coverage/` directory
   - List specific functions/branches lacking coverage

2. **Enhance existing tests:**
   - Add test cases for uncovered branches
   - Cover edge cases in existing test files
   - Focus on error paths and boundary conditions

3. **Add tests for utility files:**
   - Only if `types.ts`, `index.ts`, or `collector-types.ts` contain testable logic
   - Skip type-only and export-only files

---

## Files to Investigate

### Scout Module

- `src/lib/scout/index.ts` - Check if export-only
- `src/lib/scout/types.ts` - Check if type-only

### Inbox Module

- `src/lib/inbox/index.ts` - Check if export-only
- `src/lib/inbox/types.ts` - Check if type-only
- `src/lib/inbox/collector-types.ts` - Check if type-only
- `src/lib/inbox/collectors/index.ts` - Check if export-only

---

## Verification Steps

### 1. Run Coverage Analysis

```bash
yarn test:coverage --coverage.include='src/lib/scout/**' --coverage.include='src/lib/inbox/**'
```

### 2. Review Coverage Report

```bash
open coverage/index.html
```

### 3. Check for Failing Tests

```bash
yarn test src/lib/scout src/lib/inbox
```

### 4. Verify Test Quality

- Ensure all tests use proper mocking (Prisma, external APIs)
- Check for proper error handling tests
- Validate edge case coverage

---

## Success Criteria

**For Ticket Closure:**

- [ ] Coverage report confirms ≥95% coverage for Scout module
- [ ] Coverage report confirms ≥95% coverage for Inbox module
- [ ] All existing tests pass
- [ ] No critical functionality is untested
- [ ] Issue comment documents findings

**For Further Work (if needed):**

- [ ] Identify specific uncovered lines/branches
- [ ] Create focused test cases for gaps
- [ ] Achieve 100% coverage for both modules
- [ ] All new tests follow existing patterns

---

## Risk Assessment

**Low Risk:** Investigation-only task with no code changes required if tests are complete.

**Potential Issues:**

1. **Coverage metrics may be misleading** - Some files may be type-only or export-only
2. **Test quality vs quantity** - High line coverage doesn't guarantee quality tests
3. **Integration gaps** - Unit tests may exist but integration scenarios untested

---

## Dependencies

- Vitest test runner
- Prisma mocking patterns
- Existing test infrastructure

---

## Estimated Effort

**Investigation:** 30 minutes
**Documentation:** 15 minutes
**If gaps found:** 2-4 hours additional work

---

## Notes for Implementation

### Test Pattern Reference

All tests follow this structure:

```typescript
// Mock Prisma
vi.mock("@/lib/prisma", () => ({
  default: {
    modelName: {
      create: vi.fn(),
      findMany: vi.fn(),
      // ...
    },
  },
}));

// Import after mocks
import prisma from "@/lib/prisma";
import { functionToTest } from "./module";

describe("ModuleName", () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it("should test happy path", async () => {
    vi.mocked(prisma.modelName.create).mockResolvedValue(mockData);
    const result = await functionToTest(params);
    expect(result).toEqual(expected);
  });
});
```

### External Dependencies to Mock

- Prisma client (`@/lib/prisma`)
- Facebook Graph API
- Instagram Graph API
- Twitter API v2
- Any HTTP fetch calls

---

## Conclusion

**The requested test files already exist with comprehensive coverage.** This ticket should be verified through coverage analysis and potentially closed if coverage meets the 100% target. If gaps exist, they are likely small and can be filled with targeted test additions rather than creating entirely new test files.

**Recommended Next Action:** Run coverage analysis and document actual coverage percentage in issue comment.
