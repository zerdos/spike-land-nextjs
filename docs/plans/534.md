# Implementation Plan: Client Collaboration Portal (#534)

**Issue:** #534 - [Story] ORB-056: Build client collaboration portal
**Epic:** #519 (Agency Features)
**Complexity:** Complex
**Estimated Files Changed:** 25-30
**Estimated New Files:** 15-20

---

## Summary

Build a dedicated client collaboration portal within the Orbit workspace system. This feature enables agencies to provide secure, limited-access views for their clients to review content, approve campaigns, leave feedback via threaded comments, and track activity - all without exposing internal agency operations.

**Key Differentiator:** This leverages the existing workspace permission system but adds a new `CLIENT` role with highly restricted permissions focused on review and approval workflows.

---

## Architecture Overview

### Core Components

1. **CLIENT Role Extension** - New workspace role below VIEWER with read-only + comment permissions
2. **Content Approval Workflows** - Multi-stage approval system for drafts and scheduled posts
3. **Threaded Comment System** - Nested comments with @mentions on content items
4. **Client Dashboard** - Curated metrics view hiding internal workspace data
5. **Activity Feed** - Real-time feed of content changes and feedback
6. **WebSocket Notifications** - Real-time updates for comments and approvals

---

## Database Schema Changes

### 1. Add CLIENT Role to WorkspaceRole Enum

**File:** `prisma/schema.prisma`

```prisma
enum WorkspaceRole {
  VIEWER
  MEMBER
  ADMIN
  OWNER
  CLIENT  // NEW: Limited read-only + comment permissions
}
```

**Migration Impact:** Existing role hierarchy (VIEWER:0, MEMBER:1, ADMIN:2, OWNER:3) becomes (CLIENT:0, VIEWER:1, MEMBER:2, ADMIN:3, OWNER:4)

### 2. Content Approval Workflow Tables

```prisma
/// Multi-stage approval workflow configuration
model ApprovalWorkflow {
  id          String   @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  name        String   // e.g., "Client Campaign Review"
  description String?
  isActive    Boolean  @default(true)

  stages      ApprovalStage[]  // Ordered stages
  items       ApprovalItem[]   // Content items in this workflow

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([workspaceId, isActive])
  @@map("approval_workflows")
}

/// Individual stages within an approval workflow
model ApprovalStage {
  id         String   @id @default(cuid())
  workflowId String
  workflow   ApprovalWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  name       String   // e.g., "Legal Review", "Client Approval"
  sequence   Int      // Order in workflow (1, 2, 3...)
  approvers  Json     // Array of userId strings who can approve this stage

  // Settings
  requireAllApprovers Boolean @default(false)  // True = unanimous, False = any one
  isOptional          Boolean @default(false)  // Can skip this stage

  approvals  StageApproval[]  // Approval records for this stage

  createdAt  DateTime @default(now())

  @@unique([workflowId, sequence])
  @@index([workflowId])
  @@map("approval_stages")
}

/// Content items submitted for approval
model ApprovalItem {
  id          String   @id @default(cuid())
  workflowId  String
  workflow    ApprovalWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  // Link to content
  contentType String   // "draft", "scheduled_post", "asset"
  contentId   String   // ID of the draft/post/asset

  // Status
  status         ApprovalStatus @default(PENDING)
  currentStage   Int?           // Current stage sequence number
  submittedById  String
  submittedBy    User           @relation("SubmittedApprovals", fields: [submittedById], references: [id])

  submittedAt DateTime @default(now())
  completedAt DateTime?

  stageApprovals StageApproval[]
  comments       ContentComment[] @relation("ApprovalComments")

  @@index([workflowId, status])
  @@index([contentType, contentId])
  @@map("approval_items")
}

/// Individual approval decisions for a stage
model StageApproval {
  id        String   @id @default(cuid())
  itemId    String
  item      ApprovalItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  stageId   String
  stage     ApprovalStage @relation(fields: [stageId], references: [id], onDelete: Cascade)

  approverId String
  approver   User   @relation("StageApprovals", fields: [approverId], references: [id])

  decision   ApprovalDecision
  note       String?  @db.Text
  decidedAt  DateTime @default(now())

  @@unique([itemId, stageId, approverId])
  @@index([itemId])
  @@index([stageId])
  @@map("stage_approvals")
}

enum ApprovalStatus {
  PENDING       // Awaiting approval
  IN_REVIEW     // Currently being reviewed
  APPROVED      // All stages approved
  REJECTED      // Rejected at some stage
  CHANGES_REQUESTED  // Feedback provided, needs revision
}

enum ApprovalDecision {
  APPROVE
  REJECT
  REQUEST_CHANGES
}
```

### 3. Threaded Comment System

```prisma
/// Comments on content items (drafts, posts, assets)
model ContentComment {
  id        String   @id @default(cuid())

  // Content linkage
  contentType String  // "draft", "post", "asset", "approval_item"
  contentId   String  // ID of the content

  // Thread structure
  parentId    String?
  parent      ContentComment?  @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies     ContentComment[] @relation("CommentThread")

  // Comment data
  authorId    String
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  content     String   @db.Text

  // Mentions
  mentions    Json?    // Array of userId strings mentioned with @

  // Status
  isEdited    Boolean  @default(false)
  editedAt    DateTime?
  isDeleted   Boolean  @default(false)
  deletedAt   DateTime?

  // Approval workflow link (optional)
  approvalItemId String?
  approvalItem   ApprovalItem? @relation("ApprovalComments", fields: [approvalItemId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([contentType, contentId])
  @@index([authorId])
  @@index([parentId])
  @@index([approvalItemId])
  @@map("content_comments")
}
```

### 4. Client Activity Feed

```prisma
/// Activity feed for client-visible events
model ClientActivity {
  id          String   @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Activity details
  type        ClientActivityType
  actorId     String?  // User who triggered the activity
  actor       User?    @relation(fields: [actorId], references: [id], onDelete: SetNull)

  // Target entity
  targetType  String   // "draft", "post", "comment", "approval"
  targetId    String

  // Activity data
  title       String
  description String?  @db.Text
  metadata    Json?    // Additional activity context

  // Visibility
  isVisibleToClients Boolean @default(true)

  createdAt   DateTime @default(now())

  @@index([workspaceId, createdAt(sort: Desc)])
  @@index([workspaceId, isVisibleToClients, createdAt(sort: Desc)])
  @@index([targetType, targetId])
  @@map("client_activities")
}

enum ClientActivityType {
  CONTENT_SUBMITTED      // Content submitted for review
  CONTENT_APPROVED       // Content approved
  CONTENT_REJECTED       // Content rejected
  COMMENT_ADDED          // New comment added
  COMMENT_MENTION        // User mentioned in comment
  STAGE_COMPLETED        // Approval stage completed
  WORKFLOW_COMPLETED     // Full workflow completed
  STATUS_CHANGED         // Content status changed
}
```

---

## Permission System Updates

### File: `src/lib/permissions/permissions.ts`

**Add CLIENT role to hierarchy:**

```typescript
const ROLE_HIERARCHY: Record<WorkspaceRole, number> = {
  CLIENT: 0, // NEW: Lowest permissions
  VIEWER: 1,
  MEMBER: 2,
  ADMIN: 3,
  OWNER: 4,
};
```

**Add new client-specific actions:**

```typescript
export type WorkspaceAction =
  // ... existing actions ...

  // Client collaboration (NEW)
  | "client:dashboard:view"
  | "client:content:view"
  | "client:content:comment"
  | "client:approval:view"
  | "client:approval:approve"
  | "client:approval:reject"
  | "client:activity:view";
```

**Update permission matrix:**

```typescript
const PERMISSION_MATRIX: Record<WorkspaceAction, WorkspaceRole> = {
  // ... existing permissions ...

  // Client collaboration
  "client:dashboard:view": "CLIENT",
  "client:content:view": "CLIENT",
  "client:content:comment": "CLIENT",
  "client:approval:view": "CLIENT",
  "client:approval:approve": "CLIENT",
  "client:approval:reject": "CLIENT",
  "client:activity:view": "CLIENT",

  // Restrict existing actions from CLIENT
  "workspace:settings:read": "VIEWER", // CLIENT cannot see settings
  "analytics:view": "VIEWER", // CLIENT cannot see full analytics
  "social:view": "VIEWER", // CLIENT cannot see social accounts
};
```

---

## API Routes (New)

### 1. Approval Workflows

**`src/app/api/orbit/[workspaceSlug]/approvals/workflows/route.ts`**

- `GET` - List workflows for workspace
- `POST` - Create new workflow (ADMIN+)

**`src/app/api/orbit/[workspaceSlug]/approvals/workflows/[id]/route.ts`**

- `GET` - Get workflow details
- `PATCH` - Update workflow (ADMIN+)
- `DELETE` - Delete workflow (ADMIN+)

**`src/app/api/orbit/[workspaceSlug]/approvals/workflows/[id]/stages/route.ts`**

- `POST` - Add stage to workflow (ADMIN+)

### 2. Approval Items

**`src/app/api/orbit/[workspaceSlug]/approvals/items/route.ts`**

- `GET` - List approval items (filtered by role)
- `POST` - Submit content for approval (MEMBER+)

**`src/app/api/orbit/[workspaceSlug]/approvals/items/[id]/route.ts`**

- `GET` - Get approval item details
- `PATCH` - Update approval status

**`src/app/api/orbit/[workspaceSlug]/approvals/items/[id]/approve/route.ts`**

- `POST` - Approve current stage (CLIENT+ if in approvers list)

**`src/app/api/orbit/[workspaceSlug]/approvals/items/[id]/reject/route.ts`**

- `POST` - Reject approval (CLIENT+ if in approvers list)

### 3. Comments

**`src/app/api/orbit/[workspaceSlug]/comments/route.ts`**

- `GET` - List comments (filtered by contentType/contentId)
- `POST` - Create comment (CLIENT+)

**`src/app/api/orbit/[workspaceSlug]/comments/[id]/route.ts`**

- `GET` - Get comment and thread
- `PATCH` - Edit comment (own comments only)
- `DELETE` - Delete comment (own comments or ADMIN+)

### 4. Client Dashboard

**`src/app/api/orbit/[workspaceSlug]/client/dashboard/route.ts`**

- `GET` - Get curated dashboard metrics (CLIENT+)

**`src/app/api/orbit/[workspaceSlug]/client/activity/route.ts`**

- `GET` - Get activity feed (CLIENT+)

### 5. WebSocket Notifications

**`src/app/api/orbit/[workspaceSlug]/notifications/stream/route.ts`**

- `GET` - SSE stream for real-time notifications (CLIENT+)

---

## Frontend Pages (New)

### 1. Client Portal Dashboard

**`src/app/orbit/[workspaceSlug]/client/page.tsx`**

- Client-specific dashboard with curated metrics
- Pending approvals list
- Recent activity feed
- Quick access to content needing review

### 2. Approval Workflow Management

**`src/app/orbit/[workspaceSlug]/approvals/workflows/page.tsx`**

- List all approval workflows (ADMIN+)
- Create/edit workflow configurations

**`src/app/orbit/[workspaceSlug]/approvals/workflows/[id]/page.tsx`**

- Workflow detail and stage configuration (ADMIN+)

### 3. Approval Items View

**`src/app/orbit/[workspaceSlug]/approvals/page.tsx`**

- List all approval items (MEMBER+)
- Filter by status, workflow, assigned to me

**`src/app/orbit/[workspaceSlug]/approvals/[id]/page.tsx`**

- Approval item detail with:
  - Content preview
  - Approval stages and status
  - Comments thread
  - Approve/Reject actions

### 4. Comments Interface

**Component:** `src/components/orbit/comments/CommentThread.tsx`

- Threaded comment display
- @mention autocomplete
- Reply functionality
- Real-time updates via WebSocket

**Component:** `src/components/orbit/comments/CommentComposer.tsx`

- Rich text editor
- @mention support
- File attachments (future)

---

## Files to Modify

### Database & Schema

1. ‚úèÔ∏è `prisma/schema.prisma`
   - Add `CLIENT` to `WorkspaceRole` enum
   - Add `ApprovalWorkflow`, `ApprovalStage`, `ApprovalItem`, `StageApproval` models
   - Add `ContentComment` model
   - Add `ClientActivity` model
   - Add `ClientActivityType`, `ApprovalStatus`, `ApprovalDecision` enums

### Permissions

2. ‚úèÔ∏è `src/lib/permissions/permissions.ts`
   - Update `ROLE_HIERARCHY` to include CLIENT (0)
   - Add client collaboration actions
   - Update permission matrix
   - Add `canApproveContent()` helper

3. ‚úèÔ∏è `src/lib/permissions/permissions.test.ts`
   - Add tests for CLIENT role permissions

### Audit Trail

4. ‚úèÔ∏è `src/lib/audit/audit-logger.ts` (if exists, or create new)
   - Helper functions for logging client actions
   - Auto-log approval decisions, comments, etc.

### Components (Existing to Modify)

5. ‚úèÔ∏è `src/components/orbit/workspace/WorkspaceSwitcher.tsx`
   - Update to show CLIENT-accessible workspaces

6. ‚úèÔ∏è `src/components/orbit/workspace/MemberList.tsx`
   - Display CLIENT role members
   - Add invite CLIENT flow

7. ‚úèÔ∏è `src/app/orbit/[workspaceSlug]/layout.tsx`
   - Add client portal navigation for CLIENT role users
   - Hide internal menu items from CLIENT users

---

## Files to Create

### API Routes (11 new files)

8. üìÑ `src/app/api/orbit/[workspaceSlug]/approvals/workflows/route.ts`
9. üìÑ `src/app/api/orbit/[workspaceSlug]/approvals/workflows/[id]/route.ts`
10. üìÑ `src/app/api/orbit/[workspaceSlug]/approvals/workflows/[id]/stages/route.ts`
11. üìÑ `src/app/api/orbit/[workspaceSlug]/approvals/items/route.ts`
12. üìÑ `src/app/api/orbit/[workspaceSlug]/approvals/items/[id]/route.ts`
13. üìÑ `src/app/api/orbit/[workspaceSlug]/approvals/items/[id]/approve/route.ts`
14. üìÑ `src/app/api/orbit/[workspaceSlug]/approvals/items/[id]/reject/route.ts`
15. üìÑ `src/app/api/orbit/[workspaceSlug]/comments/route.ts`
16. üìÑ `src/app/api/orbit/[workspaceSlug]/comments/[id]/route.ts`
17. üìÑ `src/app/api/orbit/[workspaceSlug]/client/dashboard/route.ts`
18. üìÑ `src/app/api/orbit/[workspaceSlug]/client/activity/route.ts`

### Frontend Pages (5 new files)

19. üìÑ `src/app/orbit/[workspaceSlug]/client/page.tsx` - Client dashboard
20. üìÑ `src/app/orbit/[workspaceSlug]/approvals/page.tsx` - Approvals list
21. üìÑ `src/app/orbit/[workspaceSlug]/approvals/[id]/page.tsx` - Approval detail
22. üìÑ `src/app/orbit/[workspaceSlug]/approvals/workflows/page.tsx` - Workflows list
23. üìÑ `src/app/orbit/[workspaceSlug]/approvals/workflows/[id]/page.tsx` - Workflow detail

### Components (8 new files)

24. üìÑ `src/components/orbit/approvals/ApprovalWorkflowCard.tsx`
25. üìÑ `src/components/orbit/approvals/ApprovalItemCard.tsx`
26. üìÑ `src/components/orbit/approvals/ApprovalStageIndicator.tsx`
27. üìÑ `src/components/orbit/approvals/ApprovalActions.tsx`
28. üìÑ `src/components/orbit/comments/CommentThread.tsx`
29. üìÑ `src/components/orbit/comments/CommentComposer.tsx`
30. üìÑ `src/components/orbit/comments/MentionAutocomplete.tsx`
31. üìÑ `src/components/orbit/client/ClientActivityFeed.tsx`

### Utilities & Hooks (4 new files)

32. üìÑ `src/lib/approvals/approval-engine.ts` - Approval state machine logic
33. üìÑ `src/lib/approvals/approval-validator.ts` - Permission checks
34. üìÑ `src/hooks/use-approval-workflow.ts` - React hook for workflows
35. üìÑ `src/hooks/use-comments.ts` - React hook for comment threads

### WebSocket & Real-time (1 new file)

36. üìÑ `src/lib/realtime/client-notifications.ts` - SSE client for notifications

---

## Implementation Phases

### Phase 1: Database & Permissions (Week 1)

**Priority:** Foundation

- [ ] Add CLIENT role to schema
- [ ] Create approval workflow tables
- [ ] Create comment system tables
- [ ] Create activity feed tables
- [ ] Run migration
- [ ] Update permission system
- [ ] Add CLIENT role unit tests

### Phase 2: API Layer (Week 2)

**Priority:** Backend

- [ ] Implement approval workflow CRUD APIs
- [ ] Implement approval item APIs
- [ ] Implement comment thread APIs
- [ ] Implement client dashboard API
- [ ] Implement activity feed API
- [ ] Add comprehensive integration tests

### Phase 3: Core UI Components (Week 3)

**Priority:** Building Blocks

- [ ] Build CommentThread component
- [ ] Build CommentComposer with @mentions
- [ ] Build ApprovalStageIndicator
- [ ] Build ApprovalActions component
- [ ] Build ClientActivityFeed
- [ ] Unit tests for all components

### Phase 4: Client Portal (Week 4)

**Priority:** User-Facing

- [ ] Build client dashboard page
- [ ] Build approvals list page
- [ ] Build approval detail page
- [ ] Add client navigation to workspace layout
- [ ] E2E tests for client flows

### Phase 5: Admin Workflow Management (Week 5)

**Priority:** Configuration

- [ ] Build workflow list page
- [ ] Build workflow detail/config page
- [ ] Add workflow creation UI
- [ ] Add stage management UI
- [ ] E2E tests for admin flows

### Phase 6: WebSocket & Real-time (Week 6)

**Priority:** Polish

- [ ] Implement SSE notification stream
- [ ] Add real-time comment updates
- [ ] Add real-time approval status updates
- [ ] Test concurrent user scenarios
- [ ] Performance optimization

---

## Testing Strategy

### Unit Tests

- Permission checks for CLIENT role
- Approval state machine logic
- Comment threading logic
- Activity feed filtering

### Integration Tests

- Approval workflow creation and execution
- Multi-stage approval scenarios
- Comment thread with @mentions
- Client dashboard data filtering

### E2E Tests (Playwright + Cucumber)

```gherkin
Feature: Client Collaboration Portal

  Scenario: Client approves content
    Given I am logged in as a CLIENT user
    And there is pending content for my approval
    When I navigate to the approvals page
    And I click on the first pending approval
    And I click "Approve"
    Then the content status should change to "Approved"
    And I should see a success notification
    And the activity feed should show my approval

  Scenario: Client adds comment with mention
    Given I am logged in as a CLIENT user
    And I am viewing an approval item
    When I type a comment with "@username feedback needed"
    And I click "Post Comment"
    Then the comment should appear in the thread
    And @username should receive a notification
```

### Security Tests

- Verify CLIENT cannot access internal workspace data
- Verify CLIENT cannot see hidden drafts
- Verify CLIENT cannot modify workflow configurations
- Verify CLIENT cannot see social account credentials
- Verify audit trail captures all client actions

---

## Potential Risks & Mitigations

### Risk 1: Permission Matrix Complexity

**Issue:** Adding CLIENT role shifts all existing role hierarchy indices
**Mitigation:**

- Comprehensive migration testing in staging environment
- Add backward compatibility checks
- Use role names (strings) in code, not indices

### Risk 2: WebSocket Scalability

**Issue:** Real-time notifications may not scale across multiple Vercel instances
**Mitigation:**

- Implement Redis Pub/Sub for cross-instance messaging (mentioned in MY_APPS_ARCHITECTURE.md)
- Use SSE with polling fallback
- Add connection pooling limits

### Risk 3: Data Isolation

**Issue:** CLIENT users must never see internal agency data
**Mitigation:**

- Implement row-level security (RLS) filters in all queries
- Add comprehensive permission checks in middleware
- Security audit of all API endpoints
- Automated tests for data leakage scenarios

### Risk 4: Audit Trail Performance

**Issue:** Logging every client action could impact database performance
**Mitigation:**

- Batch audit log inserts
- Use async queue for non-critical logs
- Add database indices for common audit queries
- Archive old logs after 90 days

---

## Open Questions

1. **Q:** Should CLIENT role users see draft content before it's submitted for approval?
   **A:** TBD - Propose "visibility" flag on drafts (internal_only vs. client_visible)

2. **Q:** Can multiple workflows run in parallel for the same content?
   **A:** TBD - Propose single workflow per content item, but allow workflow re-submission

3. **Q:** How should we handle approval delegation (CLIENT assigns to sub-client)?
   **A:** Out of scope for MVP - can be added in future iteration

4. **Q:** Should comments support file attachments?
   **A:** Out of scope for MVP - text + @mentions only initially

5. **Q:** What metrics should CLIENT dashboard show?
   **A:** Propose: pending approvals count, recent activity (last 7 days), approved content count

---

## Success Metrics

### Functional Completeness

- [ ] CLIENT role can be assigned to workspace members
- [ ] Approval workflows can be created with multiple stages
- [ ] Content can be submitted and approved through workflow
- [ ] Comments with @mentions work on content items
- [ ] Client dashboard displays curated metrics
- [ ] Activity feed shows content changes and feedback
- [ ] Real-time notifications for comments and approvals

### Security & Compliance

- [ ] CLIENT cannot access internal workspace settings
- [ ] CLIENT cannot see social account credentials
- [ ] All client actions logged in audit trail
- [ ] Data isolation verified through security tests

### Performance

- [ ] Approval list loads < 500ms for 100 items
- [ ] Comment thread loads < 300ms for 50 comments
- [ ] WebSocket notifications delivered < 1s after trigger
- [ ] Dashboard metrics load < 1s

### Code Quality

- [ ] 100% unit test coverage for new code
- [ ] All E2E scenarios pass
- [ ] No TypeScript errors
- [ ] All linting rules pass

---

## Out of Scope (Future Iterations)

- File attachments in comments
- Approval delegation workflows
- Custom approval notification templates
- Mobile app support for client portal
- White-label client portal domains
- Advanced analytics for client performance
- Approval SLA tracking and reminders
- Multi-language support for client portal

---

**Document Version:** 1.0
**Created:** 2026-01-29
**Author:** Planning Agent (Ralph Wiggum)
**Status:** Ready for Review
