# Implementation Plan: ORB-061 - Creative Fatigue Detector

**Issue**: #554
**Epic**: #520 (Creative Factory)
**Complexity**: Medium-High
**Estimated Files**: 15-20 files (new + modified)

## Summary

Implement a creative fatigue detection system that monitors performance decay across marketing campaigns and creative assets. The system will track metrics over time, detect performance degradation patterns using rolling window analysis and anomaly detection, alert users when engagement drops below thresholds, and provide actionable recommendations for creative refresh timing.

## Architecture Overview

This feature builds on existing infrastructure:

- **Metrics Collection**: Extends `src/lib/social/metrics-collector.ts` and `src/lib/tracking/metrics-cache.ts`
- **Database**: New tables for creative performance tracking and fatigue analysis
- **Allocator Integration**: Leverages `src/lib/allocator/` patterns for performance analysis
- **Content Library**: Integrates with `src/app/orbit/[workspaceSlug]/content-library/` for asset management

## Database Schema Changes

### New Tables

#### 1. `CreativePerformanceMetrics`

Tracks performance metrics for individual creative assets over time.

```prisma
model CreativePerformanceMetrics {
  id                String    @id @default(cuid())
  workspaceId       String
  workspace         Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Asset identification
  assetId           String?   // Links to Asset model (content library)
  conversionId      String?   // Links to OrganicPostConversion for social posts
  campaignId        String?   // Links to AllocatorCampaign

  // Creative metadata
  creativeType      CreativeType // IMAGE, VIDEO, CAROUSEL, TEXT
  platform          SocialPlatform?
  adFormat          String?   // "feed", "story", "reel", "banner"

  // Performance metrics
  date              DateTime
  impressions       Int       @default(0)
  clicks            Int       @default(0)
  engagements       Int       @default(0) // likes + comments + shares
  conversions       Int       @default(0)
  spend             Decimal   @default(0) @db.Decimal(10, 2)

  // Calculated rates
  ctr               Decimal?  @db.Decimal(5, 4) // Click-through rate
  engagementRate    Decimal?  @db.Decimal(5, 4)
  conversionRate    Decimal?  @db.Decimal(5, 4)
  cpa               Decimal?  @db.Decimal(10, 2) // Cost per acquisition

  // Frequency data
  avgFrequency      Decimal?  @db.Decimal(8, 2) // Average times shown to same user

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([workspaceId, assetId, date])
  @@unique([workspaceId, conversionId, date])
  @@unique([workspaceId, campaignId, date])
  @@index([workspaceId, date])
  @@index([workspaceId, creativeType])
  @@index([platform])
  @@map("creative_performance_metrics")
}

enum CreativeType {
  IMAGE
  VIDEO
  CAROUSEL
  TEXT
  COLLECTION
}
```

#### 2. `CreativeFatigueAnalysis`

Stores fatigue detection results and recommendations.

```prisma
model CreativeFatigueAnalysis {
  id                    String    @id @default(cuid())
  workspaceId           String
  workspace             Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Creative identification
  assetId               String?
  conversionId          String?
  campaignId            String?
  creativeType          CreativeType

  // Analysis results
  fatigueScore          Decimal   @db.Decimal(5, 2) // 0-100 scale
  status                FatigueStatus
  trendDirection        TrendDirection

  // Performance metrics
  currentCtr            Decimal?  @db.Decimal(5, 4)
  baselineCtr           Decimal?  @db.Decimal(5, 4)
  ctrDecayPercent       Decimal?  @db.Decimal(5, 2)

  currentEngagementRate Decimal?  @db.Decimal(5, 4)
  baselineEngagementRate Decimal? @db.Decimal(5, 4)
  engagementDecayPercent Decimal? @db.Decimal(5, 2)

  // Time series analysis
  daysActive            Int
  peakPerformanceDate   DateTime?
  declineStartDate      DateTime?
  projectedRefreshDate  DateTime?

  // Recommendations
  recommendedAction     RefreshAction
  confidence            ConfidenceLevel
  reasoning             String    @db.Text

  // Analysis metadata
  analysisDate          DateTime  @default(now())
  windowDays            Int       @default(30)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([workspaceId, status])
  @@index([workspaceId, fatigueScore])
  @@index([workspaceId, analysisDate])
  @@map("creative_fatigue_analysis")
}

enum FatigueStatus {
  HEALTHY       // Fatigue score < 30
  WARNING       // Fatigue score 30-60
  FATIGUED      // Fatigue score 60-80
  CRITICAL      // Fatigue score > 80
}

enum TrendDirection {
  IMPROVING
  STABLE
  DECLINING
}

enum RefreshAction {
  CONTINUE      // Keep running, no action needed
  MONITOR       // Watch closely, may need refresh soon
  REFRESH       // Update creative elements (text, CTA, etc.)
  REPLACE       // Create new creative entirely
  PAUSE         // Temporarily pause and test alternatives
}

enum ConfidenceLevel {
  LOW
  MEDIUM
  HIGH
}
```

#### 3. `CreativeFatigueAlert`

Tracks alerts sent to users when fatigue is detected.

```prisma
model CreativeFatigueAlert {
  id              String    @id @default(cuid())
  workspaceId     String
  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  analysisId      String
  analysis        CreativeFatigueAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  severity        AlertSeverity // Reuse existing enum
  message         String    @db.Text

  // Alert delivery
  sentAt          DateTime  @default(now())
  channels        String[]  // ["EMAIL", "IN_APP", "SLACK"]

  // User interaction
  acknowledged    Boolean   @default(false)
  acknowledgedAt  DateTime?
  acknowledgedBy  String?

  createdAt       DateTime  @default(now())

  @@index([workspaceId, acknowledged])
  @@index([workspaceId, sentAt])
  @@map("creative_fatigue_alerts")
}
```

## Files to Create

### 1. Core Library Files

#### `/src/lib/creative-fatigue/types.ts`

TypeScript types and interfaces for the fatigue detection system.

```typescript
// Performance time series data point
export interface PerformanceDataPoint {
  date: Date;
  impressions: number;
  clicks: number;
  engagements: number;
  conversions: number;
  spend: number;
  ctr: number;
  engagementRate: number;
  conversionRate: number;
  avgFrequency: number;
}

// Anomaly detection result
export interface AnomalyDetectionResult {
  isAnomaly: boolean;
  severity: "low" | "medium" | "high";
  expectedValue: number;
  actualValue: number;
  deviationPercent: number;
  detectionMethod: "iqr" | "zscore" | "moving_average";
}

// Fatigue analysis configuration
export interface FatigueAnalysisConfig {
  workspaceId: string;
  targetIds: {
    assetId?: string;
    conversionId?: string;
    campaignId?: string;
  };
  windowDays: number; // Default: 30
  thresholds: {
    ctrDecayPercent: number; // Default: 20%
    engagementDecayPercent: number; // Default: 25%
    frequencyMax: number; // Default: 3.0
  };
}
```

#### `/src/lib/creative-fatigue/metrics-aggregator.ts`

Aggregates performance data from multiple sources into `CreativePerformanceMetrics`.

- Collects data from `AllocatorDailyMetrics` for campaigns
- Aggregates social post engagement from `OrganicPostConversion`
- Links asset performance from content library usage

#### `/src/lib/creative-fatigue/rolling-window-analyzer.ts`

Implements rolling window analysis for trend detection.

- Calculates moving averages (7-day, 14-day, 30-day)
- Detects performance slope using linear regression
- Identifies decline start dates

#### `/src/lib/creative-fatigue/anomaly-detector.ts`

Anomaly detection algorithms for sudden performance drops.

- Implements IQR (Interquartile Range) method
- Implements Z-score method
- Implements moving average deviation method
- Returns confidence scores for anomalies

#### `/src/lib/creative-fatigue/fatigue-scorer.ts`

Combines multiple signals into a single fatigue score (0-100).

**Scoring formula:**

```
fatigueScore = (
  ctrDecayWeight * ctrDecayPercent +
  engagementDecayWeight * engagementDecayPercent +
  frequencyWeight * normalizedFrequency +
  anomalyWeight * anomalyScore
)

Where:
- ctrDecayWeight = 0.35
- engagementDecayWeight = 0.30
- frequencyWeight = 0.20
- anomalyWeight = 0.15
```

#### `/src/lib/creative-fatigue/recommendation-engine.ts`

Generates recommendations based on fatigue analysis.

- Maps fatigue scores to `RefreshAction` types
- Calculates optimal refresh timing
- Provides reasoning and supporting data
- Considers creative type, platform, and historical patterns

#### `/src/lib/creative-fatigue/fatigue-service.ts`

Main service orchestrating fatigue detection workflow.

**Key methods:**

- `analyzeFatigue(config: FatigueAnalysisConfig): Promise<CreativeFatigueAnalysis>`
- `detectFatigueForWorkspace(workspaceId: string): Promise<CreativeFatigueAnalysis[]>`
- `getHistoricalPatterns(workspaceId: string, creativeType: CreativeType): Promise<HistoricalPattern>`

### 2. API Routes

#### `/src/app/api/orbit/creative-fatigue/analyze/route.ts`

POST endpoint to trigger fatigue analysis on-demand.

#### `/src/app/api/orbit/creative-fatigue/[workspaceId]/route.ts`

GET endpoint to retrieve all fatigue analyses for a workspace.

#### `/src/app/api/orbit/creative-fatigue/alerts/route.ts`

GET endpoint for retrieving alerts, PATCH for acknowledging.

### 3. UI Components

#### `/src/components/orbit/creative-fatigue/FatigueScoreCard.tsx`

Card component showing fatigue score with visual indicator (gauge/progress).

#### `/src/components/orbit/creative-fatigue/PerformanceDecayChart.tsx`

Line chart showing performance metrics over time with trend indicators.

- Uses Recharts library (already in project)
- Shows CTR, engagement rate, conversion rate
- Highlights baseline vs current
- Marks anomaly dates

#### `/src/components/orbit/creative-fatigue/FatigueRecommendationPanel.tsx`

Panel displaying recommendations with confidence levels.

#### `/src/components/orbit/creative-fatigue/FatigueAlertList.tsx`

List component for managing fatigue alerts.

#### `/src/components/orbit/creative-fatigue/HistoricalPatternsChart.tsx`

Bar chart showing typical creative lifespan by type.

### 4. Page Implementation

#### `/src/app/orbit/[workspaceSlug]/creative-fatigue/page.tsx`

Main fatigue detector dashboard page.

**Layout sections:**

1. **Summary Cards**: Total creatives monitored, avg fatigue score, alerts count
2. **Filters**: By creative type, platform, status
3. **Creative List**: Table/grid of creatives with fatigue scores
4. **Detail View**: Selected creative's performance decay chart + recommendations

### 5. Cron Job Integration

#### `/src/app/api/cron/creative-fatigue-detection/route.ts`

Scheduled job to run fatigue analysis daily.

- Analyzes all active campaigns and creatives
- Generates alerts for new fatigue detection
- Sends notifications via configured channels

### 6. Tests

Each library file should have corresponding `.test.ts` files:

- `/src/lib/creative-fatigue/metrics-aggregator.test.ts`
- `/src/lib/creative-fatigue/rolling-window-analyzer.test.ts`
- `/src/lib/creative-fatigue/anomaly-detector.test.ts`
- `/src/lib/creative-fatigue/fatigue-scorer.test.ts`
- `/src/lib/creative-fatigue/recommendation-engine.test.ts`
- `/src/lib/creative-fatigue/fatigue-service.test.ts`

Component tests:

- `/src/components/orbit/creative-fatigue/FatigueScoreCard.test.tsx`
- `/src/components/orbit/creative-fatigue/PerformanceDecayChart.test.tsx`
- `/src/components/orbit/creative-fatigue/FatigueRecommendationPanel.test.tsx`

## Files to Modify

### 1. Database Schema

**File**: `prisma/schema.prisma`

- Add new models: `CreativePerformanceMetrics`, `CreativeFatigueAnalysis`, `CreativeFatigueAlert`
- Add new enums: `CreativeType`, `FatigueStatus`, `RefreshAction`, `ConfidenceLevel`
- Add relations to `Workspace`, `Asset`, `OrganicPostConversion`, `AllocatorCampaign`

### 2. Workspace Relations

**File**: `prisma/schema.prisma` (Workspace model)

- Add relations:
  ```prisma
  creativePerformanceMetrics CreativePerformanceMetrics[]
  creativeFatigueAnalyses    CreativeFatigueAnalysis[]
  creativeFatigueAlerts      CreativeFatigueAlert[]
  ```

### 3. Navigation

**File**: `/src/app/orbit/[workspaceSlug]/layout.tsx` or relevant navigation component

- Add "Creative Fatigue" link to Orbit sidebar navigation

### 4. Allocator Integration

**File**: `/src/lib/allocator/allocator-service.ts`

- Add method to check creative fatigue when generating budget recommendations
- Factor fatigue scores into allocation decisions

### 5. Content Library Integration

**File**: `/src/app/orbit/[workspaceSlug]/content-library/page.tsx`

- Add fatigue score badge to `AssetCard` component
- Display fatigue status indicator on assets

**File**: `/src/components/orbit/AssetCard.tsx`

- Add optional `fatigueScore` prop
- Display fatigue badge when score > 30

## Implementation Phases

### Phase 1: Database & Core Logic (Days 1-3)

1. Create database schema changes
2. Run migrations
3. Implement core library files:
   - `types.ts`
   - `metrics-aggregator.ts`
   - `rolling-window-analyzer.ts`
   - `anomaly-detector.ts`
4. Write unit tests for core logic

### Phase 2: Scoring & Recommendations (Days 4-5)

1. Implement `fatigue-scorer.ts`
2. Implement `recommendation-engine.ts`
3. Implement `fatigue-service.ts` (orchestrator)
4. Write comprehensive tests
5. Test against real data samples

### Phase 3: API Layer (Day 6)

1. Create API routes
2. Test endpoints with Postman/Thunder Client
3. Add API error handling and validation

### Phase 4: UI Components (Days 7-9)

1. Build reusable components:
   - `FatigueScoreCard`
   - `PerformanceDecayChart`
   - `FatigueRecommendationPanel`
   - `FatigueAlertList`
   - `HistoricalPatternsChart`
2. Write component tests
3. Test accessibility

### Phase 5: Dashboard Page (Day 10)

1. Build main dashboard page
2. Integrate all components
3. Add filtering and search
4. Test user flows

### Phase 6: Integrations (Day 11)

1. Integrate with Content Library
2. Integrate with Allocator
3. Add navigation links
4. Test cross-feature workflows

### Phase 7: Cron Job & Alerts (Day 12)

1. Implement cron job
2. Set up alert delivery
3. Test scheduled execution
4. Configure Vercel cron schedule

### Phase 8: E2E Tests & Polish (Days 13-14)

1. Write E2E tests using Playwright
2. Test full user journeys
3. Performance optimization
4. Documentation updates

## Testing Considerations

### Unit Tests

- **Coverage target**: 100% (per project requirements)
- Test edge cases:
  - Insufficient data (< 7 days)
  - Perfectly stable metrics (no decay)
  - Sudden spikes (not just declines)
  - Division by zero scenarios

### Integration Tests

- Test metrics aggregation from multiple sources
- Test database queries with large datasets
- Test anomaly detection with various patterns

### E2E Tests

**Scenarios:**

1. User views fatigue dashboard
2. User filters by creative type
3. User views detail for a fatigued creative
4. User acknowledges an alert
5. System detects fatigue and sends alert

### Performance Tests

- Fatigue analysis should complete in < 2s for 100 creatives
- Dashboard load should be < 1s with caching
- Cron job should handle 1000+ creatives efficiently

## Risks & Mitigations

### Risk 1: Insufficient Historical Data

**Impact**: Cannot calculate baselines or trends for new creatives.

**Mitigation**:

- Require minimum 7 days of data before analysis
- Use industry benchmarks as fallback baselines
- Display "Insufficient Data" status clearly

### Risk 2: False Positives

**Impact**: Alert fatigue from too many incorrect alerts.

**Mitigation**:

- Use multiple signals (not just CTR decay)
- Require confidence threshold before alerting
- Implement feedback loop for users to mark false positives
- Adjust thresholds based on creative type and platform

### Risk 3: Performance at Scale

**Impact**: Slow analysis for workspaces with many creatives.

**Mitigation**:

- Implement caching for analysis results (TTL: 24h)
- Use database indexes on frequently queried fields
- Batch process creatives in cron job
- Consider background job queue for large workspaces

### Risk 4: Data Quality Issues

**Impact**: Missing or inconsistent metrics from platforms.

**Mitigation**:

- Validate data before aggregation
- Handle missing fields gracefully
- Log data quality issues
- Display data quality score in UI

## Dependencies

### Internal Dependencies

- Existing metrics collection infrastructure
- Allocator models and types
- Content Library asset management
- Social account integrations

### External Dependencies

- None (all calculations done in-house)
- Consider future integration with ML libraries for advanced pattern detection

## Success Metrics

1. **Coverage**: Fatigue analysis covers 100% of active campaigns
2. **Accuracy**: < 15% false positive rate on fatigue alerts
3. **Performance**: Analysis completes in < 2s for 100 creatives
4. **User Adoption**: 60%+ of users acknowledge alerts within 48h
5. **Impact**: 10%+ improvement in campaign efficiency for users who act on recommendations

## Future Enhancements (Out of Scope)

1. **Predictive Fatigue**: ML model to predict fatigue before it happens
2. **A/B Test Integration**: Automatic creative rotation testing
3. **Creative Auto-Refresh**: Automatically generate refreshed variants
4. **Cross-Platform Analysis**: Detect fatigue across multiple platforms simultaneously
5. **Seasonal Adjustments**: Account for seasonality in baseline calculations

## Acceptance Criteria Mapping

✅ **Track creative performance metrics over time with decay curve visualization**

- Implemented via `CreativePerformanceMetrics` table
- Visualized in `PerformanceDecayChart` component

✅ **Automated alerts when engagement drops below configurable thresholds**

- Implemented via `CreativeFatigueAlert` model
- Configurable thresholds in `FatigueAnalysisConfig`
- Automated via cron job

✅ **Refresh timing suggestions based on audience size and frequency**

- Implemented in `recommendation-engine.ts`
- Considers avg frequency and reach metrics
- Provides `projectedRefreshDate`

✅ **Historical pattern analysis showing typical creative lifespan by type**

- Implemented in `getHistoricalPatterns()` method
- Visualized in `HistoricalPatternsChart`

✅ **Recommendations for which creative elements to refresh vs replace**

- Implemented via `RefreshAction` enum (REFRESH vs REPLACE)
- Detailed reasoning provided in `recommendation-engine.ts`

## Technical Notes Compliance

✅ **Implement rolling window analysis for detecting performance trends**

- Implemented in `rolling-window-analyzer.ts`
- Supports 7-day, 14-day, and 30-day windows

✅ **Use anomaly detection algorithms to identify sudden performance drops**

- Implemented in `anomaly-detector.ts`
- Multiple algorithms: IQR, Z-score, Moving Average Deviation

✅ **Create fatigue score combining CTR decay, frequency cap data, and engagement trends**

- Implemented in `fatigue-scorer.ts`
- Weighted formula combining all signals

---

**Plan Created**: 2026-01-29
**Estimated Effort**: 14 working days
**Priority**: Medium (Epic #520 is P2)
