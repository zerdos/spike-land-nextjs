# Implementation Plan: Analytics Dashboard (#842)

**Parent Epic**: #836 - Spike Land Pivot
**Created**: 2026-01-29
**Status**: Ready for Implementation

---

## Summary

Create an AI-powered analytics dashboard for Orbit workspaces that provides engagement metrics, growth trends, top-performing posts, and AI-generated insights with actionable recommendations. This feature will give workspace owners comprehensive visibility into their social media performance across all connected platforms.

---

## Architecture Overview

### Database Layer

- Add `AIInsight` model to Prisma schema
- Add `InsightType` enum for categorizing insights

### Component Layer

- Create 5 reusable analytics components in `src/components/orbit/analytics/`
- Each component follows the established patterns (shadcn/ui, Recharts for charts)

### Route Layer

- New page route at `/orbit/[workspaceSlug]/analytics`
- Server component that aggregates data and renders client components

### API Layer

- New API route at `/api/orbit/[workspaceSlug]/analytics`
- Fetches aggregated metrics from social posts, calculates trends
- Generates AI insights using workspace's AI credits

---

## Database Changes

### File: `prisma/schema.prisma`

**Add InsightType enum** (after existing enums, around line 4365):

```prisma
enum InsightType {
  OPPORTUNITY   // Growth opportunity identified
  WARNING       // Potential issue detected
  ACHIEVEMENT   // Milestone or success
  TREND         // Pattern or trend analysis
}
```

**Add AIInsight model** (in the Workspace section, around line 2443):

```prisma
model AIInsight {
  id              String      @id @default(cuid())
  workspaceId     String
  type            InsightType
  title           String
  description     String      @db.Text
  recommendation  String?     @db.Text
  metrics         Json        // Supporting data for the insight
  confidence      Float       // 0.0 to 1.0 confidence score
  isRead          Boolean     @default(false)
  createdAt       DateTime    @default(now())

  workspace       Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([workspaceId, isRead])
  @@index([createdAt(sort: Desc)])
  @@map("ai_insights")
}
```

**Update Workspace model** (add relation around line 2443):

```prisma
model Workspace {
  // ... existing fields ...
  aiInsights         AIInsight[]
  // ... rest of relations ...
}
```

**Migration Steps**:

1. Run `npx prisma migrate dev --name add-ai-insights`
2. Run `npx prisma generate` to update Prisma client
3. Verify migration in `prisma/migrations/`

---

## Component Implementation

### Directory: `src/components/orbit/analytics/`

All components follow these patterns:

- Client components (`"use client"`)
- Use shadcn/ui primitives (Card, Skeleton, Badge, Table)
- Accept `workspaceSlug: string` prop for data fetching
- Include loading states with Skeleton components
- Use React Query for data fetching
- Include comprehensive JSDoc comments
- Maintain 100% test coverage

---

### 1. EngagementOverview.tsx

**Purpose**: Display key engagement metrics in card format

**Design**:

- Grid of 4 cards showing: Total Engagement, Avg Engagement Rate, Total Reach, Total Impressions
- Each card shows current value + percentage change from previous period
- Color-coded trend indicators (green up, red down)
- Skeleton loading states

**Data Source**: Aggregated from `SocialPost` metrics (likes, comments, shares, impressions, reach)

**Props**:

```typescript
interface EngagementOverviewProps {
  workspaceSlug: string;
}
```

**Key Features**:

- Use `Card`, `CardHeader`, `CardTitle`, `CardContent` from shadcn/ui
- Trend arrows using `lucide-react` icons
- Format large numbers with `Intl.NumberFormat`
- React Query with 5-minute stale time

**Test Coverage**:

- Loading state rendering
- Data display with positive/negative trends
- Error handling
- Number formatting edge cases

---

### 2. GrowthChart.tsx

**Purpose**: Line chart showing follower growth over time across platforms

**Design**:

- Multi-line chart with one line per social platform
- Platform-specific colors (consistent with existing PerformanceChart)
- 30-day default view with date range selector
- Legend with platform icons
- Responsive container (300px height minimum)

**Data Source**: Time-series data from `SocialAccount.followerCount` history (requires tracking changes)

**Props**:

```typescript
interface GrowthChartProps {
  workspaceSlug: string;
  dateRange?: { start: Date; end: Date; };
}
```

**Implementation Notes**:

- Use Recharts: `LineChart`, `Line`, `CartesianGrid`, `XAxis`, `YAxis`, `Tooltip`, `Legend`, `ResponsiveContainer`
- Platform colors: Same as `PerformanceChart.tsx` (Facebook: #1877F2, Twitter: #1DA1F2, etc.)
- Custom tooltip showing date + follower count per platform
- If no follower history exists, show empty state with message

**Test Coverage**:

- Chart rendering with multiple platforms
- Single platform rendering
- Empty state
- Date range filtering
- Custom tooltip display

---

### 3. TopPostsTable.tsx

**Purpose**: Sortable table of top-performing posts by engagement

**Design**:

- Table with columns: Platform, Content Preview, Engagement Rate, Likes, Comments, Shares, Posted Date
- Sortable by any column (default: engagement rate descending)
- Pagination (10 posts per page)
- Platform badge with icon
- Truncated content preview (100 chars) with tooltip for full text

**Data Source**: `SocialPost` ordered by engagement metrics

**Props**:

```typescript
interface TopPostsTableProps {
  workspaceSlug: string;
  limit?: number; // Default 10
}
```

**Implementation Notes**:

- Use shadcn/ui `Table`, `TableHeader`, `TableBody`, `TableRow`, `TableCell`
- Use `Badge` for platform indicators
- Click column headers to sort
- Engagement rate = (likes + comments + shares) / impressions * 100
- Format dates with `date-fns` or `Intl.DateTimeFormat`

**Test Coverage**:

- Table rendering with posts
- Empty state
- Sorting by each column
- Pagination
- Content truncation

---

### 4. AIInsightsPanel.tsx

**Purpose**: Display AI-generated insights with recommendations

**Design**:

- Vertical list of insight cards
- Each card shows:
  - Type badge (color-coded: Opportunity=green, Warning=amber, Achievement=blue, Trend=purple)
  - Title and description
  - Optional recommendation section
  - Confidence score indicator
  - Mark as read button
- Grouped by unread/read with expandable sections
- Generate new insights button (consumes AI credits)

**Data Source**: `AIInsight` model, ordered by `createdAt` DESC

**Props**:

```typescript
interface AIInsightsPanelProps {
  workspaceSlug: string;
}
```

**Implementation Notes**:

- Use `Card` for each insight
- Use `Collapsible` from shadcn/ui for read insights section
- Badge colors:
  - OPPORTUNITY: `bg-emerald-500/10 text-emerald-500`
  - WARNING: `bg-amber-500/10 text-amber-500`
  - ACHIEVEMENT: `bg-blue-500/10 text-blue-500`
  - TREND: `bg-purple-500/10 text-purple-500`
- Confidence displayed as progress bar (0-100%)
- "Generate Insights" button calls API endpoint (checks AI credits first)

**Test Coverage**:

- Insights list rendering
- Empty state (no insights)
- Mark as read functionality
- Insight type badges
- Confidence display
- Generate insights button (mocked API)

---

### 5. PlatformBreakdown.tsx

**Purpose**: Pie/donut chart showing engagement distribution across platforms

**Design**:

- Donut chart with segments per platform
- Platform-specific colors
- Legend with platform names and percentages
- Center label showing total engagement count
- Hover shows exact engagement numbers

**Data Source**: Aggregated engagement from `SocialPost` grouped by platform

**Props**:

```typescript
interface PlatformBreakdownProps {
  workspaceSlug: string;
}
```

**Implementation Notes**:

- Use Recharts: `PieChart`, `Pie`, `Cell`, `ResponsiveContainer`, `Tooltip`, `Legend`
- Inner radius for donut effect (60%)
- Outer radius responsive to container
- Custom label in center showing "Total Engagement: X"
- Same platform colors as other charts

**Test Coverage**:

- Chart rendering with multiple platforms
- Single platform rendering
- Empty state
- Percentage calculations
- Custom tooltip

---

## Route Implementation

### File: `src/app/orbit/[workspaceSlug]/analytics/page.tsx` (NEW)

**Purpose**: Analytics dashboard page

**Implementation**:

```typescript
/**
 * Analytics Dashboard Page
 *
 * Comprehensive analytics view showing engagement metrics,
 * growth trends, top posts, and AI-powered insights.
 *
 * Resolves #842
 */

import { AIInsightsPanel } from "@/components/orbit/analytics/AIInsightsPanel";
import { EngagementOverview } from "@/components/orbit/analytics/EngagementOverview";
import { GrowthChart } from "@/components/orbit/analytics/GrowthChart";
import { PlatformBreakdown } from "@/components/orbit/analytics/PlatformBreakdown";
import { TopPostsTable } from "@/components/orbit/analytics/TopPostsTable";

interface AnalyticsPageProps {
  params: Promise<{ workspaceSlug: string; }>;
}

export default async function AnalyticsPage({ params }: AnalyticsPageProps) {
  const { workspaceSlug } = await params;

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">Analytics</h1>
          <p className="text-muted-foreground">
            Track your social media performance and get AI-powered insights
          </p>
        </div>
      </div>

      {/* Engagement Overview - Top row */}
      <EngagementOverview workspaceSlug={workspaceSlug} />

      {/* Growth Chart and Platform Breakdown - Second row */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <GrowthChart workspaceSlug={workspaceSlug} />
        <PlatformBreakdown workspaceSlug={workspaceSlug} />
      </div>

      {/* AI Insights and Top Posts - Third row */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-1">
          <AIInsightsPanel workspaceSlug={workspaceSlug} />
        </div>
        <div className="lg:col-span-2">
          <TopPostsTable workspaceSlug={workspaceSlug} />
        </div>
      </div>
    </div>
  );
}
```

**Test Coverage** (`page.test.tsx`):

- Page renders with all components
- Correct props passed to components
- Layout structure (grid arrangement)
- Heading and description text

---

## Navigation Update

### File: `src/app/orbit/[workspaceSlug]/OrbitSidebar.tsx`

**Change**: Add Analytics to navigation array (line 15-44)

**Implementation**:

```typescript
const getNavItems = (workspaceSlug: string) => [
  { href: `/orbit/${workspaceSlug}/dashboard`, label: "Dashboard", icon: "ðŸ“Š" },
  { href: `/orbit/${workspaceSlug}/analytics`, label: "Analytics", icon: "ðŸ“ˆ" }, // NEW
  { href: `/orbit/${workspaceSlug}/streams`, label: "Streams", icon: "ðŸ“¡" },
  // ... rest of items unchanged
];
```

**Test Coverage**:

- Navigation item appears in sidebar
- Active state highlighting
- Link navigation works

---

## API Endpoints

### File: `src/app/api/orbit/[workspaceSlug]/analytics/route.ts` (NEW)

**Purpose**: Fetch analytics data for dashboard

**Endpoints**:

#### GET `/api/orbit/[workspaceSlug]/analytics`

Returns aggregated analytics data:

```typescript
{
  engagement: {
    total: number;
    avgRate: number;
    change: number; // percentage
    reach: number;
    impressions: number;
  };
  growth: {
    date: string;
    [platform: string]: number; // follower count per platform
  }[];
  topPosts: {
    id: string;
    platform: SocialPlatform;
    content: string;
    engagementRate: number;
    likes: number;
    comments: number;
    shares: number;
    postedAt: string;
  }[];
  platformBreakdown: {
    platform: SocialPlatform;
    engagement: number;
    percentage: number;
  }[];
}
```

**Implementation Notes**:

- Verify workspace access (check `WorkspaceMember`)
- Query `SocialPost` with date range filter (default: last 30 days)
- Aggregate metrics using Prisma aggregations
- Calculate percentage changes by comparing with previous period
- Return 401 if unauthorized, 404 if workspace not found

**Test Coverage**:

- Successful data fetch
- Unauthorized access
- Workspace not found
- Empty data handling
- Date range filtering

---

### File: `src/app/api/orbit/[workspaceSlug]/analytics/insights/route.ts` (NEW)

**Purpose**: Manage AI insights

**Endpoints**:

#### GET `/api/orbit/[workspaceSlug]/analytics/insights`

Returns paginated AI insights:

```typescript
{
  insights: AIInsight[];
  total: number;
  unreadCount: number;
}
```

#### POST `/api/orbit/[workspaceSlug]/analytics/insights/generate`

Generates new AI insights (consumes AI credits):

**Request Body**:

```typescript
{
  forceRegenerate?: boolean; // Skip recent insights check
}
```

**Response**:

```typescript
{
  insights: AIInsight[];
  creditsUsed: number;
  remainingCredits: number;
}
```

**Implementation Notes**:

- Check workspace AI credits before generation
- Deduct credits from `Workspace.usedAiCredits`
- Use OpenAI/Claude API to analyze recent posts and generate insights
- Insight generation logic:
  1. Fetch last 30 days of social posts
  2. Calculate engagement trends per platform
  3. Identify anomalies (sudden drops/spikes)
  4. Generate 3-5 insights with recommendations
  5. Assign confidence scores based on data quality
- Don't regenerate if insights exist from last 24 hours (unless forced)

#### PATCH `/api/orbit/[workspaceSlug]/analytics/insights/[insightId]`

Mark insight as read/unread:

**Request Body**:

```typescript
{
  isRead: boolean;
}
```

**Test Coverage**:

- Fetch insights (pagination)
- Generate insights (success)
- Generate insights (insufficient credits)
- Generate insights (recent insights exist)
- Mark as read/unread
- Unauthorized access

---

## Testing Strategy

### Unit Tests (100% Coverage Required)

**Component Tests**:

- Each component in `src/components/orbit/analytics/*.test.tsx`
- Test all props, loading states, error states
- Test user interactions (sorting, pagination, mark as read)
- Mock React Query hooks with `@tanstack/react-query`
- Mock Recharts with jest mocks (charts don't need visual testing in unit tests)

**API Tests**:

- Each route in corresponding `.test.ts` file
- Mock Prisma client with `jest-mock-extended`
- Test authentication/authorization
- Test data transformations
- Test error cases

**Page Tests**:

- `src/app/orbit/[workspaceSlug]/analytics/page.test.tsx`
- Test rendering of all child components
- Test layout structure

### E2E Tests

**Feature File**: `e2e/features/orbit-analytics.feature`

```gherkin
Feature: Orbit Analytics Dashboard

  Background:
    Given I am logged in
    And I have a workspace "test-workspace"
    And I have connected social accounts with posts

  Scenario: View analytics dashboard
    When I navigate to "/orbit/test-workspace/analytics"
    Then I should see "Analytics" heading
    And I should see engagement overview cards
    And I should see the growth chart
    And I should see the top posts table
    And I should see the platform breakdown chart

  Scenario: Generate AI insights
    When I navigate to "/orbit/test-workspace/analytics"
    And I click "Generate Insights" button
    Then I should see AI insights panel with new insights
    And my AI credits should be decremented

  Scenario: Mark insight as read
    Given I have unread AI insights
    When I navigate to "/orbit/test-workspace/analytics"
    And I click "Mark as Read" on the first insight
    Then the insight should move to the read section
```

**Step Definitions**: `e2e/step-definitions/orbit-analytics.steps.ts`

---

## Implementation Order

### Phase 1: Database & Types (Est. 1 hour)

1. Add `InsightType` enum to Prisma schema
2. Add `AIInsight` model to Prisma schema
3. Update `Workspace` model with relation
4. Run migration: `npx prisma migrate dev --name add-ai-insights`
5. Generate Prisma client: `npx prisma generate`
6. Verify types in `src/generated/prisma/index.d.ts`

### Phase 2: API Routes (Est. 2-3 hours)

1. Create `src/app/api/orbit/[workspaceSlug]/analytics/route.ts`
   - Implement GET endpoint
   - Add unit tests
2. Create `src/app/api/orbit/[workspaceSlug]/analytics/insights/route.ts`
   - Implement GET endpoint (list insights)
   - Add unit tests
3. Implement POST endpoint (generate insights)
   - Add AI generation logic (OpenAI/Claude integration)
   - Add unit tests
4. Implement PATCH endpoint (mark as read)
   - Add unit tests

### Phase 3: Components (Est. 4-5 hours)

Implement in parallel or sequence:

1. **EngagementOverview.tsx** (30 mins)
   - Component implementation
   - Unit tests

2. **PlatformBreakdown.tsx** (45 mins)
   - Component implementation
   - Unit tests

3. **GrowthChart.tsx** (1 hour)
   - Component implementation
   - Unit tests

4. **TopPostsTable.tsx** (1.5 hours)
   - Component implementation
   - Unit tests (sorting, pagination)

5. **AIInsightsPanel.tsx** (1.5 hours)
   - Component implementation
   - Unit tests (mark as read, generate)

### Phase 4: Page Route (Est. 30 mins)

1. Create `src/app/orbit/[workspaceSlug]/analytics/page.tsx`
2. Implement layout with all components
3. Add page tests

### Phase 5: Navigation (Est. 15 mins)

1. Update `OrbitSidebar.tsx` to add Analytics link
2. Update sidebar tests

### Phase 6: E2E Tests (Est. 1 hour)

1. Write `e2e/features/orbit-analytics.feature`
2. Implement step definitions
3. Run and verify E2E tests pass

### Phase 7: Integration & QA (Est. 1 hour)

1. Run full test suite: `yarn test:coverage`
2. Verify 100% coverage
3. Run E2E tests: `yarn test:e2e:local`
4. Manual testing on dev server
5. Fix any issues

---

## Edge Cases & Considerations

### Data Availability

- **No social posts**: Show empty states with helpful messages ("Connect social accounts to see analytics")
- **New workspace**: Show onboarding message encouraging first post
- **Insufficient data**: Disable AI insights generation if < 10 posts

### AI Credits

- Check `Workspace.usedAiCredits` vs `monthlyAiCredits` before generation
- Show credit balance in UI
- Provide upgrade prompt if credits exhausted
- Reset `usedAiCredits = 0` at `billingCycleStart` (requires cron job - out of scope for this ticket)

### Performance

- **Large datasets**: Implement pagination on API endpoints
- **Chart rendering**: Use Recharts' built-in optimization
- **Caching**: Use React Query's stale time (5 mins) to reduce API calls
- **Database queries**: Add proper indexes (already in schema)

### Security

- **Authorization**: Verify workspace membership on all endpoints
- **Rate limiting**: Consider rate limiting insight generation (e.g., max 5/hour)
- **Input validation**: Validate all API inputs with Zod schemas

### Accessibility

- All charts include `aria-label` attributes
- Tables are keyboard navigable
- Color is not the only indicator (use icons + text)
- Loading states announce to screen readers

---

## Risks & Blockers

### Potential Risks

1. **AI Credit System Not Implemented**
   - **Mitigation**: Verify `Workspace` model has `monthlyAiCredits` and `usedAiCredits` fields
   - If missing, add fields in same migration

2. **No Follower History Tracking**
   - **Current Issue**: `SocialAccount.followerCount` is a single value, not time-series
   - **Mitigation**: For Phase 1, use current follower count only (flat line chart)
   - **Future**: Add `SocialAccountMetric` model for historical tracking (separate ticket)

3. **AI Insight Generation Complexity**
   - **Mitigation**: Start with simple rule-based insights, enhance with AI later
   - Example rules:
     - `OPPORTUNITY`: Engagement rate increased >20% in last week
     - `WARNING`: Engagement dropped >30% in last week
     - `ACHIEVEMENT`: Post reached 1k+ engagement
     - `TREND`: Consistent growth for 7+ days

4. **External API Dependencies** (OpenAI/Claude)
   - **Mitigation**: Implement retry logic with exponential backoff
   - Use environment variables for API keys (`OPENAI_API_KEY`)
   - Graceful fallback to rule-based insights if API fails

### Known Blockers

**None identified** - All dependencies exist in current codebase:

- âœ… Prisma ORM configured
- âœ… shadcn/ui components available
- âœ… Recharts installed
- âœ… React Query configured
- âœ… Workspace and SocialPost models exist
- âœ… Authentication/authorization pattern established

---

## Success Criteria Checklist

- [x] Plan created and reviewed
- [ ] All database migrations run successfully
- [ ] All 5 analytics components implemented with tests
- [ ] Analytics page route created and tested
- [ ] Navigation updated with Analytics link
- [ ] All API endpoints implemented with tests
- [ ] 100% unit test coverage achieved
- [ ] E2E tests pass for analytics dashboard
- [ ] Manual testing completed on preview deployment
- [ ] No console errors or warnings
- [ ] Performance benchmarks met (page load < 3s)
- [ ] Accessibility audit passed
- [ ] CI/CD pipeline passes all checks
- [ ] Documentation updated (if needed)

---

## Future Enhancements (Out of Scope)

These features are intentionally excluded from #842 but noted for future tickets:

1. **Historical Follower Tracking** (#TBD)
   - Add `SocialAccountMetric` model
   - Track follower count changes over time
   - Enable true growth chart visualization

2. **Custom Date Ranges** (#TBD)
   - Allow users to select custom date ranges for all charts
   - Implement date range picker component

3. **Export Analytics** (#TBD)
   - Export charts as images
   - Export data as CSV/Excel
   - Schedule automated reports

4. **Advanced AI Insights** (#TBD)
   - Sentiment analysis on comments
   - Competitor comparison insights
   - Content strategy recommendations
   - Optimal posting time suggestions

5. **Real-time Updates** (#TBD)
   - WebSocket integration for live metrics
   - Push notifications for critical insights

6. **Team Collaboration** (#TBD)
   - Comment on insights
   - Assign action items from insights
   - Share analytics reports with team

---

## Related Issues

- **Parent**: #836 - Spike Land Pivot
- **Dependencies**: None
- **Blocks**: #TBD (Future analytics enhancements)
- **Related**:
  - #649 - Pulse Dashboard (similar patterns)
  - #552 - Allocator Dashboard (charting reference)

---

## Complexity Estimation

**Overall Complexity**: Medium

**Breakdown**:

- Database changes: Simple (standard model addition)
- API implementation: Medium (aggregation queries, AI integration)
- Component implementation: Medium (Recharts integration, React Query)
- Testing: Medium (comprehensive coverage required)

**Total Estimated Time**: 10-12 hours for experienced developer

---

## Notes

- Follow existing patterns from Pulse Dashboard (`src/components/orbit/pulse/`) and Allocator (`src/components/orbit/allocator/`)
- Use consistent color scheme with dark mode
- Ensure mobile responsiveness (charts stack vertically on small screens)
- All components must be client components due to interactivity
- Maintain consistency with Tailwind CSS spacing and typography scale
- JSDoc comments required for all public functions and components
