# Deployment Guide

**Updated:** December 2024 - Migrated to Vercel Native Git Integration

This document explains the CI/CD pipeline and deployment process for Spike Land.

## Architecture Overview

The deployment architecture is split between GitHub Actions (testing) and Vercel
(deployments):

```
GitHub Push/PR
      │
      ├──→ GitHub Actions (Tests Only)
      │    ├── quality-checks (lint + security)
      │    ├── unit-tests [12 shards]
      │    ├── build
      │    └── e2e [4 shards]
      │
      └──→ Vercel (Deployments - Native Git Integration)
           ├── Preview URL for PRs (automatic)
           ├── PR comment with URL (automatic)
           └── Production deploy on main merge
```

**Key Benefits:**

- ✅ Faster deployments (Vercel builds independently)
- ✅ Automatic preview URLs for every PR
- ✅ Automatic PR comments with deployment links
- ✅ Simplified GitHub Actions workflow (testing only)
- ✅ Database migrations handled separately

## GitHub Actions Pipeline

The CI/CD pipeline (`.github/workflows/ci-cd.yml`) focuses on **testing only**:

### 1. **Quality Checks** (Parallel)

- Runs linting (`yarn lint`)
- Runs security audit (`yarn npm audit`)
- **Time:** ~1-1.5 minutes

### 2. **Unit Tests** (12 Parallel Shards)

- Runs unit tests with 100% coverage requirement
- Tests split across 12 parallel runners for speed
- Uploads coverage reports to Codecov
- **Time:** ~1.5-2 minutes

### 3. **Build** (Parallel)

- Builds Next.js application
- Validates TypeScript and build configuration
- Uses content-based caching for speed
- **Time:** ~2-2.5 minutes

### 4. **E2E Tests** (4 Parallel Shards)

- Runs Playwright/Cucumber tests against localhost
- Tests run independently of Vercel deployment
- Uploads test reports and screenshots
- **Time:** ~3-3.5 minutes

## Vercel Native Git Integration

Deployments are handled **automatically by Vercel**, not GitHub Actions.

### How It Works

1. **When you push to a PR branch:**
   - Vercel automatically creates a preview deployment
   - A comment is posted to the PR with the preview URL
   - No GitHub Actions deployment job needed

2. **When you merge to main:**
   - Vercel automatically deploys to production
   - The site is live at https://spike.land within minutes

### Configuration

Vercel Git Integration is configured at:

- https://vercel.com/zerdos/spike-land-nextjs/settings/git

Settings:

- **Production Branch:** `main`
- **Automatic Deployments:** Enabled for all branches
- **Preview Deployments:** Enabled for all PRs

### Environment Variables

Environment variables are configured in Vercel dashboard:

- https://vercel.com/zerdos/spike-land-nextjs/settings/environment-variables

Key variables (all environments):

- `DATABASE_URL` - PostgreSQL connection string
- `AUTH_SECRET` - NextAuth secret
- `GITHUB_ID` / `GITHUB_SECRET` - OAuth credentials
- `GOOGLE_ID` / `GOOGLE_SECRET` - OAuth credentials
- `E2E_BYPASS_SECRET` - Test authentication (Preview only)

## Database Migrations

Database migrations are handled by a separate workflow
(`.github/workflows/db-migrate.yml`).

### Automatic Triggers

Migrations run automatically when:

- Changes to `prisma/migrations/**`
- Changes to `prisma/schema.prisma`

### Manual Trigger

You can also run migrations manually:

1. Go to Actions → Database Migration
2. Click "Run workflow"
3. Select branch and run

### Migration Commands

The workflow runs:

```bash
yarn prisma migrate deploy
```

## Deployment URLs

### Production

- **URL:** https://spike.land
- **Deploys from:** `main` branch (automatic)
- **DNS:** Cloudflare

### Preview

- **URL:** Auto-generated by Vercel (e.g.,
  `spike-land-nextjs-git-feature-abc123.vercel.app`)
- **Deploys from:** Any PR branch (automatic)
- **PR Comment:** Vercel posts URL automatically

## Rollback Procedure

If a production deployment breaks something:

### Via Vercel Dashboard

1. Go to: https://vercel.com/zerdos/spike-land-nextjs/deployments
2. Find the previous working deployment
3. Click "..." → "Promote to Production"

### Via Workflow

1. Go to: Actions → "Rollback Deployment"
2. Click "Run workflow"
3. Select environment and deployment ID
4. Click "Run workflow"

## Required GitHub Secrets

| Secret              | Purpose             | Required By            |
| ------------------- | ------------------- | ---------------------- |
| `DATABASE_URL`      | Database connection | E2E tests, migrations  |
| `AUTH_SECRET`       | NextAuth secret     | E2E tests              |
| `E2E_BYPASS_SECRET` | Test auth bypass    | E2E tests              |
| `VERCEL_TOKEN`      | Vercel API          | Rollback workflow only |
| `CODECOV_TOKEN`     | Coverage reports    | Optional               |

## Troubleshooting

### Vercel deployment not triggering

1. Check Git Integration is enabled in Vercel settings
2. Verify GitHub app has repository access
3. Check Vercel build logs for errors

### E2E tests pass locally but fail in CI

1. Check `DATABASE_URL` secret is set
2. Ensure `E2E_BYPASS_SECRET` matches Vercel config
3. Check Playwright browsers are cached

### Database migration fails

1. Check `DATABASE_URL` secret in production environment
2. Verify migration SQL is idempotent
3. Check Prisma schema matches database

### Preview URL not working

1. Wait 2-3 minutes for build to complete
2. Check Vercel deployment logs
3. Verify environment variables are set for Preview

## Manual Deployment (Emergency Only)

If Vercel Git Integration is broken:

```bash
# Install Vercel CLI
yarn global add vercel

# Login to Vercel
vercel login

# Deploy to preview
vercel deploy

# Deploy to production
vercel deploy --prod
```

## Performance

### CI Times (After Optimization)

| Stage          | Time     | Notes               |
| -------------- | -------- | ------------------- |
| Quality Checks | ~1.5 min | Lint + security     |
| Unit Tests     | ~2 min   | 12-way sharding     |
| Build          | ~2.5 min | Content-based cache |
| E2E Tests      | ~3.5 min | 4-way sharding      |
| **Total CI**   | ~5-6 min | All parallel        |

### Deployment Times

| Environment | Time     | Notes               |
| ----------- | -------- | ------------------- |
| Preview     | ~2-3 min | Vercel native build |
| Production  | ~2-3 min | Vercel native build |

## Related Documentation

- [VERCEL_DOMAIN_SETUP.md](./VERCEL_DOMAIN_SETUP.md) - Vercel domain
  configuration
- [CLOUDFLARE_DNS_SETUP.md](./CLOUDFLARE_DNS_SETUP.md) - DNS setup
- [../../CLAUDE.md](../../CLAUDE.md) - Main project documentation
